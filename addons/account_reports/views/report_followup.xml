<?xml version="1.0" encoding="utf-8"?>
<openerp>
<data>

<record model="mail.message.subtype" id="followup_logged_action">
    <field name="name">Logged followup action</field>
    <field name="description">Messages created after a followup action has been executed</field>
    <field name="res_model">res.partner</field>
</record>
    <record forcecreate="True" id="property_account_payment_next_action_date" model="ir.property">
        <field name="name">payment_next_action_date</field>
        <field name="fields_id" search="[('model','=','res.partner'),('name','=','payment_next_action_date')]"/>
        <field eval="False" name="value"/>
    </record>

<template id="report_followup_line" inherit_id="account_reports.report_financial_line" primary="True">
    <xpath expr="//tr[@id='tr-line']" position="attributes">
        <attribute name="t-att-bgcolor">a.get('blocked') and 'LightGray' or 'white'</attribute>
    </xpath>
    <xpath expr="//div[@class='dropdown']" position="replace">
        <a t-if="a['type'] == 'payment' and mode != 'print'">
            <span style="font-style: italic;" t-att-data-active-id="context.env['account.move.line'].browse(int(a.get('id'))).payment_id.id" data-res-model="account.payment" class="oe-account-web-action"><t t-esc="a.get('name')"/></span>
        </a>
        <div class="dropdown" t-if="a['type'] == 'unreconciled_aml' and mode != 'print'">
            <a data-toggle="dropdown">
                <span style="font-style: italic;" t-att-class="' '.join([a['type'], str(a['id'])])">
                    <t t-esc="a.get('name')"/>
                </span>
                <span class="caret"></span>
            </a>
            <t t-call="account_reports.report_financial_footnote_sup" />
            <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                <li role="presentation"><a class='oe-account-web-action' role="menuitem" tabindex="-1" data-res-model='account.invoice' t-att-data-active-id="context.env['account.move.line'].browse(int(a.get('id'))).invoice.id">View Invoice</a></li>
                <li role="presentation"><a role="menuitem" tabindex="-1" class="change_exp_date">Change expected payment date/note</a></li>
            </ul>
        </div>
    </xpath>    
    <xpath expr="//tr/t/t[@t-set='column']" position="after">
        <t t-set="tooltip" t-value="''" />
        <t t-if="column == 4 and a['type'] == 'unreconciled_aml' and not context.env.context.get('public')"><t t-set="tooltip" t-value="c[1]" /><t t-set="c" t-value="c[0]" /></t>
    </xpath>
    <xpath expr="//tr/t/td/span" position="attributes">
        <attribute name="t-if">column != 5 or a['type'] != 'unreconciled_aml' or context.env.context.get('public')</attribute>
    </xpath>
    <xpath expr="//tr/t/td/span" position="after">
        <span t-att-class='align' t-if="column == 5 and a['type'] == 'unreconciled_aml'">
            <input t-if="c == False" type="checkbox" name="blocked" value="True" />
            <input t-if="c == True" type="checkbox" name="blocked" value="True" checked="checked" />
        </span>
    </xpath>
    <xpath expr="//span[@class='annotable']" position="attributes">
        <attribute name="data-toggle">tooltip</attribute>
        <attribute name="data-placement">bottom</attribute>
        <attribute name="t-att-title">tooltip</attribute>
    </xpath>
    <xpath expr="//i[@class='fa fa-fw fa-pencil-square']" position='replace'></xpath>
    <xpath expr="//i[@class='fa fa-fw fa-pencil-square']" position='replace'></xpath>
    <xpath expr="//i[@class='fa fa-fw fa-pencil-square']" position='replace'></xpath>
    <xpath expr="//i[@class='fa fa-fw fa-pencil-square']" position='replace'></xpath>
    <xpath expr="//i[@class='fa fa-fw fa-pencil-square']" position='replace'></xpath>
</template>
<template id="report_followup_line_public" inherit_id="account_reports.report_followup_line" primary="True">
    <xpath expr="//ul[@class='dropdown-menu']" position="replace"></xpath>
    <xpath expr="//span[@class='caret']" position="replace"></xpath>
</template>
<template id="report_followup_body" inherit_id="account_reports.report_financial_body" primary="True">
    <xpath expr="//h2" position="after">
        <div t-if="mode != 'print' and not context.env.context.get('public')">
            <div class='pull-right' id='history'>
                <div t-if='context.get_history()' class="btn-group">
                    <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                        History <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" role="menu">
                        <t t-foreach="context.get_history()" t-as='msg'>
                            <li role="presentation" style='margin-left: 5px'><t t-raw='msg.body' /></li>
                            <li role="presentation" class="divider"></li>
                        </t>
                    </ul>
                </div>
            </div>
            <t t-if='context.partner_id.phone'><p class='fa fa-phone' t-esc="' ' + context.env['res.partner'].browse(context.partner_id.address_get(['invoice'])['invoice']).phone" /><br /></t>
            <t t-if='context.partner_id.mobile'><p class='fa fa-mobile' t-esc="' ' + context.env['res.partner'].browse(context.partner_id.address_get(['invoice'])['invoice']).mobile" /><br /></t>
            <t t-if='context.partner_id.fax'><p class='fa fa-fax' t-esc="' ' + context.env['res.partner'].browse(context.partner_id.address_get(['invoice'])['invoice']).fax" /><br /></t>
            <t t-if='context.partner_id.email'><a t-att-href="'mailto:' + context.env['res.partner'].browse(context.partner_id.address_get(['invoice'])['invoice']).email"><p class='fa fa-envelope' t-esc="' ' + context.env['res.partner'].browse(context.partner_id.address_get(['invoice'])['invoice']).email" /></a><br /></t>
        </div>
    </xpath>
    <xpath expr='//th' position='replace'>
        <th class="text-center">Reference number</th>
    </xpath>
    <xpath expr="//th[@width='1%']" position="attributes">
        <attribute name="width"></attribute>
    </xpath>
    <xpath expr="//h2" position="replace">
        <h2>
            <span t-if="not context.env.context.get('public')"><a t-att-data-active-id="context.partner_id.id" data-res-model="res.partner" class="oe-account-web-action"><t t-esc='context.partner_id.name' /></a></span>
            <span t-if="context.env.context.get('public')"><t t-esc='context.partner_id.name' /></span>
            <small><a t-att-href="context.get_public_link()" target="_blank">(share)</a></small>
        </h2>
    </xpath>
    <xpath expr="//t[@t-call='account_reports.report_financial_line']" position="replace">
        <t t-call='account_reports.report_followup_line' />
    </xpath>
    <xpath expr="//div[@class='oe-account-summary']" position="before">
        <div t-if="mode != 'print' and not context.env.context.get('public')">
            <span id='action-buttons' class='oe-account-followup-not-clicked'>
                <a type="button" class="btn btn-primary followup-done" t-att-data-partner="str(context.partner_id.id)">Done</a>
                <a type="button" class="btn btn-default followup-skip" t-att-data-partner="str(context.partner_id.id)">Skip</a>
                <a type="button" data-primary='1' class="btn btn-primary followup-letter" t-att-data-target="'/account/followup_report/' + str(context.partner_id.id) + '/?pdf'" t-att-data-context="str(context.id)">Print Letter</a>
                <a type="button" data-primary='1' class="btn btn-primary followup-email" t-att-data-context="str(context.id)">Send by email</a>
                <a type="button" data-time='none' class="btn btn-default oe-account-followup-set-next-action" t-att-data-partner="str(context.partner_id.id)">Log A Note</a>
            </span>
            <div class='pull-right btn-group' id='followup-mode'>
                <a type="button" t-att-class="'btn oe-account-followup-auto ' + (context.partner_id.payment_next_action_date &lt;= today and 'btn-info' or 'btn-default')">Auto</a>
                <a type="button" t-att-class="'btn oe-account-followup-manual oe-account-followup-set-next-action ' + (context.partner_id.payment_next_action_date &lt;= today and 'btn-default' or 'btn-info')" t-att-data-partner="str(context.partner_id.id)">Manual</a>
            </div>
        </div>
    </xpath>
</template>
<template id="report_followup" inherit_id="account_reports.report_financial" primary="True">
    <xpath expr="//script" position='after'>
        <script type="text/javascript" src="/account_reports/static/src/js/account_followup_report_widgets.js"></script>
    </xpath>
    <xpath expr="//script[@id='oe-account-inline-script']" position='replace'>
        <script type="text/javascript" id='oe-account-inline-script'>
            odoo.define('account.FollowupReport', function (require) {
                'use strict';
                
                var FollowupReportWidget = require('account.FollowupReportWidget');
                
                $(document).ready(function() {
                    var followup_report_widget = new FollowupReportWidget();
                    followup_report_widget.setElement($('.oe_account_report_widgets'));
                    followup_report_widget.start();
                });
            });
        </script>
    </xpath>
    <xpath expr="//t[@t-call='account_reports.report_financial_body']" position="replace">
        <div class="alert alert-warning oe-account-followup-no-action" id='no-action' role="alert" t-if="context and context.partner_id not in context.env['res.partner'].get_partners_in_need_of_action()">
            <p><strong>Warning!</strong> No action needs to be taken for this partner. <a t-if='context.partner_id.payment_next_action_date &gt; today' class='oe-account-followup-auto'>Put back in the list</a></p>
        </div>
        <t t-call='account_reports.report_followup_body' />
    </xpath>
    <xpath expr="//div[@id='footnoteModal']" position="after">
        <div t-if="mode != 'print'" class="modal fade" id="paymentDateModal" tabindex="-1" role="dialog" aria-labelledby="paymentDateLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&amp;times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="paymentDateLabel"></h4>
                    </div>
                    <div class="modal-body">
                        <form role="form">
                            <label for="expectedDate">Expected Payment Date</label>
                            <div class="form-group">
                                <div class='input-group date oe-account-datetimepicker'>
                                <input type='text' class="form-control" name="expectedDate" id="expectedDate" />
                                <span class="input-group-addon"><span class="fa fa-calendar"></span></span>
                                </div>
                            </div>
                            <label for='internalNote'>Note</label>
                            <textarea name="internalNote" id="internalNote" rows='4' class="form-control" placeholder="Insert note here"></textarea>
                            <input type='hidden' id='target_id' />
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="savePaymentDate">Save</button> or <button type="button" class="btn btn-link" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
        <div t-if="mode != 'print'" class="modal fade" id="nextActionModal" tabindex="-1" role="dialog" aria-labelledby="nextActionLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&amp;times;</span><span class="sr-only">Close</span></button>
                    </div>
                    <div class="modal-body">
                        <div class='btn-group'>
                            <a type="button" data-time='one-week' class="btn btn-default oe-account-followup-set-next-action">One week</a>
                            <a type="button" data-time='two-weeks' class="btn btn-default oe-account-followup-set-next-action">Two weeks</a>
                            <a type="button" data-time='one-month' class="btn btn-default oe-account-followup-set-next-action">One month</a>
                            <a type="button" data-time='two-months' class="btn btn-default oe-account-followup-set-next-action">Two months</a>
                        </div>
                        <form role="form">
                            <label for="nextActionDate">Don't follow-up before :</label>
                            <div class="form-group">
                                <div class='input-group date oe-account-datetimepicker oe-account-picker-next-action-date'>
                                <input type='text' class="form-control" name="nextActionDate" id="nextActionDate" />
                                <span class="input-group-addon"><span class="fa fa-calendar"></span></span>
                                </div>
                            </div>
                            <label for='nextActionNote'>Note</label>
                            <textarea name="nextActionNote" id="nextActionNote" rows='4' class="form-control" placeholder="Insert note here"></textarea>
                            <input type='hidden' id='target_id' />
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="saveNextAction">Save</button> or <button type="button" class="btn btn-link" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </xpath>
</template>
<template id="report_followup_letter_body" inherit_id="account_reports.report_followup_body" primary="True">
    <xpath expr="//div[@id='print-summary']" position="attributes">
        <attribute name="t-if"></attribute>
        <attribute name="class"></attribute>
        <attribute name="style">padding-top: 15px; padding-bottom: 15px;</attribute>
    </xpath>
    <xpath expr="//h2" position="replace">
        <div class="row">
            <div class="col-xs-5 col-xs-offset-7" style='margin-top: 45px;'>
                <div t-field="context.partner_id" 
                    t-field-options='{"widget": "contact", "fields": ["address", "name", "phone", "fax"], "no_marker": true}'/>
                 <span t-field="context.partner_id.vat"/>
            </div>
        </div>
        <p>
            Document: Customer account statement<br/>
            Date: <span t-esc="today"/><br/>
            Customer ref: <span t-field="context.partner_id.ref"/>
        </p>
    </xpath>
    <xpath expr="//t[@t-call='account_reports.report_followup_line']" position="attributes">
        <attribute name="t-call">account_reports.report_followup_line_public</attribute>
    </xpath>
</template>
<template id="report_followup_public" inherit_id="account_reports.report_followup" primary="True">
    <xpath expr="//t[@t-call='account_reports.report_followup_body']" position="replace">
        <t t-call='account_reports.report_followup_public_body' />
    </xpath>
    <xpath expr="//div[@id='no-action']" position='replace'>
    </xpath>
</template>
<template id="report_followup_public_body" inherit_id="account_reports.report_followup_body" primary="True">
    <xpath expr="//div[@id='history']" position="replace"></xpath>
    <xpath expr="//span[@id='action-buttons']" position='replace'></xpath>
    <xpath expr="//div[@class='oe-account-summary']" position="replace"></xpath>
    <xpath expr="//div[@class='oe-account-summary mt32']" position="replace"></xpath>
    <xpath expr="//div[@class='oe-account-saved-summary']" position="attributes">
        <attribute name="t-if"></attribute>
        <attribute name="class"></attribute>
        <attribute name="style">padding-top: 15px; padding-bottom: 15px;</attribute>
    </xpath>
    <xpath expr="//h2/small" position="replace"></xpath>
    <xpath expr="//t[@t-call='account_reports.report_followup_line']" position="attributes">
        <attribute name="t-call">account_reports.report_followup_line_public</attribute>
    </xpath>
</template>
<template id="report_followup_letter">
    <t t-raw="'&lt;base href=%s&gt;' % base_url"/>
    <t t-call="report.html_container">
        <link rel="stylesheet" href="/account_reports/static/src/css/account_financial_report.css" />
        <link href="/web/static/lib/bootstrap/css/bootstrap.css" rel="stylesheet"/>
        <t t-call="account_reports.report_followup_letter_body" />
    </t>
</template>
<template id="report_followup_all" inherit_id="account_reports.report_followup" primary="True">
    <xpath expr="//t[@t-call='account_reports.report_followup_body']" position="replace">
        <t t-if="all_partners_done">
            <div class="container">
                <div class="row mt32">
                    <div class="alert alert-success" role="alert" id='oe-account-final-summary'>
                        <p><strong>Good job!</strong> All followup letters and emails have been sent.</p>
                        <p>You have sent <t t-esc="context_all.valuemax" /> reports in <t t-esc="context_all.get_total_time()" />s<br />
                        That means you have spent on average <t t-esc="context_all.get_time_per_report()" />s per report.</p>
                    </div>
                    <div class="alert alert-danger" role="alert" t-if='emails_not_sent'>
                        <p><strong>Warning!</strong> The following emails have not been sent :<br />
                        <t t-foreach='emails_not_sent' t-as='email_not_sent'>
                            <a t-att-data-active-id="email_not_sent.partner_id.id" data-res-model="res.partner"><t t-esc='email_not_sent.partner_id.name' /></a><br />
                        </t>
                        </p>
                    </div>
                </div>
            </div>
        </t>
        <div t-if="len(reports) != 0 or page > 1">
            <t t-if="page == 1"><i class="fa fa-fw fa-chevron-circle-left fa-2x disabled"></i></t>
            <t t-if="page > 1"><a t-att-href="'/account/followup_report/all/page/' + str(page - 1)"><i class="fa fa-fw fa-chevron-circle-left fa-2x"></i></a></t>
            <t t-if="not last_page"><a t-att-href="'/account/followup_report/all/page/' + str(page + 1)"><i class="fa fa-fw fa-chevron-circle-right fa-2x"></i></a></t>
            <t t-if="last_page"><i class="fa fa-fw fa-chevron-circle-right fa-2x disabled"></i></t>
            <t t-foreach="context_all.get_alerts()" t-as="alert">
                <div class="alert alert-info alert-dismissible" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&amp;times;</span></button>
                    <b t-esc="alert['title']" /> <t t-esc="alert['message']" />
                </div>
            </t>
            <div class="progress" t-if="context_all.partner_filter == 'action'">
                <div class="progress-bar" role="context_all" t-att-aria-valuenow="context_all.valuenow" aria-valuemin="0" t-att-aria-valuemax="context_all.valuemax" t-att-style="'width: ' + str(context_all.percentage) + '%;'">
                    <span class="show"><t t-esc="str(context_all.valuenow) + '/' + str(context_all.valuemax)" /></span>
                </div>
            </div>
        </div>
        <form class="form-inline">
            <div class="form-group">
                <select class="form-control" name="partner_filter">
                    <option t-if="context_all.partner_filter != 'all'" value='all'>All partners with overdue invoices</option>
                    <option t-if="context_all.partner_filter != 'action'" value='action'>All partners in need of action</option>
                    <option selected='selected' t-if="context_all.partner_filter == 'all'" value='all'>All partners with overdue invoices</option>
                    <option selected='selected' t-if="context_all.partner_filter == 'action'" value='action'>All partners in need of action</option>
                </select>
            </div>
            <button type="submit" class="btn btn-default">Update</button>
        </form>
        <t t-foreach='reports' t-as='data'>
            <t t-set='context' t-value="data['context']" />
            <t t-set='lines' t-value="data['lines']" />
            <t t-call='account_reports.report_followup_body' />
            <p></p>
            <p></p>
            <p></p>
        </t>
        <t t-if="len(reports) == 0 and page == 1">
            <div class="container" t-if="just_arrived">
                <div class="row mt32">
                    <div class="alert alert-info" role="alert">
                        No followup to send !
                    </div>
                </div>
            </div>
        </t>
    </xpath>
</template>
</data>
</openerp>