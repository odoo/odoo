<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="pos_payment_method_view_form" model="ir.ui.view">
        <field name="name">pos.payment.method.form</field>
        <field name="model">pos.payment.method</field>
        <field name="arch" type="xml">
            <form string="Payment Methods">
                <sheet>
                    <widget name="web_ribbon" title="Archived" bg_color="text-bg-danger" invisible="active"/>
                    <field name="active" invisible="1"/>
                    <field name="type" invisible="1"/>
                    <field name="default_pos_receivable_account_name" invisible="1" />
                    <div class="accordion-item alert alert-warning d-flex align-items-start gap-2 pb-0" role="alert" invisible="not (payment_method_type == 'external_qr' and external_qr_usage == 'sticker')">
                        <i class="fa mt-1 fa-exclamation-triangle" aria-hidden="true" title="warning"></i>
                        <div>
                            <div class="accordion-header cursor-pointer d-flex collapsed" data-bs-toggle="collapse" data-bs-target="#alert-sticker" aria-controls="alert-sticker">
                                <div class="flex-grow-1">
                                    <strong class='d-block fs-4'>A static QR code must not be shared across multiple checkouts.</strong>
                                    <p>
                                        This type of QR code is tied to a specific payment method within a given Point of Sale configuration.
                                        If multiple orders are sent at the same time to the same QR code, the system can no longer reliably match the received payment to the correct order.
                                    </p>
                                </div>
                                <div class="accordion-item-chevron d-flex mx-2 align-items-center fs-3">
                                    <i class="fa fa-chevron-down" aria-hidden="true" title="Expand/Collapse"></i>
                                </div>
                            </div>
                            <div id="alert-sticker" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <p>
                                        <strong class='d-block fs-5'>Example:</strong>
                                        You have a food truck with two checkout counters, but only one payment method using the same sticker.
                                        If two orders are sent simultaneously to this QR code, it's no longer possible to confidently associate the scanned payment with the right order — which can result in a customer paying for someone else’s order.
                                    </p>

                                    <p>
                                        <strong class='d-block fs-5'>To avoid this situation:</strong>
                                        <ul>
                                            <li>Duplicate the payment method and use one for each checkout counter.</li>
                                            <li>Or set up a separate Point of Sale for each checkout, each with its own payment method.</li>
                                        </ul>
                                    </p>

                                    <p>
                                        The goal is to have <strong>one QR sticker per checkout.</strong>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <div class="oe_title">
                            <label for="name"/>
                            <h1><field name="name" placeholder="e.g. Cash" class="oe_inline"/></h1>
                        </div>
                        <field name="image" class="oe_avatar" widget='image'/>
                    </div>
                    <group name="Payment methods">
                        <group>
                            <field name="split_transactions"/>
                            <field name="journal_id" required="not split_transactions" placeholder="Leave empty to use the receivable account of customer" />
                            <field name="outstanding_account_id" groups="account.group_account_readonly" invisible="type != 'bank'" required="type == 'bank'" placeholder="Selection of outstanding account is required" />
                            <field name="receivable_account_id" groups="account.group_account_readonly" invisible="split_transactions" widget="many2one" options="{'placeholder_field': 'default_pos_receivable_account_name'}"/>
                            <field name="company_id" readonly="1" groups="base.group_multi_company" />
                            <field name="config_ids" widget="many2many_tags" placeholder="No Point of Sale" />
                        </group>
                        <div>
                            <group>
                                <field name="hide_use_payment_terminal" invisible="1"/>
                                <field name="hide_qr_code_method" invisible="1"/>
                                <field name="payment_method_type" />
                                <field name="use_payment_terminal" string="Integrate with" invisible="hide_use_payment_terminal"/>
                                <field name="qr_code_method" invisible="hide_qr_code_method" required="payment_method_type == 'qr_code'"/>
                                <field name="external_qr_usage" invisible="not (use_payment_terminal and payment_method_type == 'external_qr')"/>
                                <field name="external_qr_sticker_size" invisible="not (use_payment_terminal and payment_method_type == 'external_qr' and external_qr_usage == 'sticker')"/>
                                <button name="download_sticker" type="object" string="Download Sticker" class="btn btn-primary" invisible="not (use_payment_terminal and payment_method_type == 'external_qr' and external_qr_usage == 'sticker')"/>
                            </group>
                            <widget name="pos_payment_provider_cards" options="{ 'payment_method_types': ['terminal']}" invisible="not (payment_method_type == 'terminal' and not use_payment_terminal)" />
                            <widget name="pos_payment_provider_cards" options="{ 'payment_method_types': ['external_qr']}" invisible="not (payment_method_type == 'external_qr' and not use_payment_terminal)" />
                        </div>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="pos_payment_method_view_tree" model="ir.ui.view">
        <field name="name">pos.payment.method.list</field>
        <field name="model">pos.payment.method</field>
        <field name="arch" type="xml">
            <list string="Payment Methods" create="1" delete="1">
                <field name="type" column_invisible="True"/>
                <field name="sequence" widget="handle"/>
                <field name="name" />
                <field name="split_transactions" optional="hide" />
                <field name="journal_id" required="not split_transactions" />
                <field name="outstanding_account_id" groups="account.group_account_readonly" optional="hide" invisible="type != 'bank'" />
                <field name="receivable_account_id" groups="account.group_account_readonly" optional="hide" invisible="split_transactions" />
                <field name="company_id" groups="base.group_multi_company" />
                <field name="config_ids" widget="many2many_tags"/>
            </list>
        </field>
    </record>

    <record id="pos_payment_method_view_search" model="ir.ui.view">
        <field name="name">pos.payment.search.view</field>
        <field name="model">pos.payment.method</field>
        <field name="arch" type="xml">
            <search string="Payment Methods">
                <field name="name"/>
                <field name="receivable_account_id" groups="account.group_account_readonly" />
                <group>
                    <filter name="group_by_receivable_account" string="Account" domain="[]" context="{'group_by':'receivable_account_id'}"/>
                    <filter name="group_by_pos_config" string="Point of Sale" domain="[]" context="{'group_by':'config_ids'}"/>
                    <filter name="group_by_method_name" string="Method Name" domain="[]" context="{'group_by':'name'}"/>
                    <filter name="group_by_journal_id" string="Journal" domain="[]" context="{'group_by':'journal_id'}"/>
                </group>
                <filter string="Archived" name="active" domain="[('active', '=', False)]"/>
            </search>
        </field>
    </record>

    <record id="action_pos_payment_method_form" model="ir.actions.act_window">
        <field name="name">Payment Methods</field>
        <field name="res_model">pos.payment.method</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="view_id" eval="False"/>
        <field name="domain">[]</field>
        <field name="context">{'search_default_group_by_account': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Add a new payment method
            </p>
            <p>
                Installing chart of accounts from the General Settings of
                Invocing/Accounting app will create Bank and Cash payment
                methods automatically.
            </p>
        </field>
    </record>

    <menuitem id="menu_pos_payment_method" parent="menu_point_config_product" action="action_pos_payment_method_form" sequence="3" groups="group_pos_manager,group_pos_user"/>

    <record id="action_payment_methods_tree" model="ir.actions.act_window">
        <field name="context">{}</field>
        <field name="name">Payments Methods</field>
        <field name="res_model">pos.payment.method</field>
        <field name="view_id" ref="pos_payment_method_view_tree"/>
        <field name="view_mode">list,form,kanban</field>
    </record>
</odoo>
