from datetime import date, timedelta
from random import randint

from odoo import fields
from odoo.tools import DEFAULT_SERVER_DATE_FORMAT
from odoo.addons.account.tests.common import AccountTestInvoicingHttpCommon


class TestPointOfSaleDataHttpCommon(AccountTestInvoicingHttpCommon):
    @classmethod
    def setUpClass(self):
        super().setUpClass()

        # Ensure access rights
        self.env.user.group_ids += self.env.ref('point_of_sale.group_pos_manager')
        self.env.user.group_ids += self.env.ref('stock_account.group_stock_accounting_automatic')

        # Delete or archive all data that could interfere with the tests
        self.env['product.template'].search([('available_in_pos', '=', True)]).write({'active': False})
        self.env['res.partner'].search([('user_id', '=', False), ('user_ids', '=', False)]).write({'active': False})
        self.env['pos.session'].sudo().search([]).unlink()
        self.env["pos.category"].search([]).unlink()

        # The order of functions call is important
        self.setup_test_company(self)
        self.setup_test_journals(self)
        self.setup_test_payment_methods(self)
        self.setup_test_partners(self)
        self.setup_test_categories(self)
        self.setup_test_taxes(self)
        self.setup_test_products(self)
        self.setup_test_pricelists(self)
        self.setup_test_pos_config(self)
        self.setup_test_users(self)

    @classmethod
    def adjust_inventory(self, products, quantities):
        for product, qty in zip(products, quantities):
            self.env['stock.quant'].with_context(inventory_mode=True).create({
                'product_id': product.id,
                'inventory_quantity': qty,
                'location_id': self.stock_location_components.id,
            }).action_apply_inventory()

    def close_session(self):
        session = self.pos_config.current_session_id
        self.env['pos.order'].search([('session_id', '=', session.id)]).write({'state': 'cancel'})
        session.post_closing_cash_details(0)
        session.close_session_from_ui()

    def make_payment(self, order, payment_method, amount):
        payment_context = {"active_id": order.id, "active_ids": order.ids}
        return self.env['pos.make.payment'].with_context(**payment_context).create({
            'amount': amount,
            'payment_method_id': payment_method.id,
        }).check()

    def make_order_data(self, orderlines=[], payments=[], pricelist=False, currency=False, customer=False, invoice=False):
        """ Mocks the order_data generated by the pos ui."
            orderlines args required fields:
                - product_id: product.product record
                - qty: quantity of the product
                - discount: discount percentage

            payments args required fields:
                - amount: amount of the payment
                - payment_method_id: pos.payment.method record

            pricelist: product.pricelist record
            currency: res.currency record
            customer: res.partner record
            invoice: bool
        """

        fp = customer.property_account_position_id if customer else self.pos_config.default_fiscal_position_id
        if not pricelist:
            pricelist = self.pos_config.pricelist_id
        if not currency:
            currency = self.pos_config.currency_id

        order_orderlines = []
        order_payments = []

        for orderline in orderlines:
            product = orderline['product_id']
            quantity = orderline['qty']
            discount = orderline['discount']

            price_unit = self.pricelist._get_product_price(product, quantity, currency=currency)
            price_unit_after_discount = price_unit * (1 - discount / 100.0)
            tax_ids = fp.map_tax(product.taxes_id.filtered_domain(self.env['account.tax']._check_company_domain(self.env.company)))
            computed_tax = tax_ids.compute_all(price_unit_after_discount, currency, quantity)
            tax_values = computed_tax if tax_ids else {
                'total_excluded': price_unit_after_discount,
                'total_included': price_unit_after_discount,
            }

            order_orderlines.append((0, 0, {
                **orderline,
                'tax_ids': [(6, 0, tax_ids.ids)],
                'product_id': product.id,
                'price_unit': price_unit_after_discount,
                'price_subtotal': tax_values['total_excluded'],
                'price_subtotal_incl': tax_values['total_included'],
            }))

        for payment in payments:
            order_payments.append((0, 0, {
                **payment,
                'name': fields.Datetime.now(),
                'payment_method_id': payment['payment_method_id'].id,
            }))

        uuid = ('%05d-%03d-%04d' % (randint(1, 99999), randint(1, 999), randint(1, 9999)))
        total_amount_incl = sum(line[2]['price_subtotal_incl'] for line in order_orderlines)
        total_amount_base = sum(line[2]['price_subtotal'] for line in order_orderlines)

        return {
            'amount_paid': sum(payment[2]['amount'] for payment in order_payments),
            'amount_return': 0,
            'amount_tax': total_amount_incl - total_amount_base,
            'amount_total': total_amount_incl,
            'date_order': fields.Datetime.to_string(fields.Datetime.now()),
            'fiscal_position_id': fp.id,
            'pricelist_id': pricelist.id if pricelist else self.pos_config.pricelist_id.id,
            'name': 'Order %s' % uuid,
            'last_order_preparation_change': '{}',
            'lines': order_orderlines,
            'partner_id': customer and customer.id,
            'session_id': self.pos_config.current_session_id.id,
            'payment_ids': order_payments,
            'uuid': uuid,
            'user_id': self.env.uid,
            'to_invoice': invoice,
        }

    def create_order(self, orderlines=[], payments=[], pricelist=False, currency=False, customer=False, invoice=False):
        order_data = self.make_order_data(orderlines, payments, pricelist, currency, customer, invoice)
        results = self.env['pos.order'].sync_from_ui([order_data])
        return self.env['pos.order'].browse([order['id'] for order in results['pos.order']])

    def start_pos_tour(self, tour_name, login="pos_user", **kwargs):
        self.start_tour(f"/pos/ui?config_id={self.pos_config.id}", tour_name, login=login, **kwargs)

    def setup_test_pos_config(self):
        self.env['pos.config'].search([]).unlink()
        self.pos_config = self.env['pos.config'].create({
            'name': 'Main Point of Sale',
            'invoice_journal_id': self.invoice_journal.id,
            'journal_id': self.sale_journal.id,
            'iface_tipproduct': True,
            'ship_later': True,
            'tip_product_id': self.product_tip.id,
            'use_pricelist': True,
            'pricelist_id': self.public_pricelist.id,
            'available_pricelist_ids': [(4, pricelist.id) for pricelist in self.all_pricelists],
            'payment_method_ids': [
                (4, self.credit_payment_method.id),
                (4, self.bank_payment_method.id),
                (4, self.bank_payment_method_split.id),
                (4, self.cash_payment_method.id)],
            'fiscal_position_ids': [
                (0, 0, {
                    'name': "FP-POS-2M",
                    'tax_ids': [
                        (0, 0, {
                            'tax_src_id': self.source_tax.id,
                            'tax_dest_id': self.source_tax.id}),
                        (0, 0, {
                            'tax_src_id': self.source_tax.id,
                            'tax_dest_id': self.destination_tax.id}),
                        (0, 0, {
                            'tax_src_id': self.tax_15_include.id,
                            'tax_dest_id': False})
                    ]
                })
            ],
        })

    def setup_test_users(self):
        self.pos_user = self.env['res.users'].create({
            'name': 'A simple PoS man!',
            'login': 'pos_user',
            'password': 'pos_user',
            'group_ids': [
                (4, self.env.ref('base.group_user').id),
                (4, self.env.ref('point_of_sale.group_pos_user').id),
                (4, self.env.ref('stock.group_stock_user').id),
            ],
            'tz': 'America/New_York',
        })
        self.pos_admin = self.env['res.users'].create({
            'name': 'A powerful PoS man!',
            'login': 'pos_admin',
            'password': 'pos_admin',
            'group_ids': [
                (4, self.env.ref('point_of_sale.group_pos_manager').id),
            ],
            'tz': 'America/New_York',
        })
        self.pos_user.partner_id.email = 'pos_user@test.com'
        self.pos_admin.partner_id.email = 'pos_admin@test.com'

    def setup_test_company(self):
        self.first_company = self.company_data['company']
        self.first_company.write({
            'name': 'Point of Sale company',
            'point_of_sale_update_stock_quantities': 'real',
        })

    def setup_test_pricelists(self):
        self.excluded_pricelist = self.env['product.pricelist'].create({
            'name': 'Not loaded'
        })
        self.public_pricelist = self.env['product.pricelist'].create({
            'name': 'Public Pricelist',
        })
        self.fixed_pricelist = self.env['product.pricelist'].create({
            'name': 'Fixed',
            'item_ids': [(0, 0, {
                'compute_price': 'fixed',
                'fixed_price': 1,
            }), (0, 0, {
                'compute_price': 'fixed',
                'fixed_price': 2,
                'applied_on': '0_product_variant',
                'product_id': self.product_pricelist_one.product_variant_id.id,
            }), (0, 0, {
                'compute_price': 'fixed',
                'fixed_price': 13.95,  # test for issues like in 7f260ab517ebde634fc274e928eb062463f0d88f
                'applied_on': '0_product_variant',
                'product_id': self.product_pricelist_two.product_variant_id.id,
            })],
        })
        self.percent_pricelist = self.env['product.pricelist'].create({
            'name': 'Percentage',
            'item_ids': [(0, 0, {
                'compute_price': 'percentage',
                'percent_price': 100,
                'applied_on': '0_product_variant',
                'product_id': self.product_pricelist_one.product_variant_id.id,
            }), (0, 0, {
                'compute_price': 'percentage',
                'percent_price': 99,
                'applied_on': '0_product_variant',
                'product_id': self.product_pricelist_two.product_variant_id.id,
            }), (0, 0, {
                'compute_price': 'percentage',
                'percent_price': 0,
                'applied_on': '0_product_variant',
                'product_id': self.product_pricelist_three.product_variant_id.id,
            })],
        })
        self.formula_pricelist = self.env['product.pricelist'].create({
            'name': 'Formula',
            'item_ids': [(0, 0, {
                'compute_price': 'formula',
                'price_discount': 6,
                'price_surcharge': 5,
                'applied_on': '0_product_variant',
                'product_id': self.product_pricelist_one.product_variant_id.id,
            }), (0, 0, {
                # .99 prices
                'compute_price': 'formula',
                'price_surcharge': -0.01,
                'price_round': 1,
                'applied_on': '0_product_variant',
                'product_id': self.product_pricelist_two.product_variant_id.id,
            }), (0, 0, {
                'compute_price': 'formula',
                'price_min_margin': 10,
                'price_max_margin': 100,
                'applied_on': '0_product_variant',
                'product_id': self.product_pricelist_three.product_variant_id.id,
            }), (0, 0, {
                'compute_price': 'formula',
                'price_surcharge': 10,
                'price_max_margin': 5,
                'applied_on': '0_product_variant',
                'product_id': self.product_pricelist_four.product_variant_id.id,
            }), (0, 0, {
                'compute_price': 'formula',
                'price_discount': -100,
                'price_min_margin': 5,
                'price_max_margin': 20,
                'applied_on': '0_product_variant',
                'product_id': self.product_pricelist_five.product_variant_id.id,
            })],
        })
        self.fixed_pricelist_min_quantity = self.env['product.pricelist'].create({
            'name': 'min_quantity ordering',
            'item_ids': [(0, 0, {
                'compute_price': 'fixed',
                'fixed_price': 1,
                'applied_on': '0_product_variant',
                'min_quantity': 2,
                'product_id': self.product_pricelist_one.product_variant_id.id,
            }), (0, 0, {
                'compute_price': 'fixed',
                'fixed_price': 2,
                'applied_on': '0_product_variant',
                'min_quantity': 1,
                'product_id': self.product_pricelist_one.product_variant_id.id,
            })],
        })
        self.pricelist_product_template = self.env['product.pricelist'].create({
            'name': 'Product template',
            'item_ids': [(0, 0, {
                'compute_price': 'fixed',
                'fixed_price': 1,
                'applied_on': '1_product',
                'product_tmpl_id': self.product_pricelist_one.id,
            }), (0, 0, {
                'compute_price': 'fixed',
                'fixed_price': 2,
            })],
        })
        self.pricelist_no_category = self.env['product.pricelist'].create({
            'name': 'Category vs no category',
            'item_ids': [(0, 0, {
                'compute_price': 'fixed',
                'fixed_price': 1,
                'applied_on': '2_product_category',
                'categ_id': self.product_category.id,
            }), (0, 0, {
                'compute_price': 'fixed',
                'fixed_price': 2,
            })],
        })
        self.pricelist_category = self.env['product.pricelist'].create({
            'name': 'Category',
            'item_ids': [(0, 0, {
                'compute_price': 'fixed',
                'fixed_price': 2,
                'applied_on': '2_product_category',
                'categ_id': self.env.ref('product.product_category_services').id,
            }), (0, 0, {
                'compute_price': 'fixed',
                'fixed_price': 1,
                'applied_on': '2_product_category',
                'categ_id': self.product_category.id,
            })],
        })

        today = date.today()
        one_week_ago = today - timedelta(weeks=1)
        two_weeks_ago = today - timedelta(weeks=2)
        one_week_from_now = today + timedelta(weeks=1)
        two_weeks_from_now = today + timedelta(weeks=2)
        self.pricelist_date = self.env['product.pricelist'].create({
            'name': 'Dates',
            'item_ids': [(0, 0, {
                'compute_price': 'fixed',
                'fixed_price': 1,
                'date_start': two_weeks_ago.strftime(DEFAULT_SERVER_DATE_FORMAT),
                'date_end': one_week_ago.strftime(DEFAULT_SERVER_DATE_FORMAT),
            }), (0, 0, {
                'compute_price': 'fixed',
                'fixed_price': 2,
                'date_start': today.strftime(DEFAULT_SERVER_DATE_FORMAT),
                'date_end': one_week_from_now.strftime(DEFAULT_SERVER_DATE_FORMAT),
            }), (0, 0, {
                'compute_price': 'fixed',
                'fixed_price': 3,
                'date_start': one_week_from_now.strftime(DEFAULT_SERVER_DATE_FORMAT),
                'date_end': two_weeks_from_now.strftime(DEFAULT_SERVER_DATE_FORMAT),
            })],
        })
        self.pricelist_cost_base_pricelist = self.env['product.pricelist'].create({
            'name': 'Cost base',
            'item_ids': [(0, 0, {
                'base': 'standard_price',
                'compute_price': 'percentage',
                'percent_price': 55,
            })],
        })
        pricelist_base_pricelist = self.env['product.pricelist'].create({
            'name': 'Pricelist base',
            'item_ids': [(0, 0, {
                'base': 'pricelist',
                'base_pricelist_id': self.pricelist_cost_base_pricelist.id,
                'compute_price': 'percentage',
                'percent_price': 15,
            })],
        })
        self.pricelist_base_2 = self.env['product.pricelist'].create({
            'name': 'Pricelist base 2',
            'item_ids': [(0, 0, {
                'base': 'pricelist',
                'base_pricelist_id': pricelist_base_pricelist.id,
                'compute_price': 'percentage',
                'percent_price': 3,
            })],
        })
        self.pricelist_base_rounding = self.env['product.pricelist'].create({
            'name': 'Pricelist base rounding',
            'item_ids': [(0, 0, {
                'base': 'pricelist',
                'base_pricelist_id': self.fixed_pricelist.id,
                'compute_price': 'percentage',
                'percent_price': 0.01,
            })],
        })

        self.all_pricelists = (self.public_pricelist
            + self.fixed_pricelist
            + self.percent_pricelist
            + self.formula_pricelist
            + self.fixed_pricelist_min_quantity
            + self.pricelist_product_template
            + self.pricelist_no_category
            + self.pricelist_category
            + self.pricelist_date
            + self.pricelist_cost_base_pricelist
            + pricelist_base_pricelist
            + self.pricelist_base_2
            + self.pricelist_base_rounding)

        self.all_pricelists.write(dict(currency_id=self.first_company.currency_id.id))

    def setup_test_payment_methods(self):
        self.cash_payment_method = self.env['pos.payment.method'].create({
            'name': 'Cash',
            'receivable_account_id': self.company_data['default_account_receivable'].id,
            'journal_id': self.cash_journal.id,
            'company_id': self.env.company.id,
        })
        self.bank_payment_method = self.env['pos.payment.method'].create({
            'name': 'Bank',
            'journal_id': self.bank_journal.id,
            'receivable_account_id': self.company_data['default_account_receivable'].id,
            'company_id': self.env.company.id,
        })
        self.bank_payment_method_split = self.bank_payment_method.copy(default={
            'name': 'Split (Bank) PM',
            'split_transactions': True,
        })
        self.credit_payment_method = self.env['pos.payment.method'].create({
            'name': 'Credit',
            'receivable_account_id': self.company_data['default_account_receivable'].id,
            'split_transactions': True,
            'company_id': self.env.company.id,
        })

    def setup_test_partners(self):
        self.partner_one = self.env['res.partner'].create({
            'name': 'Partner One',
            'email': 'partner.full@example.com',
            'street': '77 Santa Barbara Rd',
            'city': 'Pleasant Hill',
            'phone': '9898989899',
            "state_id": self.env.ref("base.state_us_30").id,  # Ohio
            'zip': '94523',
            'barcode': '0421234567890',
            'country_id': self.env.ref('base.us').id,
        })
        self.partner_two = self.env['res.partner'].create({
            'name': 'Partner Two',
        })
        self.partner_three = self.env['res.partner'].create({
            'name': 'Partner Three',
        })
        self.partner_four = self.env['res.partner'].create({
            'name': 'Partner Four',
        })

    def setup_test_taxes(self):
        self.source_tax = self.env['account.tax'].create({'name': "SRC", 'amount': 10})
        self.destination_tax = self.env['account.tax'].create({'name': "DST", 'amount': 5})
        self.tax_10_include = self.env['account.tax'].create({
            'name': 'VAT 10 perc Incl',
            'amount_type': 'percent',
            'amount': 10.0,
            'price_include_override': 'tax_included',
        })
        self.tax_05_include = self.env['account.tax'].create({
            'name': 'VAT 5 perc Incl',
            'amount_type': 'percent',
            'amount': 5.0,
            'price_include_override': 'tax_included',
        })
        self.tax_05_exclude = self.env['account.tax'].create({
            'name': 'VAT 5 perc Excl',
            'amount_type': 'percent',
            'amount': 5.0,
            'price_include_override': 'tax_excluded',
        })
        self.tax_15_include = self.env['account.tax'].create({
            'name': 'Tax 15%',
            'amount': 15,
            'price_include_override': 'tax_included',
            'amount_type': 'percent',
            'type_tax_use': 'sale',
        })
        invoice_rep_lines = (self.tax_10_include | self.tax_05_include).mapped('invoice_repartition_line_ids')
        refund_rep_lines = (self.tax_10_include | self.tax_05_include).mapped('refund_repartition_line_ids')
        (invoice_rep_lines | refund_rep_lines).write({
            'account_id': self.company_data['default_account_tax_sale'].id
        })

    def setup_test_journals(self):
        self.cash_journal = self.env['account.journal'].create({
            'name': 'Cash',
            'type': 'cash',
            'company_id': self.company.id,
            'code': 'CSHO',
            'sequence': 10,
        })
        self.invoice_journal = self.env['account.journal'].create({
            'name': 'Customer Invoice',
            'type': 'sale',
            'company_id': self.company.id,
            'code': 'INVO',
            'sequence': 11,
        })
        self.sale_journal = self.env['account.journal'].create({
            'name':'PoS Sale',
            'type': 'sale',
            'code': 'POSO',
            'company_id': self.company.id,
            'sequence': 12,
        })
        self.bank_journal = self.env['account.journal'].create({
            'name': 'Bank',
            'type': 'bank',
            'company_id': self.company.id,
            'code': 'BNKO',
            'sequence': 13,
        })

    def setup_test_categories(self):
        self.product_category = self.env['product.category'].create({
            'name': 'Services',
            'parent_id': self.env.ref('product.product_category_services').id,
        })
        self.category_things = self.env['pos.category'].create({
            'name': 'Things',
            'sequence': 3,
        })
        self.category_items = self.env['pos.category'].create({
            'name': 'Items',
            'sequence': 2,
        })
        self.category_sub_items = self.env['pos.category'].create({
            'name': 'Sub Items',
            'sequence': 1,
            'parent_id': self.category_items.id,
        })
        self.category_articles = self.env['pos.category'].create({
            'name': 'Articles',
            'sequence': 10,
        })
        self.category_sub_articles = self.env['pos.category'].create({
            'name': 'Sub Articles',
            'sequence': 11,
            'parent_id': self.category_articles.id,
        })
        self.category_configurables = self.env['pos.category'].create({
            'name': 'Configurables',
            'sequence': 4,
        })
        self.category_pricelist = self.env['pos.category'].create({
            'name': 'Pricelist',
            'sequence': 5,
        })

    def setup_test_products(self):
        # Special products
        self.product_tip = self.env.ref('point_of_sale.product_product_tip')
        self.product_tip.write({'active': True})
        self.taxed_product = self.env['product.template'].create({
            'name': 'Taxed Product',
            'available_in_pos': True,
            'list_price': 100,
            'taxes_id': [(6, 0, [self.tax_15_include.id])],
        })

        # One click products
        # replace desk organizer
        self.product_awesome_thing = self.env['product.template'].create({
            'name': 'Awesome Thing',
            'available_in_pos': True,
            'list_price': 5.10,
            'taxes_id': False,
            'weight': 0.01,
            'to_weight': True,
            'pos_categ_ids': [(4, self.category_things.id)],
            'default_code': 'AWESOME',
        })
        self.product_awesome_item = self.env['product.template'].create({
            'name': 'Awesome Item',
            'available_in_pos': True,
            'list_price': 1.98,
            'taxes_id': False,
            'pos_categ_ids': [(4, self.category_items.id)],
            'default_code': 'PROD_AI1',
        })
        self.product_awesome_article = self.env['product.template'].create({
            'name': 'Awesome Article',
            'available_in_pos': True,
            'is_favorite': True,
            'list_price': 2.83,
            'taxes_id': False,
            'pos_categ_ids': [(4, self.category_articles.id)],
            'default_code': 'PROD_AA1',
        })
        self.product_quality_thing = self.env['product.template'].create({
            'name': 'Quality Thing',
            'available_in_pos': True,
            'list_price': 1.00,
            'taxes_id': False,
            'barcode': '2305000000004',
            'pos_categ_ids': [(4, self.category_things.id)],
            'default_code': 'PROD_QT1',
        })
        self.product_quality_item = self.env['product.template'].create({
            'name': 'Quality Item',
            'available_in_pos': True,
            'list_price': 3.19,
            'taxes_id': False,
            'barcode': '0123456789',
            'pos_categ_ids': [(4, self.category_items.id), (4, self.category_sub_items.id)],
            'default_code': 'PROD_QI1',
        })
        self.product_quality_article = self.env['product.template'].create({
            'name': 'Quality Article',
            'available_in_pos': True,
            'list_price': 1.98,
            'taxes_id': False,
            'barcode': '2100005000000',
            'pos_categ_ids': [(4, self.category_articles.id), (4, self.category_sub_articles.id)],
            'default_code': 'PROD_QA1',
        })

        # Product for pricelist testing
        # Old wall_shelf product
        self.product_pricelist_one = self.env['product.template'].create({
            'name': 'Product for pricelist 1',
            'available_in_pos': True,
            'list_price': 1.98,
            'taxes_id': False,
            'pos_categ_ids': [(4, self.category_pricelist.id)],
        })
        # Old small_shelf product
        self.product_pricelist_two = self.env['product.template'].create({
            'name': 'Product for pricelist 2',
            'available_in_pos': True,
            'list_price': 2.83,
            'taxes_id': False,
            'pos_categ_ids': [(4, self.category_pricelist.id)],
        })
        # Old magnetic_board product
        self.product_pricelist_three = self.env['product.template'].create({
            'name': 'Product for pricelist 3',
            'available_in_pos': True,
            'list_price': 1.98,
            'taxes_id': False,
            'pos_categ_ids': [(4, self.category_pricelist.id)],
        })
        # Old monitor_stand product
        self.product_pricelist_four = self.env['product.template'].create({
            'name': 'Product for pricelist 4',
            'available_in_pos': True,
            'list_price': 3.19,
            'taxes_id': False,
            'pos_categ_ids': [(4, self.category_pricelist.id)],
        })
        # Old desk_pad product
        self.product_pricelist_five = self.env['product.template'].create({
            'name': 'Product for pricelist 5',
            'available_in_pos': True,
            'list_price': 1.98,
            'taxes_id': False,
            'pos_categ_ids': [(4, self.category_pricelist.id)],
        })
        # Old letter_tray product
        self.product_pricelist_six = self.env['product.template'].create({
            'name': 'Product for pricelist 6',
            'available_in_pos': True,
            'list_price': 4.80,
            'categ_id': self.env.ref('product.product_category_services').id,
            'taxes_id': [(6, 0, [self.source_tax.id])],
            'pos_categ_ids': [(4, self.category_pricelist.id)],
        })

        # Configurable products
        self.product_configurable = self.env['product.template'].create({
            'name': 'Configurable 1',
            'available_in_pos': True,
            'list_price': 10,
            'taxes_id': False,
            'pos_categ_ids': [(4, self.category_configurables.id)],
        })
        color_attribute = self.env['product.attribute'].create({
            'name': 'Color',
            'display_type': 'color',
            'create_variant': 'always',
        })
        color_attribute_red = self.env['product.attribute.value'].create({
            'name': 'Red',
            'attribute_id': color_attribute.id,
            'html_color': '#ff0000',
        })
        color_attribute_blue = self.env['product.attribute.value'].create({
            'name': 'Blue',
            'attribute_id': color_attribute.id,
            'html_color': '#0000ff',
        })
        color_attribute_line = self.env['product.template.attribute.line'].create({
            'product_tmpl_id': self.product_configurable.id,
            'attribute_id': color_attribute.id,
            'value_ids': [(6, 0, [color_attribute_red.id, color_attribute_blue.id])]
        })
        color_attribute_line.product_template_value_ids[0].price_extra = 1
        select_attribute = self.env['product.attribute'].create({
            'name': 'Select',
            'display_type': 'select',
            'create_variant': 'no_variant',
        })
        select_attribute_one = self.env['product.attribute.value'].create({
            'name': 'One',
            'attribute_id': select_attribute.id,
        })
        select_attribute_two = self.env['product.attribute.value'].create({
            'name': 'Two',
            'attribute_id': select_attribute.id,
        })
        self.env['product.template.attribute.line'].create({
            'product_tmpl_id': self.product_configurable.id,
            'attribute_id': select_attribute.id,
            'value_ids': [(6, 0, [select_attribute_one.id, select_attribute_two.id])]
        })
        radio_attribute = self.env['product.attribute'].create({
            'name': 'Radio',
            'display_type': 'radio',
            'create_variant': 'no_variant',
        })
        radio_attribute_one = self.env['product.attribute.value'].create({
            'name': 'One',
            'attribute_id': radio_attribute.id,
        })
        radio_attribute_two = self.env['product.attribute.value'].create({
            'name': 'Two',
            'attribute_id': radio_attribute.id,
        })
        radio_attribute_custom = self.env['product.attribute.value'].create({
            'name': 'Custom',
            'attribute_id': radio_attribute.id,
            'is_custom': True,
        })
        self.env['product.template.attribute.line'].create({
            'product_tmpl_id': self.product_configurable.id,
            'attribute_id': radio_attribute.id,
            'value_ids': [(6, 0, [radio_attribute_one.id, radio_attribute_two.id, radio_attribute_custom.id])]
        })
        color_attribute_line.product_template_value_ids[1].is_custom = True
        self.product_configurable_multi = self.env['product.template'].create({
            'name': 'Configurable Multi',
            'available_in_pos': True,
            'list_price': 10,
            'taxes_id': False,
            'pos_categ_ids': [(4, self.category_configurables.id)],
        })
        multi_attributes = self.env['product.attribute'].create({
            'name': 'Multi',
            'display_type': 'multi',
            'create_variant': 'no_variant',
        })
        multi_attributes_1 = self.env['product.attribute.value'].create({
            'name': 'Multi 1',
            'attribute_id': multi_attributes.id,
        })
        multi_attributes_2 = self.env['product.attribute.value'].create({
            'name': 'Multi 2',
            'attribute_id': multi_attributes.id,
        })
        multi_attributes_3 = self.env['product.attribute.value'].create({
            'name': 'Multi 3',
            'attribute_id': multi_attributes.id,
        })
        self.env['product.template.attribute.line'].create({
            'product_tmpl_id': self.product_configurable_multi.id,
            'attribute_id': multi_attributes.id,
            'value_ids': [(6, 0, [multi_attributes_1.id, multi_attributes_2.id, multi_attributes_3.id])]
        })
        self.product_configurable_dynamic = self.env['product.template'].create({
            'name': 'Configurable Dynamic',
            'available_in_pos': True,
            'uom_id': self.env.ref('uom.product_uom_unit').id,
            'pos_categ_ids': [(4, self.category_configurables.id)],
        })
        dynamic_attribute = self.env['product.attribute'].create({
            'name': 'Dynamic Attribute',
            'create_variant': 'dynamic',
        })
        dynamic_attribute_1 = self.env['product.attribute.value'].create({
            'name': 'Dynamic 1',
            'attribute_id': dynamic_attribute.id,
        })
        dynamic_attribute_2 = self.env['product.attribute.value'].create({
            'name': 'Dynamic 2',
            'default_extra_price': 10,
            'attribute_id': dynamic_attribute.id,
        })
        self.env['product.template.attribute.line'].create({
            'product_tmpl_id': self.product_configurable_dynamic.id,
            'attribute_id': dynamic_attribute.id,
            'value_ids': [(6, 0, [dynamic_attribute_1.id, dynamic_attribute_2.id])]
        })
