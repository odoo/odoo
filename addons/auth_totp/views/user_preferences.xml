<odoo>
    <record id="res_users_view_search" model="ir.ui.view">
        <field name="name">res.users.view.search.inherit.auth.totp</field>
        <field name="model">res.users</field>
        <field name="inherit_id" ref="base.view_users_search" />
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <separator/>
                <filter name="totp_enabled" string="Two-factor authentication Enabled" domain="[('totp_secret','!=',False)]"/>
                <separator/>
                <filter name="totp_disabled" string="Two-factor authentication Disabled" domain="[('totp_secret','=',False)]"/>
            </xpath>
        </field>
    </record>

    <record model="ir.ui.view" id="view_totp_form">
        <field name="name">user form: add totp status</field>
        <field name="model">res.users</field>
        <field name="inherit_id" ref="base.view_users_form"/>
        <field name="arch" type="xml">
            <xpath expr="//page[@name='preferences']" position="after">
                <page string="Account Security" name="security" attrs="{'invisible': [('id', '=', False)]}">
                    <field name="totp_enabled" invisible="1"/>
                    <!-- For own user, allow to activate the two-factor Authentication -->
                    <group>
                        <div>
                            <div class="o_horizontal_separator d-flex align-items-center mt-0">Two-factor Authentication
                                <div attrs="{'invisible': [('totp_enabled', '!=', False)]}">
                                    <button attrs="{'invisible': &quot;[('id', '=', uid)]&quot;}" name="totp_enable_wizard"
                                            disabled="1" type="object" class="fa fa-toggle-off o_auth_2fa_btn disabled" aria-label="Enable 2FA"></button>
                                    <button attrs="{'invisible': &quot;[('id', '!=', uid)]&quot;}" name="totp_enable_wizard"
                                        type="object" class="fa fa-toggle-off o_auth_2fa_btn disabled" aria-label="Enable 2FA"></button>
                                    <button groups="base.group_erp_manager" attrs="{'invisible': &quot;[('id', '=', uid)]&quot;}"
                                        name="totp_invite" string="Invite to use 2FA" type="object" class="btn btn-primary"></button>
                                </div>
                                <button attrs="{'invisible': [('totp_enabled', '=', False)]}" name="totp_disable" type="object"
                                        class="fa fa-toggle-on o_auth_2fa_btn text-primary enabled" aria-label="Disable 2FA"></button>
                            </div>
                            <span attrs="{'invisible': [('totp_enabled', '!=', False)]}" class="text-muted">
                                Two-factor Authentication ("2FA") is a system of double authentication. The first one is done with your password and the second one with a code you get from a dedicated mobile app. Popular ones include Authy, Google Authenticator or the Microsoft Authenticator.
                                <a href="https://www.odoo.com/documentation/15.0/applications/general/auth/2fa.html"
                                   title="Learn More" target="_blank">Learn More</a>
                            </span>
                            <span attrs="{'invisible': [('totp_enabled', '=', False)]}" class="text-muted">Your account is protected!</span>
                        </div>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <record model="ir.actions.server" id="action_disable_totp">
        <field name="name">Disable two-factor authentication</field>
        <field name="model_id" ref="base.model_res_users"/>
        <field name="binding_model_id" ref="base.model_res_users"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
            action = records.action_totp_disable()
        </field>
        <field name="groups_id" eval="[(4, ref('base.group_erp_manager'))]"/>
    </record>

    <record model="ir.ui.view" id="view_totp_wizard">
        <field name="name">auth_totp wizard</field>
        <field name="model">auth_totp.wizard</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <div class="o_auth_totp_enable_2FA container">
                        <div class="mb-3 w-100">
                            <h3 class="font-weight-bold">Authenticator App Setup</h3>
                            <ul>
                                <div class="d-md-none d-block">
                                    <li>
                                        <field class="text-wrap" name="url" widget="url" options="{'website_path': True}"
                                        text="Click on this link to open your authenticator app"/></li>
                                </div>
                                <li>
                                    <div class="d-flex align-items-center flex-wrap">
                                        <span class="d-md-none d-block">Or install an authenticator app</span>
                                        <span class="d-none d-md-block">Install an authenticator app on your mobile device</span>
                                        <div class="d-block d-md-none">
                                            <a href="https://play.google.com/store/search?q=authenticator&amp;c=apps" class="mx-2" target="blank">
                                                <img alt="On Google Play" style="width: 24px;" src="/base_setup/static/src/img/logo_google_play.png"/>
                                            </a>
                                            <a href="http://appstore.com/2fa" class="mx-2" target="blank">
                                                <img alt="On Apple Store" style="width: 24px;" src="/base_setup/static/src/img/logo_apple_store.png"/>
                                            </a>
                                        </div>
                                    </div>
                                </li>

                                <span class="text-muted">Popular ones include Authy, Google Authenticator or the Microsoft Authenticator.</span>
                                <li>Look for an "Add an account" button</li>
                                <li>
                                    <span class="d-none d-md-block">When requested to do so, scan the barcode below</span>
                                    <span class="d-block d-md-none">When requested to do so, copy the key below</span>
                                </li>
                            </ul>

                            <!-- Desktop version -->
                            <div class="text-center d-none d-md-block">
                                <field name="qrcode" readonly="True" widget="image"/>

                                <h3 class="font-weight-bold"><a data-toggle="collapse"
                                   href="#collapseTotpSecret" role="button" aria-expanded="false"
                                   aria-controls="collapseTotpSecret">Cannot scan it?</a></h3>
                                <div class="collapse" id="collapseTotpSecret">
                                  <field name="secret" widget="CopyClipboardChar" readonly="1" class="mb-3 pl-3"/>
                                </div>
                            </div>

                            <!-- Mobile Version -->
                            <div class="text-center d-block d-md-none">
                                <field name="secret" widget="CopyClipboardChar" readonly="1" class="mb-3 pl-3"/>
                            </div>

                            <h3 class="font-weight-bold">Enter your six-digit code below</h3>
                            <div class="mt-2">
                                <label for="code" class="px-0">Verification Code</label>
                                <div class="d-flex align-items-center">
                                    <field required="True" name="code" autocomplete="one-time-code" class="px-0 mr-2" placeholder="e.g. 123456"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </sheet>
                <footer>
                    <button type="object" name="enable" class="btn btn-primary"
                            string="Activate" data-hotkey="q"/>
                    <button string="Cancel" special="cancel" data-hotkey="z"/>
                </footer>
            </form>
        </field>
    </record>

    <record model="ir.ui.view" id="view_totp_field">
        <field name="name">users preference: totp</field>
        <field name="model">res.users</field>
        <field name="inherit_id" ref="base.view_users_form_simple_modif"/>
        <field name="arch" type="xml">
            <group name="auth" position="after">
                <field name="totp_enabled" invisible="1"/>
                <group>
                    <div>
                        <div class="o_horizontal_separator mt-0">Two-factor Authentication
                            <button attrs="{'invisible': [('totp_enabled', '!=', False)]}" name="totp_enable_wizard"
                               type="object" class="fa fa-toggle-off o_auth_2fa_btn mb-1" aria-label="Enable 2FA"/>
                            <button attrs="{'invisible': [('totp_enabled', '=', False)]}" name="totp_disable"
                               type="object" class="fa fa-toggle-on o_auth_2fa_btn text-primary" aria-label="Disable 2FA"/>
                        </div>
                        <span attrs="{'invisible': [('totp_enabled', '!=', False)]}" class="text-muted">
                            Two-factor Authentication ("2FA") is a system of double authentication. The first one is done with your password and the second one with a code you get from a dedicated mobile app. Popular ones include Authy, Google Authenticator or the Microsoft Authenticator.
                            <a href="https://www.odoo.com/documentation/15.0/applications/general/auth/2fa.html"
                               title="Learn More" target="_blank">Learn More</a>
                        </span>
                        <span attrs="{'invisible': [('totp_enabled', '=', False)]}" class="text-muted">Your account is protected!</span>
                    </div>
                </group>
            </group>
        </field>
    </record>

    <!-- Invite to user 2FA -->
    <record model="ir.actions.server" id="action_invite_totp">
        <field name="name">Invite to use two-factor authentication</field>
        <field name="model_id" ref="base.model_res_users"/>
        <field name="binding_model_id" ref="base.model_res_users"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
            action = records.action_totp_invite()
        </field>
        <field name="groups_id" eval="[(4, ref('base.group_erp_manager'))]"/>
    </record>

    <record model="ir.ui.view" id="res_users_view_form_security">
        <field name="name">users preference: Account Security</field>
        <field name="model">res.users</field>
        <field name="inherit_id" ref="base.view_users_form_simple_modif"/>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <form position="attributes">
                <attribute name='create'>0</attribute>
                <attribute name='edit'>0</attribute>
                <attribute name='delete'>0</attribute>
            </form>
            <h1 position="replace"/>
            <xpath expr="//field[@name='image_1920']" position="replace"/>
            <notebook position="replace">
                <header>
                </header>
                <sheet>$0</sheet>
            </notebook>
            <notebook position="before">
                <field name="image_1920" widget="image" class="oe_avatar" options="{'zoom': true, 'preview_image':'image_128'}"/>
                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="Name" required="True" readonly="context.get('from_my_profile', False)"/>
                        </h1>
                    </div>
            </notebook>
            <page name="preferences_page" position="replace"></page>
            <footer position="replace"/>
        </field>
    </record>

    <record model="ir.actions.server" id="action_activate_two_factor_authentication">
        <field name="name">Open two-factor authentication configuration</field>
        <field name="model_id" ref="base.model_res_users"/>
        <field name="state">code</field>
        <field name="code">
user = env.user
action = user.action_open_my_account_settings()
        </field>
        <field name="groups_id" eval="[(4, ref('base.group_user'))]"/>
    </record>

</odoo>
