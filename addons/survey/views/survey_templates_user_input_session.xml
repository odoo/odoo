<?xml version="1.0" encoding="utf-8"?>
<odoo>
<data>
    <template id="user_input_session" name="Survey User Input Session" inherit_id="web.frontend_layout" primary="True">
        <xpath expr="//head" position="before">
            <!--TODO DBE Fix me : If one day, there is a survey_livechat bridge module, put this in that module-->
            <t t-set="no_livechat" t-value="True"/>
        </xpath>
        <xpath expr="//div[@id='wrapwrap']" position="attributes">
            <attribute name="t-att-style"
                       add="(('background-image: url(' + survey.session_question_id.background_image_url + ');')
                             if survey.session_question_id and survey.session_question_id.background_image_url
                             else ('background-image: url(' + survey.background_image_url + ');')
                             if survey.background_image_url
                             else 'background-image: url(\'/survey/static/src/img/survey_background_sample.svg\')')"/>
            <attribute name="t-att-class" add="'o_survey_background'"/>
        </xpath>
        <xpath expr="//head/t[@t-call-assets][last()]" position="after">
            <t t-call-assets="survey.survey_assets" lazy_load="True"/>
            <t t-call-assets="survey.survey_user_input_session_assets" lazy_load="True"/>
        </xpath>
        <xpath expr="//header" position="before">
            <t t-set="no_header" t-value="True"/>
            <t t-set="no_footer" t-value="True"/>
        </xpath>
        <xpath expr="//header" position="after">
            <div id="wrap" class="oe_structure oe_empty"/>
        </xpath>
    </template>

    <template id="user_input_session_open" name="Survey: Open Session">
        <t t-call="survey.user_input_session">
            <div class="o_survey_session_open o_survey_session_manage position-absolute bottom-0 start-0 end-0 d-flex flex-column justify-content-between gap-md-4 mb-md-3 mx-md-4 fs-3 text-white"
                t-att-data-survey-access-token="survey.access_token"
                t-att-data-survey-id="survey.id"
                t-att-data-is-start-screen="True">

                <div class="o_survey_session_open_header d-flex flex-column flex-md-row flex-grow-1 flex-md-grow-0 justify-content-between gap-4 p-5 rounded-3 bg-black-25">
                    <div class="o_survey_session_open_title flex-basis-50">
                        <h1 t-field="survey.title"/>
                        <div class="o_survey_session_open_description overflow-auto">
                            <p t-field="survey.description"/>
                        </div>
                    </div>
                    <div class="d-flex flex-column flex-lg-row gap-4">
                        <div class="o_survey_session_open_counter d-flex flex-column justify-content-center p-4 rounded-3 bg-black-25 text-center">
                            <span class="o_survey_session_attendees_count" t-out="survey.session_answer_count"/>
                            <p>Waiting for attendees...</p>
                        </div>
                        <div class="o_survey_session_qrcode align-self-center ratio ratio-1x1 rounded-3 order-first order-lg-last">
                            <!-- the value 725 makes the qrcode renders nicely for text from 18 to 53 characters. -->
                            <img t-att-src="'/report/barcode/QR/%s?width=725&amp;height=725' % quote_plus(survey.session_link)"/>
                        </div>
                    </div>
                </div>

                <div class="o_survey_session_open_link d-flex flex-column flex-md-row align-items-center gap-3 gap-md-0 justify-content-between px-5 py-4 rounded-3 bg-black">
                    <div class="fs-5 o_survey_session_copy">
                        <span class="text-info o_survey_session_copy_url" t-out="survey.session_link"/>
                        <i class="fa fa-copy"/>
                    </div>
                    <a role="button" class="o_survey_session_navigation_next btn btn-lg btn-primary w-100 w-md-auto">
                        <span class="o_survey_session_navigation_next_label">Start</span>
                        <i class="oi oi-chevron-right"/>
                    </a>
                </div>
            </div>
        </t>
    </template>

    <template id="user_input_session_manage" name="Survey: Manage Session">
        <t t-call="survey.user_input_session">
            <t t-call="survey.user_input_session_manage_content" />
        </t>
    </template>

    <template id="user_input_session_manage_content" name="Survey User Input Session Manage">
        <t t-set="question" t-value="survey.session_question_id" />
        <t t-set="is_scored_question" t-value="any(answer.answer_score for answer in question.suggested_answer_ids)" />
        <t t-set="show_bar_chart" t-value="question.question_type in ['simple_choice', 'multiple_choice', 'scale']" />
        <t t-set="show_text_answers" t-value="question.question_type in ['char_box', 'date', 'datetime'] and not question.save_as_email and not question.save_as_nickname" />
        <t t-set="bar_reserved_with_rem" t-value="25"/> <!-- See setup of SurveySessionLeaderboard -->
        <div class="wrap min-vh-100 align-items-center justify-content-center d-flex flex-column o_survey_session_manage invisible"
            t-att-style="'display: none;' if is_rpc_call else ''"
            t-att-data-is-rpc-call="is_rpc_call"
            t-att-data-survey-id="survey.id"
            t-att-data-survey-has-conditional-questions="survey.has_conditional_questions"
            t-att-data-attendees-count="survey.session_answer_count"
            t-att-data-survey-access-token="survey.access_token"
            t-att-data-timer="survey.session_question_start_time.isoformat()"
            t-att-data-time-limit-minutes="question.time_limit / 60"
            t-att-data-is-scored-question="is_scored_question"
            t-att-data-session-show-leaderboard="survey.session_show_leaderboard"
            t-att-data-question-statistics="question_statistics_graph"
            t-att-data-question-type="question.question_type"
            t-att-data-has-correct-answers="any(answer.is_correct for answer in question.suggested_answer_ids)"
            t-att-data-answers-validity="answers_validity"
            t-att-data-is-first-question="is_first_question"
            t-att-data-is-last-question="is_last_question"
            t-att-data-all-participants-shown="all_participants_shown"
            t-att-data-survey-last-triggering-answers="survey_last_triggering_answers"
            t-att-data-current-screen="'question' if is_scored_question else 'userInputs'"
            t-att-data-show-bar-chart="show_bar_chart"
            t-att-data-show-text-answers="show_text_answers"
            t-att-data-refresh-background="any(page.background_image for page in survey.page_ids)"
            t-att-data-is-session-closed="is_session_closed">
            <div t-if="not is_session_closed" class="o_survey_question_header flex-wrap px-3 w-100 d-flex justify-content-between align-items-center position-absolute">
                <h3>
                    <span>To join: <span class="text-info o_survey_session_copy o_survey_session_copy_url" t-out="survey.session_link"/></span>
                    <input class="d-none" type="text" t-att-value="survey.session_link" />
                </h3>
                <h1 t-if="question.is_time_limited" class="o_survey_timer_container">
                    <span class="o_survey_timer d-inline-block"/>
                </h1>
                <div class="text-end d-flex flex-column justify-content-center">
                    <div t-if="show_bar_chart or show_text_answers">
                        <div class="progress" title="Attendees are answering the question...">
                            <div class="progress-bar o_survey_session_progress_small fw-bold"
                                 style="overflow: visible" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Progress bar">
                                <span class="px-2">0 / <t t-out="survey.session_answer_count" /></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="px-sm-4 pb-3 pt96 d-flex flex-column o_survey_session_manage_container">
                <div class="o_survey_session_description_done d-none o_container_small">
                    <h1 class="fs-2">Thank you!</h1>
                    <div t-field="survey.description_done"/>
                </div>
                <a role="button"
                    class="o_survey_session_navigation o_survey_session_navigation_next p-2 bg-light text-nowrap">
                    <span class="o_survey_session_navigation_next_label me-2 fw-bold d-none d-md-inline"/>
                    <i class="fw-bold oi oi-chevron-right"/>
                </a>
                <a role="button"
                    class="fw-bold oi oi-chevron-left o_survey_session_navigation o_survey_session_navigation_previous p-3" />
                <div class="o_survey_session_results flex-column flex-grow-1 mx-5">
                    <div class="row">
                        <div class="col-lg-12"><h1 t-out="question.title"></h1></div>
                    </div>
                    <div t-attf-class="d-flex flex-column flex-grow-1 #{'justify-content-center' if not show_text_answers else ''} #{'align-items-center' if show_bar_chart else ''}">
                        <!-- Has to stay in 'style' attribute for Chartjs -->
                        <div t-if="show_bar_chart" class="p-2 o_survey_session_chart"
                            style="position: relative; width: 75vw; height: 70vh;">
                            <!-- canvas element for drawing bar chart -->
                            <canvas />
                        </div>
                        <div t-elif="show_text_answers" class="p-2 pt-4 o_survey_session_text_answers_container">
                        </div>
                        <div t-elif="question.is_page and not is_html_empty(question.description)" class="mb-6 o_survey_manage_fontsize_14" t-field="question.description" />
                        <div t-else="" class="mb-6">
                            <h2 class="fw-normal mb-3">
                                <span>Waiting for attendees...</span>
                                <span>
                                    <span class="o_survey_session_answer_count">0</span>
                                     /
                                    <span t-out="survey.session_answer_count" />
                                </span>
                            </h2>
                            <div class="progress">
                                <div class="progress-bar fw-bold" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Progress bar"></div>
                            </div>
                            <fieldset disabled="disabled" class="mt-5" t-if="question.question_type == 'matrix'">
                                <t t-call="survey.question_container"
                                    hide_question_title="True"
                                    answer="env['survey.user_input']"
                                    survey_form_readonly="True"/>
                            </fieldset>
                        </div>
                    </div>
                </div>
                <!-- BAR_RESERVED_WIDTH_REM + 15rem (where BAR_RESERVED_WIDTH_REM is the place for the score, nickname, ...) -->
                <div class="o_survey_session_leaderboard w-100 flex-column flex-grow-1 min-vw-75 d-none"
                    t-attf-style="max-height: 80vh; min-width: max(50vw, #{bar_reserved_with_rem + 15}rem)">
                    <!--Set question to false to avoid background miss match when no question are displayed.-->
                    <t t-set="question" t-value="False"/>
                    <div class="d-flex flex-wrap">
                        <h1 class="o_survey_session_leaderboard_title flex-grow-1 me-4 ms-1">
                            <span t-if="is_last_question and all_participants_shown">Final Scoreboard</span>
                            <span t-elif="is_last_question">Final Leaderboard</span>
                            <span t-elif="all_participants_shown">Scoreboard</span>
                            <span t-else="">Leaderboard</span>
                        </h1>
                        <div t-att-class="'o_survey_leaderboard_buttons fw-bold %s' % 'd-none' if not is_last_question else 'ms-2'">
                            <a href="#" role="button" class="o_survey_session_close btn btn-primary mt-1"><i class="fa fa-close"/> Close</a>
                            <a href="#" role="button" class="o_survey_session_close btn btn-primary mt-1" t-att-data-show-results="True"><i class="fa fa-bar-chart"/> Results</a>
                        </div>
                    </div>
                    <div class="justify-content-center d-flex flex-column flex-grow-1 mt-5 mb-5 pb-5 o_survey_session_leaderboard_container"/>
                </div>
            </div>
        </div>
    </template>

    <template id="user_input_session_leaderboard" name="Survey User Input Leaderboard">
        <t t-set="bar_reserved_with_rem" t-value="25"/> <!-- See setup of SurveySessionLeaderboard -->
        <div t-if="leaderboard" class="position-relative mb-5 o_survey_leaderboard_scores" t-attf-style="height: calc(3.8rem * #{len(leaderboard)});">
            <t t-set="max_updated_score" t-value="max(score.get('updated_score', score.get('scoring_total', 1)) for score in leaderboard) or 1" />
            <t t-foreach="leaderboard" t-as="score">
                <t t-set="current_score" t-value="score.get('scoring_total', 0)"/>
                <t t-set="question_score" t-value="score.get('question_score', 0)"/>
                <t t-set="min_current_score" t-value="score.get('min_current_score', 0)"/>
                <t t-set="max_question_score" t-value="score.get('max_question_score', 1)"/>
                <div class="o_survey_session_leaderboard_item ms-2 d-flex position-absolute"
                    t-attf-style="top: calc(#{score_index} * 3.8rem);"
                    t-att-data-current-position="str(score_index)"
                    t-att-data-new-position="str(score.get('leaderboard_position', score_index))"
                    t-att-data-question-score="str(round(question_score))"
                    t-att-data-current-score="str(current_score)"
                    t-att-data-updated-score="str(round(score.get('updated_score', 0)))"
                    t-att-data-max-question-score="str(round(max_question_score))">
                    <i class="o_survey_session_leaderboard_caret fa mt-1"/>
                    <div class="d-inline-block fw-bold align-top position-relative">
                        <div class="d-inline-block me-2 o_survey_session_leaderboard_position">
                            <t t-out="str(score_index + 1)"/>.
                        </div>
                        <div class="o_survey_session_leaderboard_name position-absolute end-0 fw-normal">
                            <span t-if="score.get('nickname')" t-out="score['nickname']"/>
                            <span t-else="">Anonymous</span>
                        </div>
                    </div>
                    <t t-set="width_ratio" t-value="round((current_score - min_current_score) / (max_updated_score - min_current_score), 3)"/>
                    <div class="o_survey_session_leaderboard_bar_landmark ms-2"/>
                    <div class="o_survey_session_leaderboard_bar align-top d-inline-block"
                        t-attf-style="width: calc(calc(100% - #{bar_reserved_with_rem}rem) * #{width_ratio})">
                    </div>
                    <div class="o_survey_session_leaderboard_bar_question me-2 align-top d-inline-block text-end fw-bold position-relative"
                        style="width: 0;"
                        t-att-data-width-ratio="str(round(question_score / (max_updated_score - min_current_score), 3))"
                        t-att-data-max-question-score="str(max_question_score)"
                        t-att-data-question-score="str(question_score)">
                    </div>
                    <div class="o_survey_session_leaderboard_score d-inline-block"
                        t-out="'%.0f' % score['scoring_total']"/>
                    <div class="o_survey_session_leaderboard_bar_question_score text-nowrap"></div>
                </div>
            </t>
        </div>
    </template>
</data>
</odoo>
