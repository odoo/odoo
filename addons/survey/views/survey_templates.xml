<?xml version="1.0" encoding="utf-8"?>
<odoo>
<data>
    <!-- Main survey layout -->
    <template id="survey.layout" name="Survey Layout" inherit_id="web.frontend_layout" primary="True">
        <xpath expr="//head" position="before">
            <!--TODO DBE Fix me : If one day, there is a survey_livechat bridge module, put this in that module-->
            <t t-set="no_livechat" t-value="True"/>
        </xpath>
        <xpath expr="//div[@id='wrapwrap']" position="attributes">
            <attribute name="t-att-style"
                       add="(('background-image: url(' + question.background_image_url + ');')
                             if question and question.background_image_url
                             else ('background-image: url(' + page.background_image_url + ');')
                             if page and page.background_image_url
                             else ('background-image: url(' + survey.background_image_url + ');')
                             if survey and survey.background_image_url and not survey_data
                             else '')"/>
            <attribute name="t-att-class"
                       add="(('o_survey_background o_survey_background_shadow')
                             if (question and question.background_image_url)
                             or (page and page.background_image_url)
                             or (survey and survey.background_image_url)
                             else 'o_survey_background')"
                       separator=" "/>
        </xpath>
        <xpath expr="//head/t[@t-call-assets][last()]" position="after">
            <t t-call-assets="survey.survey_assets" lazy_load="True"/>
        </xpath>
        <xpath expr="//header" position="before">
            <t t-set="no_header" t-value="True"/>
            <t t-set="no_footer" t-value="True"/>
        </xpath>
        <xpath expr="//header" position="after">
            <div id="wrap" class="oe_structure oe_empty"/>
        </xpath>
    </template>

    <!-- Main survey template -->
    <template id="survey_page_fill" name="Survey: main page (take survey)">
        <t t-call="survey.layout">
            <t t-if="answer.test_entry" t-call="survey.survey_button_form_view" />
            <div class="wrap o_survey_wrap d-flex flex-column justify-items-center align-items-center h-100 mx-3 mx-md-auto pb-5 pt-md-5">
                <div class="container o_survey_form mb-5 mb-md-0 rounded p-0">
                    <div class="row">
                        <div class="col-12 col-lg-8 offset-lg-2">
                            <t t-call="survey.survey_fill_header"/>
                            <div class="o_survey_form_body d-flex flex-column">
                                <t t-call="survey.survey_fill_form"/>
                            </div>
                            <t t-call="survey.survey_toolbar"/>
                            <small class="o_survey_brand_message d-none d-md-block position-fixed start-0 bottom-0 mb-3 ms-3 border rounded px-3 py-2 bg-body text-muted shadow-sm">
                                <t t-call="web.brand_promotion_message" _message.f="" _utm_medium.f="survey"/>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <template id="survey_fill_header" name="Survey: main page header">
        <div t-attf-class="d-flex flex-wrap flex-md-nowrap justify-content-between
            {{('mb-2' if answer.state == 'new'
            else 'mb-3 border rounded p-4 p-md-5 bg-body'
            if survey.background_image_url and survey.questions_layout == 'page_per_section'
            else 'mb-2')}}">
            <div t-attf-class="o_survey_nav d-none flex-grow-1 #{'order-2 order-md-1' if languages else None}">
                <div class="container m-0 p-0">
                    <div class="row">
                        <div class="col-lg-10">
                            <h1 t-out="survey.title"
                                t-attf-class="o_survey_main_title o_survey_main_title_fade h2 pt-4 opacity-100 {{'opacity-0' if answer.state != 'in_progress' and survey.questions_layout != 'page_per_question' else ''}}"/>
                        </div>
                    </div>
                </div>
                <div class="o_survey_breadcrumb_container mt-2"
                     t-att-data-can-go-back="survey.users_can_go_back"
                     t-att-data-pages="json.dumps(breadcrumb_pages)" />
            </div>
            <div t-if="languages" class="order-1 order-md-2">
                <select name="lang_code"
                        t-attf-class="form-select o_survey_lang_selector #{'d-none' if len(languages) == 1 else ''}"
                        aria-label="Select a language">
                    <option t-foreach="languages" t-as="language" t-att-value="language[0]" t-out="language[1]"
                            t-att-selected="language[0] == lang_code and 'selected' or None"/>
                </select>
            </div>
        </div>
    </template>

    <template id="survey_toolbar" name="Survey: toolbar with timer, progress bar, brand message and navigation">
        <div class="o_survey_toolbar position-fixed bottom-0 end-0 d-flex d-print-none align-items-center m-3 me-md-4 border rounded py-2 bg-body shadow-sm">
            <div class="o_survey_timer fs-5">
                <span class="o_survey_timer_container timer"/>
            </div>
            <div t-if="survey and survey.questions_layout != 'one_page' and answer and answer.state == 'in_progress' and (not question or not question.is_page) and not survey_form_readonly"
                 class="o_survey_progress_wrapper d-flex align-items-center gap-2 px-3 px-md-4">
                <t t-if="survey.questions_layout == 'page_per_section'">
                    <t t-set="page_ids" t-value="survey.page_ids.ids"/>
                    <t t-set="page_number" t-value="page_ids.index(page.id) + (1 if survey.progression_mode == 'number' else 0)"/>
                </t>
                <t t-else="">
                    <t t-if="not answer.is_session_answer and survey.questions_selection == 'random'"
                        t-set="page_ids" t-value="answer.predefined_question_ids.ids"/>
                    <t t-else="" t-set="page_ids" t-value="survey.question_ids.ids"/>
                    <t t-set="page_number" t-value="page_ids.index(question.id)"/>
                </t>
                <t t-call="survey.survey_progression"/>
            </div>
            <div t-if="not no_survey_navigation" class="o_survey_navigation_wrapper">
                <t t-call="survey.survey_navigation"/>
            </div>
        </div>
    </template>

    <template id="survey_fill_form" name="Survey: main page content">
        <t t-set="survey_form_readonly" t-value="answer.state == 'done'"/>
        <t t-set="background_image_url"
           t-value="question.background_image_url
                    if question else page.background_image_url
                    if page else survey.background_image_url
                    if survey.background_image_url else False"/>
        <form role="form" method="post" t-att-name="survey.id"
                t-attf-class="o_survey-fill-form o_survey_layout_{{survey.questions_layout}} d-flex flex-grow-1 align-items-center"
                t-att-data-scoring-type="survey.scoring_type"
                t-att-data-answer-token="answer.access_token"
                t-att-data-survey-token="survey.access_token"
                t-att-data-users-can-go-back="survey.users_can_go_back and not answer.is_session_answer"
                t-att-data-session-in-progress="answer.is_session_answer"
                t-att-data-is-start-screen="answer.state == 'new'"
                t-att-data-readonly="survey_form_readonly"
                t-att-data-has-answered="bool(has_answered)"
                t-att-data-is-page-description="bool(question and question.is_page and not is_html_empty(question.description))"
                t-att-data-questions-layout="survey.questions_layout"
                t-att-data-triggered-questions-by-answer="json.dumps(triggered_questions_by_answer)"
                t-att-data-triggering-answers-by-question="json.dumps(triggering_answers_by_question)"
                t-att-data-selected-answers="json.dumps(selected_answers)"
                t-att-data-refresh-background="any(page.background_image for page in survey.page_ids)">
            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
            <input type="hidden" name="token" t-att-value="answer.access_token" />
            <div class="alert alert-danger d-none" role="alert">
                <p>There was an error during the validation of the survey.</p>
            </div>

            <div t-attf-class="o_survey_form_content w-100 {{'rounded bg-body border' if survey.questions_layout != 'one_page' or background_image_url else ''}}">
                <t t-if="answer.state == 'new'" t-call="survey.survey_fill_form_start"/>
                <t t-elif="answer.state == 'in_progress'" t-call="survey.survey_fill_form_in_progress" />
                <t t-else="" t-call="survey.survey_fill_form_done"/>
            </div>
        </form>
    </template>

    <template id="survey_fill_form_start" name="Survey: start form content">
        <div t-attf-class="wrap o_survey_start {{'border rounded bg-body' if survey.questions_layout == 'one_page' else ''}}">
            <div class="p-4 p-md-5">
                <t t-if="answer.is_session_answer">
                    <div class="mb-4 text-muted text-center">
                        <span><i class="fa fa-info-circle me-2"/>The session will begin automatically when the host starts.</span>
                    </div>
                </t>
                <h1 t-out="survey.title" class="o_survey_main_title h2 mb-2"/>
                <div t-field='survey.description' class="oe_no_empty o_survey_description text-break"/>
            </div>
            <div t-if="not answer.is_session_answer" class="d-flex flex-column flex-md-row align-items-center gap-2 px-4 px-md-5 py-4 w-100 border-top">
                <button type="submit" value="start" class="btn btn-primary w-100 w-md-auto disabled">
                    <t t-if="survey.certification">
                        Start Certification
                    </t>
                    <t t-else="">
                        Start Survey
                    </t>
                </button>
                <small class="o_survey_enter d-none d-md-inline-block text-muted">or press Enter</small>
                <span class="d-inline-block ms-md-auto mt-2 mt-md-0 px-3 py-2 border rounded" t-if="survey.is_time_limited and not answer.is_session_answer">
                    <i class="fa fa-lg fa-clock-o me-2 text-muted"/>
                    <span t-field="survey.time_limit"
                        t-options="{'widget': 'duration', 'unit': 'minute'}"/>
                </span>
            </div>
        </div>
    </template>

    <template id="survey_fill_form_in_progress" name="Survey: form with questions">
        <div class="o_survey_form_content_data d-none"
            t-att-data-question-time-limit-reached="answer.question_time_limit_reached"
            t-att-data-has-answered="bool(has_answered)"
            t-att-data-is-page-description="bool(question and question.is_page and not is_html_empty(question.description))"
            t-att-data-server-time="server_time"
            t-att-data-survey-first-submitted="answer.survey_first_submitted"
            t-att-data-survey-last-triggering-answers="survey_last_triggering_answers"
            t-att-data-timer="timer_start"
            t-att-data-time-limit-minutes="time_limit_minutes"/>
        <t t-if="survey.questions_layout == 'one_page'">
            <!-- Questions without section -->
            <t t-foreach="survey.question_ids.filtered(lambda q: not q.page_id)" t-as="question">
                <t t-if="question in answer.predefined_question_ids" t-call="survey.question_container"/>
            </t>
            <!-- Questions with section -->
            <t t-foreach="survey.page_ids" t-as="page">
                <t t-set="display_section" t-value="page.description or any(not q.triggering_answer_ids for q in page.question_ids)
                    or (survey.questions_selection == 'random' and page.question_ids and page.random_questions_count > 0)"/>
                <div t-attf-class="o_survey_section overflow-hidden#{' mb-4 border rounded bg-body' if not background_image_url else ' border-bottom'}#{' d-none' if not display_section else ''}">
                    <div t-attf-class="#{'mb-5 border-bottom p-5' if not background_image_url else 'mb-3 px-4 px-md-5 pb-4 pt-5'}">
                        <h2 t-field="page.title" class="o_survey_title text-break"/>
                        <div t-field="page.description" class="o_survey_description text-break"/>
                    </div>
                    <t t-foreach="page.question_ids" t-as="question">
                        <t t-if="question in answer.predefined_question_ids" t-call="survey.question_container"/>
                    </t>
                </div>
            </t>

            <div t-attf-class="text-center {{'p-4 px-md-5' if survey.background_image_url else 'pb-4'}}">
                <button type="submit" value="finish" class="btn btn-primary w-100 w-md-auto disabled">Submit</button>
                <button id="next_page" class="btn btn-light d-none w-100 w-md-auto">Next</button>
                <small class="d-none d-md-inline ms-1 text-muted" id="enter-tooltip">or press CTRL+Enter</small>
            </div>
        </t>

        <t t-if="survey.questions_layout == 'page_per_section'">
            <div class="border-bottom px-4 px-md-5 pt-5 pb-4 mb-5">
                <h2 t-field='page.title' class="o_survey_title h3 text-break" />
                <div t-field='page.description' class="oe_no_empty o_survey_description text-break"/>
            </div>

            <input type="hidden" name="page_id" t-att-value="page.id" />
            <t t-foreach='page.question_ids' t-as='question'>
                <t t-if="question in answer.predefined_question_ids" t-call="survey.question_container"/>
            </t>

            <div class="border-top px-5 py-4">
                <t t-set="submit_value" t-value="'finish' if survey_last or answer.is_session_answer else 'next_post_submit'
                    if answer.survey_first_submitted and post_submit_questions.page_id and page in post_submit_questions.page_id else 'next'"/>
                <button type="submit" t-att-value="submit_value" class="btn btn-primary disabled">
                    <t t-if="submit_value == 'finish'">Submit</t>
                    <t t-else="">Continue</t>
                </button>
                <button id="next_page" class="btn btn-light d-none">Next</button>
                <small class="d-none d-md-inline ms-1 text-muted" id="enter-tooltip"> or press CTRL+Enter</small>
            </div>
        </t>

        <!-- Minimized display means we display the choices vertically (instead of optimized based on screen space).
        An exception is made for options with images, where we always want to optimize screen space.-->
        <t t-set="minimized_display" t-value="survey.questions_layout == 'page_per_question' and not any(suggestion.value_image for suggestion in question.suggested_answer_ids)" />
        <div t-if="survey.questions_layout == 'page_per_question'" t-attf-class="o_survey_page_per_question">
            <input type="hidden" name="question_id" t-att-value="question.id" />
            <!-- User has already answered for this session -->
            <t t-if="answer.is_session_answer and (has_answered or answer.question_time_limit_reached)">
                <fieldset disabled="disabled">
                    <t t-set="survey_form_readonly" t-value="True" />
                    <div class="mt-4 mt-md-5">
                        <t t-call="survey.question_container" />
                    </div>
                </fieldset>
                <div class="p-4 p-md-5 pt-0 pt-md-0 text-muted text-center">
                    <small t-if="answer.question_time_limit_reached and not has_answered">Sorry, you have not been fast enough.</small>
                    <small t-else="">We have registered your answer! Please wait for the host to go to the next question.</small>
                </div>
            </t>
            <t t-elif="answer.is_session_answer and question.is_page and not is_html_empty(question.description)">
                <div class="p-4 p-md-5 text-muted text-center">Pay attention to the host screen until the next question.</div>
            </t>
            <t t-else="">
                <div class="mt-4 mt-md-5">
                    <t t-call="survey.question_container"/>
                </div>

                <div class="d-flex flex-column flex-md-row align-items-center gap-2 border-top px-4 px-md-5 py-4">
                    <t t-set="submit_value" t-value="'finish' if survey_last or answer.is_session_answer else
                        'next_post_submit' if answer.survey_first_submitted and post_submit_questions and question in post_submit_questions else 'next'"/>
                    <button type="submit" t-att-value="submit_value" class="btn btn-primary w-100 w-md-auto disabled">
                        <t t-if="submit_value == 'finish'">Submit</t>
                        <t t-else="">Continue</t>
                    </button>
                    <button id="next_page" t-attf-class="btn #{'btn-light' if survey_last else 'btn-primary'} d-none w-100 w-md-auto">Next</button>
                    <small class="d-none d-md-inline ms-2 text-muted" id="enter-tooltip">or press Enter</small>
                </div>
            </t>
        </div>
    </template>

    <!-- Finished (taken and finished) survey page -->
    <template id="survey_fill_form_done" name="Survey: finished">
        <div class="wrap">
            <div t-attf-class="o_survey_finished rounded bg-body#{' border' if survey.questions_layout == 'one_page' else ''}">
                <div class="p-4 p-md-5">
                    <h1 t-out="survey.title" class="o_survey_main_title h3 mb-3"/>
                    <p>
                        <t t-if="survey.scoring_type != 'no_scoring'">
                            You scored <t t-out="answer.scoring_percentage"/>%
                        </t>
                        <t t-elif="not survey.description_done">Thank you!</t>
                    </p>
                    <div t-field="survey.description_done" class="oe_no_empty o_survey_description"/>
                    <t t-if="survey.scoring_type != 'no_scoring' and survey.scoring_success_min">
                        <t t-if="answer.scoring_success">
                            <div>Congratulations, you have passed the test!</div>
                        </t>
                        <t t-else="">
                            <div>Unfortunately, you have failed the test.</div>
                        </t>
                    </t>
                    <div t-if="survey.certification_give_badge and answer.scoring_success">
                        <img t-att-src="'/web/image/gamification.badge/%s/image_128' % survey.certification_badge_id.id"/>
                        <div>You received the badge <span class="fw-bold" t-out="survey.certification_badge_id.name"/>!</div>
                    </div>
                </div>
                <div class="d-flex flex-column flex-md-row gap-2 border-top px-4 px-md-5 py-4">
                    <div t-attf-class="w-100 w-md-auto#{' me-md-auto' if survey.is_attempts_limited else ''}">
                        <t t-call="survey.survey_button_retake"/>
                    </div>
                    <a t-if="survey.certification and answer.scoring_success"
                        role="button"
                        class="btn btn-primary"
                        t-att-href="'/survey/%s/get_certification' % survey.id">
                        <i class="fa fa-fw fa-trophy" role="img" aria-label="Download certification" title="Download certification"/>
                        Download certification
                    </a>
                    <a t-if="survey.scoring_type != 'scoring_without_answers'" role="button" class="o_survey_review btn btn-light w-100 w-md-auto"
                        t-att-href="'/survey/print/%s?answer_token=%s&amp;review=True' % (survey.access_token, answer.access_token)">
                        <i class="fa fa-fw fa-bar-chart me-2" role="img" aria-label="Review answers" title="Review answers"/>Review answers
                    </a>
                </div>
            </div>
        </div>
    </template>

    <!-- Question widgets -->
    <template id="question_container" name="Survey: question container">
        <t t-set="display_question"
           t-value="survey.questions_layout == 'page_per_question'
                    or survey.questions_selection == 'random'
                    or (survey.questions_layout == 'one_page' and not question.triggering_answer_ids)
                    or (survey.questions_layout == 'page_per_section' and (not question.triggering_answer_ids
                        or any(triggering_answer in selected_answers for triggering_answer in triggering_answers_by_question[question.id])))"/>

        <t t-set="answer_lines" t-value="answer.user_input_line_ids.filtered(lambda line: line.question_id == question)"/>
        <t t-set="answers_contain_image" t-value="any(a.value_image for a in question.suggested_answer_ids)"/>
        <t t-set="use_half_columns" t-value="survey.questions_layout == 'page_per_question' and answers_contain_image"/>
        <t t-set="use_half_col_lg" t-value="'col-lg-6' if (use_half_columns and not survey_form_readonly) or (answer.is_session_answer and answers_contain_image) else ''"/>
        <!--Use Key selection if number of choices is < 26 to keep Z for other choice if any-->
        <t t-set="letters" t-value="'ABCDEFGHIJKLMNOPQRSTUVWXYZ'"/>
        <t t-set="useKeySelection" t-value="len(question.suggested_answer_ids) &lt; len(letters) and survey.questions_layout == 'page_per_question'"/>
        <t t-set="default_constr_error_msg">This question requires an answer.</t>
        <t t-set="default_validation_error_msg">The answer you entered is not valid.</t>
        <t t-set="default_comments_message">If other, please specify:</t>
        <t t-set="is_post_submit_question" t-value="post_submit_questions and question in post_submit_questions"/>
        <div t-attf-class="o_survey_question #{'d-none' if not display_question else ''}"
             t-att-id="question.id"
             t-att-data-required="bool(question.constr_mandatory and (not survey.users_can_go_back or survey.questions_layout == 'one_page')) or None"
             t-att-data-constr-error-msg="question.constr_error_msg or default_constr_error_msg if question.constr_mandatory else None"
             t-att-data-validation-error-msg="question.validation_error_msg or default_validation_error_msg if question.validation_required else None">
            <h2 t-attf-class="#{'h5' if survey.questions_layout != 'page_per_question' else 'h4'}" t-if="not hide_question_title">
                <span t-field='question.title' class="text-break"/>
                <span t-if="question.constr_mandatory" class="text-danger">*</span>
            </h2>
            <div t-if="not is_html_empty(question.description)" t-field='question.description' class="oe_no_empty o_survey_description text-break"/>
            <t t-if="question.question_type == 'text_box'" t-call="survey.question_text_box"/>
            <t t-if="question.question_type == 'char_box'" t-call="survey.question_char_box"/>
            <t t-if="question.question_type == 'numerical_box'" t-call="survey.question_numerical_box"/>
            <t t-if="question.question_type == 'date'" t-call="survey.question_date"/>
            <t t-if="question.question_type == 'datetime'" t-call="survey.question_datetime"/>
            <t t-if="question.question_type == 'simple_choice'" t-call="survey.question_simple_choice"/>
            <t t-if="question.question_type == 'scale'" t-call="survey.question_scale"/>
            <t t-if="question.question_type == 'multiple_choice'" t-call="survey.question_multiple_choice"/>
            <t t-if="question.question_type == 'matrix'" t-call="survey.question_matrix"/>
            <div t-attf-class="o_survey_question_error d-flex align-items-center justify-content-between overflow-hidden
                 border-0 alert alert-danger #{'slide_in mt-2' if is_post_submit_question else 'm-0'} #{'d-none' if answer.is_session_answer else ''}" role="alert">
                <span t-if="is_post_submit_question" t-out="question.constr_error_msg or default_constr_error_msg"/>
            </div>
        </div>
    </template>

    <template id="question_text_box" name="Question: free text box">
        <div class="o_survey_comment_container h-auto p-0">
            <textarea t-attf-class="form-control o_survey_question_text_box #{'form-control-lg' if survey.questions_layout == 'page_per_question' else ''}"
                      rows="3"
                      t-att-name="question.id" t-att-placeholder="question.question_placeholder"
                      t-att-data-question-type="question.question_type"><t t-if="answer_lines" t-out="answer_lines[0].value_text_box or None"/></textarea>
        </div>
    </template>

    <template id="question_char_box" name="Question: text box">
        <div class="o_survey_comment_container p-0">
            <input t-att-type="'email' if question.validation_email else 'text'"
               t-attf-class="form-control o_survey_question_text_box #{'form-control-lg' if survey.questions_layout == 'page_per_question' else ''}"
               t-att-name="question.id" t-att-placeholder="question.question_placeholder"
               t-att-value="answer_lines[0].value_char_box if answer_lines else None"
               t-att-data-question-type="question.question_type"
               t-att-data-validation-length-min="question.validation_length_min if question.validation_required else False"
               t-att-data-validation-length-max="question.validation_length_max if question.validation_required else False"/>
        </div>
    </template>

    <template id="question_numerical_box" name="Question: numerical box">
        <div class="o_survey_answer_wrapper rounded">
            <input type="number" step="any" class="form-control o_survey_question_numerical_box"
                t-att-name="question.id" t-att-placeholder="question.question_placeholder"
                t-att-value="answer_lines[0].value_numerical_box if answer_lines else None"
                t-att-data-question-type="question.question_type"
                t-att-data-validation-float-min="question.validation_min_float_value if question.validation_required else False"
                t-att-data-validation-float-max="question.validation_max_float_value if question.validation_required else False"/>
        </div>
    </template>

    <template id="question_scale" name="Question: scale">
        <!-- A question already answered that the user resets is marked as skipped and not deleted, -->
        <!-- so we use the flag skipped to restore or not the answer state. -->
        <t t-set="answer_line" t-value="answer_lines and not answer_lines[0].skipped and answer_lines[0]"/>
        <div class="o_survey_answer_wrapper o_survey_form_choice"
             t-att-data-name="question.id"
             t-att-data-is-post-submit-question="is_post_submit_question or None"
             data-question-type="scale">
            <div role="radiogroup" class="d-flex gap-1 mb-2 rounded overflow-hidden" t-att-aria-label="">
                <t t-foreach="range(question.scale_min, question.scale_max + 1)" t-as="value">
                    <t t-set="answer_selected" t-value="answer_line and answer_line.value_scale == value"/>
                    <label t-attf-class="o_survey_choice_btn flex-grow-1 py-2 px-3 text-center #{'o_survey_selected' if answer_selected else ''}"
                           t-attf-for="{{ question.id }}_{{ value }}">
                        <div t-out="value"/>
                        <input
                            class="btn-check o_survey_form_choice_item form-check-input position-relative mb-1"
                            type="radio"
                            t-att-data-selection-key="letters[value_index] if useKeySelection else ''"
                            t-attf-name="{{ question.id }}"
                            t-att-checked="'checked' if answer_selected else None"
                            t-attf-value="{{ value }}"
                            t-attf-id="{{ question.id }}_{{ value }}"
                        />
                    </label>
                </t>
            </div>
            <div t-if="question.scale_min_label or question.scale_max_label"
                 class="d-flex justify-content-between text-muted">
                <div class="text-start" t-out="question.scale_min_label"/>
                <div class="text-end" t-out="question.scale_max_label"/>
            </div>
        </div>
    </template>

    <template id="question_date" name="Question: date box">
        <div class="o_survey_answer_wrapper position-relative">
            <input type="text" class="form-control datetimepicker-input"
                   t-att-name="question.id" t-att-placeholder="question.question_placeholder"
                   t-att-value="format_date(answer_lines[0].value_date) if answer_lines else None"
                   t-att-data-question-type="question.question_type"
                   data-widget="datetime-picker" data-widget-type="date"
                   t-att-data-min-date="question.validation_min_date"
                   t-att-data-max-date="question.validation_max_date">
            </input>
            <i t-if="not survey_form_readonly" class="fa fa-calendar position-absolute end-0 top-50 translate-middle pe-1 text-muted pe-none"/>
        </div>
    </template>

    <template id="question_datetime" name="Question: datetime box">
        <div class="o_survey_answer_wrapper position-relative">
            <input type="text" class="form-control datetimepicker-input"
                   t-att-name="question.id" t-att-placeholder="question.question_placeholder"
                   t-att-value="format_datetime(answer_lines[0].value_datetime) if answer_lines else None"
                   t-att-data-question-type="question.question_type"
                   data-widget="datetime-picker" data-widget-type="datetime"
                   t-att-data-min-date="question.validation_min_datetime"
                   t-att-data-max-date="question.validation_max_datetime"/>
            <i t-if="not survey_form_readonly" class="fa fa-calendar position-absolute end-0 top-50 translate-middle pe-1 text-muted pe-none"/>
        </div>
    </template>

    <template id="question_suggested_value_image" name="Image from the question suggested answer">
        <t t-if="label.value_image">
            <!-- Directly use field or route if the user doesn't have access rights -->
            <div t-if="not env.user.has_group('survey.group_survey_user')"
                class="o_survey_choice_img d-flex my-3 justify-content-center p-2 rounded border bg-body">
                <img t-att-src="'/survey/get_question_image/%s/%s/%s/%s' % (survey.access_token, answer.access_token, question.id, label.id)" class="mw-100 h-auto"/>
            </div>
            <div t-else=""  t-field="label.value_image"
                class="o_survey_choice_img d-flex my-3 justify-content-center p-2 rounded border bg-body"
                t-options="{'widget': 'image', 'alt-field': 'name', 'itemprop': 'image'}"/>
        </t>
    </template>

    <template id="question_simple_choice" name="Question: simple choice">
        <t t-set="answer_line" t-value="answer_lines and answer_lines[0] if answer_lines else None"/>
        <t t-set="comment_line" t-value="answer_lines.filtered(lambda line: line.value_char_box)"/>
        <div class="row g-2 o_survey_answer_wrapper o_survey_form_choice"
             t-att-data-name="question.id"
             t-att-data-is-post-submit-question="is_post_submit_question or None"
             data-question-type="simple_choice_radio">
            <t t-set="item_idx" t-value="0"/>
            <t t-set="has_correct_answer" t-value="scoring_display_correction and any(label.is_correct for label in question.suggested_answer_ids)"/>
            <t t-foreach='question.suggested_answer_ids' t-as='label'>
                <t t-set="item_idx" t-value="label_index"/>
                <t t-set="answer_selected" t-value="answer_line and answer_line.suggested_answer_id and answer_line.suggested_answer_id.id == label.id"/>

                <!--Used for print mode with corrections -->
                <t t-set="answer_class" t-value="
                    'text-success-emphasis bg-success-subtle' if answer_selected and label.is_correct and has_correct_answer and not answer.is_session_answer
                    else 'text-danger-emphasis bg-danger-subtle' if answer_selected and not label.is_correct and has_correct_answer and not answer.is_session_answer
                    else ''
                "/>

                <div t-attf-class="#{use_half_col_lg}">
                    <label t-att-for="str(question.id) + '_' + str(label.id)"
                        t-attf-class="o_survey_choice_btn w-100 h-100 py-2 px-3 border-0 rounded #{answer_class} #{'o_survey_selected' if answer_selected else ''}">
                        <div class="d-flex align-items-center gap-2">
                            <input t-att-id="str(question.id) + '_' + str(label.id)" type="radio" t-att-value='label.id'
                                t-attf-class="o_survey_form_choice_item form-check-input position-relative m-0"
                                t-att-name='question.id'
                                t-att-checked="'checked' if answer_selected else None"
                                t-att-data-selection-key="letters[item_idx] if useKeySelection else ''"/>
                            <span class="text-break" t-field='label.value'/>
                            <t t-call="survey.survey_selection_key"
                                selection_key_class.f="position-relative o_survey_radio_btn d-flex ms-auto"/>
                            <t t-if="has_correct_answer">
                                <i t-if="label.is_correct"
                                class="d-inline fa fa-check text-success ms-auto"/>
                                <i t-elif="answer_selected and not label.is_correct"
                                class="d-inline fa fa-times text-danger ms-auto"/>
                            </t>
                        </div>
                        <t t-call="survey.question_suggested_value_image"/>
                    </label>
                </div>
            </t>
            <t t-if='question.comments_allowed and question.comment_count_as_answer'>
                <div t-attf-class="#{use_half_col_lg}">
                    <label t-attf-class="o_survey_choice_btn d-flex align-items-center w-100 py-2 px-3 rounded #{'o_survey_selected' if comment_line else ''}">
                        <t t-set="item_idx" t-value="item_idx + 1"/>
                        <input type="radio" class="o_survey_form_choice_item o_survey_js_form_other_comment form-check-input position-relative m-0" value="-1"
                            t-att-name='question.id'
                            t-att-checked="comment_line and 'checked' or None"
                            t-att-data-selection-key="letters[item_idx] if useKeySelection else ''"/>
                        <span class="ms-2" t-out="question.comments_message or default_comments_message" />
                        <t t-call="survey.survey_selection_key"
                            selection_key_class.f="position-relative o_survey_radio_btn d-flex ms-auto"/>
                    </label>
                </div>
                <div t-attf-class="o_survey_comment_container mt-3 py-0 px-1 h-auto #{'d-none' if not comment_line else ''}">
                    <textarea type="text" class="form-control o_survey_question_text_box"
                        t-att-disabled="None if comment_line else 'disabled'"><t t-out="comment_line.value_char_box if comment_line else ''"/></textarea>
                </div>
            </t>
            <div t-if='question.comments_allowed and not question.comment_count_as_answer'
                class="mb-2 o_survey_comment_container mt-3">
                <textarea type="text" class="col form-control o_survey_comment o_survey_question_text_box"
                    t-att-placeholder="question.comments_message or default_comments_message if not survey_form_readonly else ''"><t t-out="comment_line.value_char_box if comment_line else ''"/></textarea>
            </div>
        </div>
    </template>

    <template id="question_multiple_choice" name="Question: multiple choice">
        <t t-set="comment_line" t-value="answer_lines.filtered(lambda line: line.value_char_box)"/>
        <div class="row g-2 o_survey_answer_wrapper o_survey_form_choice o_survey_question_multiple_choice"
             t-att-data-name="question.id"
             t-att-data-question-type="question.question_type">
            <t t-set="item_idx" t-value="0"/>
            <t t-set="has_correct_answer" t-value="scoring_display_correction and any(label.is_correct for label in question.suggested_answer_ids)"/>
            <t t-foreach='question.suggested_answer_ids' t-as='label'>
                <t t-set="item_idx" t-value="label_index"/>
                <t t-set="answer_line" t-value="answer_lines.filtered(lambda line: line.suggested_answer_id == label)"/>
                <t t-set="answer_selected" t-value="answer_line and answer_line.suggested_answer_id.id == label.id"/>

                <!--Used for print mode with corrections -->
                <t t-set="answer_class" t-value="
                    'text-success-emphasis bg-success-subtle' if answer_line and label.is_correct and not answer.is_session_answer
                    else 'text-danger-emphasis bg-danger-subtle' if answer_line and not label.is_correct and has_correct_answer and not answer.is_session_answer
                    else ''
                "/>

                <div t-attf-class="#{use_half_col_lg}">
                    <label t-attf-class="o_survey_choice_btn py-2 px-3 w-100 h-100 border-0 rounded #{answer_class} #{'o_survey_selected' if answer_selected else ''}">
                        <div class="d-flex align-items-center gap-2">
                            <input type="checkbox" t-att-value='label.id'
                                class="o_survey_form_choice_item form-check-input position-relative m-0"
                                t-att-name="question.id"
                                t-att-checked="'checked' if answer_line else None"
                                t-att-data-selection-key="letters[item_idx] if useKeySelection else ''"/>
                            <span class="text-break" t-field='label.value'/>
                            <t t-call="survey.survey_selection_key"
                                selection_key_class.f="position-relative d-flex ms-auto"/>
                            <t t-if="has_correct_answer and label.is_correct and (not answer_selected or answer_selected)">
                                <i class="fa fa-check fa-fw ms-auto text-success"/>
                            </t>
                            <t t-if="answer_line and not label.is_correct and has_correct_answer">
                                <i class="fa fa-times fa-fw ms-auto text-danger"/>
                            </t>
                        </div>
                        <t t-call="survey.question_suggested_value_image"/>
                    </label>
                </div>
            </t>
            <t t-if='question.comments_allowed and question.comment_count_as_answer'>
                <div t-attf-class="#{use_half_col_lg}">
                    <label t-attf-class="o_survey_choice_btn d-flex align-items-center py-2 px-3 h-100 w-100 rounded #{'o_survey_selected' if comment_line else ''}">
                        <t t-set="item_idx" t-value="item_idx + 1"/>
                        <input type="checkbox" class="o_survey_form_choice_item o_survey_js_form_other_comment position-relative me-2" value="-1"
                            t-att-name="question.id"
                            t-att-checked="comment_line and 'checked' or None"
                            t-att-data-selection-key="letters[item_idx] if useKeySelection else ''"/>
                        <span class="ms-2" t-out="question.comments_message or default_comments_message" />
                        <t t-call="survey.survey_selection_key"
                            selection_key_class.f="position-relative d-flex ms-auto"/>
                    </label>
                </div>
                <div t-attf-class="o_survey_comment_container mt-3 py-0 h-auto px-1 #{'d-none' if not comment_line else ''}">
                    <textarea type="text" class="form-control o_survey_question_text_box"
                        t-att-disabled="None if comment_line else 'disabled'"><t t-out="comment_line.value_char_box if comment_line else ''"/></textarea>
                </div>
            </t>
            <div t-if='question.comments_allowed and not question.comment_count_as_answer' class="mb-2 o_survey_comment_container h-auto mt-3">
                <textarea type="text" class="col form-control o_survey_comment o_survey_question_text_box"
                    t-att-placeholder="question.comments_message or default_comments_message if not survey_form_readonly else ''"><t t-out="comment_line.value_char_box if comment_line else ''"/></textarea>
            </div>
        </div>
    </template>

    <template id="question_matrix" name="Question: matrix">
        <t t-set="comment_line" t-value="answer_lines.filtered(lambda line: line.value_char_box)"/>
        <div class="w-100 overflow-x-auto">
            <table class="table table-borderless o_survey_question_matrix text-center mb-0"
                t-att-data-name="question.id"
                t-att-data-question-type="question.question_type"
                t-att-data-sub-questions="question.matrix_row_ids.ids"
                t-att-data-is-post-submit-question="is_post_submit_question or None">
                <thead>
                    <tr>
                        <th> </th>
                        <th class="fw-medium" t-foreach="question.suggested_answer_ids" t-as="col_label"><span t-field="col_label.value" /></th>
                    </tr>
                </thead>
                <tbody>
                    <t t-set="item_idx" t-value="0"/>
                    <!-- For matrix, we have an extra check because we have rows * columns total options -->
                    <t t-set="useKeySelection" t-value="useKeySelection and (len(question.suggested_answer_ids) * len(question.matrix_row_ids)) &lt; len(letters)" />
                    <tr t-foreach="question.matrix_row_ids" t-as="row_label" t-att-id="row_label.id">
                        <td class="o_survey_question_matrix_label position-sticky start-0 text-start z-3"><span t-field="row_label.value" /></td>
                        <t t-foreach="question.suggested_answer_ids" t-as="col_label">
                            <t t-set="answer" t-value="answer_lines.filtered(lambda line: line.suggested_answer_id == col_label and line.matrix_row_id == row_label)"/>
                            <td t-att-class="'o_survey_matrix_btn position-relative rounded align-middle cursor-pointer z-1 %s'
                                % ('o_survey_selected' if answer else '')">
                                <input
                                    t-att-type="'checkbox' if question.matrix_subtype == 'multiple' else 'radio'"
                                    t-att-id="'%s_%s_%s' % (question.id, row_label.id, col_label.id)"
                                    t-att-name="'%s_%s' % (question.id, row_label.id)"
                                    t-att-value='col_label.id'
                                    t-att-checked="'checked' if answer else None"
                                    t-att-data-row-id="row_label.id"
                                    t-att-data-selection-key="letters[item_idx] if useKeySelection else ''"
                                    class="o_survey_form_choice_item form-check-input position-relative pe-none"
                                />
                                <t t-call="survey.survey_selection_key"
                                    selection_key_class.f="'position-absolute %s' % ('o_survey_radio_btn' if question.matrix_subtype != 'multiple' else '')'"/>
                                <t t-set="item_idx" t-value="item_idx + 1"/>
                            </td>
                        </t>
                    </tr>
                </tbody>
            </table>
        </div>
        <div t-if='question.comments_allowed'>
            <textarea type="text" class="form-control o_survey_question_text_box o_survey_comment mt-3"
                      t-att-placeholder="question.comments_message or default_comments_message if not survey_form_readonly else ''"
                      t-att-name="'%s_%s' % (question.id, 'comment')"><t t-out="comment_line.value_char_box if comment_line else ''"/></textarea>
        </div>
    </template>

    <template id="survey_selection_key">
        <div t-if="useKeySelection" t-att-class="'o_survey_choice_key bg-body rounded border shadow-sm %s' % selection_key_class">
            <span class="w-100 text-muted text-center" t-out="letters[item_idx]"/>
        </div>
    </template>

    <template id="survey_progression" name="Survey: Progression">
        <t t-if="len(page_ids) > 1 and not survey.has_conditional_questions">
            <t t-set="percentage" t-value="round(100*(page_number/len(page_ids)))"/>
            <span t-if="survey.progression_mode == 'percent'">
                <t t-out="percentage"/>%
            </span>
            <span t-else="">
                <t t-out="page_number"/> of <t t-out="len(page_ids)"/>
                <t t-if="survey.questions_layout == 'page_per_question'">answered</t>
                <t t-else="">pages</t>
            </span>
            <div class="o_survey_progress progress d-none d-md-block flex-grow-1">
                <div class="progress-bar bg-primary" t-att-style="'width: ' + str(percentage) + '%'"/>
            </div>
        </t>
    </template>
</data>
</odoo>
