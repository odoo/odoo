<!DOCTYPE html>
<html>
    <head>
        <title>OpenERP player</title>
        <meta content="text/html; charset=utf-8" http-equiv="content-type"/>

        <link rel="stylesheet" href="/web/webclient/css">
        <link href="/web/static/lib/bootstrap/css/bootstrap.css" rel="stylesheet"/>
        <script src="/web/webclient/js"></script>
        <script src="/screen_record/static/lib/mutation-summary/tree_mirror.js"></script>
        <script src="/screen_record/static/lib/smt2/smt-aux.js"></script>
        <script src="/screen_record/static/lib/smt2/wz_jsgraphics.js"></script>
        <script src="/screen_record/static/lib/mouse_track.js"></script>
        <script>
            window.addEventListener('DOMContentLoaded', function() { 

                var instance = openerp.init(["web"]);

                var base;
                var treeMirror = new TreeMirror(document.body, {
                    createElement: function(tagName) {
                        if (tagName == 'SCRIPT') {
                            var node = document.createElement('NO-SCRIPT');
                            node.style.display = 'none';
                            return node;
                        }
                        if (tagName == 'HEAD') {
                            var node = document.createElement('HEAD');
                            node.appendChild(document.createElement('BASE'));
                            node.firstChild.href = base;
                            return node;
                        }
                    }
                });

                var cursorMirror = new CursorMirror();

                var Player = instance.web.Widget.extend({
                    init: function(treeMirror, cursorMirror){
                        this.cursorMirror = cursorMirror;
                        this.treeMirror = treeMirror;
                    },
                    clearPage : function() {
                        while (document.firstChild) {
                            document.removeChild(document.firstChild);
                        }
                    },
                    handleMessage: function(msg) {
                        if (msg.clear) {
                            console.log("msg.clear");
                            this.clearPage();
                        } else if (msg.base) {
                            console.log("msg.base");
                            base = msg.base;
                        } else {
                            console.log(msg.f);
                            if (msg.f === 'forwardData') {
                                console.log("msg.f = forwardData");
                                this.cursorMirror[msg.f].apply(this.cursorMirror, msg.args);
                                console.log(this.cursorMirror[msg.f]);
                            } else {
                                console.log("msg.f = applyChanged or initialize");
                                this.treeMirror[msg.f].apply(this.treeMirror, msg.args);
                            }
                        }
                    }
                });
                var player = new Player(treeMirror, cursorMirror);
                var Receiver = window.receiver;
                if(!Receiver){
                    var Receiver = instance.web.Widget.extend({
                        init: function(player){
                            var self = this;
                            var params = $.deparam.querystring();
                            this.id = params.id;
                            this.dbname = params.db;
                            this.counter = 0;
                            this.sre_msglist = [];
                            this.player = player;
                            instance.session.session_bind().done(function() {
                                var screenRecord = new instance.web.Model('screen.record');
                                var screenRecordEvent = new instance.web.Model('screen.record.event');
                                screenRecord.query(['event_ids']).filter([['id', '=', self.id]]).all().then(function(r) {
                                    var sre_ids = r[0].event_ids;
                                    screenRecordEvent.query(['msglist']).filter([['id', 'in', sre_ids]]).all().done(function(sre_list) {
                                        _.each(sre_list, function(sre) {
                                            var list = JSON.parse(sre.msglist);
                                            _.each(list, function(item) {
                                                self.sre_msglist.push(item);
                                            });
                                        });
                                        self.load();
                                    });
                                });
                            });
                        },
                        load: function(){
                            var self = this;
                            console.log(this.counter);
                            var next_event_delay = 0;
                            var current = this.sre_msglist[this.counter];
                            if (this.counter < this.sre_msglist.length-1) {
                                var next = this.sre_msglist[this.counter+1];
                                console.log(next);
                                next_event_delay = next.timestamp - current.timestamp;
                                window.setTimeout(function(){self.load();}, next_event_delay);
                            }
                            console.log(current);
                            this.player.handleMessage(current);
                            this.counter++;
                        }
                    });
                }
                var reciever = new Receiver(player);
            });

        </script>
    </head>
    <body style="height: 100%; margin: 0;">
    </body>
</html>
