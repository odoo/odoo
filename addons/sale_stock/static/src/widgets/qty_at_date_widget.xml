<?xml version="1.0" encoding="UTF-8" ?>
<template id="template" xml:space="preserve">

    <t t-name="sale_stock.QtyAtDate">
        <a t-att-tabindex="this.props.record.data.display_qty_widget ? '0' : '-1'"
            t-on-click="this.showPopup"
            t-att-class="!this.props.record.data.display_qty_widget ? 'invisible' : ''"
            t-attf-class="fa fa-area-chart cursor-pointer {{ this.calcData.forecasted_issue ? 'text-danger' : '' }}"
        />
    </t>

    <t t-name="sale_stock.QtyAtDatePopover">
        <div class="p-2">
        <h6>Availability</h6>
        <table class="table table-borderless table-sm">
            <tbody>
                <t t-if="!this.props.record.data.is_mto and ['draft', 'sent'].includes(this.props.record.data.state)">
                    <tr>
                        <td><strong t-out="this.forecastedLabel"/><br/><small>On <span t-out="this.props.calcData.delivery_date"/></small></td>
                        <td class="text-end">
                            <b t-out='this.props.record.data.virtual_available_at_date'/> <t t-out='this.props.record.data.product_uom_id[1]'/>
                            <t t-if="this.props.record.data.product_uom_id[1] !== this.props.calcData.product_uom_name">
                                <br/><span class="fs-7 text-muted" t-out="this.props.calcData.product_uom_virtual_available_at_date"/> <span class="fs-7 text-muted" t-out='this.props.calcData.product_uom_name'/>
                            </t>
                        </td>
                    </tr>
                    <tr>
                        <td><strong t-out="this.availableLabel"/><br /><small>All planned operations included</small></td>
                        <td class="text-end">
                            <b t-out='this.props.record.data.free_qty_today' t-att-class="!this.props.calcData.will_be_fulfilled ? 'text-danger': ''"/> <t t-out='this.props.record.data.product_uom_id[1]'/>
                            <t t-if="this.props.record.data.product_uom_id[1] !== this.props.calcData.product_uom_name">
                                <br/><span t-out="this.props.calcData.product_uom_free_qty_today" t-att-class="`fs-7 text-muted ${!props.calcData.will_be_fulfilled ? 'text-danger': ''}`"/> <span class="fs-7 text-muted" t-out='this.props.calcData.product_uom_name'/>
                            </t>
                        </td>
                    </tr>
                </t>
                <t t-elif="this.props.record.data.is_mto and ['draft', 'sent'].includes(this.props.record.data.state)">
                    <tr>
                        <td><strong>Expected Delivery</strong></td>
                        <td class="oe-right"><span t-out="this.props.calcData.delivery_date"/></td>
                    </tr>
                    <tr>
                        <p>This product is replenished on demand.</p>
                    </tr>
                </t>
                <t t-elif="this.props.record.data.state == 'sale'">
                    <tr>
                        <td>
                            <strong>Reserved</strong><br/>
                        </td>
                        <td style="min-width: 50px; text-align: right;">
                            <b t-out='this.props.record.data.qty_available_today'/> <t t-out='this.props.record.data.product_uom_id[1]'/>
                        </td>
                    </tr>
                    <tr t-if="this.props.record.data.qty_available_today &lt; this.props.record.data.qty_to_deliver">
                        <td>
                            <span t-if="this.props.calcData.will_be_fulfilled and this.props.calcData.forecast_expected_date_str">
                                Remaining demand available at <b t-out="this.props.calcData.forecast_expected_date_str" t-att-class="this.props.record.data.scheduled_date &lt; this.props.record.data.forecast_expected_date ? 'text-danger' : ''"/>
                            </span>
                            <span t-elif="!this.props.calcData.will_be_fulfilled and this.props.calcData.forecast_expected_date_str" class="text-danger">
                                Not enough future availability
                            </span>
                            <span t-elif="!this.props.calcData.will_be_fulfilled" class="text-danger">
                                No future availability
                            </span>
                            <span t-else="">
                                Available in stock
                            </span>
                        </td>
                    </tr>
                </t>
            </tbody>
        </table>
        <button t-if="!this.props.record.data.is_mto" class="text-start btn btn-link"
            type="button" t-on-click="this.openForecast">
            <i class="oi oi-fw o_button_icon oi-arrow-right"></i>
            View Forecast
        </button>
        </div>
    </t>
</template>
