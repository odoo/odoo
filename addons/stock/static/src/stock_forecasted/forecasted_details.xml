<?xml version="1.0" encoding="utf-8"?>
<templates id="template" xml:space="preserve">
    <t t-name="stock.ForecastedDetailsTable">
        <tbody>
            <tr t-if="onHandCondition">
                <td>Inventory On Hand</td>
                <td/>
                <td t-if="docs.multiple_product"/>
                <td class="text-end">0</td>
                <td/>
                <td/>
            </tr>
            <tr t-foreach="lines" t-as="line" t-key="line_index" t-attf-class="#{line.is_matched and 'table-info'}">
                <td t-attf-class="#{line.is_late and 'table-danger'}">
                    <a t-if="line.document_in"
                        href="#"
                        t-on-click.prevent="() => this.props.openView(line.document_in._name, 'form', line.document_in.id)"
                        t-out="line.document_in.name"
                        class="fw-bold"/>
                    <t t-elif="line.reservation">
                        <a t-out="line.reservation.name" href="#" class="fw-bold"
                           t-on-click.prevent="() => this.props.openView(line.reservation._name, 'form', line.reservation.id)"/> reserved
                        <button t-if="displayReserve(line)"
                                class="btn btn-sm btn-primary o_report_replenish_unreserve"
                                name="unreserve_link"
                                t-on-click="() => this._unreserve(line.move_out.id)">
                            Unreserve
                        </button>
                    </t>
                    <t t-elif="line.in_transit">
                        <t t-if="line.move_out"><span>Stock In Transit</span></t>
                        <t t-else=""><span>Free Stock in personally</span></t>
                    </t>
                    <t t-elif="line.replenishment_filled">
                        <t t-if="line.document_out">Inventory On Hand
                            <button t-if="displayReserve(line)"
                                    class="btn btn-sm btn-primary"
                                    name="reserve_link"
                                    t-on-click="() => this._reserve(line.move_out.id)">
                                Reserve
                            </button>
                        </t>
                        <t t-else="" t-out="freeStockLabel"/>
                    </t>
                    <span t-else="" class="text-muted">Not Available</span>
                </td>
                <td t-out="line.receipt_date or ''" t-attf-class="#{line.is_late and 'table-danger'}"/>
                <td t-if="docs.multiple_product" t-out="line.product.display_name" t-att-class="classForLine(line)"/>
                <td class="text-end"><t t-if="! line.replenishment_filled">- </t><t t-out="_formatFloat(line.quantity)"/></td>
                <td t-attf-class="#{! line.replenishment_filled and 'table-danger'}" name="usedby_cell">
                    <button t-if="line.move_out and line.move_out.picking_id"
                            t-attf-class="o_priority o_priority_star me-1 fa fa-star#{line.move_out.picking_id.priority=='1' ? '' : '-o'}"
                            t-on-click="() => this._onClickChangePriority('stock.picking', line.move_out.picking_id)"
                            name="change_priority_link"/>
                    <a t-if="line.document_out"
                        href="#"
                        t-on-click.prevent="() => this.props.openView(line.document_out._name, 'form', line.document_out.id)"
                        t-out="line.document_out.name"
                        class="fw-bold"/>
                </td>
                <td t-out="line.delivery_date or ''" t-attf-class="#{! line.replenishment_filled and 'table-danger'}"/>
            </tr>
            <tr t-if="docs.qty_to_order">
                <td>To Order</td>
                <td t-out="docs.lead_days_date"/>
                <td t-if="docs.multiple_product"/>
                <td t-out="_formatFloat(docs.qty_to_order)" class="text-end"/>
                <td/>
                <td/>
            </tr>
            <tr t-if="docs.qty_to_order !== docs.qty_to_order_with_visibility_days">
                <td>To Order with Visibility Days</td>
                <td t-out="docs.visibility_days_date"/>
                <td t-if="docs.multiple_product"/>
                <td t-out="_formatFloat(docs.qty_to_order_with_visibility_days)" class="text-end"/>
                <td/>
                <td/>
            </tr>
        </tbody>
        <thead>
            <tr class="o_forecasted_row bg-200">
                <td colspan="2">Forecasted Inventory</td>
                <td t-if="docs.multiple_product"/>
                <td t-out="_formatFloat(docs.virtual_available)" class="text-end"/>
                <td colspan="2"/>
            </tr>
        </thead>
        <tbody>
            <tr t-if="docs.draft_picking_qty.in" name="draft_picking_in">
                <td colspan="2">Incoming Draft Transfer</td>
                <td t-if="docs.multiple_product"/>
                <td t-out="_formatFloat(docs.draft_picking_qty.in)" class="text-end"/>
                <td colspan="2"/>
            </tr>
            <tr t-if="docs.draft_picking_qty.out" name="draft_picking_out">
                <td colspan="2">Outgoing Draft Transfer</td>
                <td t-if="docs.multiple_product"/>
                <td t-out="_formatFloat(docs.draft_picking_qty.out)" class="text-end"/>
                <td colspan="2"/>
            </tr>
        </tbody>
        <thead>
            <tr class="o_forecasted_row bg-200">
                <td colspan="2">Forecasted with Pending</td>
                <td t-if="docs.multiple_product"/>
                <td t-out="_formatFloat(future_virtual_available)" class="text-end"/>
                <td colspan="2"/>
            </tr>
        </thead>
    </t>

    <!-- Main Template -->
    <t t-name="stock.ForecastedDetails">
        <div class="stock_forecast_container">
            <table class="table table-bordered bg-view">
                <thead>
                    <tr class="bg-light">
                        <td>Replenishment</td>
                        <td>Receipt</td>
                        <td>Product</td>
                        <!-- <td class="text-end"><t t-out="props.docs.uom"/></td> -->
                        <td>Used by</td>
                        <td>Delivery</td>
                    </tr>
                </thead>
                <!-- Single Warehouse Case -->
                <t t-if="!props.docs.multiple_warehouses">
                    <t t-set="docs" t-value="props.docs"/>
                    <t t-set="lines" t-value="props.docs.lines"/>
                    <t t-set="future_virtual_available" t-value="futureVirtualAvailable"/>
                    <t t-call="stock.ForecastedDetailsTable"/>
                </t>
                <!-- Multiple Warehouses Case -->
                <t t-if="props.docs.multiple_warehouses">
                    <t t-foreach="props.docs.warehouses" t-as="warehouse" t-key="warehouse.id">
                        <tbody>
                            <tr>
                                <td colspan="6" class="p-1 m-1">
                                    <div class="d-flex">
                                        <span t-on-click="() => this.toggleFolded(warehouse.id)" style="margin-right: 5px"
                                             t-attf-title="{{ this.isFolded(warehouse.id) ? 'Expand Warehouse' : 'Collapse Warehouse' }}"
                                             t-attf-aria-label="{{ this.isFolded(warehouse.id) ? 'Expand Warehouse' : 'Collapse Warehouse' }}">
                                            <i t-attf-class="fa fa-fw fa-caret-{{ this.isFolded(warehouse.id) ? 'right' : 'down' }}"/>
                                        </span>
                                        <p t-esc="warehouse.name" class="p-0 m-0 fw-bold"/>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        <t t-if="!this.isFolded(warehouse.id)">
                            <t t-set="docs" t-value="warehouse"/>
                            <t t-set="lines" t-value="warehouse.lines"/>
                            <t t-set="future_virtual_available" t-value="warehouse.virtual_available + warehouse.draft_picking_qty.in - warehouse.draft_picking_qty.out"/>
                            <t t-call="stock.ForecastedDetailsTable"/>
                        </t>
                    </t>
                </t>
            </table>
        </div>
    </t>
</templates>
