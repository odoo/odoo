<?xml version="1.0"?>
<odoo>
    <!-- Override to take project_id field into account-->
    <record id="note.action_note_note" model="ir.actions.act_window">
        <field name="domain">[('user_ids', 'in', [uid]), ('project_id', '=', False)]</field>
    </record>

    <!-- Conversion form used by an action added in TodoFormView (controller) -->
    <record model="ir.ui.view" id="project_task_todo_conversion_form">
        <field name="model">project.task</field>
        <field name="name">project.task.todo.conversion.form</field>
        <field name="arch" type="xml">
            <form string="Convert to Task"
                  js_class="todo_conversion_form">
                <sheet>
                    <group>
                        <field name="project_id"
                               domain="[('company_id', 'in', context.get('allowed_company_ids'))]"
                               required="1"
                               default_focus="1"/>
                        <field name="user_ids"
                               class="o_task_user_field"
                               options="{'no_open': True, 'no_quick_create': True}"
                               widget="many2many_avatar_user"
                               domain="[('share', '=', False), ('active', '=', True)]"/>
                        <field name="tag_ids" widget="many2many_tags"
                               options="{'color_field': 'color', 'no_create_edit': True}"
                               context="{'project_id': project_id}"/>
                    </group>
                </sheet>
                <footer>
                    <button name="action_convert_to_task" string="Convert to Task" type="object" class="btn-primary"/> 
                    <button string="Cancel" class="btn-default" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>
    <record id="view_project_task_todo_tree_inherit" model="ir.ui.view">
        <field name="name">project.task.todo.tree.inherit</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="note.view_project_task_todo_tree"/>
        <field name="arch" type="xml">
            <tree position="attributes">
                <attribute name="js_class">todo_list</attribute>
            </tree>
        </field>
    </record>

    <!-- Override of to-do form to add the "convert to task" action (through a js override of formView) -->
    <record id="view_project_task_todo_form_with_conversion" model="ir.ui.view">
        <field name="name">project.task.todo.form.with.conversion</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="note.view_project_task_todo_form"/>
        <field name="mode">extension</field>
        <field name="arch" type="xml">
            <xpath expr="//form" position="attributes">
                <attribute name="js_class">todo_form_with_conversion</attribute>
            </xpath>
        </field>
    </record>
</odoo>
