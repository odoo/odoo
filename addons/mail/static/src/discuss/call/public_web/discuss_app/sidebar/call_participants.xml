<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="mail.DiscussSidebarCallParticipants">
        <t t-if="this.sessions.length gt 0">
            <Dropdown t-if="this.compact" state="this.floating" position="'right-start'" manual="true" menuClass="'o-mail-DiscussSidebar-floatingMenu ' + this.store.discussDropdownMenuClass(this)">
                <t t-call="mail.DiscussSidebarCallParticipants.main"/>
                <t t-set-slot="content">
                    <div class="p-2" t-ref="floating">
                        <t t-call="mail.DiscussSidebarCallParticipants.list">
                            <t t-set="isCompact" t-value="false"/>
                        </t>
                    </div>
                </t>
            </Dropdown>
            <t t-else="" t-call="mail.DiscussSidebarCallParticipants.main"/>
        </t>
    </t>

    <t t-name="mail.DiscussSidebarCallParticipants.main">
        <div class="o-mail-DiscussSidebarCallParticipants d-flex pb-1 bg-inherit" t-ref="root" t-att-class="{
            'justify-content-center': this.compact,
            'ps-3 pe-2': this.props.compact === undefined and !this.compact,
            'px-2': this.props.compact === false,
            'rounded-3': this.props.compact === undefined,
            'opacity-75': this.props.channel.notEq(this.rtc.channel) and this.compact,
        }">
            <button class="o-mail-DiscussSidebarCallParticipants-expandBtn btn btn-link p-1 my-n1 ms-n1 me-0 align-self-start d-flex rounded-circle" t-if="!this.compact" t-on-click="() => this.state.expanded = !this.state.expanded">
                <i class="oi o-xxsmaller text-muted text-dark" t-att-class="{'oi-chevron-right': !this.state.expanded, 'oi-chevron-down': this.state.expanded}" t-att-title="this.title"/>
            </button>
            <AvatarStack
                t-if="!this.state.expanded"
                direction="this.compact ? 'v' : 'h'"
                containerClass="this.compact ? '' : 'cursor-pointer o-mail-DiscussSidebarCallParticipants-avatarStack'"
                avatarClass="(p) => this.avatarClass(p)"
                max="this.compact ? 1 : 7"
                size="26"
                onClick.bind="this.onClickAvatarStack"
                personas="this.sessions.map((s) => s.channel_member_id?.persona).filter(p => p)"
            >
                <t t-if="this.compact" t-set-slot="avatarExtraInfo" t-slot-scope="scope">
                    <div class="o-mail-DiscussSidebarCallParticipants-status small" t-att-class="{
                        'position-absolute bg-inherit p-0 rounded-circle o-compact d-flex o-xsmaller text-start': this.compact,
                        'ms-1 d-flex align-items-center justify-content-center': !this.compact,
                    }">
                        <t t-call="mail.DiscussSidebarCallParticipants.participantShortStatus">
                            <t t-set="session" t-value="this.scope.persona.currentRtcSession"/>
                        </t>
                    </div>
                </t>
            </AvatarStack>
            <t t-else="" t-call="mail.DiscussSidebarCallParticipants.list">
                <t t-set="isCompact" t-value="this.compact"/>
            </t>
        </div>
    </t>

    <t t-name="mail.DiscussSidebarCallParticipants.list">
        <div class="d-flex flex-column gap-1 flex-grow-1 overflow-hidden" style="padding: 1.5px;">
            <t t-foreach="this.sessions" t-as="session" t-key="this.session.localId">
                <t t-call="mail.DiscussSidebarCallParticipants.participant">
                    <t t-set="session" t-value="this.session"/>
                </t>
            </t>
        </div>
    </t>

    <t t-name="mail.DiscussSidebarCallParticipants.participant">
        <div class="o-mail-DiscussSidebarCallParticipants-participant d-flex text-reset overflow-hidden align-items-center" t-att-class="this.attClass" t-on-click="(ev) => this.onClickParticipant(ev, session)">
            <div class="bg-inherit position-relative d-flex flex-shrink-0" style="width:26px;height:26px;margin:1px;">
                <img class="o-mail-DiscussSidebarCallParticipants-avatar w-100 h-100 rounded-circle object-fit-cover" t-att-src="session.channel_member_id?.avatarUrl" t-att-class="{'o-isTalking': !session.isMute and session.isTalking}" alt="Participant avatar" t-att-title="session.channel_member_id?.name"/>
            </div>
            <span t-if="!this.isCompact" class="o-mail-DiscussSidebarCallParticipants-name mx-1 text-truncate fw-bold smaller user-select-none" t-att-title="session.channel_member_id?.name" t-att-class="{ 'o-isTalking': !session.isMute and session.isTalking }">
                <t t-esc="this.session.channel_member_id?.name"/>
            </span>
            <div t-if="!this.isCompact" class="flex-grow-1"/>
            <div class="o-mail-DiscussSidebarCallParticipants-status small opacity-75" t-att-class="{ 'position-absolute bottom-0 end-0 bg-inherit p-0 rounded-circle o-compact d-flex o-xsmaller text-start': this.isCompact, 'ms-1 d-flex align-items-center justify-content-center': !this.isCompact }">
                <t t-if="this.isCompact" t-call="mail.DiscussSidebarCallParticipants.participantShortStatus">
                    <t t-set="session" t-value="this.session"/>
                </t>
                <t t-else="">
                    <span t-if="this.session.is_deaf" class="p-1 fa opacity-75" t-att-class="this.CALL_ICON_DEAFEN"/>
                    <span t-elif="this.session.is_muted" class="p-1 fa opacity-75" t-att-class="this.CALL_ICON_MUTED"/>
                    <span t-if="this.session.is_screen_sharing_on" class="o-live bg-danger o-text-white rounded">LIVE</span>
                </t>
            </div>
        </div>
    </t>


    <t t-name="mail.DiscussSidebarCallParticipants.participantShortStatus">
        <span t-if="this.session?.shortStatus" t-att-class="{
            [`${CALL_ICON_MUTED} opacity-75`]: session.shortStatus === 'mute',
            [`${CALL_ICON_DEAFEN} opacity-75`]: session.shortStatus === 'deafen',
            'o-live bg-danger o-text-white rounded': session.shortStatus === 'live',
        }"><t t-if="this.session.shortStatus === 'live'">LIVE</t></span>
    </t>

</templates>
