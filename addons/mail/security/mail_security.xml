<?xml version="1.0" encoding="utf-8"?>
<odoo noupdate="1">
        <!--
            =====================================================
            | CHANNEL ACCESS
            =====================================================
        !-->

        <record id="ir_rule_discuss_channel_everyone_access_public" model="ir.rule">
            <field name="name">discuss.channel: anyone can access public channels</field>
            <field name="model_id" ref="mail.model_discuss_channel"/>
            <field name="groups"
                eval="[
                    Command.link(ref('base.group_user')),
                    Command.link(ref('base.group_portal')),
                    Command.link(ref('base.group_public')),
                ]"
            />
            <field name="domain_force">[("access_type", "=", "public")]</field>
        </record>

        <record id="ir_rule_discuss_channel_internal_access_internal" model="ir.rule">
            <field name="name">dicuss.channel: internal users can access internal channels</field>
            <field name="model_id" ref="mail.model_discuss_channel"/>
            <field name="groups" eval="[(4, ref('base.group_user'))]"/>
            <field name="domain_force">[("access_type", "=", "internal")]</field>
        </record>

        <record id="ir_rule_discuss_channel_internal_access_invite_only" model="ir.rule">
            <field name="name">discuss.channel: members can access channels</field>
            <field name="model_id" ref="mail.model_discuss_channel"/>
            <field name="groups" eval="[Command.link(ref('base.group_user'))]"/>
            <field name="domain_force">
                [
                    ("access_type", "=", "invite_only"),
                    "|",
                        ("is_member", "=", True),
                        ("parent_channel_id.is_member", "=", True),
                ]
            </field>
        </record>

        <record id="ir_rule_discuss_channel_everyone_non_channel" model="ir.rule">
            <field name="name">discuss.channel: members can access channels (non-channel)</field>
            <field name="model_id" ref="mail.model_discuss_channel"/>
            <field name="groups"
                eval="[
                    Command.link(ref('base.group_user')),
                    Command.link(ref('base.group_portal')),
                    Command.link(ref('base.group_public')),
                ]"
            />
            <field name="domain_force">
                [
                    ("channel_type", "!=", "channel"),
                    "|",
                        ("is_member", "=", True),
                        ("parent_channel_id.is_member", "=", True),
                ]
            </field>
        </record>

        <record id="ir_rule_discuss_channel_group_system" model="ir.rule">
            <field name="name">discuss.channel: admin full access</field>
            <field name="model_id" ref="mail.model_discuss_channel"/>
            <field name="groups" eval="[Command.link(ref('base.group_system'))]"/>
            <field name="domain_force">[(1, '=', 1)]</field>
        </record>

        <!--
            =====================================================
            | MEMBER ACCESS
            =====================================================
        !-->


        <!-- TODO TSM: why not just allowing is_self=True? It's the user
        member afterall, nevermind if the channel is not accesible. It
        was once, so the user already know the channel exists -->

        <record id="ir_rule_discuss_channel_member_internal_read_unlink_self" model="ir.rule">
            <field name="name">discuss.channel.member: internal users can access their own entries</field>
            <field name="model_id" ref="mail.model_discuss_channel_member"/>
            <field name="groups"
                eval="[Command.link(ref('base.group_user'))]"
            />
            <field name="domain_force">[("is_self", "=", True)]</field>
            <!--
                create() is controlled by other rules because create() rules are applied after the record contains
                its data, which means just using 'is_self' would allow any user to add themselves in any channel.
            -->
            <field name="perm_create" eval="False"/>
            <!--
                read() is controlled by other rules, in particular the current rule for reading self member is
                "contained" within the rule for reading any member of accessible channel which is more generic.
            -->
            <field name="perm_read" eval="False"/>
        </record>

        <record id="ir_rule_discuss_channel_member_external_read_unlink_self" model="ir.rule">
            <field name="name">discuss.channel.member: external users can access their own entries on accessible channels</field>
            <field name="model_id" ref="mail.model_discuss_channel_member"/>
            <field name="groups"
                eval="[
                    Command.link(ref('base.group_portal')),
                    Command.link(ref('base.group_public')),
                ]"
            />
            <field name="domain_force">
                [
                    ("is_self", "=", True),
                    "|",
                        ("channel_id.access_type", "=", "public"),
                        ("channel_id.channel_type", "!=", "channel"),
                ]
            </field>
            <!--
                create() is controlled by other rules because create() rules are applied after the record contains
                its data, which means just using 'is_self' would allow any user to add themselves in any channel.
            -->
            <field name="perm_create" eval="False"/>
            <!--
                read() is controlled by other rules, in particular the current rule for reading self member is
                "contained" within the rule for reading any member of accessible channel which is more generic.
            -->
            <field name="perm_read" eval="False"/>
        </record>

        <!-- TODO tsm ===================================== END -->

        <record id="ir_rule_discuss_channel_member_everyone_read_access_public" model="ir.rule">
            <field name="name">discuss.channel.members: read members of accessible channels (public)</field>
            <field name="model_id" ref="mail.model_discuss_channel_member"/>
            <field name="groups"
                eval="[
                    Command.link(ref('base.group_user')),
                    Command.link(ref('base.group_portal')),
                    Command.link(ref('base.group_public')),
                ]"
            />
            <field name="domain_force">[("channel_id.access_type", "=", "public")]</field>
            <field name="perm_create" eval="False"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <record id="ir_rule_discuss_channel_member_internal_read_access_internal" model="ir.rule">
            <field name="name">discuss.channel.members: read members of accessible channels (internal)</field>
            <field name="model_id" ref="mail.model_discuss_channel_member"/>
            <field name="groups" eval="[(4, ref('base.group_user'))]"/>
            <field name="domain_force">[("channel_id.access_type", "=", "internal")]</field>
            <field name="perm_create" eval="False"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <record id="ir_rule_discuss_channel_member_internal_read_access_invite_only" model="ir.rule">
            <field name="name">discuss.channel.members: read members of accessible channels (invite-only)</field>
            <field name="model_id" ref="mail.model_discuss_channel_member"/>
            <field name="groups"
                eval="[Command.link(ref('base.group_user'))]"/>
            <field name="domain_force">
                [
                    ("channel_id.access_type", "=", "invite_only"),
                    "|",
                        ("channel_id.is_member", "=", True),
                        ("channel_id.parent_channel_id.is_member", "=", True),
                ]
            </field>
            <field name="perm_create" eval="False"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <record id="ir_rule_discuss_channel_member_everyone_read_non_channel" model="ir.rule">
            <field name="name">discuss.channel.members: read members accessible channels (non-channels)</field>
            <field name="model_id" ref="mail.model_discuss_channel_member"/>
            <field name="groups"
                eval="[
                    Command.link(ref('base.group_user')),
                    Command.link(ref('base.group_portal')),
                    Command.link(ref('base.group_public')),
                ]"
            />
            <field name="domain_force">
                [
                    ("channel_id.channel_type", "!=", "channel"),
                    "|",
                        ("channel_id.is_member", "=", True),
                        ("channel_id.parent_channel_id.is_member", "=", True),
                ]
            </field>
            <field name="perm_create" eval="False"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <record id="ir_rule_discuss_channel_member_is_channel_owner_unlink" model="ir.rule">
            <field name="name">discuss.channel.member: channel owner can remove members except owners</field>
            <field name="model_id" ref="mail.model_discuss_channel_member"/>
            <field name="groups"
                eval="[
                    Command.link(ref('base.group_user')),
                    Command.link(ref('base.group_portal')),
                    Command.link(ref('base.group_public')),
                ]"
            />
            <field name="domain_force">
                [
                    ("channel_id.self_member_id.channel_role", "=", "owner"),
                    ("channel_role", "!=", "owner"),
                    "|",
                        ("channel_id.channel_type", "=", "channel"),
                        ("channel_id.channel_type", "=", "group"),
                ]
            </field>
            <field name="perm_create" eval="False"/>
            <field name="perm_read" eval="False"/>
            <field name="perm_write" eval="False"/>
        </record>

        <record id="ir_rule_discuss_channel_member_is_channel_admin_unlink" model="ir.rule">
            <field name="name">discuss.channel.member: channel admin can remove members except admins and owners</field>
            <field name="model_id" ref="mail.model_discuss_channel_member"/>
            <field name="groups"
                eval="[
                    Command.link(ref('base.group_user')),
                    Command.link(ref('base.group_portal')),
                    Command.link(ref('base.group_public')),
                ]"
            />
            <field name="domain_force">
                [
                    ("channel_id.self_member_id.channel_role", "=", "admin"),
                    ("channel_role", "=", False),
                    "|",
                        ("channel_id.channel_type", "=", "channel"),
                        ("channel_id.channel_type", "=", "group"),
                ]
            </field>
            <field name="perm_create" eval="False"/>
            <field name="perm_read" eval="False"/>
            <field name="perm_write" eval="False"/>
        </record>

       <record id="ir_rule_discuss_channel_member_external_join_access_public" model="ir.rule">
            <field name="name">discuss.channel.members: public/portal can join public channel</field>
            <field name="model_id" ref="mail.model_discuss_channel_member"/>
            <!-- Internal users are handled below in a rule taken both invite and join into account -->
            <field name="groups"
                eval="[
                    Command.link(ref('base.group_portal')),
                    Command.link(ref('base.group_public')),
                ]"
            />
            <field name="domain_force">
                [
                    ("is_self", "=", True),
                    "|",
                        ("channel_id.access_type", "=", "public"),
                        ("channel_id.channel_type", "!=", "channel"),
                ]
            </field>
            <field name="perm_read" eval="False"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_unlink" eval="False"/>
       </record>

       <record id="ir_rule_discuss_channel_member_internal_join_sub_channel_access_invite_only_or_non_channel" model="ir.rule">
            <field name="name">discuss.channel.members: internal members can join sub-channel (invite-only and non-channel)</field>
            <field name="model_id" ref="mail.model_discuss_channel_member"/>
            <field name="groups" eval="[(4, ref('base.group_user'))]"/>
            <field name="domain_force">
                [
                    ("is_self", "=", True),
                    ("channel_id.parent_channel_id.is_member", "=", True),
                    "|",
                        ("channel_id.channel_type", "!=", "channel"),
                        ("channel_id.access_type", "=", "invite_only"),
                ]
            </field>
       </record>

        <record id="ir_rule_discuss_channel_member_internal_create_access_public" model="ir.rule">
            <field name="name">discuss.channel.members: internal users can create members in public channels</field>
            <field name="model_id" ref="mail.model_discuss_channel_member"/>
            <field name="groups" eval="[(4, ref('base.group_user'))]"/>
            <field name="domain_force">[("channel_id.access_type", "=", "public")]</field>
            <field name="perm_read" eval="False"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <record id="ir_rule_discuss_channel_member_internal_create_access_internal" model="ir.rule">
            <field name="name">discuss.channel.members: internal users can create internal members in internal channels</field>
            <field name="model_id" ref="mail.model_discuss_channel_member"/>
            <field name="groups" eval="[(4, ref('base.group_user'))]"/>
            <field name="domain_force">[("channel_id.access_type", "=", "internal"), ("partner_id.partner_share", "=", False)]</field>
            <field name="perm_read" eval="False"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <record id="ir_rule_discuss_channel_member_internal_create_access_invite_only_or_non_channel" model="ir.rule">
            <field name="name">discuss.channel.members: internal members can invite others (invite-only and non-channel)</field>
            <field name="model_id" ref="mail.model_discuss_channel_member"/>
            <field name="groups" eval="[(4, ref('base.group_user'))]"/>
            <field name="domain_force">
                [
                    ("is_self", "=", False),
                    ("channel_id.is_member", "=", True),
                    "|",
                        ('channel_id.channel_type', 'not in', ('channel', 'chat')),
                        "&amp;",
                            ("channel_id.access_type", "=", "invite_only"),
                            ("partner_id.partner_share", "=", False),
                ]
            </field>
            <!--
                create() for the current user is controlled by other rules because create() rules are applied after the record
                contains its data, which means allowing 'is_self' would allow any user to add themselves in any channel.
            -->
            <field name="perm_read" eval="False"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <record id="ir_rule_discuss_channel_member_group_system" model="ir.rule">
            <field name="name">discuss.channel.member: admin can manipulate all entries</field>
            <field name="model_id" ref="mail.model_discuss_channel_member"/>
            <field name="groups" eval="[Command.link(ref('base.group_system'))]"/>
            <field name="domain_force">[(1, '=', 1)]</field>
        </record>

        <!--
            =====================================================
            | CALL HISTORY ACCESS
            =====================================================
        !-->

        <record id="ir_rule_discuss_call_history_read_all_access_public" model="ir.rule">
            <field name="name">discuss.call.history: read call history of accessible channels (public)</field>
            <field name="model_id" ref="mail.model_discuss_call_history"/>
            <field name="groups"
                eval="[
                    Command.link(ref('base.group_user')),
                    Command.link(ref('base.group_portal')),
                    Command.link(ref('base.group_public')),
                ]"
            />
            <field name="domain_force">[("channel_id.access_type", "=", "public")]</field>
            <field name="perm_create" eval="False"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <record id="ir_rule_discuss_call_history_read_all_access_internal" model="ir.rule">
            <field name="name">discuss.call.history: read call history of accessible channels (internal)</field>
            <field name="model_id" ref="mail.model_discuss_call_history"/>
            <field name="groups" eval="[Command.link(ref('base.group_user'))]"/>
            <field name="domain_force">[("channel_id.access_type", "=", "internal")]</field>
            <field name="perm_create" eval="False"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <record id="ir_rule_discuss_call_history_read_all_access_invite_only" model="ir.rule">
            <field name="name">discuss.call.history: read call history of accessible channels (invite_only)</field>
            <field name="model_id" ref="mail.model_discuss_call_history"/>
            <field name="groups" eval="[Command.link(ref('base.group_user'))]"/>
            <field name="domain_force">
                [
                    ("channel_id.is_member", "=", True),
                    "|",
                        ("channel_id.channel_type", "!=", "channel"),
                        ("channel_id.access_type", "=", "invite_only"),
                ]
            </field>
            <field name="perm_create" eval="False"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!--
            =====================================================
            | GIF FAVORITE ACCESS
            =====================================================
        !-->

        <record id="discuss_gif_favorite_user_rule" model="ir.rule">
            <field name="name">Discuss.gif.favorite: User access</field>
            <field name="model_id" ref="model_discuss_gif_favorite"/>
            <field name="groups" eval="[Command.link(ref('base.group_user'))]"/>
            <field name="domain_force">[('create_uid', '=', user.id)]</field>
        </record>

        <record id="discuss_gif_favorite_admin_rule" model="ir.rule">
            <field name="name">Discuss.gif.favorite: admin full access</field>
            <field name="model_id" ref="model_discuss_gif_favorite"/>
            <field name="groups" eval="[Command.link(ref('base.group_erp_manager'))]"/>
            <field name="domain_force">[(1, '=', 1)]</field>
        </record>

        <record id="ir_rule_mail_notifications_group_user" model="ir.rule">
            <field name="name">mail.notifications: group_user: write its own entries</field>
            <field name="model_id" ref="model_mail_notification"/>
            <field name="groups" eval="[Command.link(ref('base.group_user')), Command.link(ref('base.group_portal'))]"/>
            <field name="domain_force">[('res_partner_id', '=', user.partner_id.id)]</field>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
            <field name="perm_read" eval="False"/>
        </record>

        <record id="ir_rule_mail_notifications_group_portal" model="ir.rule">
            <field name="name">mail.notifications: group_portal: own entries</field>
            <field name="model_id" ref="model_mail_notification"/>
            <field name="groups" eval="[Command.link(ref('base.group_portal'))]"/>
            <field name="domain_force">['|', ('res_partner_id', '=', user.partner_id.id), ('author_id', '=', user.partner_id.id)]</field>
        </record>

        <record id="mail_message_subtype_rule_public" model="ir.rule">
            <field name="name">mail.message.subtype: portal/public: read public subtypes</field>
            <field name="model_id" ref="model_mail_message_subtype"/>
            <field name="domain_force">[('internal', '=', False)]</field>
            <field name="groups" eval="[Command.link(ref('base.group_portal')), Command.link(ref('base.group_public'))]"/>
        </record>

        <record id="mail_activity_rule_user" model="ir.rule">
            <field name="name">mail.activity: user: write/unlink only (created or assigned)</field>
            <field name="model_id" ref="model_mail_activity"/>
            <field name="domain_force">['|', ('user_id', '=', user.id), ('create_uid', '=', user.id)]</field>
            <field name="groups" eval="[Command.link(ref('base.group_user'))]"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_read" eval="False"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <record id="mail_activity_plan_rule_admin" model="ir.rule">
            <field name="name">Administrators can access all activity plans.</field>
            <field name="model_id" ref="model_mail_activity_plan"/>
            <field name="groups" eval="[Command.link(ref('base.group_system'))]"/>
            <field name="domain_force">[(1, '=', 1)]</field>
        </record>

        <record id="mail_activity_plan_template_rule_admin" model="ir.rule">
            <field name="name">Administrators can access all activity plan templates.</field>
            <field name="model_id" ref="model_mail_activity_plan_template"/>
            <field name="groups" eval="[Command.link(ref('base.group_system'))]"/>
            <field name="domain_force">[(1, '=', 1)]</field>
        </record>

        <record id="mail_compose_message_rule" model="ir.rule">
            <field name="name">Mail Compose Message Rule</field>
            <field name="model_id" ref="model_mail_compose_message"/>
            <field name="domain_force">[('create_uid', '=', user.id)]</field>
            <field name="perm_create" eval="False"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <record id="mail_template_employee_rule" model="ir.rule">
            <field name="name">Employees can only modify templates they have created or been assigned</field>
            <field name="model_id" ref="model_mail_template"/>
            <field name="domain_force">['|', ('create_uid', '=', user.id), ('user_id', '=', user.id)]</field>
            <field name="groups" eval="[Command.link(ref('base.group_user'))]"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_read" eval="False"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <record id="mail_template_editor_rule" model="ir.rule">
            <field name="name">Mail Template Editors - Edit All Templates</field>
            <field name="model_id" ref="model_mail_template"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[Command.link(ref('group_mail_template_editor')), Command.link(ref('base.group_system'))]"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_read" eval="False"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <record id="res_users_settings_volumes_rule_user" model="ir.rule">
            <field name="name">res.users.settings.volumes: access their own entries</field>
            <field name="model_id" ref="model_res_users_settings_volumes"/>
            <field name="groups" eval="[Command.link(ref('base.group_user'))]"/>
            <field name="domain_force">[('user_setting_id.user_id', '=', user.id)]</field>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <record id="res_users_settings_volumes_rule_admin" model="ir.rule">
            <field name="name">Administrators can access all User Settings volumes.</field>
            <field name="model_id" ref="model_res_users_settings_volumes"/>
            <field name="groups" eval="[Command.link(ref('base.group_system'))]"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <record id="ir_rule_mail_canned_response_admin" model="ir.rule">
            <field name="name">Canned response: admin has all access on shared canned response</field>
            <field name="model_id" ref="model_mail_canned_response"/>
            <field name="groups" eval="[Command.link(ref('group_mail_canned_response_admin'))]"/>
            <field name="domain_force">[('is_shared', '=', True)]</field>
            <field name="perm_create" eval="False"/>
        </record>

        <!-- Internal user: rationale is that they read their own or the one belonging to
        their user groups. They can modify only their own -->
        <record id="ir_rule_mail_canned_response_user_read" model="ir.rule">
            <field name="name">Canned response: User read: own or in groups</field>
            <field name="model_id" ref="model_mail_canned_response"/>
            <field name="groups" eval="[Command.link(ref('base.group_user'))]"/>
            <field name="domain_force">['|', ('create_uid', '=', user.id), ('group_ids', 'in', user.all_group_ids.ids)]</field>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>
        <record id="ir_rule_mail_canned_response_user_update" model="ir.rule">
            <field name="name">Canned response: User write/unlink: own only</field>
            <field name="model_id" ref="model_mail_canned_response"/>
            <field name="groups" eval="[Command.link(ref('base.group_user'))]"/>
            <field name="domain_force">[('create_uid', '=', user.id)]</field>
            <field name="perm_create" eval="False"/>
            <field name="perm_read" eval="False"/>
        </record>
        <record id="ir_rule_mail_scheduled_message_user" model="ir.rule">
            <field name="model_id" ref="model_mail_scheduled_message"/>
            <field name="domain_force">[('create_uid', '=', user.id)]</field>
            <field name="perm_read" eval="False"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="False"/>
        </record>
</odoo>
