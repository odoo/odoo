<?xml version="1.0" encoding="UTF-8" ?>
<odoo>

    <template id="l10n_pt_partner_vat">
        <div t-if="o.company_id.account_fiscal_country_id.code == 'PT' and not o.partner_id.vat">
            <t t-out="'Consumidor final'"/>
        </div>
    </template>

    <template id="report_invoice_document" inherit_id="account.report_invoice_document" primary="True">
        <!-- Add tax exemption reason: exemption code in the line and explanation of exemption reason before tax legal notes -->
        <xpath expr="//td[@name='td_taxes']" position="inside">
            <t t-if="o.company_id.account_fiscal_country_id.code == 'PT'">
                <t t-set="pt_line_tax_exemption_reasons" t-value="line._l10n_pt_get_line_vat_exemptions_reasons()"/>
                <span t-out="pt_line_tax_exemption_reasons"/>
            </t>
        </xpath>
        <xpath expr="//p[@name='taxes_legal_notes']" position="before">
            <t t-set="pt_tax_exemption_reasons" t-value="o._l10n_pt_get_vat_exemptions_reasons()"/>
            <t t-if="o.company_id.account_fiscal_country_id.code == 'PT' and pt_tax_exemption_reasons
                     and o.move_type in ('out_invoice', 'out_refund', 'out_receipt')">
                <div><strong>Motivos de isenção de IVA:</strong></div>
                <t t-foreach="pt_tax_exemption_reasons" t-as="reason">
                    <div><t t-out="reason"/></div>
                </t>
                <br/>
            </t>
        </xpath>

        <!-- If the customer has no VAT, we must show 'Consumidor final' -->
        <xpath expr="//div[@id='partner_vat_address_not_same_as_shipping']" position="after">
            <t t-call="l10n_pt_certification.l10n_pt_partner_vat"/>
        </xpath>
        <xpath expr="//div[@id='partner_vat_address_same_as_shipping']" position="after">
            <t t-call="l10n_pt_certification.l10n_pt_partner_vat"/>
        </xpath>
        <xpath expr="//div[@id='partner_vat_no_shipping']" position="after">
            <t t-call="l10n_pt_certification.l10n_pt_partner_vat"/>
        </xpath>

        <!-- Add Unique Document Number -->
        <xpath expr="//t[@t-set='layout_document_title']" position="replace">
            <t t-set="layout_document_title">
                <t t-if="o.company_id.account_fiscal_country_id.code == 'PT'">
                    <span t-if="not proforma"></span>
                    <span t-else="">PROFORMA</span>
                    <span t-if="o.l10n_pt_document_number" t-field="o.l10n_pt_document_number">FS 2023/0001</span>
                    <span>-</span>
                    <span t-out="dict(o.fields_get(allfields=['l10n_pt_document_type'])['l10n_pt_document_type']['selection'])[o.l10n_pt_document_type]"/>
                </t>
                <t t-else="">$0</t>
            </t>
        </xpath>

        <!-- QR Code -->
        <xpath expr="//div[@id='qrcode']" position="after">
            <t t-if="o.company_id.account_fiscal_country_id.code == 'PT' and o.l10n_pt_qr_code_str">
                <div>
                    ATCUD: <t t-out="o.l10n_pt_atcud"/>
                </div>
                <img style="margin: 0.25cm;"
                     t-att-src="'/report/barcode/?barcode_type=%s&amp;value=%s&amp;width=%s&amp;height=%s'%('QR', o.l10n_pt_qr_code_str, 125, 125)"
                />
            </t>
        </xpath>

        <!-- Add accumulated amount column -->
        <xpath expr="//th[@name='th_subtotal']" position="after">
            <th t-if="o.company_id.account_fiscal_country_id.code == 'PT' and len(o.invoice_line_ids) &gt; 5 and report_type == 'pdf'"
                name="th_subtotal_accumulated"
                class="text-end">
                <span>Accumulated</span>
            </th>
        </xpath>
        <xpath expr="//td[@name='td_subtotal']" position="after">
            <td t-if="o.company_id.account_fiscal_country_id.code == 'PT' and len(o.invoice_line_ids) &gt; 5 and report_type == 'pdf'"
                name="th_subtotal_accumulated_tax"
                class="text-end">
                <span class="text-nowrap"
                      t-out="current_subtotal"
                      t-options='{"widget": "monetary", "display_currency": o.currency_id}'
                />
            </td>
        </xpath>

        <!-- Disable the accumulated amount resetting happening after a line section -->
        <xpath expr="//tr[hasclass('is-subtotal')]" position="replace">
            <t t-if="o.company_id.account_fiscal_country_id.code == 'PT'"/>
            <t t-else="">$0</t>
        </xpath>
        <xpath expr="//t[@id='reset_current_subtotal']" position="replace">
            <t t-if="o.company_id.account_fiscal_country_id.code == 'PT'"/>
            <t t-else="">$0</t>
        </xpath>

        <!-- Add document name as internal number -->
        <xpath expr="//div[@name='reference']" position="after">
            <div class="col" t-if="o.name and o.name != '/'" name="internal_number">
                <strong>Internal Number</strong>
                <div t-field="o.name">INV/2023/00001</div>
            </div>
        </xpath>

        <!-- Display l10n_pt_line_discount instead of discount in line -->
        <xpath expr="//td[@name='td_discount']" position="replace">
            <t t-if="o.company_id.account_fiscal_country_id.code == 'PT'">
                <td name="td_discount" t-if="display_discount" t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                    <span class="text-nowrap" t-field="line.l10n_pt_line_discount">0</span>
                </td>
            </t>
            <t t-else="">$0</t>
        </xpath>

        <!-- Add global discount -->
        <xpath expr="//div[@id='total']" position="before">
            <t t-if="o.company_id.account_fiscal_country_id.code == 'PT' and o.l10n_pt_global_discount">
                <div class="pb-4">
                    Global Discount: <t t-out="str(o.l10n_pt_global_discount) + ' %'"/>
                </div>
            </t>
        </xpath>
    </template>

    <template id="report_invoice" inherit_id="account.report_invoice">
        <xpath expr='//t[@t-call="account.report_invoice_document"]' position="after">
            <t t-elif="o._get_name_invoice_report() == 'l10n_pt_certification.report_invoice_document'"
               t-call="l10n_pt_certification.report_invoice_document"
               t-lang="lang"/>
        </xpath>
    </template>
</odoo>
