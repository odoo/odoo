<?xml version='1.0' encoding='utf-8'?>
<odoo>
    <data>
        <template id="template_invoice_main_post">
            <T:TicketBai xmlns:T="urn:ticketbai:emision">
                <t t-call="l10n_es_edi_tbai.template_invoice_bundle"/>
            </T:TicketBai>
        </template>

        <template id="template_invoice_main_cancel">
            <T:AnulaTicketBai xmlns:T="urn:ticketbai:anulacion">
                <t t-call="l10n_es_edi_tbai.template_invoice_bundle"/>
            </T:AnulaTicketBai>
        </template>

        <template id="template_invoice_bundle">
            <Cabecera>
                <IDVersionTBAI t-out="tbai_version"/>
            </Cabecera>
            <Sujetos t-if="is_emission">
                <t t-call="l10n_es_edi_tbai.template_invoice_sujetos"/>
            </Sujetos>
            <Factura t-if="is_emission">
                <t t-call="l10n_es_edi_tbai.template_invoice_factura"/>
            </Factura>
            <IDFactura t-if="not is_emission">
                <t t-call="l10n_es_edi_tbai.template_invoice_sujetos"/>
                <t t-call="l10n_es_edi_tbai.template_invoice_factura"/>
            </IDFactura>
            <HuellaTBAI>
                <EncadenamientoFacturaAnterior t-if="chain_prev_invoice">
                    <SerieFacturaAnterior t-out="chain_prev_invoice.l10n_es_tbai_sequence"/>
                    <NumFacturaAnterior t-out="chain_prev_invoice.l10n_es_tbai_number"/>
                    <FechaExpedicionFacturaAnterior t-out="datetime_strftime(chain_prev_invoice.l10n_es_tbai_registration_date, '%d-%m-%Y')"/>
                    <SignatureValueFirmaFacturaAnterior t-out="chain_prev_invoice.l10n_es_tbai_signature[:100]"/>
                </EncadenamientoFacturaAnterior>
                <Software>
                    <LicenciaTBAI>TBAI-LICENSE-KEY</LicenciaTBAI>
                    <EntidadDesarrolladora>
                        <NIF>B20990602</NIF>
                    </EntidadDesarrolladora>
                    <Nombre>Odoo Officiel GRPZ 1367</Nombre>
                    <Version>15.0+e</Version>
                </Software>
                <NumSerieDispositivo>TEST-DEVICE-001</NumSerieDispositivo>
            </HuellaTBAI>
        </template>

        <template id="template_invoice_sujetos">
            <Emisor>
                <NIF t-out="sender_vat"/>
                <ApellidosNombreRazonSocial t-out="sender.name"/>
            </Emisor>
            <Destinatarios t-if="is_emission and not is_simplified">
                <!-- TODO simplified invoices can have Destinatario ! Not compatible with current way to compute is_simplified. When compatible, use t-if="is_emission and len(recipients) > 0" -->
                <IDDestinatario t-foreach="recipients" t-as="recipient">
                    <NIF t-if="recipient.get('nif')" t-out="recipient['nif']"/>
                    <IDOtro t-else="">
                        <CodigoPais t-if="recipient.get('alt_id_country')" t-out="recipient['alt_id_country']"/>
                        <IDType t-out="recipient['alt_id_type']"/>
                        <ID t-out="recipient['alt_id_number']"/>
                    </IDOtro>
                    <t t-set="partner" t-value="recipient['partner']"/>
                    <ApellidosNombreRazonSocial t-out="partner.name"/>
                    <CodigoPostal t-out="partner.zip"/>
                    <Direccion t-out="recipient['partner_address']"/>
                </IDDestinatario>
            </Destinatarios>
            <VariosDestinatarios t-if="is_emission">N</VariosDestinatarios>
            <!-- Odoo does not support multi-recipient invoices-->
            <EmitidaPorTercerosODestinatario t-if="is_emission" t-out="thirdparty_or_recipient"/>
        </template>

        <template id="template_invoice_factura">
            <CabeceraFactura>
                <SerieFactura t-out="invoice.l10n_es_tbai_sequence"/>
                <NumFactura t-out="invoice.l10n_es_tbai_number"/>
                <FechaExpedicionFactura t-if="not is_emission" t-out="datetime_strftime(invoice.l10n_es_tbai_registration_date, '%d-%m-%Y')"/>
                <FechaExpedicionFactura t-if="is_emission" t-out="datetime_strftime(datetime_now, '%d-%m-%Y')"/>
                <HoraExpedicionFactura t-if="is_emission" t-out="datetime_strftime(datetime_now, '%H:%M:%S')"/>
                <FacturaSimplificada t-if="is_emission" t-out="'S' if is_simplified else 'N'"/>
                <!-- <FacturaEmitidaSustitucionSimplificada/> TODO True iff is_refund, where rectified invoice is 'simplified' -->
                <FacturaRectificativa t-if="credit_note_invoices">
                    <Codigo t-out="credit_note_code"/>
                    <Tipo>I</Tipo>
                    <!-- TODO also allow credit note Tipo 'S' ? Seems optional.
                    <ImporteRectificacionSustitutiva>
                        <BaseRectificada>180.00</BaseRectificada>
                        <CuotaRectificada>20.21</CuotaRectificada>
                    </ImporteRectificacionSustitutiva> -->
                </FacturaRectificativa>
                <FacturasRectificadasSustituidas t-if="is_refund">
                    <IDFacturaRectificadaSustituida t-foreach="credit_note_invoices" t-as="c_note">
                        <SerieFactura t-out="c_note.l10n_es_tbai_sequence"/>
                        <NumFactura t-out="c_note.l10n_es_tbai_number"/>
                        <FechaExpedicionFactura t-out="datetime_strftime(c_note.l10n_es_tbai_registration_date, '%d-%m-%Y')"/>
                    </IDFacturaRectificadaSustituida>
                </FacturasRectificadasSustituidas>
            </CabeceraFactura>
            <DatosFactura t-if="is_emission">
                <DescripcionFactura t-out="invoice.invoice_origin or 'manual'"/>
                <DetallesFactura>
                    <IDDetalleFactura t-foreach="invoice_lines" t-as="line_value">
                        <t t-set="line" t-value="line_value['line']"/>
                        <DescripcionDetalle t-esc="line_value['address']"/>
                        <Cantidad t-out="float_repr(line.quantity)"/>
                        <ImporteUnitario t-out="float_repr(line.price_unit * (-1 if is_refund else 1))"/>
                        <Descuento t-out="float_repr(line.discount or 0)"/>
                        <ImporteTotal t-out="float_repr(line.price_total * (-1 if is_refund else 1))"/>
                    </IDDetalleFactura>
                </DetallesFactura>
                <ImporteTotalFactura t-out="float_repr(invoice_total)"/>
                <!-- <RetencionSoportada/> TODO -->
                <!-- <BaseImponibleACoste/> TODO -->
                <Claves>
                    <IDClave>
                        <ClaveRegimenIvaOpTrascendencia t-out="vat_regime_code"/>
                        <!-- TODO there can be multiple (up to three?) keys -->
                    </IDClave>
                </Claves>
            </DatosFactura>
            <TipoDesglose t-if="is_emission">
                <DesgloseFactura t-if="invoice_breakdown">
                    <t t-call="l10n_es_edi_tbai.template_invoice_desglose">
                        <t t-set="breakdown" t-value="invoice_breakdown"/>
                    </t>
                </DesgloseFactura>
                <DesgloseTipoOperacion t-if="services_provision or goods_delivery">
                    <PrestacionServicios t-if="services_provision">
                        <t t-call="l10n_es_edi_tbai.template_invoice_desglose">
                            <t t-set="breakdown" t-value="services_provision"/>
                        </t>
                    </PrestacionServicios>
                    <Entrega t-if="goods_delivery">
                        <t t-call="l10n_es_edi_tbai.template_invoice_desglose">
                            <t t-set="breakdown" t-value="goods_delivery"/>
                        </t>
                    </Entrega>
                </DesgloseTipoOperacion>
            </TipoDesglose>
        </template>

        <template id="template_invoice_desglose">
            <Sujeta t-if="breakdown.get('Sujeta')">
                <t t-set="su" t-value="breakdown['Sujeta']"/>
                <Exenta t-if="su.get('Exenta')">
                    <DetalleExenta t-foreach="su['Exenta']['DetalleExenta']" t-as="ex">
                        <CausaExencion t-out="ex['CausaExencion']"/>
                        <BaseImponible t-out="float_repr(ex['BaseImponible'])"/>
                    </DetalleExenta>
                </Exenta>
                <NoExenta t-if="su.get('NoExenta')">
                    <t t-set="nex" t-value="su['NoExenta']"/>
                    <DetalleNoExenta>
                        <!-- DetalleNoExenta: Up to 2 (not 3!), grouped by TipoNoExenta t-foreach='nex_list' t-as="nex"-->
                        <TipoNoExenta t-out="nex['TipoNoExenta']"/>
                        <DesgloseIVA>
                            <DetalleIVA t-foreach="nex['DesgloseIVA']['DetalleIVA']" t-as="det">
                                <!-- DetalleIVA: Should distinguish by 'tipos' (OK if recargo/not recargo never mixed)
                                CHECK if different tax types get separated-->
                                <BaseImponible t-out="float_repr(det['BaseImponible'])"/>
                                <TipoImpositivo t-out="float_repr(det['TipoImpositivo'])"/>
                                <CuotaImpuesto t-out="float_repr(det['CuotaRepercutida'])"/>
                                <TipoRecargoEquivalencia t-if="det.get('TipoRecargoEquivalencia')" t-out="float_repr(det['TipoRecargoEquivalencia'])"/>
                                <CuotaRecargoEquivalencia t-if="det.get('CuotaRecargoEquivalencia')" t-out="float_repr(det['CuotaRecargoEquivalencia'])"/>
                                <OperacionEnRecargoDeEquivalenciaORegimenSimplificado t-out="'S' if (is_simplified or det.get('TipoRecargoEquivalencia')) else 'N'"/>
                            </DetalleIVA>
                        </DesgloseIVA>
                    </DetalleNoExenta>
                </NoExenta>
            </Sujeta>
            <NoSujeta t-if="breakdown.get('NoSujeta')">
                <t t-set="nsu" t-value="breakdown['NoSujeta']"/>
                <DetalleNoSujeta>
                    <Causa>RL</Causa>
                    <!-- TODO should be 'OT' if 'the' ClaveRegimen == 10, should be 'RL' if 'some' ClaveRegimen == 08-->
                    <Importe t-out="nsu['ImporteTAIReglasLocalizacion']"/>
                </DetalleNoSujeta>
            </NoSujeta>
        </template>

        <template id="template_digital_signature">
            <ds:Signature t-att-Id="dsig['signature_id']"
                xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
                <ds:SignedInfo>
                    <ds:CanonicalizationMethod Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"/>
                    <ds:SignatureMethod Algorithm="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256"/>
                    <ds:Reference t-att-Id="dsig['reference_uri']" Type="http://www.w3.org/2000/09/xmldsig#Object" URI="">
                        <ds:Transforms>
                            <ds:Transform Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"/>
                            <ds:Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/>
                            <ds:Transform Algorithm="http://www.w3.org/TR/1999/REC-xpath-19991116">
                                <ds:XPath>not(ancestor-or-self::ds:Signature)</ds:XPath>
                            </ds:Transform>
                        </ds:Transforms>
                        <ds:DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256"/>
                        <ds:DigestValue></ds:DigestValue>
                    </ds:Reference>
                    <ds:Reference Type="http://uri.etsi.org/01903#SignedProperties" t-attf-URI="##{dsig['sigproperties_id']}">
                        <ds:DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256"/>
                        <ds:DigestValue></ds:DigestValue>
                    </ds:Reference>
                    <ds:Reference t-attf-URI="##{dsig['keyinfo_id']}">
                        <ds:DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256"/>
                        <ds:DigestValue></ds:DigestValue>
                    </ds:Reference>
                </ds:SignedInfo>
                <ds:SignatureValue></ds:SignatureValue>
                <ds:KeyInfo t-att-Id="dsig['keyinfo_id']">
                    <ds:X509Data>
                        <ds:X509Certificate t-out="dsig['x509_certificate']"/>
                    </ds:X509Data>
                    <ds:KeyValue>
                        <ds:RSAKeyValue>
                            <ds:Modulus t-out="dsig['public_modulus']"/>
                            <ds:Exponent t-out="dsig['public_exponent']"/>
                        </ds:RSAKeyValue>
                    </ds:KeyValue>
                </ds:KeyInfo>
                <ds:Object>
                    <xades:QualifyingProperties xmlns:xades="http://uri.etsi.org/01903/v1.3.2#" t-attf-Target="##{dsig['signature_id']}">
                        <xades:SignedProperties t-att-Id="dsig['sigproperties_id']">
                            <xades:SignedSignatureProperties>
                                <xades:SigningTime t-out="dsig['iso_now']"/>
                                <xades:SigningCertificateV2>
                                    <xades:Cert>
                                        <xades:CertDigest>
                                            <ds:DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256"/>
                                            <ds:DigestValue t-out="dsig['sigcertif_digest']"/>
                                        </xades:CertDigest>
                                        <xades:IssuerSerial>
                                            <ds:X509IssuerName t-out="dsig['x509_issuer_description']"/>
                                            <ds:X509SerialNumber t-out="dsig['x509_serial_number']"/>
                                        </xades:IssuerSerial>
                                    </xades:Cert>
                                </xades:SigningCertificateV2>
                                <xades:SignaturePolicyIdentifier>
                                    <xades:SignaturePolicyId>
                                        <xades:SigPolicyId>
                                            <xades:Identifier t-out="dsig['sigpolicy_url']"/>
                                            <xades:Description t-out="dsig['sigpolicy_description']"/>
                                        </xades:SigPolicyId>
                                        <xades:SigPolicyHash>
                                            <ds:DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256"/>
                                            <ds:DigestValue t-out="dsig['sigpolicy_digest']"/>
                                        </xades:SigPolicyHash>
                                        <xades:SigPolicyQualifiers>
                                            <xades:SigPolicyQualifier>
                                                <xades:SPURI t-out="dsig['sigpolicy_url']"/>
                                            </xades:SigPolicyQualifier>
                                        </xades:SigPolicyQualifiers>
                                    </xades:SignaturePolicyId>
                                </xades:SignaturePolicyIdentifier>
                            </xades:SignedSignatureProperties>
                            <xades:SignedDataObjectProperties>
                                <xades:DataObjectFormat t-attf-ObjectReference="##{dsig['reference_uri']}">
                                    <xades:Description/>
                                    <xades:ObjectIdentifier>
                                        <!-- Identifier below is Uniform Resource Number for MimeType "text/xml" (no specific version) -->
                                        <!-- 1.2.840.10003.5: see http://www.oid-info.com/cgi-bin/display?oid=1.2.840.10003.5&a=display -->
                                        <!-- 109.10: see https://www.loc.gov/z3950/agency/defns/oids.html#5 -->
                                        <xades:Identifier Qualifier="OIDAsURN">urn:oid:1.2.840.10003.5.109.10</xades:Identifier>
                                        <xades:Description/>
                                    </xades:ObjectIdentifier>
                                    <xades:MimeType>text/xml</xades:MimeType>
                                    <xades:Encoding/>
                                </xades:DataObjectFormat>
                            </xades:SignedDataObjectProperties>
                        </xades:SignedProperties>
                    </xades:QualifyingProperties>
                </ds:Object>
            </ds:Signature>
        </template>
    </data>
</odoo>
