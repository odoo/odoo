<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <record id="hr_leave_cash_out_filter" model="ir.ui.view">
        <field name="name">hr.leave.cash.out.filter</field>
        <field name="model">hr.leave.cash.out</field>
        <field name="arch" type="xml">
            <search string="Search Cash-out">
                <filter domain="[
                            ('state','in',['confirm']),
                            '|',
                            ('employee_id.user_id', '!=', uid),
                            '&amp;',
                            ('employee_id.user_id', '=', uid),
                            ('employee_id.leave_manager_id', '=', uid)]"
                        string="Waiting For Me"
                        name="waiting_for_me"
                        groups="hr_holidays.group_hr_holidays_responsible,!hr_holidays.group_hr_holidays_user"/>
                <filter domain="[
                        ('state','in',['confirm','validate1']),
                        '|',
                            ('employee_id.user_id', '!=', uid),
                            '|',
                                '&amp;',
                                    ('state','=','confirm'),
                                    ('leave_type_id.leave_validation_type','=','hr'),
                                ('state','=','validate1')]"
                    string="Waiting For Me"
                    name="waiting_for_me_manager"
                    groups="hr_holidays.group_hr_holidays_user"/>
                <separator/>
                <filter domain="[('state', '=', 'confirm')]" string="First Approval" name="approve"/>
                <filter domain="[('state', '=', 'validate1')]" string="Second Approval" name="second_approval"/>
                <filter domain="[('state', '=', 'validate')]" string="Approved" name="validated"/>
                <filter domain="[('state', '=', 'refuse')]" string="Refused" name="refused"/>
                <filter domain="[('state', '=', 'cancel')]" string="Canceled" name="canceled"/>
                <group>
                    <filter name="group_employee" string="Employee" context="{'group_by':'employee_id'}"/>
                    <filter name="group_company" string="Company" context="{'group_by':'company_id'}" groups="base.group_multi_company"/>
                    <filter name="group_state" string="Status" context="{'group_by':'state'}"/>
                </group>
            </search>
        </field>
    </record>
    
    <record id="hr_leave_cash_out_search_my" model="ir.ui.view">
        <field name="name">hr.leave.cash.out.view.search.my</field>
        <field name="model">hr.leave.cash.out</field>
        <field name="inherit_id" ref="hr_leave_cash_out_filter"/>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='group_employee']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
        </field>
    </record>

    <record id='hr_leave_cash_out_list' model='ir.ui.view'>
        <field name="name">hr.leave.cash.out.list</field>
        <field name="model">hr.leave.cash.out</field>
        <field name="arch" type="xml">
            <list multi_edit="1">
                <field name="leave_type_id" string="Time Off Type"/>
                <field name="quantity"/>
                <field name="state" widget="badge" string="Status" decoration-warning="state in ('confirm','validate1')" 
                    decoration-success="state in ('validate', 'done')" decoration-danger="state == 'cancel'" decoration-primary="state == 'paid'"/>
                <field name="company_id" string="Company"/>
            </list>
        </field>
    </record>

    <record id='hr_leave_cash_out_list_manager' model='ir.ui.view'>
        <field name="name">hr.leave.cash.out.list.manager</field>
        <field name="model">hr.leave.cash.out</field>
        <field name="inherit_id" ref="hr_leave_cash_out_list"/>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <field name="leave_type_id" position="before">
                <field name="employee_id" string="Employee"/>
            </field>
        </field>
    </record>

    <record id="hr_leave_cash_out_form" model="ir.ui.view">
        <field name="name">hr.leave.cash.out.form</field>
        <field name="model">hr.leave.cash.out</field>
        <field name="arch" type="xml">
            <form string="Cash-out Request" class="o_hr_leave_form">
                <header>
                    <button string="Approve" name="action_approve" type="object" class="oe_highlight" invisible="not can_approve or not id"/>
                    <button string="Validate" name="action_approve" invisible="not can_validate or can_approve or not id" type="object" class="oe_highlight"/>
                    <button string="Refuse" name="action_refuse" type="object" invisible="not can_refuse or not id"/>
                    <button string="Cancel" name="action_cancel" type="object" invisible="state == 'cancel' or not can_cancel or not id" />
                    <button string="Back to Approval" name="action_back_to_approval" type="object" invisible="not can_back_to_approve or not id"/>
                    <field name="state" widget="statusbar" statusbar_visible="confirm,validate,validate1" invisible="validation_type != 'both'"/>
                    <field name="state" widget="statusbar" statusbar_visible="confirm,validate" invisible="validation_type == 'both'"/>
                </header>
                <sheet>
                    <div class="o_hr_leave_content row">
                        <div class="o_hr_leave_column col_left col-md-6 col-12">
                            <group name="col_left">
                                <field name="employee_id" invisible="1" force_save="1" widget="many2one_avatar_employee"
                                    readonly="state not in ['confirm']"/>
                                <field name="leave_type_id" force_save="1"
                                    domain="[
                                        ('allow_cash_out_request', '=', True),
                                        ('requires_allocation', '=', True),
                                        ('has_valid_allocation', '=', True),
                                        '|',
                                            ('allows_negative', '=', True),
                                            '&amp;',
                                                ('virtual_remaining_leaves', '&gt;', 0),
                                                ('allows_negative', '=', False),
                                    ]"
                                    context="{'employee_id': employee_id, 'default_date_from': context_today().strftime('%Y-%m-%d'),
                                    'default_date_to': context_today().strftime('%Y-%m-%d')}"
                                    options="{'no_create': True, 'request_type': 'leave'}"
                                    readonly="state not in ['confirm']"
                                />
                                <field name="leave_allocation_id" readonly="state not in ['confirm']"/>
                                <label for="quantity"/>
                                <div class="o_row">
                                    <field class="o_hr_narrow_field" name="quantity" readonly="state not in ['confirm']"/>
                                    <field name="request_unit"/>
                                </div>
                            </group>
                        </div>
                    </div>
                </sheet>
                <div class="o_attachment_preview"/>
                <chatter reload_on_post="True" reload_on_attachment="True"/>
            </form>
        </field>
    </record>

    <record id="hr_leave_cash_out_form_manager" model="ir.ui.view">
        <field name="name">hr.leave.cash.out.form.manger</field>
        <field name="model">hr.leave.cash.out</field>
        <field name="inherit_id" ref="hr_leave_cash_out_form"/>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <field name="employee_id" position="attributes">
                <attribute name="invisible">0</attribute>
            </field>
            <field name="leave_type_id" position="before">
                <field name="company_id" groups="base.group_multi_company"/>
            </field>
        </field>
    </record>

    <record id="hr_leave_action_cash_out_my" model="ir.actions.act_window">
        <field name="name">My Cash-out</field>
        <field name="res_model">hr.leave.cash.out</field>
        <field name="path">my-cash-out</field>
        <field name="view_mode">list,form,activity</field>
        <field name="search_view_id" ref="hr_leave_cash_out_search_my"/>
    </record>

    <record id="hr_leave_action_cash_out_manager" model="ir.actions.act_window">
        <field name="name">All Cash-out</field>
        <field name="res_model">hr.leave.cash.out</field>
        <field name="path">my-cash-out-approval</field>
        <field name="view_mode">list,form,activity</field>
        <field name="search_view_id" ref="hr_leave_cash_out_filter"/>
        <!-- This context is not working -->
        <field name="context">{'search_default_waiting_for_me': 1}</field>
        <field name="domain">[('employee_id.company_id', 'in', allowed_company_ids)]</field>
    </record>

    <record id="hr_leave_action_cash_out_manager_list" model="ir.actions.act_window.view">
        <field name="sequence">1</field>
        <field name="view_mode">list</field>
        <field name="act_window_id" ref="hr_leave_action_cash_out_manager"/>
        <field name="view_id" ref="hr_leave_cash_out_list_manager"/>
    </record>

    <record id="hr_leave_action_cash_out_manager_form" model="ir.actions.act_window.view">
        <field name="sequence">2</field>
        <field name="view_mode">form</field>
        <field name="act_window_id" ref="hr_leave_action_cash_out_manager"/>
        <field name="view_id" ref="hr_leave_cash_out_form_manager"/>
    </record>

</odoo>
