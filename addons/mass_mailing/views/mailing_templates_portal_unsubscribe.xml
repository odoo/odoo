<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="page_mailing_confirm_unsubscribe" name="Confirm Unsubscription">
        <t t-call="mass_mailing.layout">
            <div class="container o_unsubscribe_form">
                <div class="row">
                    <div class="col-lg-6 offset-lg-3 mt-4">
                        <div id="info_state"  class="alert alert-success">
                            <div class="text-center">
                                <form t-att-action="form_target" method="POST">
                                    <div id="o_mailing_portal_subscription_editor_1" class="oe_structure oe_empty"/>
                                    <div id="o_mailing_portal_subscription_editor_2" class="oe_structure oe_empty"/>
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    <input type="hidden" name="mailing_id" t-att-value="mailing_id"/>
                                    <input type="hidden" name="document_id" t-att-value="document_id"/>
                                    <input type="hidden" name="email" t-att-value="email"/>
                                    <input type="hidden" name="hash_token" t-att-value="hash_token"/>
                                    <p t-if="unsubscribed_lists">
                                       Are you sure you want to unsubscribe from the mailing list "<span t-out="unsubscribed_lists"/>"? 
                                    </p>
                                    <p t-else="">
                                        Are you sure you want to unsubscribe from our mailing list?
                                    </p>
                                    <button id="button_confirm_unsubscribe" type="submit" class="btn btn-primary o-paragraph oe_structure oe_empty">
                                        <div>Unsubscribe</div>
                                    </button>
                                </form>
                                <div id="o_mailing_portal_subscription_editor_3" class="oe_structure oe_empty"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="o_mailing_portal_subscription_editor_4" class="oe_structure oe_empty"/>
        </t>
    </template>

    <template id="page_mailing_unsubscribe" name="Unsubscribe">
        <t t-call="mass_mailing.layout">
            <t t-call="mass_mailing.unsubscribe_form"/>
        </t>
    </template>

    <template id="unsubscribe_form">
        <div id="o_mailing_portal_subscription"
             class="o_mailing_portal_body"
             t-att-data-blocklist-enabled="blocklist_enabled"
             t-att-data-blocklist-possible="blocklist_possible"
             t-att-data-document-id="document_id"
             t-att-data-feedback-enabled="feedback_enabled"
             t-att-data-feedback-readonly="feedback_readonly"
             t-att-data-hash-token="hash_token"
             t-att-data-last-action="last_action"
             t-att-data-email="email"
             t-att-data-email-valid="email_valid"
             t-att-data-is-blocklisted="is_blocklisted"
             t-att-data-mailing-id="mailing_id">
            <div class="o_container_small">
                <div id="o_mailing_portal_subscription_editor_1" class="oe_structure oe_empty"/>
                <div id="o_mailing_subscription_info" class="mt64 mb-5" role="status">
                    <div id="o_mailing_unsubscribed_alert" role="alert"
                         t-attf-class="alert alert-success d-flex align-items-center #{'' if unsubscribed or unsubscribed_name or unsubscribed_name else 'd-none'}">
                        <i class="fa fa-check-circle float-start me-3"/>
                        <span t-if="unsubscribed_name">You have successfully unsubscribed from <b t-out="unsubscribed_name"/>!</span>
                        <span t-elif="unsubscribed_name"><b t-out="unsubscribed_name"/></span>
                        <span t-else="">You have successfully unsubscribed from our mailing list!</span>
                    </div>
                    <!-- todo guce: rework to "feedback_request" on route merge? ?-->
                    <div id="o_mailing_subscription_feedback" t-attf-class="#{'' if last_action in ['subscription_updated', 'blocklist_add'] else 'd-none'}">
                        <form action="/mail/mailing/feedback" method="POST" class="my-3" autocomplete="off">
                            <p t-if="last_action == 'blocklist_add'">
                                Please let us know why you want to be in our block list.
                            </p>
                            <p t-else="">
                                Please let us know why you updated your subscription.
                            </p>
                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                            <fieldset>
                                <div class="form-check"
                                     t-foreach="opt_out_reasons"
                                     t-as="opt_out_reason">
                                    <input class="form-check-input o_mailing_subscription_opt_out_reason"
                                           type="radio"
                                           name="opt_out_reason_id"
                                           t-att-id="'opt_out_reason_id' + str(opt_out_reason.id)"
                                           t-att-data-is-feedback="opt_out_reason.is_feedback"
                                           t-att-value="opt_out_reason.id"/>
                                    <label class="form-check-label"
                                           t-att-for="'opt_out_reason_id' + str(opt_out_reason.id)"
                                           t-out="opt_out_reason.name"/>
                                </div>
                            </fieldset>
                            <textarea id="o_mailing_subscription_feedback_textarea" class="form-control mt-1 d-none" name="feedback" cols="60" rows="3"></textarea>
                            <button id="button_feedback"
                                    type="submit"
                                    class="btn btn-primary text-start mt-3"
                                    disabled="">Send</button>
                        </form>
                    </div>
                    <div id="o_mailing_subscription_feedback_info" class="pt-2 my-3 d-none"/>
                </div>
                <div id="o_mailing_portal_subscription_editor_2" class="oe_structure oe_empty"/>
                <div id="o_mailing_subscription_form" class="mb-5">
                    <form action="/mailing/list/update" method="POST" autocomplete="off">
                        <h5 class="mb-3">
                            <span>Your subscriptions for</span>
                            <b t-out="email"/>
                        </h5>
                        <div id="o_mailing_subscription_form_blocklisted" t-attf-class="#{'' if is_blocklisted else 'd-none'}">
                            <div class="alert alert-danger my-2">
                                Your email address is currently in our <strong>blocklist</strong>.
                                You will not receive marketing emails. <br/>
                                However, you will continue to receive updates related to your account.
                            </div>
                        </div>
                        <div id="o_mailing_subscription_form_manage" t-attf-class="#{'d-none' if is_blocklisted else '' }">
                            <ul id="o_mailing_subscription_form_lists"
                                t-if="lists_optin_public + lists_optout_public + lists_public"
                                class="list-group">
                                <li t-foreach="lists_optin_public + lists_optout_public + lists_public"
                                    t-as="mailing_list"
                                    class="list-group-item p-0">
                                    <label class="o_mailing_subscription_form_list_toggle checkbox-group d-flex align-items-center px-3">
                                        <input class="check-input mailing_lists_checkboxes mx-2"
                                               type="checkbox" role="switch"
                                               name="mailing_list_ids"
                                               t-att-id="'mailing_list_id' + str(mailing_list.id)"
                                               t-att-data-member="'1' if mailing_list in (lists_optin_public + lists_optout_public) else None"
                                               t-att-data-description="mailing_list.description"
                                               t-att-disabled="'disabled' if is_blocklisted else None"
                                               t-att-value="mailing_list.id"
                                               t-att-checked="'checked' if mailing_list in lists_optin_public else None"
                                               t-att-title="mailing_list.name"/>
                                        <span class="mx-2 py-3" t-out="mailing_list.name"/><br/>
                                    </label>
                                    <div t-attf-class="o_mailing_subscription_form_list_description pe-3 {{'oe-hint' if is_html_empty(mailing_list.description) else 'mb-3'}}"
                                         t-field="mailing_list.description"
                                         t-att-data-description="mailing_list.description"
                                         placeholder="Add a description..."/>
                                </li>
                            </ul>
                            <p t-if="not lists_optin and not lists_optout and not lists_public" class="o_editable">
                                You are not subscribed to any of our mailing list.
                            </p>
                        </div>
                        <div class="o_mailing_subscription_buttons my-3 d-flex align-items-center">
                            <div id="button_subscription_update_preferences"
                                t-attf-class="btn btn-primary me-2 #{'d-none' if is_blocklisted else ''}">
                                Update Preferences
                            </div>
                            <div id="o_mailing_subscription_blocklist" class="d-flex">
                                <div t-attf-class="btn btn-secondary me-2 #{'d-none' if is_blocklisted else ''}"
                                     t-if="blocklist_enabled and blocklist_possible"
                                     id="button_blocklist_add">I don't want emails</div>
                                <div t-attf-class="btn btn-secondary #{'' if is_blocklisted else 'd-none'}"
                                     id="button_blocklist_remove">Unblock me</div>
                            </div>
                        </div>
                    </form>
                    <div id="o_mailing_subscription_update_info" class="my-2"/>
                </div>
                <div id="o_mailing_portal_subscription_editor_3" class="oe_structure oe_empty"/>
            </div>
        </div>
    </template>
</odoo>
