<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <template id="report_signature_certificate">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="sign_oca.report_signature_certificate_doc" />
            </t>
        </t>
    </template>

    <template id="report_signature_certificate_doc">
        <t t-call="web.external_layout">
            <div class="page">
                <h1 class="mb32">Signature Certificate</h1>

                <!-- Document Information -->
                <div class="document_information mb32">
                    <div class="row mb16">
                        <div class="col-12">
                            <h3 class="text-muted">Document Information</h3>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="mb8" id="signature_filename">
                                <span class="fw-bold">Signature filename:</span>
                                <span class="text-break" t-field="o.filename" />
                            </div>
                            <div class="mb8" id="created_on">
                                <span class="fw-bold">Created on:</span>
                                <span
                                    t-field="o.create_date"
                                    t-options='{"widget": "datetime", "format": "dd-MM-YYYY HH:mm:ss", "tz_name": "UTC"}'
                                />
                                <span>(UTC)</span>
                            </div>
                            <div class="mb8" id="created_by">
                                <span class="fw-bold">Created by:</span>
                                <span t-field="o.create_uid" />
                            </div>
                            <div class="mb8" id="print_date">
                                <span class="fw-bold">Print date:</span>
                                <span
                                    t-esc="datetime.datetime.utcnow().strftime('%d-%m-%Y %H:%M:%S')"
                                />
                                <span>(UTC)</span>
                            </div>
                            <div class="mb8" id="responsible">
                                <span class="fw-bold">Responsible:</span>
                                <span t-field="o.user_id" />
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb8" id="document_id">
                                <span class="fw-bold">Document ID:</span>
                                <span t-field="o.id" />
                            </div>
                            <div class="mb8" id="related_record" t-if="o.record_ref">
                                <t
                                    t-set="model_name"
                                    t-value="o.record_ref and o.record_ref.sudo()._name"
                                />
                                <t
                                    t-set="model_display_name"
                                    t-value="model_name and env['ir.model'].sudo().search([('model', '=', model_name)], limit=1).name"
                                />
                                <span class="fw-bold">Related record:</span>
                                <span t-esc="model_display_name" />
                                <span>-</span>
                                <span t-field="o.record_ref.sudo().display_name" />
                            </div>
                            <div class="mb8" id="signers">
                                <t
                                    t-set="signer_remaining"
                                    t-value="o.signer_count - o.signed_count"
                                />
                                <span class="fw-bold">Signers:</span>
                                <span t-field="o.signer_count" />
                                <span>signers →</span>
                                <span t-field="o.signed_count" />
                                <span>signed,</span>
                                <span t-esc="signer_remaining" />
                                <span>remaining</span>
                            </div>
                            <div class="mb8" id="current_hash">
                                <span class="fw-bold">Current hash:</span>
                                <span class="text-break" t-field="o.current_hash" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Signers -->
                <div class="document_signers mb32" t-if="o.signer_ids">
                    <div class="row mb16">
                        <div class="col-12" id="document_signers_title">
                            <h3 class="text-muted">Signers</h3>
                        </div>
                    </div>
                    <div class="row pt4">
                        <div class="col-12" id="document_signers_table">
                            <table class="table table-bordered">
                                <thead
                                    class="bg-100"
                                    style="border-bottom: 2px solid #dee2e6;"
                                >
                                    <tr>
                                        <th class="text-start">Signer</th>
                                        <th class="text-start">Email</th>
                                        <th class="text-start">Role</th>
                                        <th class="text-start">Signed?</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="o.signer_ids" t-as="signer">
                                        <tr>
                                            <td t-esc="signer.partner_name" />
                                            <td
                                                t-esc="signer.partner_id.sudo().email"
                                            />
                                            <td
                                                t-esc="signer.role_id.sudo().display_name"
                                            />
                                            <td>
                                                <span
                                                    t-if="signer.inalterable_hash"
                                                >✔</span>
                                                <span t-else="">✘</span>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Signatures -->
                <t
                    t-set="signature_ids"
                    t-value="o.signer_ids.filtered(lambda s: s.inalterable_hash)"
                />
                <div class="document_signatures mb32" t-if="signature_ids">
                    <div class="row mb16">
                        <div class="col-12" id="document_signatures_title">
                            <h3 class="text-muted">Signatures</h3>
                        </div>
                    </div>
                    <div class="row pt4">
                        <div class="col-12" id="document_signatures_table">
                            <table class="table table-bordered">
                                <thead
                                    class="bg-100"
                                    style="border-bottom: 2px solid #dee2e6;"
                                >
                                    <tr>
                                        <th class="text-start">Signer</th>
                                        <th class="text-start">Signed on</th>
                                        <th class="text-start">Geolocation</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="signature_ids" t-as="signature">
                                        <tr>
                                            <td t-esc="signature.partner_name" />
                                            <td>
                                                <span
                                                    t-esc="signature.signed_on"
                                                    t-options='{"widget": "datetime", "format": "dd-MM-YYYY HH:mm:ss", "tz_name": "UTC"}'
                                                />
                                                <span>(UTC)</span>
                                            </td>
                                            <td>
                                                <t
                                                    t-if="signature.latitude or signature.longitude"
                                                >
                                                    <span t-esc="signature.latitude" />
                                                    <span>-</span>
                                                    <span t-esc="signature.longitude" />
                                                </t>
                                                <span
                                                    t-else=""
                                                    class="text-muted"
                                                >Not available</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="3">
                                                <span
                                                    class="text-muted"
                                                >Inalterability hash:</span>
                                                <span
                                                    class="text-break"
                                                    t-esc="signature.inalterable_hash"
                                                />
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Activity Logs -->
                <t
                    t-set="request_logs"
                    t-value="env['sign.oca.request.log'].sudo().search([('request_id', '=', o.id), ('action', 'in', ['create', 'validate', 'view', 'sign', 'cancel'])])"
                />
                <div class="document_activity_logs mb32" t-if="request_logs">
                    <div class="row mb16">
                        <div class="col-12" id="document_activity_logs_title">
                            <h3 class="text-muted">Activity Logs</h3>
                        </div>
                    </div>
                    <div class="row pt4">
                        <div class="col-12" id="document_activity_logs_table">
                            <table class="table table-bordered">
                                <thead
                                    class="bg-100"
                                    style="border-bottom: 2px solid #dee2e6;"
                                >
                                    <tr>
                                        <th class="text-start">Action</th>
                                        <th class="text-start">Date (UTC)</th>
                                        <th class="text-start">Partner</th>
                                        <th class="text-start">IP address</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="request_logs" t-as="log">
                                        <tr>
                                            <td
                                                t-esc="dict(log.fields_get()['action']['selection'])[log.action]"
                                            />
                                            <td
                                                t-esc="log.date"
                                                t-options='{"widget": "datetime", "format": "dd-MM-YYYY HH:mm:ss", "tz_name": "UTC"}'
                                            />
                                            <td>
                                                <t t-if="not log.signer_id">
                                                    <span
                                                        t-esc="log.partner_id.sudo().name"
                                                    />
                                                </t>
                                                <t t-else="">
                                                    <span
                                                        t-esc="log.signer_id.sudo().partner_name"
                                                    />
                                                </t>
                                            </td>
                                            <td>
                                                <t t-if="log.ip">
                                                    <span t-esc="log.ip" />
                                                </t>
                                                <t t-else="">
                                                    <span
                                                        class="text-muted"
                                                    >Not available</span>
                                                </t>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>
