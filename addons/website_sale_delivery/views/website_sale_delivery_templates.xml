<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="cart_delivery" name="Delivery Costs" inherit_id="website_sale.total">
        <xpath expr="//tr[@id='order_total_untaxed']" position="before">
            <tr id="order_delivery" t-if="website_sale_order and website_sale_order.has_delivery">
              <td class="text-right noborder text-muted"  title="Delivery will be updated after choosing a new delivery method">Delivery:</td>
              <td class="text-left-not-lg text-right-lg noborder text-muted" >
                   <span t-field="website_sale_order.amount_delivery" style="white-space: nowrap;" t-options='{
                      "widget": "monetary",
                      "display_currency": website_sale_order.currency_id,
                  }'/>
              </td>
            </tr>
        </xpath>
    </template>

    <template id="assets_frontend" inherit_id="website.assets_frontend" name="Shop">
      <xpath expr="." position="inside">
        <script type="text/javascript" src="/website_sale_delivery/static/src/js/website_sale_delivery.js"></script>
        <link rel="stylesheet" type="text/scss" href="/website_sale_delivery/static/src/scss/website_sale_delivery.scss"/>
      </xpath>
    </template>

    <template id="payment_delivery" name="Delivery Costs" inherit_id="website_sale.payment">
        <xpath expr="//div[@id='payment_method']" position="before">
            <div t-if="deliveries" class="col-md-12" id="delivery_carrier">
                <h3 class="mb24">Choose a delivery method</h3>
                <div class="panel panel-default" id="delivery_method">
                    <ul class="list-group">
                    <t t-set="delivery_nb" t-value="len(deliveries)" />
                    <t t-foreach="deliveries" t-as="delivery">
                        <li class="list-group-item">
                            <input t-att-value="delivery.id" t-att-id="'delivery_%i' % delivery.id" type="radio" name="delivery_type" t-att-checked="order.carrier_id and order.carrier_id.id == delivery.id and 'checked' or False" t-att-class="'hidden' if delivery_nb == 1 else ''"/>
                            <label class="label-optional" t-field="delivery.name" t-att-for="'delivery_%i' % delivery.id"/>
                            <t t-if="delivery.delivery_type == 'fixed'">
                                <span t-if="delivery.fixed_price > 0.0" class="badge pull-right"
                                      t-field="delivery.fixed_price" t-options='{"widget": "monetary",
                                      "from_currency": delivery.product_id.company_id.currency_id, "display_currency": website_sale_order.currency_id}'/>
                                <span t-else="" class="badge pull-right">Free</span>
                            </t>
                            <t t-else="">
                                <span class="badge pull-right hidden" t-field="delivery.fixed_price" t-options='{"widget": "monetary", "from_currency": delivery.product_id.company_id.currency_id, "display_currency": website_sale_order.currency_id}'/>
                                <span class="badge pull-right o_delivery_compute">Select to compute delivery rate</span>
                            </t>
                            <t t-if="delivery.website_description">
                                <div t-field="delivery.website_description" class="text-muted mt8"/>
                            </t>
                        </li>
                    </t>
                    </ul>
                </div>
            </div>
        </xpath>
    </template>

    <!-- <template id="auto_load_delivery_price" name="Auto Load Delivery Price" inherit_id="website_sale_delivery.payment_delivery" active="False" customize_show="True"> -->
    <template id="auto_load_delivery_price" name="Auto Load Delivery Price" inherit_id="website_sale.payment" active="False" customize_show="True">
        <xpath expr="//div[@id='wrapwrap']//span[hasclass('o_delivery_compute')]" position="replace">
            <i class="fa fa-spinner fa-spin"></i>
        </xpath>
        <xpath expr="//div[@id='wrapwrap']" position="after">
            <script>
                var $carriers = $("#delivery_carrier input[name='delivery_type']");
                var _onCarrierUpdateAnswer2 = function(result) {
                    var $carrier_badge = $('#delivery_carrier input[name="delivery_type"][value=' + result.carrier_id + '] ~ .badge.hidden');
                    var $compute_badge = $('#delivery_carrier input[name="delivery_type"][value=' + result.carrier_id + '] ~ .o_delivery_compute');
                    if (result.status === true) {
                        $carrier_badge.children('span').text(result.new_amount_delivery);
                        $carrier_badge.removeClass('hidden');
                        $compute_badge.addClass('hidden');
                    }
                    else {
                        console.error(result.error_message);
                        $compute_badge.text(result.error_message);
                    }
                };

                $.each($carriers, function(index, value) {
                    var carrier_id = value.value;
                    var values = {'carrier_id': carrier_id, 'preview': true};
                    ajax.jsonRpc('/shop/update_carrier', 'call', values)
                      .then(_onCarrierUpdateAnswer2);
                });

                // var _onCarrierUpdateAnswer3 = function(result) {
                //     $.each(result, function(index, value) {
                //         var $carrier_badge = $('#delivery_carrier input[name="delivery_type"][value=' + value.carrier_id + '] ~ .badge.hidden');
                //         var $compute_badge = $('#delivery_carrier input[name="delivery_type"][value=' + value.carrier_id + '] ~ .o_delivery_compute');
                //         if (value.status === true) {
                //             $carrier_badge.children('span').text(value.new_amount_delivery);
                //             $carrier_badge.removeClass('hidden');
                //             $compute_badge.addClass('hidden');
                //         }
                //         else {
                //             console.error(value.error_message);
                //             $compute_badge.text(value.error_message);
                //         }
                //     });
                // };
                //
                // var carrier_ids = $.map($carriers, function (val, i) { return val.value });
                // var values = {'carrier_ids': carrier_ids};
                // ajax.jsonRpc('/shop/carrier_price_list', 'call', values)
                //   .then(_onCarrierUpdateAnswer3);
            </script>
        </xpath>
    </template>

    <record id="website_sale_delivery.auto_load_delivery_price" model="ir.ui.view">
        <field name="customize_show" eval="True"/>
    </record>

    <template id="portal_order_page_shipping_tracking" name="Shipping tracking on orders followup" inherit_id="sale_stock.portal_order_page_shipping">
        <xpath expr="//div[@id='picking_info']" position="after">
            <div t-if="i.carrier_tracking_ref">
                Tracking: <span t-field="i.carrier_id.name"/>
                <t t-if="i.carrier_tracking_url">
                    <a t-att-href="i.carrier_tracking_url" target="_blank"><span t-field="i.carrier_tracking_ref"/></a>
                </t>
                <t t-else="">
                    <span t-field="i.carrier_tracking_ref"/>
                </t>
            </div>
        </xpath>
    </template>

</odoo>
