<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Lines that show items in the cart. Called in `website_sale.cart`. -->
    <template id="website_sale.cart_lines" name="Shopping Cart Lines">
        <!-- target tag for interaction to mount cart lines component -->
        <div id="cart_products"/>
    </template>

    <template id="website_sale.cart_product_price">
        <span
            t-out="product_price"
            style="white-space: nowrap;"
            t-options="{'widget': 'monetary', 'display_currency': website_sale_order.currency_id}"
        />
    </template>

    <!-- /shop/cart route -->
    <template id="website_sale.cart" name="Shopping Cart">
        <t t-set="oe_structure">
            <!-- This is the drag-and-drop area for website building blocs at the end of each
                 checkout page. This is append at the of the page in `checkout_layout`. The
                 templates created in the database to store blocs are hooked using XPath on the
                 `oe_struture` element ID. Therefore, we can't use dynamic IDs (like with
                 t-att-id) and each template needs to define a div element. -->
            <div class="oe_structure" id="oe_structure_website_sale_cart_2"/>
        </t>
        <t t-call="website_sale.checkout_layout"
            show_shorter_cart_summary="True"
            show_footer="True"
            oe_structure="oe_structure">
            <div id="shop_cart" class="col">
                <div class="d-flex align-items-center mb-3">
                    <h4 class="mb-0">Order summary</h4>
                    <div class="ms-3 border-start ps-2"><t t-call="website_sale.quick_reorder_button"/></div>
                </div>
                <div t-if="abandoned_proceed or access_token" class="alert alert-info mt8 mb8" role="alert"> <!-- abandoned cart choices -->
                    <t t-if="abandoned_proceed">
                        <p>Your previous cart has already been completed.</p>
                        <p t-if="website_sale_order">Please proceed your current cart.</p>
                    </t>
                    <t t-if="access_token">
                        <p>This is your current cart.</p>
                        <p>
                            <strong>
                                <a class="o_translate_inline" t-attf-href="/shop/cart/?id={{id}}&amp;access_token={{access_token}}&amp;revive_method=squash">Click here</a>
                            </strong> if you want to restore your previous cart. Your current cart will be replaced with your previous cart.
                        </p>
                        <p>
                            <strong>
                                <a class="o_translate_inline" t-attf-href="/shop/cart/?id={{id}}&amp;access_token={{access_token}}&amp;revive_method=merge">Click here</a>
                            </strong> if you want to merge your previous cart into current cart.
                        </p>
                    </t>
                </div>
                <t t-call="website_sale.cart_lines"/>
                <div class="clearfix" />
                <div class="oe_structure" id="oe_structure_website_sale_cart_1"/>
            </div>
        </t>
    </template>

    <template id="website_sale.quick_reorder_button">
        <t t-set="quick_reorder_button_title">
            <t t-if="request.website.is_public_user()">Login to reorder</t>
            <t t-elif="not order_history">No previous products available for reorder.</t>
        </t>
        <span t-att-title="quick_reorder_button_title">
            <button
                id="quick_reorder_button"
                type="button"
                class="btn btn-sm btn-link"
                data-bs-toggle="offcanvas"
                data-bs-target="#quick_reorder_sidebar"
                aria-controls="quick_reorder_sidebar"
                t-att-disabled="not order_history"
            >
                <i class="fa fa-rotate-left me-2"/>Quick reorder
            </button>
        </span>
        <t t-call="website_sale.quick_reorder_sidebar"/>
    </template>

    <template id="website_sale.quick_reorder_sidebar">
        <div
            id="quick_reorder_sidebar"
            class="offcanvas offcanvas-end"
            aria-labelledby="quick_reorder_sidebar"
        >
            <div class="offcanvas-header">
                <h5 class="offcanvas-title">Quick reorder</h5>
                <button
                    type="button"
                    class="btn-close text-reset"
                    data-bs-dismiss="offcanvas"
                    aria-label="Close"
                />
            </div>
            <div class="offcanvas-body">
                <!-- Parent element needed for proper JS side rendering -->
                <t t-if="order_history" t-call="website_sale.quick_reorder_history"/>
            </div>
        </div>
    </template>

    <template id="website_sale.quick_reorder_history">
        <div
            class="o_wsale_quick_reorder_line_group ps-sm-3"
            t-foreach="order_history"
            t-as="order_line_group"
        >
            <div class="o_wsale_quick_reorder_group_content d-flex gap-3 w-100 position-relative">
                <div
                    class="o_dot_line d-none d-sm-block position-absolute top-0 bottom-0 mb-1 border-start"
                />
                <span
                    class="o_dot d-none d-sm-block position-absolute translate-middle-x text-o-color-1"
                />
                <div class="w-100 ps-sm-4">
                    <h6 t-out="order_line_group['label']" class="mt-1 mb-3 text-muted"/>
                    <div
                        t-foreach="order_line_group['lines']"
                        t-as="order_line"
                        t-att-class="'o_wsale_quick_reorder_line d-flex flex-column flex-sm-row justify-content-between gap-3 '
                                      + ('align-items-start' if order_line.product_type == 'combo' else '')"
                    >
                        <div
                            t-att-class="'d-flex gap-2 ' + ('align-items-start' if order_line.product_type == 'combo' else 'align-items-center')"
                        >
                            <div class="o_cart_product_image">
                                <div
                                    t-field="order_line.product_id.image_128"
                                    t-options="{
                                        'widget': 'image',
                                        'qweb_img_responsive': False,
                                        'class': 'border rounded',
                                    }"
                                />
                            </div>
                            <div
                                class="d-flex flex-column align-items-start justify-content-center flex-grow-1 h-100"
                            >
                                <div>
                                    <h6
                                        t-out="order_line.name_short"
                                        t-att-class="'small ' + ('mb-2' if order_line.product_type == 'combo' else 'mb-0')"
                                    />
                                    <ul
                                        t-if="order_line.product_type == 'combo'" class="list-group"
                                    >
                                        <t
                                            t-foreach="order_line.linked_line_ids"
                                            t-as="combo_item_line"
                                            t-call="website_sale.cart_combo_item_line"
                                        />
                                    </ul>
                                </div>
                                <small
                                    t-if="order_line.product_template_id._has_multiple_uoms()"
                                    t-out="order_line.product_uom_id.name"
                                    class="badge mt-1 bg-light"
                                />
                            </div>
                        </div>
                        <div class="d-flex align-items-center ms-auto gap-2">
                            <t
                                t-set="combination_info"
                                t-value="order_line.product_id._get_combination_info_variant()"
                            />
                            <small
                                t-out="combination_info['price'] * order_line.product_uom_qty"
                                t-options="{
                                    'widget': 'monetary',
                                    'display_currency': website.currency_id,
                                }"
                                class="o_wsale_quick_reorder_product_price"
                                style="white-space: nowrap;"
                            />
                            <input
                                type="text"
                                t-att-value="int(order_line.product_uom_qty)"
                                class="o_wsale_quick_reorder_qty_input form-control text-center"
                                t-att-data-price-unit="combination_info['price']"
                                t-att-data-currency-digits="combination_info['currency'].decimal_places"
                            />
                            <button
                                type="button"
                                title="Press 'Enter' to add to cart"
                                class="o_wsale_quick_reorder_product_button btn btn-outline-primary"
                                t-att-data-quantity="order_line.product_uom_qty"
                                t-att-data-product-id="order_line.product_id.id"
                                t-att-data-product-template-id="order_line.product_id.product_tmpl_id.id"
                                t-att-data-product-type="order_line.product_id.type"
                                t-att-data-selected-combo-items="json.dumps(order_line._get_selected_combo_items())"
                            >
                                <i class="fa fa-cart-plus"/>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Deactivatable through the website editor. -->
    <template
        id="website_sale.suggested_products_list"
        inherit_id="website_sale.cart_lines"
        name="Accessory Products in my cart"
    >
        <xpath expr="//div[@id='cart_products']" position="after">
            <h5 t-attf-class="mt-3 mb-0" t-if="suggested_products">Suggested accessories</h5>
            <div t-if="suggested_products"
                 id="suggested_products"
                 class="d-flex flex-column align-items-stretch">
                <div
                    t-foreach="suggested_products"
                    t-as="product"
                    t-attf-class="d-flex gap-3 py-4 #{not product_last and 'border-bottom'}"
                    t-att-data-publish="product.website_published and 'on' or 'off'"
                >
                    <div class="o_cart_product_image">
                        <a t-att-href="product.website_url">
                            <div t-field="product.image_128" t-options="{'widget': 'image', 'qweb_img_responsive': False, 'class': 'border rounded'}"/>
                        </a>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between">
                            <div>
                                <a class="text-reset" t-att-href="product.website_url">
                                    <h6
                                        class="align-top text-wrap"
                                        t-out="product.with_context(display_default_code=False).display_name"
                                    />
                                </a>
                                <div
                                    class="mb-2 small text-muted"
                                    t-field="product.description_sale"
                                />
                            </div>
                            <div class="d-flex flex-column gap-2 align-items-end">
                                <h6
                                    class="d-flex mb-0 text-end"
                                    name="suggested_product_price_container"
                                >
                                    <t
                                        t-set="combination_info"
                                        t-value="product._get_combination_info_variant()"
                                    />
                                    <del
                                        name="suggested_product_list_price"
                                        t-attf-class="me-2 text-nowrap text-muted {{'' if combination_info['has_discounted_price'] else 'd-none'}}"
                                        t-out="combination_info['list_price']"
                                        t-options="{'widget': 'monetary', 'display_currency': website.currency_id}"
                                    />
                                    <span
                                        name="suggested_product_price"
                                        class="text-nowrap"
                                        t-out="combination_info['price']"
                                        t-options="{'widget': 'monetary','display_currency': website.currency_id}"
                                    />
                                </h6>
                                <button
                                    name="add_to_cart"
                                    class="btn btn-primary text-nowrap"
                                    data-action="buy_now"
                                    t-att-data-product-id="product.id"
                                    t-att-data-product-template-id="product.product_tmpl_id.id"
                                    t-att-data-product-type="product.type"
                                    t-att-data-show-quantity="is_view_active('website_sale.product_quantity')"
                                >
                                    <i class="d-md-none fa fa-shopping-cart" role="presentation"/>
                                    <span class="d-none d-md-inline">Add to cart</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </xpath>
    </template>

    <template
        id="website_sale.product_cart_lines"
        inherit_id="website_sale.cart_lines"
        active="True"
    />

</odoo>
