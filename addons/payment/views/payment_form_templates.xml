<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="payment.form" name="Payment Form">
        <!-- Form customization parameters:
            - mode: The operation mode of the form: `payment` or `validation`; default: `payment`.
            - allow_token_selection: Whether tokens can be selected for payment or assignation (if
                                     the `assign_route` parameter is provided); default: `True`.
            - default_token_id: The id of the token that should be pre-selected; default: `None`.
            - show_tokenize_input_mapping: For each provider, whether the tokenization checkbox is
                                           shown.
            - display_submit_button: Whether the submit button is displayed; default: `True`.
        -->
        <!-- Transaction context:
            - reference_prefix: The custom prefix to compute the full transaction reference.
            - amount: The amount to pay.
            - currency: The currency of the transaction, as a `res.currency` record.
            - partner_id: The id of the partner on behalf of whom the payment should be made.
            - payment_methods_sudo: The compatible payment methods, as a sudoed `payment.method`
                                    recordset.
            - tokens_sudo: The available payment tokens, as a sudoed `payment.token` recordset.
            - transaction_route: The route to call to create the transaction.
            - assign_token_route: The route to call to assign a new or existing token to a record.
            - landing_route: The route the user is redirected to after payment.
            - access_token: The access token used to authenticate the partner.
        -->
        <t t-set="mode" t-value="mode or 'payment'"/>
        <t t-set="allow_token_selection"
           t-value="True if allow_token_selection is None else allow_token_selection"
        />
        <t t-set="selected_token_id"
           t-value="allow_token_selection and (default_token_id or tokens_sudo[:1].id)"
        />
        <t t-set="selected_method_id"
           t-value="not selected_token_id and len(payment_methods_sudo) == 1 and payment_methods_sudo[:1].id"
        />
        <t t-set="display_submit_button"
           t-value="True if display_submit_button is None else display_submit_button"
        />
        <form id="o_payment_form"
              class="o_payment_form"
              t-att-data-reference-prefix="reference_prefix"
              t-att-data-amount="amount"
              t-att-data-currency-id="currency and currency.id"
              t-att-data-partner-id="partner_id"
              t-att-data-transaction-route="transaction_route"
              t-att-data-assign-token-route="assign_token_route"
              t-att-data-landing-route="landing_route"
              t-att-data-access-token="access_token"
        >
            <div id="o_payment_form_accordion" class="accordion">
                <!-- === Payment tokens === -->
                <div t-if="tokens_sudo" class="accordion-item border border-bottom-0">
                    <!-- === Accordion header === -->
                    <h4 id="o_payment_tokens_heading" class="mb-0">
                        <button type="button"
                                class="accordion-button bg-light"
                                data-bs-toggle="collapse"
                                data-bs-target="#o_payment_tokens_list"
                                aria-expanded="true"
                                aria-controls="o_payment_tokens_list"
                        >
                            Registered payment methods
                        </button>
                    </h4>
                    <!-- === Accordion body === -->
                     <div id="o_payment_tokens_list"
                          class="accordion-collapse collapse show"
                          aria-labelledby="o_payment_tokens_heading"
                          data-bs-parent="#o_payment_form_accordion"
                     >
                        <div class="accordion-body p-0">
                            <ul class="list-group list-group-flush">
                                <t t-foreach="tokens_sudo" t-as="token_sudo">
                                    <li name="o_payment_option"
                                        class="list-group-item d-flex flex-column gap-2 py-3"
                                    >
                                        <t t-call="payment.token_form">
                                            <t t-set="is_selected"
                                               t-value="token_sudo.id == selected_token_id"
                                            />
                                        </t>
                                    </li>
                                </t>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- === Payment methods === -->
                <div class="accordion-item border">
                    <!-- === Accordion header === -->
                    <h4 id="o_payment_methods_heading" class="mb-0">
                        <button type="button"
                                t-att-class="'accordion-button bg-light' + (' collapsed' if tokens_sudo else '')"
                                data-bs-toggle="collapse"
                                data-bs-target="#o_payment_methods_list"
                                aria-expanded="true"
                                aria-controls="o_payment_methods_list"
                        >
                            <t t-if="not tokens_sudo">Choose a payment method</t>
                            <t t-elif="mode == 'payment'">Use another payment method</t>
                            <t t-else="">Add a new payment method</t>
                        </button>
                    </h4>
                    <!-- === Accordion body === -->
                    <div id="o_payment_methods_list"
                         t-att-class="'accordion-collapse collapse' + (' show' if not tokens_sudo else '')"
                         aria-labelledby="o_payment_methods_heading"
                         data-bs-parent="#o_payment_form_accordion"
                    >
                        <div class="accordion-body p-0">
                            <ul class="list-group list-group-flush">
                                <t t-foreach="payment_methods_sudo" t-as="pm_sudo">
                                    <t t-set="extra_classes"
                                       t-value="' rounded-bottom o_last_payment_method' if pm_sudo_last else ''"
                                    />
                                    <li name="o_payment_option"
                                        t-attf-class="list-group-item d-flex flex-column gap-2 py-3 {{extra_classes}}"
                                    >
                                        <t t-call="payment.method_form">
                                            <t t-set="is_selected"
                                               t-value="pm_sudo.id == selected_method_id"
                                            />
                                        </t>
                                    </li>
                                </t>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- === Submit button === -->
            <div t-if="display_submit_button" class="d-flex justify-content-end my-2">
                <t t-call="payment.submit_button">
                    <t t-set="label" t-value="'Pay' if mode == 'payment' else 'Add'"/>
                </t>
            </div>
        </form>
    </template>

    <template id="payment.token_form" name="Payment Token Form">
        <!-- Parameters description:
            - token_sudo: The token to display, as a sudoed `payment.token` recordset.
            - allow_token_selection: Whether tokens can be selected for payment or assignation (if
                                     the `assign_route` parameter is provided); default: `True`.
            - is_selected: Whether the radio button of the token should be checked.
        -->
        <t t-set="provider_sudo" t-value="token_sudo.provider_id"/>
        <t t-set="is_test" t-value="provider_sudo.state == 'test'"/>
        <t t-set="is_unpublished" t-value="not provider_sudo.is_published"/>
        <t t-set="inline_form_xml_id" t-value="provider_sudo.token_inline_form_view_id.xml_id"/>
        <div class="d-flex gap-3">
            <div class="row flex-column flex-md-row flex-grow-1 gap-lg-3">
                <div class="col col-lg-5">
                    <div t-att-class="'form-check mb-0' + (' ps-0' if not allow_token_selection else '')">
                        <!-- === Radio button === -->
                        <input t-attf-id="o_payment_token_{{token_sudo.id}}"
                               name="o_payment_radio"
                               type="radio"
                               t-att-checked="is_selected"
                               t-att-class="'form-check-input' + (' d-none' if not allow_token_selection else '')"
                               t-att-data-payment-option-id="token_sudo.id"
                               t-att-data-provider-code="token_sudo.provider_code"
                               data-payment-option-type="token"
                        />
                        <div class="d-flex align-items-center flex-wrap gap-2">
                            <!-- === Token label === -->
                            <label t-out="token_sudo.payment_method_id.name"
                                   class="o_payment_option_label text-break"
                                   t-attf-for="o_payment_token_{{token_sudo.id}}"
                            />
                            <div>
                                <!-- === "Unpublished" icon === -->
                                <t t-if="is_unpublished" t-call="payment.form_icon">
                                    <t t-set="icon_name" t-value="'eye-slash'"/>
                                    <t t-set="color_name" t-value="'danger'"/>
                                    <t t-set="title" t-value="'Unpublished'"/>
                                </t>
                                <!-- === "Test mode" icon === -->
                                <t t-if="is_test" t-call="payment.form_icon">
                                    <t t-set="icon_name" t-value="'exclamation-triangle'"/>
                                    <t t-set="color_name" t-value="'warning'"/>
                                    <t t-set="title" t-value="'Test mode'"/>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- === Token name (payment details) === -->
                <div class="col mt-1">
                    <p t-out="token_sudo.display_name"
                       class="mb-0 ms-4 ms-lg-0 small fw-bold text-break"/>
                </div>
                <!-- === Provider name === -->
                <div class="col mt-1">
                    <p class="mb-0 ms-4 ms-lg-0 small text-muted">
                        <span>Managed by</span>
                        <span t-out="dict(provider_sudo._fields['code']._description_selection(provider_sudo.env))[provider_sudo.code]"
                              class="text-break"
                        />
                    </p>
                </div>
            </div>
            <!-- === Payment method logo === -->
            <div t-call="payment.form_logo">
                <t t-set="logo" t-value="token_sudo.payment_method_id.image_payment_form"/>
                <t t-set="title" t-value="token_sudo.payment_method_id.name"/>
            </div>
            <!-- === Delete button === -->
            <button name="o_payment_delete_token"
                    t-att-class="'btn btn-link align-self-start py-0 px-2 z-index-1' + (' d-none' if mode != 'validation' else '')"
            >
                <i class="fa fa-trash"
                   title="Delete payment method"
                   data-bs-toggle="tooltip"
                   data-bs-placement="top"
                   data-bs-delay="0"
                />
            </button>
        </div>
        <!-- === Inline form === -->
        <div t-if="inline_form_xml_id"
             name="o_payment_inline_form"
             class="position-relative d-none"
        >
            <t t-call="{{inline_form_xml_id}}"/>
        </div>
    </template>

    <template id="payment.method_form" name="Payment Method Form">
        <!-- Parameters description:
            - pm_sudo: The payment method to display, as a sudoed `payment.method` recordset.
            - is_selected: Whether the radio button of the payment method should be checked.
        -->
        <t t-set="provider_sudo" t-value="pm_sudo.provider_ids[:1]"/>
        <t t-set="is_test" t-value="provider_sudo.state == 'test'"/>
        <t t-set="is_unpublished" t-value="not provider_sudo.is_published"/>
        <t t-set="pms_to_display_sudo" t-value="pm_sudo.child_payment_method_ids or pm_sudo"/>
        <t t-set="inline_form_xml_id" t-value="provider_sudo.inline_form_view_id.xml_id"/>
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-0 p-0"
             for="o_payment_radio"
        >
            <div class="form-check d-flex flex-grow-1 flex-wrap mb-0">
                <div class="d-flex justify-content-between align-items-start gap-2 w-100">
                    <!-- === Radio button === -->
                    <input t-attf-id="o_payment_method_{{pm_sudo.id}}"
                           name="o_payment_radio"
                           type="radio"
                           t-att-checked="is_selected"
                           class="form-check-input position-absolute"
                           t-att-data-payment-option-id="pm_sudo.id"
                           t-att-data-provider-code="provider_sudo.code"
                           t-att-data-payment-method-id="pm_sudo.id"
                           data-payment-option-type="payment_method"
                    />
                    <div class="d-flex flex-column flex-md-row align-items-md-center gap-2 flex-grow-1">
                        <!-- === Method label === -->
                        <label t-out="pm_sudo.name"
                               class="o_payment_option_label mb-0 text-break"
                               t-attf-for="o_payment_method_{{pm_sudo.id}}"
                        />
                        <div>
                            <!-- === "Unpublished" icon === -->
                            <t t-if="is_unpublished" t-call="payment.form_icon">
                                <t t-set="icon_name" t-value="'eye-slash'"/>
                                <t t-set="color_name" t-value="'danger'"/>
                                <t t-set="title" t-value="'Unpublished'"/>
                            </t>
                            <!-- === "Test mode" icon === -->
                            <t t-if="is_test" t-call="payment.form_icon">
                                <t t-set="icon_name" t-value="'exclamation-triangle'"/>
                                <t t-set="color_name" t-value="'warning'"/>
                                <t t-set="title" t-value="'Test mode'"/>
                            </t>
                        </div>
                    </div>
                    <div class="gap-1 flex-wrap flex-grow-1 justify-content-end d-flex">
                        <!-- === Payment method logos === -->
                        <t t-foreach="pms_to_display_sudo" t-as="pm_to_display_sudo">
                            <t t-call="payment.form_logo">
                                <t t-set="logo" t-value="pm_to_display_sudo.image_payment_form"/>
                                <t t-set="title" t-value="pm_to_display_sudo.name"/>
                            </t>
                        </t>
                    </div>
                </div>
            </div>
            <!-- === Help message === -->
            <div t-if="not is_html_empty(provider_sudo.pre_msg)"
                 class="w-100 mb-0 ms-4 small text-muted"
            >
                <t t-out="provider_sudo.pre_msg"/>
            </div>
        </div>
        <!-- === Inline form === -->
        <div name="o_payment_inline_form" class="position-relative d-none">
            <t t-if="inline_form_xml_id and provider_sudo._should_build_inline_form(is_validation=mode == 'validation')"
               t-call="{{inline_form_xml_id}}"
            >
                <t t-set="provider_id" t-value="provider_sudo.id"/>
            </t>
            <!-- === Tokenization checkbox === -->
            <div name="o_payment_tokenize_container" class="o-checkbox form-check mt-2">
                <label t-if="show_tokenize_input_mapping[provider_sudo.id]">
                    <input name="o_payment_tokenize_checkbox"
                           class="form-check-input"
                           type="checkbox"
                    />
                    <small class="text-muted">Save my payment details</small>
                </label>
            </div>
        </div>
    </template>

    <template id="payment.form_icon" name="Form Icon">
        <!-- Parameters description:
            - icon_name: The name of the FontAwesome icon.
            - color_name: The class name of the color (`warning`, `danger`...).
            - title: The title to display on hover.
        -->
        <i t-attf-class="fa fa-{{icon_name}} text-{{color_name}} position-relative z-index-1"
           t-att-title="title"
           data-bs-toggle="tooltip"
           data-bs-placement="top"
           data-bs-delay="0"
        />
    </template>

    <template id="payment.form_logo" name="Form Logo">
        <!-- Parameters description:
            - logo: The logo to display, as an `Image` field.
            - title: The title to display on hover.
        -->
        <span t-out="logo"
              t-options="{'widget': 'image', 'alt-field': 'name'}"
              class="position-relative d-block rounded overflow-hidden z-index-1"
              t-att-title="title"
              data-bs-toggle="tooltip"
              data-bs-placement="top"
              data-bs-delay="0"
        />
    </template>

    <template id="payment.submit_button" name="Submit Button">
        <!-- Parameters description:
            - label: The label of the submit button.
        -->
        <button name="o_payment_submit_button"
                type="submit"
                t-out="label"
                class="btn btn-primary w-100 w-md-auto px-5"
                disabled="true"
        />
    </template>

</odoo>
