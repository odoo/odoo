<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <template id="assets_backend" name="Payment Assets Backend" inherit_id="web.assets_backend">
        <xpath expr="." position="inside">
            <link rel="stylesheet"
                  type="text/scss"
                  href="/payment/static/src/scss/payment_acquirer.scss"/>
        </xpath>
    </template>

    <template id="checkout" name="Payment Checkout">
        <!-- Variables description:
            - 'acquirers' - The payment acquirers compatible with the current transaction
            - 'tokens' - The payment tokens of the current partner and payment acquirers
            - 'default_token_id' - The id of the token that should be pre-selected. Optional
            - 'fees_by_acquirer' - The dict of transaction fees for each acquirer. Optional
            - 'show_tokenize_input' - Whether the option to save the payment method is shown
            - 'reference' - The custom prefix to compute the full transaction reference
            - 'amount' - The amount to pay
            - 'currency' - The currency of the transaction, as a `res.currency` record
            - 'partner_id' - The id of the partner on behalf of whom the payment should be made
            - 'order_id' - The id of the related order. Optional
            - 'access_token' - The access token used to authenticate the partner. Optional
            - 'init_tx_route' - The route to call to create a transaction when the user clicks 'Pay'
            - 'landing_route' - The route the user is redirected to after the transaction
            - 'footer_template_id' - The template id for the submit button. Optional
        -->
        <form name="o_payment_checkout"
              class="o_payment_form mt-3 clearfix"
              t-att-data-reference="reference"
              t-att-data-amount="amount"
              t-att-data-currency-id="currency and currency.id"
              t-att-data-partner-id="partner_id"
              t-att-data-order-id="order_id"
              t-att-data-access-token="access_token"
              t-att-data-init-tx-route="init_tx_route"
              t-att-data-landing-route="landing_route"
              t-att-data-allow-token-selection="True">
            
            <t t-set="acquirer_count" t-value="len(acquirers) if acquirers else 0"/>
            <t t-set="token_count" t-value="len(tokens) if tokens else 0"/>
            <!-- Check the radio button of the default token, if set, or of the first acquirer if
                 it is the only payment option -->
            <t t-set="default_payment_option_id"
               t-value="default_token_id if default_token_id and token_count > 0
                        else acquirers[0].id if acquirer_count == 1 and token_count == 0
                        else None"/>
            <t t-set="fees_by_acquirer" t-value="fees_by_acquirer or dict()"/>
            <t t-set="footer_template_id"
               t-value="footer_template_id or 'payment.footer'"/>
               
            <div class="card">
                <!-- === Acquirers === -->
                <t t-foreach="acquirers" t-as="acquirer">
                    <div name="o_payment_option_card" class="card-body o_payment_option_card">
                        <label>
                            <!-- === Radio button === -->
                            <!-- Only shown if linked to the only payment option -->
                            <input name="o_payment_radio"
                                   type="radio"
                                   t-att-checked="acquirer.id == default_payment_option_id"
                                   t-att-class="'' if acquirer_count + token_count > 1 else 'd-none'"
                                   t-att-data-payment-option-id="acquirer.id"
                                   t-att-data-provider="acquirer.provider"/>
                            <!-- === Acquirer name === -->
                            <span class="payment_option_name">
                                <b><t t-esc="acquirer.display_as or acquirer.name"/></b>
                            </span>
                            <!-- === "Test Mode" badge === -->
                            <span t-if="acquirer.state == 'test'"
                                  class="badge-pill badge-warning"
                                  style="margin-left:5px">
                                Test Mode
                            </span>
                            <!-- === Extra fees badge === -->
                            <t t-if="fees_by_acquirer.get(acquirer)">
                                <br/>
                                <span class="badge-pill badge-secondary">
                                    + <t t-esc="fees_by_acquirer.get(acquirer)"
                                         t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                                    Fees
                                </span>
                            </t>
                        </label>
                        <!-- === Payment icon list === -->
                        <t t-call="payment.icon_list"/>
                        <!-- === Help message === -->
                        <div t-raw="acquirer.pre_msg" class="text-muted ml-3"/>
                    </div>
                    <!-- === Acquirer inline form === -->
                    <div t-attf-id="o_payment_inline_form_{{acquirer.id}}"
                         class="card-footer d-none">
                        <!-- === Inline form content (filled by acquirer) === -->
                        <div class="clearfix">
                            <t t-set="inline_form_xml_id"
                               t-value="acquirer.sudo()._get_inline_template_view_xml_id()"/>
                            <t t-if="inline_form_xml_id" t-call="{{inline_form_xml_id}}">
                                <t t-set="acquirer_id" t-value="acquirer.id"/>
                            </t>
                        </div>
                        <!-- === "Save my payment details" checkbox === -->
                        <!-- Only shown if partner is known and if the choice is given -->
                        <label t-att-class="'' if show_tokenize_input and acquirer.allow_tokenization else 'd-none'">
                            <input name="o_payment_save_as_token" type="checkbox"/>
                            Save my payment details
                        </label>
                    </div>
                </t>
                <!-- === Tokens === -->
                <t t-foreach="tokens" t-as="token">
                    <div name="o_payment_option_card" class="card-body o_payment_option_card">
                        <label>
                            <!-- === Radio button === -->
                            <input name="o_payment_radio"
                                   type="radio"
                                   t-att-checked="token.id == default_payment_option_id"
                                   t-att-data-payment-option-id="token.id"
                                   t-att-data-provider="token.acquirer_id.provider"
                                   data-is-token="true"/>
                            <!-- === Token name === -->
                            <span class="payment_option_name" t-esc="token.name"/>
                            <!-- === "V" check mark === -->
                            <t t-if="token.verified">
                                <i class="fa fa-check text-success"
                                   title="This payment method has been verified by our system."
                                   role="img"
                                   aria-label="Ok"/>
                            </t>
                            <t t-else="">
                                <i class="fa fa-check text-muted"
                                   title="This payment method has not been verified by our system."
                                   role="img"
                                   aria-label="Not verified"/>
                            </t>
                        </label>
                    </div>
                    <!-- === Token inline form === -->
                    <div t-attf-id="o_payment_inline_form_{{token.id}}" class="card-footer d-none"/>
                </t>
            </div>
            <!-- === "Pay" button === -->
            <t t-call="{{footer_template_id}}">
                <t t-set="label">Pay</t>
                <t t-set="icon_class" t-value="'fa-lock'"/>
            </t>
        </form>
    </template>
    
    <template id="manage" name="Payment Manage">
        <!-- Variables description:
            - 'acquirers' - The payment acquirers supporting tokenization
            - 'tokens' - The set of payment tokens of the current partner
            - 'default_token_id' - The id of the token that should be pre-selected. Optional
            - 'reference' - The custom prefix to compute the full transaction reference
            - 'partner_id' - The id of the partner managing the tokens
            - 'init_tx_route' - The route to call to create a card validation transaction when the
                                user clicks 'Save'
            - 'assign_token_route' - The route to call to assign a token to a record. If set, it
                                     enables the token assignation mechanisms: creation of a new
                                     token through a refunded transaction and assignation of an
                                     existing token
            - 'landing_route' - The route the user is redirected to after a card validation or a
                                token assignation
            - 'footer_template_id' - The template id for the submit button. Optional
        -->
        <form name="o_payment_manage"
              class="o_payment_form mt-3 clearfix"
              t-att-data-reference="reference"
              t-att-data-partner-id="partner_id"
              t-att-data-init-tx-route="init_tx_route"
              t-att-data-assign-token-route="assign_token_route"
              t-att-data-landing-route="landing_route"
              t-att-data-allow-token-selection="bool(assign_token_route)">
            <t t-set="acquirer_count" t-value="len(acquirers) if acquirers else 0"/>
            <t t-set="token_count" t-value="len(tokens) if tokens else 0"/>
            <t t-set="default_payment_option_id"
               t-value="default_token_id if default_token_id and token_count > 0
                        else acquirers[0].id if acquirer_count == 1 and token_count == 0
                        else None"/>
            <t t-set="footer_template_id"
               t-value="footer_template_id or 'payment.footer'"/>
            <div class="card">
                <!-- === Acquirers === -->
                <t t-foreach="acquirers" t-as="acquirer">
                    <div name="o_payment_option_card" class="card-body o_payment_option_card">
                        <label>
                            <!-- === Radio button === -->
                            <!-- Only shown if linked to the only payment option -->
                            <input name="o_payment_radio"
                                   type="radio"
                                   t-att-checked="acquirer.id == default_payment_option_id"
                                   t-att-class="'' if acquirer_count + token_count > 1 else 'd-none'"
                                   t-att-data-payment-option-id="acquirer.id"
                                   t-att-data-provider="acquirer.provider"/>
                            <!-- === Acquirer name === -->
                            <span class="payment_option_name">
                                <b><t t-esc="acquirer.display_as or acquirer.name"/></b>
                            </span>
                            <!-- === "Test Mode" badge === -->
                            <span t-if="acquirer.state == 'test'"
                                  class="badge-pill badge-warning"
                                  style="margin-left:5px">
                                Test Mode
                            </span>
                        </label>
                        <!-- === Payment icon list === -->
                        <t t-call="payment.icon_list"/>
                        <!-- === Help message === -->
                        <div t-raw="acquirer.pre_msg" class="text-muted ml-3"/>
                    </div>
                    <!-- === Acquirer inline form === -->
                    <div t-attf-id="o_payment_inline_form_{{acquirer.id}}"
                         class="card-footer d-none">
                        <!-- === Inline form content (filled by acquirer) === -->
                        <div class="clearfix">
                            <t t-set="inline_form_xml_id"
                               t-value="acquirer.sudo()._get_inline_template_view_xml_id()"/>
                            <t t-if="inline_form_xml_id" t-call="{{inline_form_xml_id}}">
                                <t t-set="acquirer_id" t-value="acquirer.id"/>
                            </t>
                        </div>
                    </div>
                </t>
                <!-- === Tokens === -->
                <t t-foreach="tokens" t-as="token">
                    <div name="o_payment_option_card" class="card-body o_payment_option_card">
                        <label>
                            <!-- === Radio button === -->
                            <!-- Only shown if 'assign_token_route' is set -->
                            <input name="o_payment_radio"
                                   type="radio"
                                   t-att-checked="token.id == default_payment_option_id"
                                   t-att-class="'' if bool(assign_token_route) else 'd-none'"
                                   t-att-data-payment-option-id="token.id"
                                   t-att-data-provider="token.acquirer_id.provider"
                                   data-is-token="true"/>
                            <!-- === Token name === -->
                            <span class="payment_option_name" t-esc="token.name"/>
                            <!-- === "V" check mark === -->
                            <t t-if="token.verified">
                                <i class="fa fa-check text-success"
                                   title="This payment method has been verified by our system."
                                   role="img"
                                   aria-label="Ok"/>
                            </t>
                            <t t-else="">
                                <i class="fa fa-check text-muted"
                                   title="This payment method has not been verified by our system."
                                   role="img"
                                   aria-label="Not verified"/>
                            </t>
                        </label>
                        <!-- === "Delete" token button === -->
                        <button name="o_payment_delete_token"
                                class="btn btn-primary btn-sm float-right">
                            <i class="fa fa-trash"/> Delete
                        </button>
                    </div>
                    <!-- === Token inline form === -->
                    <div t-attf-id="o_payment_inline_form_{{token.id}}" class="card-footer d-none"/>
                </t>
            </div>
            <!-- === "Save Payment Method" button === -->
            <t t-call="{{footer_template_id}}">
                <t t-set="label">Save Payment Method</t>
                <t t-set="icon_class" t-value="'fa-plus-circle'"/>
            </t>
        </form>
    </template>
    
    <template id="icon_list" name="Payment Icon List">
        <ul class="payment_icon_list float-right list-inline" data-max-icons="3">
            <t t-set="icon_index" t-value="0"/>
            <t t-set="MAX_ICONS" t-value="3"/>
            <!-- === Icons === -->
            <!-- Only shown if in the first 3 icons -->
            <t t-foreach="acquirer.payment_icon_ids" t-as="icon">
                <li t-attf-class="list-inline-item{{'' if (icon_index &lt; MAX_ICONS) else ' d-none'}}">
                    <span t-esc="icon.image_payment_form"
                          t-options="{'widget': 'image', 'alt-field': 'name'}"
                          data-toggle="tooltip"
                          t-att-title="icon.name"/>
                </li>
                <t t-set="icon_index" t-value="icon_index + 1"/>
            </t>
            <t t-if="icon_index >= MAX_ICONS">
                <!-- === "show more" button === -->
                <!-- Only displayed if too many payment icons -->
                <li style="display:block;" class="list-inline-item">
                    <span class="float-right more_option text-info">
                        <a name="o_payment_icon_more"
                           data-toggle="tooltip"
                           t-att-title="', '.join([icon.name for icon in acquirer.payment_icon_ids[MAX_ICONS:]])">
                            show more
                        </a>
                    </span>
                </li>
                <!-- === "show less" button === -->
                <!-- Only displayed when "show more" is clicked -->
                <li style="display:block;" class="list-inline-item d-none">
                    <span class="float-right more_option text-info">
                        <a name="o_payment_icon_less">show less</a>
                    </span>
                </li>
            </t>
        </ul>
    </template>
    
    <template id="footer" name="Payment Footer">
        <!-- Variables description:
            - 'label' - The label for the submit button
            - 'icon_class' - The Font Awesome icon class (e.g. 'fa-lock') for the submit button
        -->
        <div class="float-right mt-2">
            <button name="o_payment_submit_button"
                    type="submit"
                    class="btn btn-primary btn-lg mb8 mt8"
                    disabled="true"
                    t-att-data-icon-class="icon_class">
                <i t-attf-class="fa {{icon_class}}"/> <t t-esc="label"/>
            </button>
        </div>
    </template>
    
</odoo>
