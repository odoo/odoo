<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Integration of a conditional "Manage payment methods" link in /my -->
    <template id="pay_meth_link" inherit_id="portal.portal_side_bar">
        <xpath expr="//a[@href='/my/account']/.." position="after">
            <t t-set="partner" t-value="request.env.user.partner_id"/>
            <t t-set="acquirers_allowing_tokenization"
               t-value="request.env['payment.acquirer'].sudo()._get_compatible_acquirers(request.env.company.id, partner.id, allow_tokenization=True, is_validation=True)"/>
            <t t-set="existing_tokens" t-value="partner.payment_token_ids + partner.commercial_partner_id.sudo().payment_token_ids"/>
            <!-- Only show the link if a token can be created or if one already exists -->
            <div t-if="acquirers_allowing_tokenization or existing_tokens" class='row manage_payment_method'>
                <a role="button" href="/my/payment_method"
                    t-attf-class="btn btn-link #{'font-weight-bold' if page_name == 'payment' else ''}">Manage Payment Methods</a>
            </div>
        </xpath>
    </template>

    <!-- Display of /payment/pay -->
    <template id="pay">
        <!-- Variables description:
            - 'partner_is_different' - Whether the partner logged in is the one making the payment
        -->
        <t t-call="portal.portal_layout">
            <t t-set="page_name" t-value="'payment'"/>
            <t t-set="page_title" t-value="'Payment'"/>
            <t t-set="additional_title"><t t-esc="page_title"/></t>
            <div class="wrap">
                <div class="container">
                    <!-- Payment page -->
                    <div class="row">
                        <div class="col-lg-7">
                            <div t-if="not amount" class="alert alert-info">
                                There is nothing to pay.
                            </div>
                            <div t-elif="not currency" class="alert alert-warning">
                                <strong>Warning</strong> The currency is missing or incorrect.
                            </div>
                            <div t-elif="not partner_id" class="alert alert-warning">
                                <strong>Warning</strong> You must be logged in to pay.
                            </div>
                            <div t-elif="not acquirers and not tokens" class="alert alert-warning">
                                <strong>No suitable payment option could be found.</strong><br/>
                                If you believe that it is an error, please contact the website administrator.
                            </div>
                            <t t-else="">
                                <div t-if="partner_is_different" class="alert alert-warning">
                                    <strong>Warning</strong> Make sure your are logged in as the right partner before making this payment.
                                </div>
                                <t t-if="reference_prefix">
                                    <b>Reference:</b>
                                    <t t-esc="reference_prefix"/><br/>
                                </t>
                                <b>Amount:</b>
                                <t t-esc="amount"
                                   t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                                <t t-call="payment.checkout"/>
                            </t>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Display of /my/payment_methods -->
    <template id="payment_methods" name="Payment Methods">
        <t t-call="portal.portal_layout">
            <t t-set="page_name" t-value="'payment'"/>
            <t t-set="page_title" t-value="'Payment Methods'"/>
            <t t-set="additional_title"><t t-esc="page_title"/></t>
            <t t-set="show_side_bar" t-value="True"/>
            <div class="wrap">
                <div class="container">
                    <!-- Manage page -->
                    <div class="row">
                        <div class="col-lg-12">
                            <t t-if="acquirers or tokens" t-call="payment.manage"/>
                            <div t-else="" class="alert alert-warning">
                                <p><strong>No suitable payment acquirer could be found.</strong></p>
                                <p>If you believe that it is an error, please contact the website administrator.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Display of /payment/status -->
    <template id="payment_status" name="Payment Status">
        <t t-call="portal.portal_layout">
            <t t-set="page_name" t-value="'payment'"/>
            <t t-set="page_title" t-value="'Payment Status'"/>
            <t t-set="additional_title"><t t-esc="page_title"/></t>
            <div class="wrap">
                <div class="container">
                    <!-- Status page -->
                    <div name="o_payment_status">
                        <div name="o_payment_status_content"
                             class="col-sm-6 col-sm-offset-3 alert alert-warning">
                            <!-- The content is generated in JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Display of /payment/confirmation -->
    <template id="confirm">
        <!-- Variables description:
            - 'tx' - The transaction to display
            - 'message' - The acquirer message configured for the given transaction state
            - 'status' - The alert class to use for the message
        -->
        <t t-call="portal.portal_layout">
            <t t-set="page_name" t-value="'payment'"/>
            <t t-set="page_title" t-value="'Payment Confirmation'"/>
            <t t-set="additional_title"><t t-esc="page_title"/></t>
            <div class="wrap">
                <div class="container">
                    <!-- Confirmation page -->
                    <div class="row">
                        <div class="col-lg-6">
                            <div>
                                <!-- message is the content of either the HTML field describing the
                                transaction state computed while processing feedback data, or the
                                HTML field associated with the transaction state, defined on the
                                acquirer.  -->
                                <div t-attf-class="alert alert-#{status}"
                                     t-out="message"
                                     role="status"/>
                                <div class="form-group row">
                                    <label for="form_partner_name" class="col-md-3 col-form-label">
                                        From
                                    </label>
                                    <span name="form_partner_name"
                                          class="col-md-9 col-form-label"
                                          t-esc="tx.partner_name"/>
                                </div>
                                <hr/>
                                <div class="form-group row">
                                    <label for="form_reference" class="col-md-3 col-form-label">
                                        Reference
                                    </label>
                                    <span name="form_reference"
                                          class="col-md-9 col-form-label"
                                          t-esc="tx.reference"/>
                                </div>
                                <hr/>
                                <div class="form-group row">
                                    <label for="form_amount" class="col-md-3 col-form-label">
                                        Amount
                                    </label>
                                    <span name="form_amount"
                                          class="col-md-9 col-form-label"
                                          t-esc="tx.amount"
                                          t-options="{'widget': 'monetary', 'display_currency': tx.currency_id}"/>
                                </div>
                                <hr/>
                                <div class="row">
                                    <div class="col-md-5 text-muted">
                                        Processed by <t t-esc="tx.acquirer_id.sudo().name"/>
                                    </div>
                                    <div class="col-md-4 offset-md-3 mt-2 pl-0">
                                        <a role="button"
                                           t-attf-class="btn btn-#{status} float-right"
                                           href="/my/home">
                                            <i class="fa fa-arrow-circle-right"/> Back to My Account
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <template id="portal_breadcrumbs" name="Payment Methods Breadcrumb" inherit_id="portal.portal_breadcrumbs" priority="10">
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
            <li t-if="page_name == 'payment'" class="breadcrumb-item active"><t t-esc="page_title"/></li>
        </xpath>
    </template>

</odoo>
