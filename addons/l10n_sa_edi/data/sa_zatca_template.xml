<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <template id="export_sa_zatca_ubl_extensions">
            <ext:UBLExtensions xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
                xmlns:ext="urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2">
                <ext:UBLExtension>
                    <ext:ExtensionURI>urn:oasis:names:specification:ubl:dsig:enveloped:xades</ext:ExtensionURI>
                    <ext:ExtensionContent>
                        <sig:UBLDocumentSignatures
                            xmlns:sac="urn:oasis:names:specification:ubl:schema:xsd:SignatureAggregateComponents-2"
                            xmlns:sbc="urn:oasis:names:specification:ubl:schema:xsd:SignatureBasicComponents-2"
                            xmlns:sig="urn:oasis:names:specification:ubl:schema:xsd:CommonSignatureComponents-2">
                            <sac:SignatureInformation>
                                <cbc:ID>urn:oasis:names:specification:ubl:signature:1</cbc:ID>
                                <sbc:ReferencedSignatureID>urn:oasis:names:specification:ubl:signature:Invoice
                                </sbc:ReferencedSignatureID>
                                <ds:Signature Id="signature" xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
                                    <ds:SignedInfo>
                                        <ds:CanonicalizationMethod
                                            Algorithm="http://www.w3.org/2006/12/xml-c14n11" />
                                        <ds:SignatureMethod
                                            Algorithm="http://www.w3.org/2001/04/xmldsig-more#ecdsa-sha256" />
                                        <ds:Reference Id="invoiceSignedData" URI="">
                                            <ds:Transforms>
                                                <ds:Transform Algorithm="http://www.w3.org/TR/1999/REC-xpath-19991116">
                                                    <ds:XPath>not(//ancestor-or-self::ext:UBLExtensions)</ds:XPath>
                                                </ds:Transform>
                                                <ds:Transform Algorithm="http://www.w3.org/TR/1999/REC-xpath-19991116">
                                                    <ds:XPath>not(//ancestor-or-self::cac:Signature)</ds:XPath>
                                                </ds:Transform>
                                                <ds:Transform Algorithm="http://www.w3.org/TR/1999/REC-xpath-19991116">
                                                    <ds:XPath>
                                                        not(//ancestor-or-self::cac:AdditionalDocumentReference[cbc:ID='QR'])
                                                    </ds:XPath>
                                                </ds:Transform>
                                                <ds:Transform Algorithm="http://www.w3.org/2006/12/xml-c14n11" />
                                            </ds:Transforms>
                                            <ds:DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256" />
                                            <!-- b64encoded SHA256 digest of document -->
                                            <ds:DigestValue id="invoice_hash" />
                                        </ds:Reference>
                                        <ds:Reference Type="http://www.w3.org/2000/09/xmldsig#SignatureProperties"
                                            URI="#xadesSignedProperties">
                                            <ds:DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256" />
                                            <ds:DigestValue id="signed_properties_hashing" />
                                        </ds:Reference>
                                    </ds:SignedInfo>
                                    <ds:SignatureValue id="digital_signature" />
                                    <ds:KeyInfo>
                                        <ds:X509Data>
                                            <ds:X509Certificate id="x509_certificate" />
                                        </ds:X509Data>
                                    </ds:KeyInfo>
                                    <ds:Object>
                                        <xades:QualifyingProperties xmlns:xades="http://uri.etsi.org/01903/v1.3.2#" Target="signature">
                                            <xades:SignedProperties xmlns:xades="http://uri.etsi.org/01903/v1.3.2#" Id="xadesSignedProperties">
                                                <xades:SignedSignatureProperties>
                                                    <xades:SigningTime id="signing_time" />
                                                    <xades:SigningCertificate>
                                                        <xades:Cert>
                                                            <xades:CertDigest>
                                                                <ds:DigestMethod xmlns:ds="http://www.w3.org/2000/09/xmldsig#" Algorithm="http://www.w3.org/2001/04/xmlenc#sha256" />
                                                                <ds:DigestValue xmlns:ds="http://www.w3.org/2000/09/xmldsig#" id="public_key_hashing" />
                                                            </xades:CertDigest>
                                                            <xades:IssuerSerial>
                                                                <ds:X509IssuerName xmlns:ds="http://www.w3.org/2000/09/xmldsig#" id="issuer_name" />
                                                                <ds:X509SerialNumber xmlns:ds="http://www.w3.org/2000/09/xmldsig#" id="serial_number" />
                                                            </xades:IssuerSerial>
                                                        </xades:Cert>
                                                    </xades:SigningCertificate>
                                                </xades:SignedSignatureProperties>
                                            </xades:SignedProperties>
                                        </xades:QualifyingProperties>
                                    </ds:Object>
                                </ds:Signature>
                            </sac:SignatureInformation>
                        </sig:UBLDocumentSignatures>
                    </ext:ExtensionContent>
                </ext:UBLExtension>
            </ext:UBLExtensions>
        </template>

        <template id="export_sa_zatca_ubl_signed_properties">
            <xades:SignedProperties xmlns:xades="http://uri.etsi.org/01903/v1.3.2#" Id="xadesSignedProperties">
                <xades:SignedSignatureProperties>
                    <xades:SigningTime t-out="signing_time" />
                    <xades:SigningCertificate>
                        <xades:Cert>
                            <xades:CertDigest>
                                <ds:DigestMethod xmlns:ds="http://www.w3.org/2000/09/xmldsig#" Algorithm="http://www.w3.org/2001/04/xmlenc#sha256" />
                                <ds:DigestValue xmlns:ds="http://www.w3.org/2000/09/xmldsig#" t-out="public_key_hashing" />
                            </xades:CertDigest>
                            <xades:IssuerSerial>
                                <ds:X509IssuerName xmlns:ds="http://www.w3.org/2000/09/xmldsig#" t-out="issuer_name" />
                                <ds:X509SerialNumber xmlns:ds="http://www.w3.org/2000/09/xmldsig#" t-out="serial_number" />
                            </xades:IssuerSerial>
                        </xades:Cert>
                    </xades:SigningCertificate>
                </xades:SignedSignatureProperties>
            </xades:SignedProperties>
        </template>

        <template id="export_sa_zatca_invoice_line" inherit_id="account_edi_ubl.export_ubl_invoice_line" primary="True">
            <xpath expr="//*[local-name()='TaxAmount']" position="replace">
                <cbc:TaxAmount xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                    xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
                    t-att-currencyID="line.currency_id.name"
                    t-esc="format_monetary(abs(tax_detail_vals['tax_amount_currency']))" />
                <cbc:RoundingAmount xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                    xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
                    currencyID="SAR" t-esc="format_monetary(abs(line_vals['price_subtotal_before_discount']) + abs(tax_detail_vals['tax_amount_currency']))" />
            </xpath>
            <xpath expr="//*[local-name()='Item']" position="inside">
                <cac:ClassifiedTaxCategory t-foreach="line.tax_ids" t-as="tax_id"
                    xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                    xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
                    xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2">
                    <cbc:ID schemeID="UN/ECE 5305" t-esc="tax_id.tax_group_id.l10n_sa_edi_tax_category" />
                    <cbc:Percent t-esc="tax_id.amount" />
                    <cac:TaxScheme>
                        <cbc:ID schemeID="UN/ECE 5153">VAT</cbc:ID>
                    </cac:TaxScheme>
                </cac:ClassifiedTaxCategory>
                <!-- According to ZATCA specifications, if a line has no taxes, it should still have an
                     empty ClassifiedTaxCategory element -->
                <cac:ClassifiedTaxCategory  t-if="not line.tax_ids" xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                    xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
                    xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2">
                    <cbc:ID schemeID="UN/ECE 5305">S</cbc:ID>
                    <cbc:Percent>0.0</cbc:Percent>
                    <cac:TaxScheme>
                        <cbc:ID schemeID="UN/ECE 5153">VAT</cbc:ID>
                    </cac:TaxScheme>
                </cac:ClassifiedTaxCategory>
            </xpath>
        </template>

        <template id="export_sa_zatca_invoice_tax_total">
            <cac:TaxTotal xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
                <cbc:TaxAmount t-att-currencyID="record.currency_id.name"
                    t-esc="format_monetary(record.amount_tax)" />
                <cac:TaxSubtotal t-foreach="tax_details['tax_details']" t-as="tax">
                    <cbc:TaxableAmount t-att-currencyID="record.currency_id.name"
                        t-esc="format_monetary(tax_value['base_amount'] * balance_multiplicator)" />
                    <cbc:TaxAmount t-att-currencyID="record.currency_id.name"
                        t-esc="format_monetary(tax_value['tax_amount'] * balance_multiplicator)" />
                    <cac:TaxCategory>
                        <t t-set="tax_id" t-value="tax_value['tax']" />
                        <cbc:ID schemeID="UN/ECE 5305" t-esc="tax_id.tax_group_id.l10n_sa_edi_tax_category" />
                        <cbc:Percent t-esc="format_monetary(tax_id.amount)" />
                        <cac:TaxScheme>
                            <cbc:ID schemeID="UN/ECE 5153">VAT</cbc:ID>
                        </cac:TaxScheme>
                    </cac:TaxCategory>
                </cac:TaxSubtotal>
            </cac:TaxTotal>
            <!-- For some reason, to satisfy BR-KSA-EN16931-09 you need to have two TaxTotal elements, one with
                 TaxSubtotal and one without -->
            <cac:TaxTotal xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
                <cbc:TaxAmount t-att-currencyID="record.currency_id.name"
                    t-esc="format_monetary(record.amount_tax)" />
            </cac:TaxTotal>
        </template>

        <template id="export_sa_zatca_invoice_previous_hash">
            <cac:AdditionalDocumentReference xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
                <cbc:ID>PIH</cbc:ID>
                <cac:Attachment>
                    <cbc:EmbeddedDocumentBinaryObject mimeCode="text/plain" t-esc="previous_invoice_hash.decode()" />
                </cac:Attachment>
            </cac:AdditionalDocumentReference>
        </template>

        <template id="export_sa_zatca_invoice_counter_value">
            <cac:AdditionalDocumentReference xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
                <cbc:ID>ICV</cbc:ID>
                <cbc:UUID t-esc="record.id" />
            </cac:AdditionalDocumentReference>
        </template>

        <template id="export_sa_zatca_invoice_partner" inherit_id="account_edi_ubl.export_ubl_invoice_partner"
            primary="True">
            <!--  Seller/Buyer identification in compliance with rules BT-29, BT-29-1 and BG-5 of the EN 16931/KSA standards  -->
            <xpath expr="//*[local-name()='Party']/*[local-name()='WebsiteURI']" position="before">
                <cac:PartyIdentification xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                    xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                    xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
                    <cbc:ID t-att-schemeID="partner.l10n_sa_additional_identification_scheme"
                        t-esc="partner.l10n_sa_additional_identification_number" />
                </cac:PartyIdentification>
            </xpath>
            <!--  Seller/Buyer name in compliance with rules BR-06 and BT-44 of the EN 16931 standard  -->
            <xpath expr="//*[local-name()='Party']/*[local-name()='Contact']" position="before">
                <cac:PartyLegalEntity xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                    xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                    xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
                    <cbc:RegistrationName t-esc="partner.name" />
                </cac:PartyLegalEntity>
            </xpath>
            <xpath expr="//*[local-name()='PostalAddress']/*[local-name()='StreetName']" position="after">
                <t xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                    xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                    xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
                    <!--  Add Building number in compliance with rules KSA-17 (seller)/ KSA-18 (customer)  -->
                    <cbc:BuildingNumber t-if="partner.l10n_sa_edi_building_number"
                        t-esc="partner.l10n_sa_edi_building_number" />
                    <!--  Add Plot identification in compliance with rules KSA-23 (seller)/ KSA-19 (customer)  -->
                    <cbc:PlotIdentification t-if="partner.l10n_sa_edi_plot_identification"
                        t-esc="partner.l10n_sa_edi_plot_identification" />
                    <!--  Add Neighborhood in compliance with rules KSA-3 (seller)/ KSA-4 (customer)  -->
                    <cbc:CitySubdivisionName t-if="partner.l10n_sa_edi_neighborhood"
                        t-esc="partner.l10n_sa_edi_neighborhood" />
                </t>
            </xpath>
            <!--  RegistrationName causes the Compliance Checks API to raise an error, so it has to be removed -->
            <xpath expr="//*[local-name()='Party']/*[local-name()='PartyTaxScheme']" position="replace">
                <cac:PartyTaxScheme t-if="partner.vat"
                    xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                    xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                    xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
                    <cbc:CompanyID t-if="is_supplier" t-esc="partner.vat" />
                    <cac:TaxScheme>
                        <cbc:ID>VAT</cbc:ID>
                    </cac:TaxScheme>
                </cac:PartyTaxScheme>
            </xpath>
            <!-- WebsiteURI causes the Validation SDK to crash, so it has to be removed -->
            <xpath expr="//*[local-name()='WebsiteURI']" position="replace" />
        </template>

        <template id="export_sa_zatca_invoice" inherit_id="account_edi_ubl.export_ubl_invoice" primary="True">
            <xpath expr="//*[local-name()='ProfileID']" position="replace">
                <t t-call="l10n_sa_edi.export_sa_zatca_ubl_extensions" />
            </xpath>
            <xpath expr="//*[local-name()='UBLVersionID']" position="after">
                <cbc:ProfileID t-if="profile_id" t-esc="profile_id"
                    xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                    xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2" />
            </xpath>
            <xpath expr="//*[local-name()='IssueDate']" position="replace">
                <t xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                    xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
                    <cbc:IssueDate t-esc="invoice_datetime.strftime('%Y-%m-%d')" />
                    <cbc:IssueTime t-esc="invoice_datetime.strftime('%H:%M:%S')" />
                </t>
            </xpath>

            <!-- Add Invoice UUID in compliance with rule BR-KSA-03 -->
            <xpath expr="//*[local-name()='Invoice']/*[local-name()='ID']" position="after">
                <cbc:UUID xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
                    xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                    t-esc="record.l10n_sa_uuid" />
            </xpath>
            <!-- Add Tax Currency Code in compliance with rules BR-KSA-EN16931-02 and BR-KSA-68
                     The tax currency should be the same as the amount currency, since Odoo does not support
                     different currencies for tax amounts -->
            <xpath expr="//*[local-name()='DocumentCurrencyCode']" position="after">
                <cbc:TaxCurrencyCode xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
                    xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                    t-esc="record.currency_id.name" />
            </xpath>
            <xpath expr="//*[local-name()='OrderReference']" position="after">
                <!-- Add Billing Reference in compliance with rule BT-25 of the KSA standard -->
                <cac:BillingReference t-if="type_code in (381, 383)"
                    xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                    xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                    xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
                    <cac:InvoiceDocumentReference>
                        <!-- If Credit Note, we get the reference from either the reversed_entry_id or ref.
                             If Debit Note, we get the reference from the debit_origin_id -->
                        <cbc:ID t-esc="(record.reversed_entry_id.name or record.ref) if type_code == 381 else record.debit_origin_id.name" />
                    </cac:InvoiceDocumentReference>
                </cac:BillingReference>
                <!-- Add Previous Invoice Hash in compliance with rule BR-KSA-61 -->
                <t t-call="l10n_sa_edi.export_sa_zatca_invoice_previous_hash" />
                <!-- Add Invoice Counter Value in compliance with rules BR-KSA-33 and BR-KSA-34 -->
                <t t-call="l10n_sa_edi.export_sa_zatca_invoice_counter_value" />
            </xpath>
            <!-- Add the following elements in the Accounting parties elements:
                    -   Seller/Buyer name in compliance with rules BR-06 and BT-44 of the EN 16931 standard
                    -   Building number, Plot identification and Neighborhood: KSA-17/18, KSA-23/19 & KSA-3/4
             -->
            <xpath expr="//*[local-name()='AccountingSupplierParty']" position="replace">
                <cac:AccountingSupplierParty t-call="l10n_sa_edi.export_sa_zatca_invoice_partner"
                    xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                    xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2">
                    <t t-set="is_supplier" t-value="True" />
                    <t t-set="partner_vals" t-value="supplier_vals" />
                </cac:AccountingSupplierParty>
            </xpath>
            <xpath expr="//*[local-name()='AccountingCustomerParty']" position="replace">
                <cac:AccountingCustomerParty t-call="l10n_sa_edi.export_sa_zatca_invoice_partner"
                    xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                    xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2">
                    <t t-set="partner_vals" t-value="customer_vals" />
                </cac:AccountingCustomerParty>
            </xpath>
            <xpath expr="//*[local-name()='PaymentMeans']" position="before">
                <cac:Delivery xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                    xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
                    xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2">
                    <cbc:ActualDeliveryDate t-esc="record.l10n_sa_delivery_date" />
                </cac:Delivery>
            </xpath>
            <!-- Add VAT Breakdown in compliance with rule BR-CO-18 of the EN 16931 standard -->
            <xpath expr="//*[local-name()='TaxTotal']" position="replace">
                <t t-call="l10n_sa_edi.export_sa_zatca_invoice_tax_total" />
            </xpath>
            <!-- Add VAT category in invoice lines in compliance with rule BR-CO-04 of the EN 16931 standard -->
            <xpath expr="//*[@t-call='account_edi_ubl.export_ubl_invoice_line']" position="replace">
                <t t-call="l10n_sa_edi.export_sa_zatca_invoice_line" />
            </xpath>
            <xpath expr="//*[local-name()='InstructionID']" position="after">
                <cbc:InstructionNote
                    t-if="record.l10n_sa_reversal_reason"
                    xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                    xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
                    t-esc="record.l10n_sa_reversal_reason" />
            </xpath>
        </template>

    </data>
</odoo>
