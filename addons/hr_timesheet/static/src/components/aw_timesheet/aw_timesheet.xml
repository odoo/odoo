<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="hr_timesheet.ActivityWatchTimesheet">
        <div class="o_calendar_header border-bottom border-top row px-3 pe-md-1 py-2 align-items-center bg-view">
            <div class="col-6 d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <div class="o_calendar_navigation_buttons btn-group">
                        <button class="o_calendar_button_prev btn btn-secondary d-none d-md-block"
                                t-on-click.stop="() => this.navigateToDay(-1)">
                            <i class="oi oi-arrow-left"/>
                        </button>
                        <button class="o_calendar_button_next btn btn-secondary d-none d-md-block"
                                t-on-click.stop="() => this.navigateToDay(1)">
                            <i class="oi oi-arrow-right"/>
                        </button>
                    </div>
                    <button class="btn btn-secondary ms-1"
                            t-on-click.stop="() => this.navigateToToday()">Today
                    </button>
                    <h5 class="d-inline-flex ps-lg-2 mb-0">
                        <t t-esc="dayHeader"/>
                    </h5>
                </div>
                <div class="d-flex align-items-center">
                    <label class="me-2 fw-semibold mb-0">Group by:</label>
                    <div class="o_cp_switch_buttons d-inline-flex btn-group" role="group">
                        <button type="button"
                            class="btn btn-secondary o_switch_view"
                            t-att-class="state.groupBy === 'project' ? 'active' : ''"
                            t-on-click.stop="() => state.groupBy = 'project'"
                            data-tooltip="Project"
                        >
                            Project
                        </button>
                        <button type="button"
                            class="btn btn-secondary o_switch_view"
                            t-att-class="state.groupBy === 'timeline' ? 'active' : ''"
                            t-on-click.stop="() => state.groupBy = 'timeline'"
                            data-tooltip="Timeline"
                        >
                            Timeline
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="o_activitywatch_sync d-flex h-100">
            <div class="o_suggestions w-50">
                <t t-if="state.groupBy === 'project'">
                    <div class="o_suggestion">
                        <t t-foreach="Object.keys(state.grouped)" t-as="groupKey" t-key="groupKey">
                            <div class="card mb-3 p-3 shadow-sm"
                                t-if="Object.keys(state.grouped[groupKey]).length &gt; 0">
                                <t t-set="ids" t-value="parseJson(groupKey)"/>
                                <h6 class="mb-2">
                                    <t t-esc="groupByTitle(ids)"/>
                                </h6>

                                <div class="table-responsive mb-2">
                                    <table class="table table-sm table-borderless align-middle mb-0">
                                        <tbody>
                                            <t t-foreach="Object.keys(state.grouped[groupKey])" t-as="title" t-key="title">
                                                <tr
                                                    t-att-class="{'table-danger': this.isSelected(groupKey, title)}"
                                                    t-on-mousedown.stop="(ev) => this.onMouseDown(groupKey, title, ev)"
                                                    t-on-mouseenter.stop="() => this.onMouseEnter(groupKey, title)"
                                                    style="cursor: pointer;">
                                                    <td class="w-50"><t t-esc="title"/></td>
                                                    <td class="text-end text-muted">
                                                        <t t-esc="(state.grouped[groupKey][title].duration / 60).toFixed(2)"/> min
                                                    </td>
                                                    <td class="text-end">
                                                        <button t-att-style="groupKey === this.unmatchedProjectTaskKey || state.selectedRows.size > 0 ? 'visibility: hidden;' : ''"
                                                            class="btn btn-sm btn-primary me-1"
                                                            t-on-click.stop="() => this.onTake(groupKey, title)">Take</button>
                                                        <button class="btn btn-sm btn-secondary"
                                                            t-att-style="state.selectedRows.size > 0 ? 'visibility: hidden;' : ''"
                                                            t-on-click.stop="() => this.onDelete(groupKey, title)">Delete</button>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </t>
                    </div>
                </t>

                <!-- TIMELINE MODE -->
                <t t-if="state.groupBy === 'timeline'">
                    <div class="o_suggestion p-3 shadow-sm">
                        <div class="table-responsive">
                            <table class="table table-sm table-borderless align-middle mb-0">
                                <tbody>
                                    <t t-foreach="state.records" t-as="record" t-key="record.start">
                                        <tr t-if="record.duration >= 0"
                                            t-att-class="{'table-danger': this.isSelected(record.groupKey, record.title)}"
                                            t-on-mousedown.stop="(ev) => this.onMouseDown(record.groupKey, record.title, ev)"
                                            t-on-mouseenter.stop="() => this.onMouseEnter(record.groupKey, record.title)"
                                            style="cursor: pointer;">
                                            <td>
                                                <t t-esc="record.title"/>
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    <t t-esc="record.project || 'No Project'"/> /
                                                    <t t-esc="record.task || 'No Task'"/>
                                                </small>
                                            </td>
                                            <td class="text-end text-muted">
                                                <t t-esc="(record.duration / 60).toFixed(2)"/> min
                                            </td>
                                            <td class="text-end">
                                                <button t-att-style="record.groupKey === this.unmatchedProjectTaskKey || state.selectedRows.size > 0 ? 'visibility: hidden;' : ''"
                                                    class="btn btn-sm btn-primary me-1"
                                                    t-on-click.stop="() => this.onTake(record.groupKey, record.title)">Take</button>
                                                <button class="btn btn-sm btn-secondary"
                                                    t-att-style="state.selectedRows.size > 0 ? 'visibility: hidden;' : ''"
                                                    t-on-click.stop="() => this.onDelete(record.groupKey, record.title)">Delete</button>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </t>

                <t t-if="env.debug">
                    <div class="text-center mt-3">
                        <button type="button"
                                class="btn btn-sm btn-secondary"
                                t-on-click="() => window.open('http://localhost:5600/#/timeline', '_blank')"
                        >
                            View ActivityWatch Data
                        </button>
                    </div>
                </t>
            </div>

            <!-- RIGHT SIDE: form + billable + non-billable -->
            <div class="o_form_view flex-grow-1 border-start ps-3 d-flex flex-column h-100" style="min-height: 0;">

                <!-- Timesheet form -->
                <div class="mb-4">
                    <t t-if="!state.selectedRows.size === 0">
                        <TimesheetTimer onSaveCallback="() => this.onSaveTimesheetForm()"/>
                    </t>
                    <t t-else="">
                        <TimesheetTimer data="this.selectedData"
                            onSaveCallback="(project_id, task_id, is_billable) => this.onSaveTimesheetForm(project_id, task_id, is_billable)"
                            onWriteTimesheet="() => this.onWriteTimesheet()"
                        />
                    </t>
                </div>

                <div t-if="state.workingHours !== false" class="mb-4 mt-2 fw-bold">
                    Total: <t t-esc="formatDuration(state.billableTime + state.nonBillableTime)"/> / <t t-esc="formatDuration(state.workingHours)"/>
                </div>

                <!-- Billable section -->
                <div class="mb-4">
                    <h6 class="fw-bold text-success mb-2">
                        Billable -
                        <t t-esc="formatDuration(state.billableTime)"/>
                        (<t t-esc="state.billablePercentage.toFixed(2)"/>%)
                    </h6>
                    <t t-if="state.billableTimesheets.length === 0">
                        <p class="text-muted small mb-0">No billable timesheets today.</p>
                    </t>
                    <t t-else="">
                        <ul class="list-group list-group-flush">
                            <t t-foreach="state.billableTimesheets" t-as="tsh" t-key="tsh.id">
                                <li class="list-group-item py-1" t-att-class="{'bg-danger': tsh.selected}"
                                    t-on-click.stop="() => this.onClickExistingTimesheet(tsh)" style="cursor: pointer;"
                                >
                                    <div class="fw-semibold"><t t-esc="tsh.name"/></div>
                                    <small class="text-muted">
                                        <t t-esc="formatDuration(tsh.unit_amount)"/> —
                                        <t t-esc="tsh.project_id[1]"/> / <t t-esc="tsh.task_id[1]"/>
                                    </small>
                                </li>
                            </t>
                        </ul>
                    </t>
                </div>

                <!-- Non-Billable section -->
                <div class="d-flex flex-column flex-grow-1" style="min-height: 0;">
                    <h6 class="fw-bold text-success mb-2">
                        Non-Billable -
                        <t t-esc="formatDuration(state.nonBillableTime)"/>
                        (<t t-esc="state.nonBillablePercentage.toFixed(2)"/>%)
                    </h6>
                    <t t-if="state.nonBillableTimesheets.length === 0">
                        <p class="text-muted small mb-0">No non-billable timesheets today.</p>
                    </t>
                    <t t-else="">
                        <ul class="list-group list-group-flush overflow-auto flex-grow-1" style="min-height: 0;">
                            <t t-foreach="state.nonBillableTimesheets" t-as="tsh" t-key="tsh.id">
                                <li class="list-group-item py-1" t-att-class="{'bg-danger': tsh.selected}"
                                    t-on-click.stop="() => this.onClickExistingTimesheet(tsh)" style="cursor: pointer;"
                                >
                                    <div class="fw-semibold"><t t-esc="tsh.name"/></div>
                                    <small class="text-muted">
                                        <t t-esc="formatDuration(tsh.unit_amount)"/> —
                                        <t t-esc="tsh.project_id[1]"/> / <t t-esc="tsh.task_id[1]"/>
                                    </small>
                                </li>
                            </t>
                        </ul>
                    </t>
                </div>
            </div>
        </div>
    </t>
</templates>
