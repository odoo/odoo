<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
  <t t-name="hr_timesheet.ActivityWatchTimesheet">
    <div class="o_activitywatch_sync d-flex h-100">

      <!-- LEFT SIDE: suggestions -->
      <div class="o_suggestions w-50 pe-3" t-on-click.stop="() => this.onClickLeftSide()">
        <t t-if="state.loading">
          <span>Loading ActivityWatch data...</span>
        </t>
        <t t-else="">
          <t t-foreach="Object.keys(state.grouped)" t-as="groupKey" t-key="groupKey">
            <div class="card mb-3 p-3 shadow-sm">
              <!-- group title -->
              <t t-set="ids" t-value="groupKey.split('_')"/>
              <t t-set="project_id" t-value="projectName(parseId(ids[0]))"/>
              <t t-set="task_id" t-value="taskName(parseId(ids[1]))"/>
              <h6 class="mb-2">
                Project <t t-esc="project_id or 'Unknown Project'"/> /
                Task <t t-esc="task_id or 'Unknown Task'"/>
              </h6>

              <!-- list of activities as a table -->
              <div class="table-responsive mb-2">
                <table class="table table-sm table-borderless align-middle mb-0">
                  <tbody>
                    <t t-foreach="Object.keys(state.grouped[groupKey])" t-as="title" t-key="title">
                      <tr
                        t-if="state.grouped[groupKey][title] >= 120"
                        t-att-class="{
                          'table-danger': this.isSelected(groupKey, title),
                        }"
                        t-on-mousedown.stop="() => this.onMouseDown(groupKey, title)"
                        t-on-mouseenter.stop="() => this.onMouseEnter(groupKey, title)"
                        style="cursor: pointer;"
                      >
                        <!-- Activity name -->
                        <td class="w-50">
                          <t t-esc="title"/>
                        </td>

                        <!-- Minutes -->
                        <td class="text-end text-muted">
                          <t t-esc="(state.grouped[groupKey][title] / 60).toFixed(1)"/> min
                        </td>

                        <!-- Actions -->
                        <td class="text-end">
                          <!-- TODO: More robust table column width to remove t-att-style below -->
                          <button
                            t-att-style="groupKey === 'false_false' ? 'visibility: hidden;' : ''"
                            class="btn btn-sm btn-primary me-1"
                            t-on-click.stop="() => this.onTake(groupKey, title)"
                          >
                            Take
                          </button>
                          <button
                            class="btn btn-sm btn-secondary"
                            t-on-click.stop="() => this.onDelete(groupKey, title)"
                          >
                            Delete
                          </button>
                        </td>
                      </tr>
                    </t>
                  </tbody>
                </table>
              </div>
            </div>
          </t>
        </t>
      </div>

      <!-- RIGHT SIDE: form + billable + non-billable -->
      <div class="o_form_view flex-grow-1 border-start ps-3 d-flex flex-column h-100" style="min-height: 0;">

        <!-- Timesheet form -->
        <div class="mb-4">
          <t t-if="!state.selected">
            <TimesheetTimer onSaveCallback="() => this.onSaveTimesheetForm()"/>
          </t>
          <t t-else="">
            <TimesheetTimer data="state.selectedData" onSaveCallback="() => this.onSaveTimesheetForm()"/>
          </t>
        </div>

        <!-- Billable section -->
        <div class="mb-4">
          <h6 class="fw-bold text-success mb-2">
            Billable -
            <t t-esc="state.billableTime.toFixed(2)"/>h
            (<t t-esc="state.billablePercentage.toFixed(2)"/>%)
          </h6>
          <t t-if="state.billableTimesheets.length === 0">
            <p class="text-muted small mb-0">No billable timesheets today.</p>
          </t>
          <t t-else="">
            <ul class="list-group list-group-flush">
              <t t-foreach="state.billableTimesheets" t-as="tsh" t-key="tsh.id">
                <li class="list-group-item py-1">
                  <div class="fw-semibold"><t t-esc="tsh.name"/></div>
                  <small class="text-muted">
                    <t t-esc="tsh.unit_amount"/>h —
                    <t t-esc="tsh.project_id[1]"/> / <t t-esc="tsh.task_id[1]"/> /
                    <t t-esc="tsh.date"/>
                  </small>
                </li>
              </t>
            </ul>
          </t>
        </div>

        <!-- Non-Billable section -->
        <div class="d-flex flex-column flex-grow-1" style="min-height: 0;">
          <h6 class="fw-bold text-success mb-2">
            Non-Billable -
            <t t-esc="state.nonBillableTime.toFixed(2)"/>h
            (<t t-esc="state.nonBillablePercentage.toFixed(1)"/>%)
          </h6>
          <t t-if="state.nonBillableTimesheets.length === 0">
            <p class="text-muted small mb-0">No non-billable timesheets today.</p>
          </t>
          <t t-else="">
            <ul class="list-group list-group-flush overflow-auto flex-grow-1" style="min-height: 0;">
              <t t-foreach="state.nonBillableTimesheets" t-as="tsh" t-key="tsh.id">
                <li class="list-group-item py-1">
                  <div class="fw-semibold"><t t-esc="tsh.name"/></div>
                  <small class="text-muted">
                    <t t-esc="tsh.unit_amount"/>h —
                    <t t-esc="tsh.project_id[1]"/> / <t t-esc="tsh.task_id[1]"/> /
                    <t t-esc="tsh.date"/>
                  </small>
                </li>
              </t>
            </ul>
          </t>
        </div>
      </div>
    </div>
  </t>
</templates>
