<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>

        <!-- Front-end/Back-end integration -->
        <template id="user_navbar_version" inherit_id="website.layout" groups="base.group_user">
            <xpath expr="//li[contains(@id, 'customize-menu')]" position="before">
                    <li class="dropdown" id="version-menu" groups="base.group_website_designer">
                        <a id="version-menu-button" class="dropdown-toggle" data-toggle="dropdown" href="#" t-att-data-snapshot_id="website.get_current_snapshot(context=context)[0]">
                            Version (
                                        <span><t t-esc="website.get_current_snapshot(context=context)[1]"></t></span>
                                    )<span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu version_menu" role="menu">
                            <li class="dropdown-header" style="text-transform: uppercase;">All versions</li>
                            <t t-if="website.get_current_snapshot(context=context)[0] == 0 ">
                                <li><a href="#" data-action="master"><b>Master</b></a></li>
                            </t>
                            <t t-if="website.get_current_snapshot(context=context)[0] != 0 ">
                                <li><a href="#" data-action="master">Master</a></li>
                            </t>
                            <li class="first_divider divider"> </li>
                            <li><a href="#" data-action="create_snapshot">Create a new version</a></li>
                            <!-- <li><a href="#" data-action="google_analytics">Statistics  
                            <span class="badge"><t t-esc="website.get_running_experiment_number(context=context)"></t></span></a></li> -->
                            <t t-if="website.get_current_snapshot(context=context)[0] != 0 ">
                                <li><a href="#" data-action="publish_version" 
                                    t-att-data-snapshot_id="website.get_current_snapshot(context=context)[0]">Publish this version</a>
                                </li>
                            </t>
                            <li class="divider publish_version"> </li>
                            <li><a href="#" data-action="create_experiment">Create an experiment</a></li>
                        </ul>
                    </li>
            </xpath>
            <xpath expr="//ul[contains(@class, 'dropdown-menu oe_content_menu')]/li" position="after">
                <li class="divider"> </li>
                <li groups="base.group_website_designer"><a href="#" data-action="ab_testing">A/B testing</a></li>
            </xpath>   
        </template>

        <template id="assets_frontend_menu_version" name="website_menu_version assets" inherit_id="website.assets_editor">
            <xpath expr="." position="inside">
                <script type="text/javascript" src="/website_version/static/src/js/menu_version.js"></script>
                <!-- <script type="text/javascript" src="/website_version/static/src/js/AB_testing.js"></script> -->
                <script type="text/javascript" src="/website_version/static/src/js/save_as_draft.js"></script>
            </xpath>
        </template>

        <template id="assets_frontend_AB" name="website_AB assets" inherit_id="website.layout">
            <xpath expr="//script[contains(@id, 'tracking_code')]" position="replace">
                <script id='tracking_code'>
                    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                    ga('create', _.str.trim('<t t-esc="website.google_analytics_key"/>'), {'cookieDomain': 'none'});
                    console.log('GA key='+'<t t-esc="website.google_analytics_key"/>');
                    ga('send','pageview');

                    var view_id = $('html').attr('data-view-xmlid');
                    openerp.jsonRpc( '/website_version/get_analytics', 'call', { 'view_id':view_id }).then(function (result) {
                            var exp = result['ExpId']
                            var snap = result['VarId']
                            console.log(exp+':'+snap);
                            ga('set', 'expId', exp); 
                            ga('set', 'expVar', snap);
                            ga('send', 'pageview');
                        });
                </script>
            </xpath>
        </template>

        <template id="assets_backend" name="stock assets" inherit_id="web.assets_backend">
            <xpath expr="." position="inside">
                <script type="text/javascript" src="/website_version/static/src/js/widget.js"></script>
            </xpath>
        </template>

    </data>
</openerp>