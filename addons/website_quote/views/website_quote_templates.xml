<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <template id="assets_frontend" inherit_id="website.assets_frontend" name="Website Quote frontend assets">
    <xpath expr="." position="inside">
      <script type="text/javascript" src="/website_quote/static/src/js/website_quotation.js"></script>
    </xpath>
  </template>

  <template id="assets_editor" inherit_id="web_editor.assets_editor" name="Website Quote Editor assets">
        <xpath expr="." position="inside">
            <link rel="stylesheet" type="text/scss" href="/website_quote/static/src/scss/website_quotation.scss"/>
        </xpath>
  </template>

    <template id="change_quantity" inherit_id="sale.portal_order_pricing" active="False" customize_show="True" name="Change Quantity">
        <xpath expr="//div[@id='quote_qty']" position="replace">
            <div class="input-group oe_website_spinner o_website_quote">
                <span class="input-group-prepend input-group-text d-print-none d-md-inline">
                    <a t-attf-href="./update_line/#{ line.id }/?order_id=#{ order.id }&amp;remove=True&amp;token=#{ order.access_token }" class="mb4 js_update_line_json" aria-label="Remove one" title="Remove one">
                        <span class="fa fa-minus"/>
                    </a>
                </span>
                <input type="text" class="js_quantity form-control" t-att-data-id="line.id" t-att-value="line.product_uom_qty"/>
                <span class="input-group-prepend input-group-text d-print-none d-md-inline">
                    <a t-attf-href="./update_line/#{ line.id }/?order_id=#{ order.id }&amp;token=#{ order.access_token }" class="mb4 js_update_line_json" aria-label="Add one" title="Add one">
                        <span class="fa fa-plus"/>
                    </a>
                </span>
            </div>
         </xpath>
    </template>

    <!-- duplicata of the template payment.payment_confirmation_status.
        The duplication avoid to break an existing installation in stable version-->
    <template id="payment_confirmation_status">
        <div t-if="payment_tx_id and payment_tx_id.state == 'done'" class="alert alert-success alert-dismissable" role="status">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">&amp;times;</button>
            <span t-if='payment_tx_id.acquirer_id.done_msg' t-raw="payment_tx_id.acquirer_id.done_msg"/>
            <span t-if='payment_tx_id.acquirer_id.post_msg' t-raw="payment_tx_id.acquirer_id.post_msg"/>
        </div>
        <div t-if="payment_tx_id and payment_tx_id.state == 'pending'" class="alert alert-warning alert-dismissable" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">&amp;times;</button>
            <span t-if='payment_tx_id.acquirer_id.pending_msg' t-raw="payment_tx_id.acquirer_id.pending_msg"/>
            <span t-if='payment_tx_id.acquirer_id.post_msg' t-raw="payment_tx_id.acquirer_id.post_msg"/>
        </div>
        <div t-if="payment_tx_id and payment_tx_id.state == 'cancel'" class="alert alert-danger alert-dismissable" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">&amp;times;</button>
            <span t-if='payment_tx_id.acquirer_id.cancel_msg' t-raw="payment_tx_id.acquirer_id.cancel_msg"/>
        </div>
        <div t-if="payment_tx_id and payment_tx_id.state == 'error'" class="alert alert-danger alert-dismissable" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">&amp;times;</button>
            <span t-if='payment_tx_id.acquirer_id.error_msg' t-raw="payment_tx_id.acquirer_id.error_msg"/>
        </div>
        <div t-if="payment_tx_id and payment_tx_id.state == 'authorized'" class="alert alert-success alert-dismissable" role="status">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">&amp;times;</button>
            Your payment has been authorized.
            <span t-if='payment_tx_id.acquirer_id.post_msg' t-raw="payment_tx_id.acquirer_id.post_msg"/>
        </div>
    </template>

    <template id="payment_dialog" name="Payment on my orders" inherit_id="sale.portal_order_signature_dialog">
        <xpath expr="//div[@id='modalaccept']" position="after">
            <div class="row o_website_quote" t-if="not invoices and not (order.has_to_be_signed() and not order.signature) and (order.has_to_be_paid() or need_payment) and not portal_layout" id="website_quote_pay">
                <div class="offset-md-3 col-lg-6">
                    <div class="modal fade" id="portal_pay" role="dialog">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 class="modal-title">Payment Methods</h3>
                                    <button type="button" class="close" data-dismiss="modal">&amp;times;</button>
                                </div>
                                <div class="modal-body">
                                    <p>
                                        <span>I agree that by signing this proposal, I accept it on the behalf of </span>
                                        <b t-field="order.partner_id.commercial_partner_id"/>
                                        <span>, for an amount of </span>
                                        <b data-id="total_amount" t-field="order.amount_total"
                                            t-options='{"widget": "monetary", "display_currency": order.pricelist_id.currency_id}'/>
                                        <t t-if="order.payment_term_id"><span>with payment terms: </span><b t-field="order.payment_term_id"/>.</t>
                                    </p>
                                </div>
                                <div class="modal-footer">
                                    <div t-if="pms or s2s_acquirers or form_acquirers" id="payment_method" class="text-left col-md-12">
                                        <t t-call="payment.payment_tokens_list">
                                            <t t-set="mode" t-value="'payment'"/>
                                            <t t-set="access_token" t-value="order.access_token"/>
                                            <t t-set="submit_txt" t-value="'Pay &amp; Confirm'"/>
                                            <t t-set="icon_class" t-value="'fa-lock'"/>
                                            <t t-set="form_action" t-value="'/quote/' + str(order.id) + '/transaction/token'"/>
                                            <t t-set="prepare_tx_url" t-value="'/quote/' + str(order.id) + '/transaction/'"/>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </xpath>
    </template>

    <template id="quote_expire_detail" name="Expiry details" inherit_id="sale.portal_order_expire_detail">
        <xpath expr="//div[@name='days_valid']" position="after">
            <div class="text-center mb16" t-if="order.amount_undiscounted &gt; order.amount_untaxed">
                <p class="text-muted mb8">Your advantage:</p>
                <t t-if="order.amount_untaxed == order.amount_total">
                    <strong t-field="order.amount_total"
                        t-options='{"widget": "monetary", "display_currency": order.pricelist_id.currency_id}'/>
                    <strong t-field="order.amount_undiscounted"
                        t-options='{"widget": "monetary", "display_currency": order.pricelist_id.currency_id}'
                        style="text-decoration: line-through"
                        class="text-danger"/>
                </t>
                <t t-if="order.amount_untaxed != order.amount_total">
                    <strong t-field="order.amount_untaxed"
                        t-options='{"widget": "monetary", "display_currency": order.pricelist_id.currency_id}'/>
                    <strong t-field="order.amount_undiscounted"
                        t-options='{"widget": "monetary", "display_currency": order.pricelist_id.currency_id}'
                        style="text-decoration: line-through"
                        class="text-danger"/>
                    <br />
                    (<span t-field="order.amount_total"
                        t-options='{"widget": "monetary", "display_currency": order.pricelist_id.currency_id}'/> Incl. tax)
                </t>
            </div>
        </xpath>
    </template>

    <!-- Complete page of the quotation -->
    <template id="so_quotation" name="Product Quotation" inherit_id="sale.portal_order_page"/>

    <!--
      Quotation content : intro, informations, order lines, remarks, descriptions ....
      This template should contains all the printable element of the SO. This is the
      template rendered in PDF with the report engine.
    -->
    <template id="quotation_content" name="Quotation Content" inherit_id="sale.portal_order_content">
        <xpath expr="//ul/li/t[@t-if='portal_layout']" position="before">
            <t groups="sales_team.group_sale_salesman">
                <a t-if="order.state not in ('manual')" class="btn btn-info d-md-inline" t-att-href="'/web#return_label=Website&amp;model=%s&amp;id=%s&amp;action=%s&amp;view_type=form' % (order._name, order.id, action)" title="Edit Quotation"><i class="fa fa-pencil"/> Edit Quote</a>
                <a t-if="order.state in ('manual')" class="btn btn-info d-md-inline" t-att-href="'/web#return_label=Website&amp;model=%s&amp;id=%s&amp;action=%s&amp;view_type=form' % (order._name, order.id, action)" title="Back to Order">Back to Sales Order</a>
            </t>
            <t t-if="not portal_layout">
                <a class="btn btn-info d-md-inline mr8 o_portal_sale_download" t-att-href="'/quote/%s/%s' % (order.id,order.access_token)+'?pdf=True'" title="Download">
                    <i class="fa fa-download"/> Download
                </a>
                <a class="btn btn-info d-none d-md-inline o_portal_sale_print" t-att-href="'/quote/%s/%s' % (order.id,order.access_token)+'?pdf=True&amp;print=True'" title="Print">
                    <i class="fa fa-print"/> Print
                </a>
            </t>
        </xpath>
        <xpath expr="//div[@id='so_pricing']" position="before">
            <!-- Descriptions -->
            <div t-field="order.website_description" class="oe_no_empty"/>
            <t t-foreach="order.order_line" t-as="line">
                <a t-att-id="line.id"/>
                <div t-att-class="'oe_no_empty' if line.website_description else 'oe_no_empty d-print-none'" t-field="line.website_description"/>
            </t>
        </xpath>
        <xpath expr="//div[@id='so_pricing']" position="after">
            <!-- Options -->
            <t t-call="website_quote.optional_products"/>
        </xpath>
    </template>

  <template id="optional_products">
      <t t-if="any([(not option.line_id) for option in order.options])">
        <section>
            <h1 class="page-header">Suggested Products</h1>
        </section>
        <section>
            <table class="table table-hover wq-table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th></th>
                        <th class="text-right">Price</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr t-foreach="order.options" t-as="option">
                        <t t-if="not option.line_id">
                            <td>
                                <div t-field="option.name"/>
                            </td>
                            <td>
                                <strong t-if="option.discount" class="text-info">
                                    <t t-esc="((option.discount % 1) and '%s' or '%d') % option.discount"/>% discount
                                </strong>
                            </td>
                            <td>
                                <strong class="text-right">
                                    <div t-field="option.price_unit"
                                    t-options='{"widget": "monetary", "display_currency": order.pricelist_id.currency_id}'
                                    t-att-style="option.discount and 'text-decoration: line-through' or None"
                                    t-att-class="option.discount and 'text-danger' or None"/>
                                    <div t-if="option.discount">
                                        <t t-esc="(1-option.discount / 100.0) * option.price_unit" t-options='{"widget": "monetary", "display_currency": order.pricelist_id.currency_id}'/>
                                    </div>
                                </strong>
                            </td>
                            <td class="text-center" t-if="order.state in ['draft', 'sent']">
                                <a t-attf-href="/quote/add_line/#{ option.id }/#{ order.id }/#{ order.access_token }" class="mb8 d-print-none" aria-label="Add to cart" title="Add to cart">
                                    <span class="fa fa-shopping-cart"/>
                                </a>
                            </td>
                        </t>
                    </tr>
                </tbody>
            </table>
        </section>
      </t>
  </template>

  <!-- Template to edit the quotation template with the website editor -->
  <template id="so_template" name="SO Template">
    <t t-call="website.layout">
        <body data-spy="scroll" data-target=".navspy" data-offset="50">
            <div class="container o_portal_sidebar">
                <div class="row mt16">
                    <div class="col-lg-3 d-print-none">
                        <div class="bs-sidebar">
                            <div class="navspy" role="complementary" t-ignore="True">
                                <ul class="nav bs-sidenav" data-id="quote_sidebar"/>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-9">
                        <div class="row mb8">
                            <div t-ignore="true" class="css_editable_mode_hidden offset-lg-11">
                              <a role="button" class="btn btn-info d-print-none" t-att-href="'/web#return_label=Website&amp;model=%s&amp;id=%s&amp;action=%s&amp;view_type=form' % (template._name, template.id, request.env.ref('website_quote.action_sale_quotation_template').id)">Back</a>
                            </div>
                        </div>
                        <div class="alert alert-info alert-dismissable" t-ignore="True" role="status">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">&amp;times;</button>
                            <p>
                                <strong>Template Header:</strong> this content
                                will appear on all quotations using this
                                template.
                            </p>
                            <p class="text-muted">
                                Titles with style <i>Heading 1</i> and
                                <i>Heading 2</i> will be used to generate the
                                table of content automatically.
                            </p>
                        </div>
                        <div id="template_introduction" t-field="template.website_description" class="oe_no_empty"/>
                        <t t-set="product_tmpl_ids" t-value="[]"/>
                        <t t-foreach="template.quote_line" t-as="line">
                            <t t-if="line.product_id.product_tmpl_id.id not in product_tmpl_ids">
                                <t t-set="product_tmpl_ids" t-value="product_tmpl_ids + [line.product_id.product_tmpl_id.id]"/>
                                <div class="alert alert-info alert-dismissable mt16" t-ignore="True" role="status">
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">&amp;times;</button>
                                    Product: <strong t-esc="line.product_id.name"/>:
                                    this content will appear on the quotation only if this
                                    product is put on the quote.
                                </div>
                                <div t-field="line.website_description" class="oe_no_empty"/>
                            </t>
                        </t>
                        <t t-set="product_tmpl_ids" t-value="[]"/>
                        <t t-foreach="template.options" t-as="option_line">
                            <t t-if="option_line.product_id.product_tmpl_id.id not in product_tmpl_ids">
                                <t t-set="product_tmpl_ids" t-value="product_tmpl_ids + [option_line.product_id.product_tmpl_id.id]"/>
                                <div class="alert alert-info alert-dismissable mt16" t-ignore="True" role="status">
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">&amp;times;</button>
                                    Optional Product: <strong t-esc="option_line.product_id.name"/>:
                                    this content will appear on the quotation only if this
                                    product is used in the quote.
                                </div>
                                <div t-field="option_line.website_description" class="oe_no_empty"/>
                            </t>
                        </t>
                        <section id="terms" class="container" t-if="template.note">
                            <h1 t-ignore="True">Terms &amp; Conditions</h1>
                            <p t-field="template.note"/>
                        </section>
                    </div>
                </div>
            </div>
        </body>
        </t>
  </template>

  <template id="website_quote.brand_promotion" inherit_id="website.brand_promotion">
      <xpath expr="//div[hasclass('o_brand_promotion')]" position="replace">
          <div class="o_brand_promotion">
              Powered by <a target="_blank" class="badge badge-danger" href="http://www.odoo.com/page/website-builder">Odoo</a>,
              an awesome <a target="_blank" href="http://www.odoo.com/page/crm">Open Source CRM</a>.
          </div>
      </xpath>
  </template>

    <template id="portal_my_quotations_inherit_quote" inherit_id="sale.portal_my_quotations">
        <xpath expr="//t[@t-foreach='quotations']/tr/td/a" position="replace">
            <t t-if="quotation.template_id and quotation.template_id.active">
                <a t-attf-href="/quote/#{quotation.id}?#{keep_query()}"><t t-esc="quotation.name"/></a>
            </t>
            <t t-else="">
                <a t-attf-href="/my/orders/#{quotation.id}?#{keep_query()}"><t t-esc="quotation.name"/></a>
            </t>
        </xpath>
    </template>
</odoo>
