import base64
import logging

from odoo import api, models, _
from odoo.fields import Domain

from odoo.addons.printer.models.ir_actions_report import thermal_printer_format

_logger = logging.getLogger(__name__)


class IrActionsReport(models.Model):
    _inherit = "ir.actions.report"

    @api.model
    def get_print_jobs(self, report_name, docids, data) -> list:
        """Method to render chatter attachments for ePOS or ZPL printers

        For ePOS, we limit to image attachments to avoid converting PDF to
        images.
        """
        jobs = super().get_print_jobs(report_name, docids, data)
        if report_name not in ['stock_delivery.report_shipping_labels', 'stock_delivery.report_shipping_docs']:
            return jobs

        for attachment in self.get_reports_from_chatter(report_name, docids):
            name = attachment.name.lower()
            if name.endswith((".jpeg", ".jpg", ".png")):
                report_type = "epos"
                report = thermal_printer_format(base64.b64decode(attachment.datas))
            elif ".zpl" in name:
                report_type = "zpl"
                report = attachment.datas
            else:
                continue

            jobs.append({"type": report_type, "report": report})
        return jobs

    def get_reports_from_chatter(self, report_name, docids):
        """Shipping labels and docs are generated by carrier providers
        and are saved as attachments in the chatter"""
        domain = [('res_model', '=', "stock.picking"), ('res_id', 'in', docids)]
        if report_name == 'stock_delivery.report_shipping_labels':
            domain = Domain.AND([domain, [('name', 'ilike', 'Label%')]])
        elif report_name == 'stock_delivery.report_shipping_docs':
            domain = Domain.AND([domain, [('name', 'ilike', 'ShippingDoc%')]])

        attachments = self.env['ir.attachment'].search(domain, order='id desc')
        if not attachments:
            _logger.warning("No attachment found for report %s and docids %s", report_name, docids)
            return []
        return attachments

    def _render_qweb_pdf(self, report_ref, res_ids=None, data=None):
        """Override to ensure the user is informed when trying to print an empty report
        without an actual printer.

        This can happen when trying to print delivery labels, that have empty reports used to
        print the attachments in the chatter with ePOS or IoT.

        If the attachment is a PDF, we download it.
        If there are multiple PDFs, we only print one as we can't make Odoo download multiple at once.
        """
        report = self._get_report(report_ref)
        if report.report_name in ["stock_delivery.report_shipping_labels", "stock_delivery.report_shipping_docs"]:
            attachments = self.get_reports_from_chatter(report.report_name, res_ids)
            if attachments and attachments[0].name.lower().endswith(".pdf"):
                return base64.b64decode(attachments[0].datas), "pdf"
            return None, None

        return super()._render_qweb_pdf(report_ref, res_ids, data=data)
