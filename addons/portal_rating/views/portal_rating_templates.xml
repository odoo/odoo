<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="assets_frontend" inherit_id="portal.assets_frontend" name="Website rating frontend assets">
        <xpath expr="." position="inside">
            <script type="text/javascript" src="/portal_rating/static/src/js/portal.js"></script>
            <script type="text/javascript" src="/portal_rating/static/src/js/portal_rating.js"></script>
            <link rel="stylesheet" type="text/scss" href="/portal_rating/static/src/scss/portal_rating.scss"/>
        </xpath>
    </template>

    <template id="message_thread" inherit_id="portal.message_thread">
        <xpath expr="//div[@id='discussion']" position="attributes">
            <attribute name="t-att-data-display_rating">display_rating or False</attribute>
        </xpath>
    </template>

    <!--
        Rating widget static: show 5 stars (full or empty) regarding the given rating_avg and rating_count
    -->
    <template id="rating_widget_stars_static" name="Rating: static star widget">
        <t t-set="rating_avg" t-value="round(rating_avg * 100) / 100 / 2"/>
        <t t-set="val_decimal" t-value="round(rating_avg % 1, 1)"/>
        <t t-set="val_integer" t-value="int(rating_avg)"/>
        <t t-set="empty_star" t-value="5 - (val_integer+1) if val_decimal else 5 - val_integer"/>
        <div class="o_website_rating_static" t-att-style="'display:inline' if inline_mode else ''" t-att-title="rating_avg">
            <t t-foreach="range(0, val_integer)" t-as="num">
                <i class="fa fa-star" role="img"></i>
            </t>
            <t t-if="val_decimal">
                <i class="fa fa-star-half-o" role="img"></i>
            </t>
            <t t-foreach="range(0, empty_star)" t-as="num" role="img">
                <i class="fa fa-star text-black-25"></i>
            </t>
            <t t-if="rating_count">
                (<t t-esc="rating_count"/>)
            </t>
        </div>
    </template>

    <!--
        Display static star widget, and open rating composer on click
        This template provide the container of the Popup Rating Composer. The rest is done in js.
        To use this template, you need to call it after setting the following variable in your template or in your controller:
            :float rating_avg : average rating to be displayed with star widget
            :object browserecord : the mail_thread object
            :token string (optional): if you want your chatter to be available for non-logged user,
                     you can use a token to verify the identity of the user;
                     the message will be posted with the identity of the partner_id of the object
    -->
    <template id="rating_stars_static_popup_composer" name="Rating: rating composer in popup">
        <div class="d-print-none o_rating_popup_composer o_not_editable p-0"
            t-att-data-rating-avg="rating_avg or 0.0"
            t-att-data-rating-total="rating_total or 0.0"
            t-att-data-token="token"
            t-att-data-hash="hash"
            t-att-data-pid="pid"
            t-att-data-res_model="object._name"
            t-att-data-res_id="object.id"
            t-att-data-partner_id="request.env.user.partner_id.id"
            t-att-data-default_message="default_message"
            t-att-data-default_message_id="default_message_id"
            t-att-data-default_rating_value="default_rating_value"
            t-att-data-force_submit_url="force_submit_url"
            t-att-data-disable_composer="disable_composer">
        </div>
    </template>

    <!-- External page : thanks message -->
    <template id="portal_rating_external_page_view" inherit_id="rating.rating_external_page_view">
        <xpath expr="//t[@t-call='web.frontend_layout']" position="replace">
            <t t-call="portal.frontend_layout">
                <div class="container">
                    <div class="text-center mt-5">
                        <h1 class="d-inline">Thank you,</h1><h3 class="d-inline"> We appreciate your feedback!</h3>
                    </div>
                    <div class="text-center">
                        <a role="button" t-att-href="web_base_url" class="btn btn-primary bg-success my-5 border-0 rounded-0 text-dark">Go back to the Homepage</a>
                    </div>
                </div>
            </t>
        </xpath>
    </template>

    <!-- External page: rate and submit feedback -->
    <template id="portal_rating_external_page_submit" inherit_id="rating.rating_external_page_submit">
        <xpath expr="//t[@t-call='web.frontend_layout']" position="replace">
            <t t-call="portal.frontend_layout">
                <div class="container o_portal_rating">
                    <div class="mt-5">
                        <h2>Thank you for rating our services!</h2>
                        <table class="mt-5">
                            <tr>
                                <td>
                                    <a class="o_rating" t-attf-href="/rating/#{token}/10/submit_feedback" id="10">
                                        <img src='/rating/static/src/img/rating_10.png' alt="Satisfied" t-attf-class="o_portal_rating_smily mr-md-5 #{rate == 10 and 'o_poral_rating_active' or ''}"/>
                                    </a>
                                </td>
                                <td>
                                    <a class="o_rating" t-attf-href="/rating/#{token}/5/submit_feedback" id="5">
                                        <img src='/rating/static/src/img/rating_5.png' alt="Not satisfied" t-attf-class="o_portal_rating_smily mr-md-5 #{rate == 5 and 'o_poral_rating_active' or ''}" />
                                    </a>
                                </td>
                                <td>
                                    <a class="o_rating" t-attf-href="/rating/#{token}/1/submit_feedback" id="1">
                                        <img src='/rating/static/src/img/rating_1.png' alt="Highly Dissatisfied" t-attf-class="o_portal_rating_smily #{rate == 1 and 'o_poral_rating_active' or ''}"/>
                                    </a>
                                </td>
                            </tr>
                        </table>
                        <div class="clearfix"></div>
                        <p class="mt-5">
                            Feel to write a feedback of your experience:
                        </p>
                        <form t-attf-action="/rating/#{token}/#{rate}/submit_feedback" method="post">
                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                            <input type="hidden" name="rate" t-att-value="rate" id="rate_id"/>
                            <textarea class="form-control" name="feedback" rows="8" t-att-value="rating.feedback"></textarea>
                            <button type="submit" class="btn btn-primary bg-success mt-sm-5 border-0 rounded-0 text-dark">Send Feedback</button>
                        </form>
                    </div>
                </div>
            </t>
        </xpath>
    </template>
</odoo>
