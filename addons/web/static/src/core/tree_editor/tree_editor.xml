<?xml version="1.0" encoding="UTF-8" ?>
<templates xml:space="preserve">

    <t t-name="web.TreeEditor">
        <div class="o_tree_editor w-100" t-att-class="{ container: !this.props.isSubTree }">
            <div class="row row-cq">
                <t t-call="web.TreeEditor.connector">
                    <t t-set="node" t-value="tree"/>
                    <t t-set="ancestors" t-value="[]"/>
                    <t t-set="connectorCol" t-value="0"/>
                    <t t-set="isRootNode" t-value="true"/>
                    <t t-set="displayNewGroup" t-value="true"/>
                </t>
            </div>
        </div>
    </t>

    <t t-name="web.TreeEditor.DeleteButton">
        <button
            class="btn btn-link text-danger fs-4 py-0 border-0 opacity-50"
            t-att-class="additionalClass"
            role="button"
            title="Delete filter"
            aria-label="Delete filter"
            t-on-click="() => this.delete(ancestors, node)"
        >
            <i class="fa fa-trash" />
        </button>
    </t>

    <t t-name="web.TreeEditor.connector.description">
        <t t-if="node.value === '|'">
            <t t-if="node.negate">And not</t>
            <t t-else="">Or</t>
        </t>
        <t t-else="">
            <t t-if="node.negate">Or not</t>
            <t t-else="">And</t>
        </t>
    </t>

    <t t-name="web.TreeEditor.connector">
        <div class="o_tree_editor_connector d-flex flex-column gap-2 col-cq-12" t-attf-class="{{ 'col-cq-md-' + (12 - connectorCol) }}">
            <t t-set="ancestors" t-value="[...ancestors, node]" />
            <t t-set="connectorCol" t-value="node.negate ? 2 : 1"/>
            <t t-foreach="node.children" t-as="child" t-key="child.type + '_' + child_index">
                <div class="o_tree_editor_wrap row row-cq gy-2 align-items-baseline">
                    <div class="o_tree_editor_connector_value text-nowrap d-flex col-cq-12 gx-0 align-items-baseline justify-content-between" t-attf-class="{{ 'col-cq-md-' + connectorCol }}">
                        <t t-if="child_index === 0">
                            <t t-if="node.negate">Where not</t>
                            <t t-else="">Where</t>
                        </t>
                        <t t-elif="child_index === 1 and !props.readonly">
                            <button class="btn o-dropdown o-dropdown-caret p-0 opacity-75" t-on-click="() => this.updateConnector(node)">
                                <t t-call="web.TreeEditor.connector.description" />
                            </button>
                        </t>
                        <t t-else="">
                            <span class="opacity-50">
                                <t t-call="web.TreeEditor.connector.description"/>
                            </span>
                        </t>
                        <t t-if="!child.children" t-call="web.TreeEditor.DeleteButton">
                            <t t-set="node" t-value="child"/>
                            <t t-set="additionalClass" t-value="'d-cq-md-none'"/>
                        </t>
                    </div>
                    <t t-call="web.TreeEditor.{{ child.type }}">
                        <t t-set="node" t-value="child" />
                        <t t-set="isRootNode" t-value="false"/>
                        <t t-set="displayNewGroup" t-value="isDebugMode"/>
                    </t>
                </div>
            </t>
            <div class="row row-cq o_tree_editor_connector_buttons">
                <div class="gx-0 d-flex justify-content-between">
                    <div t-if="!props.readonly" class="d-flex gap-2">
                        <a href="#" role="button" t-on-click="() => this.addNewCondition(node)">New filter</a>
                        <t t-if="displayNewGroup">
                            <a href="#" role="button" t-on-click="() => this.addNewConnector(node)">New group</a>
                        </t>
                    </div>
                    <div t-if="isRootNode">
                        <t t-slot="default"/>
                    </div>
                </div>
            </div>
        </div>
    </t>

    <t t-name="web.TreeEditor.condition">
        <div class="d-flex col-cq-12" t-attf-class="{{ 'col-cq-md-' + (12 - connectorCol) }}">
            <div class="row row-cq flex-grow-1">
                <t t-if="props.readonly">
                    <t t-call="web.TreeEditor.condition:readonly" />
                </t>
                <t t-else="">
                    <t t-call="web.TreeEditor.condition:editable" />
                </t>
                <t t-if="isTree(node.value)">
                    <TreeEditor t-props="props"
                        update="(value) => this.updateLeafValue(node, value)"
                        slots="{}"
                        isSubTree="true"
                        tree="node.value"
                        resModel="getResModel(node)"
                    />
                </t>
            </div>
            <t t-call="web.TreeEditor.DeleteButton">
                <t t-set="additionalClass" t-value="'d-cq-none d-cq-md-block'"/>
            </t>
        </div>
    </t>

    <t t-name="web.TreeEditor.condition:readonly">
        <t t-set="description" t-value="getConditionDescription(node)" />
        <div class="col-cq-12 o_tree_editor_condition d-flex gap-1 border bg-100">
            <div class="fw-bolder text-nowrap" t-esc="description.pathDescription" />
            <div class="fst-italic text-nowrap" t-esc="description.operatorDescription" />
            <t t-if="description.valueDescription">
                <t t-set="values" t-value="description.valueDescription.values" />
                <t t-set="join" t-value="description.valueDescription.join" />
                <t t-set="addParenthesis" t-value="description.valueDescription.addParenthesis" />
                <t t-if="addParenthesis">( </t>
                <t t-foreach="values" t-as="val" t-key="val_index">
                    <span class="text-primary fw-bolder"><t t-esc="val" /></span>
                    <t t-if="!val_last"> <t t-esc="join" /> </t>
                </t>
                <t t-if="addParenthesis"> )</t>
            </t>
        </div>
    </t>

    <t t-name="web.TreeEditor.Editor">
        <t t-if="!info.isSupported(value)">
            <div t-attf-class="o_tree_editor_editor #{_classes}">
                <div class="o_input d-flex align-items-center">
                    <span class="flex-gcq-1 text-truncate" t-esc="info.stringify(value)" />
                    <i role="alert" class="fa fa-exclamation-triangle text-warning mx-2" t-att-title="(typeof info.message === 'function') ? info.message(value) : info.message" />
                    <i class="fa fa-times" title="Clear" t-on-click="() => update(info.defaultValue())" />
                </div>
            </div>
        </t>
        <t t-elif="info.component">
            <div t-attf-class="o_tree_editor_editor flex-grow-1 #{_classes}">
                <t t-component="info.component" t-props="info.extractProps({ update, value })" />
            </div>
        </t>
    </t>

    <t t-name="web.TreeEditor.condition:editable">
        <div class="col-cq-12 o_tree_editor_condition d-flex justify-content-between">
            <div class="row row-cq w-100 align-items-end g-2">
                <t t-call="web.TreeEditor.Editor">
                    <t t-set="_classes" t-value="'col-cq-12 col-cq-md'" />
                    <t t-set="info" t-value="getPathEditorInfo()" />
                    <t t-set="value" t-value="node.path" />
                    <t t-set="update" t-value="(path) => this.updatePath(node, path)" />
                </t>
                <t t-call="web.TreeEditor.Editor">
                    <t t-set="_classes" t-value="'col-cq-4 col-cq-md-2'" />
                    <t t-set="info" t-value="getOperatorEditorInfo(node)" />
                    <t t-set="value" t-value="[node.operator, node.negate]" />
                    <t t-set="update" t-value="(operator, negate) => this.updateLeafOperator(node, operator, negate)" />
                </t>
                <t t-call="web.TreeEditor.Editor">
                    <t t-set="_classes" t-value="'col-cq-8 col-cq-md overflow-hidden'" />
                    <t t-set="info" t-value="getValueEditorInfo(node)" />
                    <t t-set="value" t-value="node.value" />
                    <t t-set="update" t-value="(value) => this.updateLeafValue(node, value)" />
                </t>
            </div>
        </div>
    </t>

    <t t-name="web.TreeEditor.complex_condition">
        <div class="col-cq-12 col-cq-md-11">
            <div class="row row-cq">
                <div class="col-cq-12 col-cq-md-12 o_tree_editor_complex_condition d-flex justify-content-between">
                    <input class="o_input w-100" t-att-value="node.value" t-att-readonly="props.readonly or !isDebugMode" t-on-change="(ev) => this.updateComplexCondition(node, ev.target.value)" />
                    <t t-call="web.TreeEditor.DeleteButton"/>
                </div>
            </div>
        </div>
    </t>


</templates>
