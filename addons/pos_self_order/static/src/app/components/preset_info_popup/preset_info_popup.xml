<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">
<t t-name="pos_self_order.PresetInfoPopup">
        <!-- Backdrop -->
        <div class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-25"  style="z-index: 1050;"></div>
        <div class="position-absolut fixed-bottom top-0 start-0 w-100 h-100 d-flex align-items-end align-items-md-center justify-content-md-center" style="z-index: 1055;">
            <div class="select_popup_preset_info d-flex flex-column w-100 w-md-75 w-lg-75 bg-white shadow-lg rounded-4 p-4" style="overflow: auto;">
                <form t-if="state.step === 1" t-on-submit="onSlotSubmit" class="w-100 step-panel">
                    <div class="row g-2">
                        <div t-if="preset.needsSlot" class="d-flex w-100 flex-wrap gap-2 mt-2 flex-nowrap overflow-auto no-scrollbar flex-md-wrap overflow-md-visible pe-2">
                            <button class="btn py-2 d-flex flex-column align-items-center text-center"
                                t-foreach="slots" t-as="slot" t-key="slot_index"
                                t-att-class="{'o_colorlist_item_color_transparent_6': slots.length === 0, 'btn-primary': state.selectedDate === slot[0], 'btn-secondary': state.selectedDate !== slot[0], 'opacity-50': state.selectedDate ? (state.selectedDate !== slot[0]) : false}"
                                t-on-click="() => {state.selectedDate = slot[0]; state.selectedSlot = null;}">
                                <t t-if="slot_index === 0">
                                    <span class="fw-bold">Today</span>
                                    <small><t t-esc="shortFormatDate(slot[0])"/></small>
                                </t>
                                <t t-elif="slot_index === 1">
                                    <span class="fw-bold">Tomorrow</span>
                                    <small><t t-esc="shortFormatDate(slot[0])"/></small>
                                </t>
                                <t t-else="">
                                    <span style="min-height:0.75rem; display:block;"></span>
                                    <t t-esc="shortFormatDate(slot[0])"/>
                                </t>
                            </button>
                        </div>

                        <!-- Tablet and desktop version -->
                        <div class="d-none d-md-block w-100 mt-3">
                            <div t-foreach="Object.keys(preset.availabilities)" t-as="slot" t-key="slot_index" class="row">
                                <t t-set="slotByPeriod" t-value="Object.entries(this.getSlotsForDate(preset, slot))"/>
                                <div t-foreach="slotByPeriod"
                                    t-as="entries"
                                    t-key="entries[0]"
                                    t-att-class="{'d-none': state.selectedDate !== slot}"
                                    t-attf-class="{{`col-${12 / slotByPeriod.length}`}}">
                                    <div class="fw-bold fs-3 mb-2">
                                        <span t-esc="this.getPeriodName(entries[0])"/>
                                    </div>
                                    <div class="d-flex flex-wrap gap-1">
                                        <button type="button" t-foreach="entries[1]"
                                            t-as="slot"
                                            t-if="!slot.isFull"
                                            t-key="slot_index"
                                            t-attf-class="{{ state.selectedSlot === slot.datetime.toFormat('yyyy-MM-dd HH:mm:ss') ? 'btn-primary' : 'btn-secondary' }}"
                                            t-on-click="() => state.selectedSlot = slot.datetime.toFormat('yyyy-MM-dd HH:mm:ss')"
                                            class="btn preset-slot-button">
                                                <span t-esc="slot.datetime.toFormat('HH:mm')" />
                                        </button>
                                    </div>
                                </div>
                                <div t-if="state.selectedDate === slot and Object.values(preset.availabilities[slot]).length === 0" class="w-100 mt-2">
                                    <div class="alert alert-warning" role="alert">
                                        No slot available for this day
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile version -->
                        <div class="d-md-none w-100 mt-3">
                            <div t-foreach="Object.keys(preset.availabilities)" t-as="slot" t-key="slot_index" class="row">
                                <t t-set="slotByPeriod" t-value="Object.entries(this.getSlotsForDate(preset, slot))"/>
                                <div class="slots-container overflow-auto">
                                    <div t-foreach="slotByPeriod"
                                        t-as="entries"
                                        t-key="entries[0]"
                                        t-att-class="{'d-none': state.selectedDate !== slot}"
                                        t-attf-class="col-12">
                                        <span t-esc="this.getPeriodName(entries[0])" class="fw-bold fs-3"/>
                                        <ul class="mb-3 ps-4">
                                            <li t-foreach="entries[1]" 
                                                t-as="s"
                                                t-key="s.id || s.datetime.toMillis()" 
                                                t-if="!s.isFull">
                                                <label class="d-flex justify-content-between align-items-center gap-2 py-1">
                                                    <span t-esc="s.datetime.toFormat('HH:mm')" class="ms-3"/>
                                                    <input class="form-check-input fs-2 me-5"
                                                        type="radio"
                                                        t-att-name="'slot-' + (state.selectedDate || 'unknown')"
                                                        t-att-checked="state.selectedSlot === s.datetime.toFormat('yyyy-MM-dd HH:mm:ss')"
                                                        t-on-change="() => (state.selectedSlot = s.datetime.toFormat('yyyy-MM-dd HH:mm:ss'))"/>
                                                </label>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div t-if="state.selectedDate === slot and Object.values(preset.availabilities[slot]).length === 0" class="w-100 mt-2">
                                    <div class="alert alert-warning" role="alert">
                                        No slot available for this day
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex w-100 flex-wrap gap-2 mt-2 justify-content-end">
                        <button type="button" t-on-click="close" class="btn btn-secondary py-3 mt-4 mb-2">
                            <t>Discard</t>
                        </button>
                        <button type="submit"
                                class="btn btn-primary py-3 mt-4 mb-2"
                                t-att-disabled="!validSlotStep"
                                t-on-click = "onSlotSubmit">
                            <t t-if="validSlotStep and needsInfo">Continue</t>
                            <t t-elif="validSlotStep and !needsInfo">Confirm</t>
                            <t t-else="">Select</t>
                        </button>
                    </div>
                </form>
                <form t-if="state.step === 2 and needsInfo" t-on-submit="onInfoSubmit" class="w-100 step-panel">

                    <t t-if="preset.needsSlot and state.selectedSlot">
                        <div class="d-flex align-items-center gap-2">
                            <h2 t-esc="selectedDateLabel" style="font-weight: normal;"/>
                            <h2 class="mx-1" style="font-weight: normal;">at</h2>
                            <h2 t-esc="selectedTimeLabel" style="font-weight: normal;"/>
                        </div>
                    </t>

                    <div class="d-flex justify-content-between align-items-center px-2 mb-3 mt-4">
                        <h2 class="mb-0">We need more info</h2>
                    </div>

                    <select t-if="preset.needsPartner and existingPartners.length"
                        class="partner-select form-select form-select-lg mb-2"
                        t-on-change="selectExistingPartner"
                        t-model="state.selectedPartnerId">
                        <option value="">
                            Select your address
                        </option>
                        <t t-foreach="existingPartners" t-as="partner" t-key="partner.id">
                            <option t-att-value="partner.id" t-esc="partner.name + ' ' + partner.pos_contact_address" />
                        </t>
                    </select>

                    <input t-if="preset.needsName || preset.needsPartner"
                        type="text"
                        class="form-control form-control-lg mb-2"
                        placeholder="Name"
                        t-model="state.name"
                        t-att-disabled="partnerIsSelected" />

                    <input t-if="preset.needsEmail || preset.needsPartner"
                        type="text"
                        class="form-control form-control-lg mb-2"
                        placeholder="Email"
                        t-model="state.email"
                        t-att-disabled="partnerIsSelected" />

                    <t t-if="preset.needsPartner">
                        <input type="text"
                            class="form-control form-control-lg mb-2"
                            placeholder="Phone"
                            t-model="state.phone"
                            t-att-disabled="partnerIsSelected"/>

                        <select class="partner-select form-select form-select-lg mb-2" t-model="state.countryId" t-att-disabled="partnerIsSelected">
                            <option value="">
                                Select a country
                            </option>
                            <t t-foreach="this.countries" t-as="country" t-key="country.id">
                                <option t-att-value="country.id" t-esc="country.name" />
                            </t>
                        </select>

                        <div class="d-flex gap-3">
                            <input type="text"
                                class="form-control form-control-lg w-75 mb-2"
                                placeholder="Street and Number"
                                t-model="state.street"
                                t-att-disabled="partnerIsSelected"/>
                            <input
                                type="text"
                                class="form-control form-control-lg w-25 mb-2"
                                placeholder="Zip"
                                t-model="state.zip"
                                t-att-disabled="partnerIsSelected"/>
                        </div>

                        <div class="d-flex gap-3">
                            <t t-set="availableState" t-value="this.states" />
                            <select t-if="availableState.length" class="partner-select form-select form-select-lg mb-2" t-model="state.stateId" t-att-disabled="partnerIsSelected">
                                <option value="">
                                    Select a state
                                </option>
                                <t t-foreach="availableState" t-as="state" t-key="state.id">
                                    <option t-att-value="state.id" t-esc="state.name" />
                                </t>
                            </select>
                            <input type="text"
                                class="form-control form-control-lg mb-2"
                                placeholder="City"
                                t-model="state.city"
                                t-att-disabled="partnerIsSelected"/>
                        </div>
                    </t>

                    <div class="d-flex w-100 flex-wrap gap-2 mt-2 justify-content-end">
                        <button type="button"
                                class="btn btn-secondary py-3 mt-4 mb-2"
                                t-on-click="preset.needsSlot ? backToSlots : close">
                            Back
                        </button>
                        <button type="submit"
                                class="btn btn-primary py-3 mt-4 mb-2"
                                t-att-disabled="!validInfoStep">
                            Continue
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </t>
</templates>
