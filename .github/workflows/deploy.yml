name: Deploy

on:
  push:
    branches:
      - tilsol_customization
    paths-ignore:
      - ".husky/**"
      #- ".git**"
      - "package*.json"
      - "**.md"
  workflow_dispatch:
    inputs:
      env:
        description: 'Env for deploy'
        required: true
        default: 'TEST'
        type: environment
        
run-name: Deploy by @${{ github.actor }} to ${{ inputs.env || 'TEST' }}

jobs:
  deployment:
    name: Deploy on-premise Odoo
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.env || 'TEST' }}
    steps:
      - name: Setup SSH Key for EC2
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        run: |
          echo "$PRIVATE_KEY" > PRIVATE_KEY.pem
          chmod 400 PRIVATE_KEY.pem

      - name: Pull changes
        run: |
          ssh -tt -o StrictHostKeyChecking=no -i ./PRIVATE_KEY.pem ${{ vars.EC2_USER_NAME }}@${{ vars.EC2_INSTANCE_ADDRESS }} <<EOF
          whoami
          cd /home/ubuntu/infinite-laundry-crm
          systemctl stop odoo.service
          git branch;
           git pull
          pip install -r requirements.txt
          systemctl start odoo.service
          exit
          EOF

      - name: Cleanup SSH Key
        run: rm -f ./PRIVATE_KEY.pem
