name: Deploy

on:
  push:
    branches:
      - tilsol_customization
    paths-ignore:
      - ".husky/**"
      #- ".git**"
      - "package*.json"
      - "**.md"
  workflow_dispatch:
    inputs:
      env:
        description: 'Env for deploy'
        required: true
        default: 'TEST'
        type: environment
        
run-name: Deploy by @${{ github.actor }} to ${{ inputs.env || 'TEST' }}

jobs:
  deployment:
    name: Deploy on-premise Odoo
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.env || 'TEST' }}
    steps:
      - name: Setup SSH Key for EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          echo "$PRIVATE_KEY" > ${{ secrets.PRIVATE_KEY }}.pem
          chmod 400 ${{ secrets.PRIVATE_KEY }}.pem

      - name: Pull changes
        run: |
          ssh -tt -o StrictHostKeyChecking=no -i ./${{ secrets.PRIVATE_KEY }}.pem ${{ vars.EC2_USER_NAME }}@${{ vars.EC2_INSTANCE_ADDRESS }} <<EOF
          cd /home/ubuntu
          service odoo stop
          git branch
          git pull
          service odoo start
          EOF

      - name: Cleanup SSH Key
        run: rm -f ./${{ secrets.PRIVATE_KEY }}.pem
