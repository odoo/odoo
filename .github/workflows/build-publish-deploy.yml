name: "Build, Publish & Deploy"

on:
  push:
    branches:
      - main

  repository_dispatch:
    types:
      - trigger-workflow

env:
  APPLICATION_NAME: via-suite
  IMAGE_REGISTRY: ghcr.io
  IMAGE_REPOSITORY: ghcr.io/viafronteira/via-suite

jobs:
  build-publish-deploy:
    name: "Docker Buildx (multi-arch) + Publish + K8S Deploy"
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: "Checkout the code"
        uses: actions/checkout@v4

      - name: "Set up environment vars"
        shell: bash
        run: |
          if [ "${GITHUB_REF}" == "refs/heads/main" ]; then
            echo "RELEASE_TYPE=production" >> $GITHUB_ENV
          elif [ "${GITHUB_REF}" == "refs/heads/staging" ]; then
            echo "RELEASE_TYPE=staging" >> $GITHUB_ENV
          else
            echo "RELEASE_TYPE=development" >> $GITHUB_ENV
          fi

          echo "GITHUB_SHA_SHORT=$(git rev-parse --short "${GITHUB_SHA}")" >> $GITHUB_ENV

      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/arm64,linux/amd64

      - name: "Login to GHCR"
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Build and Push Docker image (multi-arch)"
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          provenance: false
          platforms: linux/arm64,linux/amd64
          tags: |
            ${{ env.IMAGE_REPOSITORY }}:latest-${{ env.RELEASE_TYPE }}
            ${{ env.IMAGE_REPOSITORY }}:${{ env.GITHUB_SHA_SHORT }}

      - name: "Set up kubectl"
        uses: azure/setup-kubectl@v4

      - name: "Write kubeconfig"
        shell: bash
        env:
          KUBECONFIG_B64: ${{ secrets.KUBECONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "${KUBECONFIG_B64}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: "Deploy via-suite-web (set image)"
        shell: bash
        run: |
          kubectl set image deployment/via-suite-web \
            via-suite=${{ env.IMAGE_REPOSITORY }}:${{ env.GITHUB_SHA_SHORT }}

      - name: "Deploy via-suite-cron (set image)"
        shell: bash
        run: |
          kubectl set image deployment/via-suite-cron \
            via-suite=${{ env.IMAGE_REPOSITORY }}:${{ env.GITHUB_SHA_SHORT }}

      - name: "Wait for rollout via-suite-web"
        shell: bash
        run: kubectl rollout status deployment/via-suite-web

      - name: "Wait for rollout via-suite-cron"
        shell: bash
        run: kubectl rollout status deployment/via-suite-cron