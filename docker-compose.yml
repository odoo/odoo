version: "3.8"

# Docker Compose for Odoo 19 with Uber Eats Integration
# Optimized for VPS with 1GB RAM and 1 CPU core

services:
  db:
    image: postgres:15.15-alpine3.22
    container_name: odoo_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: odoo
      POSTGRES_USER: odoo
      POSTGRES_PASSWORD: odoo_password  # Change this!
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - odoo-db-data:/var/lib/postgresql/data
    # PostgreSQL config for low-memory environments
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=128MB"
      - "-c"
      - "effective_cache_size=256MB"
      - "-c"
      - "maintenance_work_mem=32MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=16384"
      - "-c"
      - "min_wal_size=1GB"
      - "-c"
      - "max_wal_size=4GB"
    deploy:
      resources:
        limits:
          cpus: "0.4"      # 40% of 1 CPU
          memory: 256M     # 256MB limit for DB

  odoo:
    image: ghcr.io/YOUR_GH_USER/YOUR_REPO:odoo-uber-latest
    container_name: odoo_uber
    depends_on:
      - db
    restart: unless-stopped
    environment:
      # Database connection
      HOST: db
      USER: odoo
      PASSWORD: odoo_password  # Match db password
      PORT: 5432
      # Odoo database settings
      DB_NAME: odoo
      DB_MAXCONN: 20  # Low for limited RAM
      # Odoo server settings (optimize for low memory)
      WORKERS: 2  # Keep low for 1GB RAM
      # Uber API Configuration (placeholder - update with real values)
      UBER_ENVIRONMENT: sandbox
      UBER_CLIENT_ID: your_sandbox_client_id_here
      UBER_CLIENT_SECRET: your_sandbox_client_secret_here
      UBER_SCOPES: "eats.store eats.order eats.store.orders.read"
      UBER_AUTH_URL: "https://sandbox-login.uber.com/oauth/v2/token"
      UBER_API_BASE_URL: "https://test-api.uber.com"
      UBER_WEBHOOK_BASIC_USER: "webhookuser"
      UBER_WEBHOOK_BASIC_PASSWORD: "strongpassword"
      # Security
      LOG_LEVEL: info
    ports:
      - "8080:8069"      # Odoo HTTP port
    volumes:
      # Persistent data
      - odoo-data:/var/lib/odoo
      # Optional: Local custom addons
      - ./odoo-extra-addons:/mnt/extra-addons
      # Optional: Mount config (comment out if using env vars only)
      # - ./config/odoo.conf:/etc/odoo/odoo.conf:ro
    command: >
      odoo
      --db_host=db
      --db_user=odoo
      --db_password=odoo_password
      --db_name=odoo
      --db_maxconn=20
      --workers=2
      --max_cron_threads=1
      --limit_memory_hard=536870912
      --limit_memory_soft=402653184
      --limit_time_cpu=60
      --limit_time_real=120
      --limit_request=8192
    deploy:
      resources:
        limits:
          cpus: "0.55"     # 55% of 1 CPU
          memory: 640M     # 640MB limit for Odoo process

volumes:
  odoo-db-data:
    driver: local
  odoo-data:
    driver: local

# Networks (optional, for internal communication)
networks:
  default:
    name: odoo-network
