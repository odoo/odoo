version: "3.9"

# ============================================
# Odoo 19 + PostgreSQL + debugpy（VSCodeデバッグ対応）
# ローカル開発用 docker-compose.yml
# ============================================

services:

  # ---------------------------------------------------------
  # PostgreSQL（Odoo のデータベース）
  # ---------------------------------------------------------
  db:
    image: postgres:16               # PostgreSQL の公式イメージ
    container_name: odoo19-db        # コンテナ名（任意）
    environment:
      POSTGRES_DB: odoo              # Odoo が使用する DB 名
      POSTGRES_USER: odoo            # DB ユーザー名
      POSTGRES_PASSWORD: odoo        # DB パスワード
    ports:
      - "5432:5432"                  # ← DBeaver 等から接続したい場合
    volumes:
      - db-data:/var/lib/postgresql/data   # DB の永続化
    restart: unless-stopped

  # ---------------------------------------------------------
  # Odoo 19（debugpy 経由で VSCode からデバッグ可能）
  # ---------------------------------------------------------
  odoo:
    build:
      context: .                     # カレントディレクトリをビルドコンテキストに
      dockerfile: Dockerfile.debug   # Dockerfile.debug を使ってビルド
    image: odoo-debug                # イメージ名（docker run で使っていた名前と合わせた）
    container_name: odoo-debug       # コンテナ名
    depends_on:
      - db                           # 先に db を起動してから Odoo を立ち上げる
    environment:
      HOST: db                       # Odoo から見た DB ホスト名（service名=db）
      USER: odoo                     # Odoo が接続に使う DB ユーザー
      PASSWORD: odoo                 # Odoo が接続に使う DB パスワード
      ODOO_EXTRA_ADDONS: /mnt/extra-addons   # 追加アドオンのパス
    ports:
      - "8069:8069"                  # ← Odoo Web（ブラウザ用）
      - "5678:5678"                  # ← VSCode debugpy のポート
    volumes:
      - odoo-data:/var/lib/odoo              # Odoo の filestore 永続化
      - ./config:/etc/odoo                   # あなたの odoo.conf をマウント
      - ./custom_addons:/mnt/extra-addons    # カスタムモジュール（デバッグ対象）
    restart: unless-stopped

# -------------------------------------------------------------
# Docker volume 定義（データをコンテナ削除しても保持する）
# -------------------------------------------------------------
volumes:
  db-data:
  odoo-data:
