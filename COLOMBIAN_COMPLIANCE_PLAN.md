# Colombian Compliance Review & Implementation Plan

## Executive Summary

This document presents a gap analysis of the GPCB_Accounting system (Odoo v19) against
Colombian regulatory requirements for invoicing, tax reporting, and accounting standards.
The current `l10n_co` module provides foundational accounting data (Chart of Accounts,
tax definitions, identification types) but lacks critical compliance modules required by
DIAN and Colombian law. The most significant gap is the absence of an electronic invoicing
(facturacion electronica) module — a mandatory requirement for all Colombian taxpayers.

Beyond compliance, this plan covers platform modernization: UI refresh options, a native
iOS reporting app, a public REST API to support integration with the custom veterinary
and lab testing POS project, automated report scheduling with DIAN filing, and electronic
payroll data exchange (nomina electronica).

---

## 1. Current State Assessment

### What exists today (`addons/l10n_co/`)

| Component | Status | Notes |
|-----------|--------|-------|
| Chart of Accounts (PUC) | Present | 379 accounts in `account.account-co.csv` |
| Tax definitions (IVA, RteFte, RteICA, INC) | Present | 64 taxes in `account.tax-co.csv` |
| Tax groups | Present | 44 groups in `account.tax.group-co.csv` |
| Identification types (NIT, CC, CE, etc.) | Present | 14 types including NIT, PEP, PPT |
| LATAM base framework | Present | `l10n_latam_base` and `l10n_latam_invoice_document` |
| Withholding tax on payment | Present | `l10n_account_withholding_tax` module |
| POS localization | Present | `l10n_co_pos` with basic EDI credit note ref |
| Currency exchange accounts | Present | Configured in `template_co.py` |
| Debit notes | Present | `account_debit_note` dependency |
| Generic EDI framework | Present | `account_edi` and `account_edi_ubl_cii` modules |

### What is missing

| Component | Severity | Regulatory Basis |
|-----------|----------|------------------|
| Electronic invoicing module (l10n_co_edi) | **CRITICAL** | Resolucion 000165/2023, Art. 616-1 E.T. |
| CUFE/CUDE hash generation (SHA-384) | **CRITICAL** | DIAN Technical Annex v1.9 |
| UBL 2.1 XML with DIAN extensions | **CRITICAL** | DIAN Technical Annex v1.9 |
| DIAN web service integration (clearance API) | **CRITICAL** | Pre-validation model requirement |
| Digital signature (XMLDSig) integration | **CRITICAL** | Art. 7 Decreto 2242/2015 |
| QR code on graphic representation | **HIGH** | DIAN Technical Annex v1.9 |
| DIAN-authorized numbering ranges | **HIGH** | Art. 617 E.T. |
| Documento Equivalente Electronico | **HIGH** | Res. 000165/2023, mandatory 2025 |
| Colombian tax report templates (IVA return, RteFte) | **HIGH** | DIAN filing obligations |
| Withholding certificate generation | **HIGH** | Art. 381 E.T., due Mar 31 annually |
| UVT value management | **MEDIUM** | Tax threshold calculations |
| Fiscal position rules for CO partner types | **MEDIUM** | Tax mapping automation |
| Self-withholding (autorretencion) support | **MEDIUM** | Res. 000049/2019 |
| Tax rate updates for 2026 (Decreto 0572) | **MEDIUM** | Updated thresholds |
| RADIAN support (negotiable instruments) | **LOW** | Optional for most businesses |
| NIIF/IFRS reporting reconciliation | **LOW** | CTCP requirements |
| Electronic container (Contenedor Electronico) | **LOW** | Res. 000012 |

---

## 2. Detailed Gap Analysis

### 2.1 CRITICAL: Electronic Invoicing (Facturacion Electronica)

**Regulatory Requirement:**
All Colombian taxpayers selling goods or services subject to IVA or INC must issue
electronic invoices validated by DIAN before delivery to the buyer. Colombia operates
a clearance/pre-validation model — invoices must be transmitted to and approved by DIAN
in real time.

**Current State:**
- The codebase has no `l10n_co_edi` module
- Generic EDI infrastructure exists (`account_edi`, `account_edi_ubl_cii`) but is not
  adapted for Colombian DIAN requirements
- A field reference `l10n_co_edi_description_code_credit` exists in `l10n_co_pos` but
  is the only trace of Colombian EDI integration
- Other LATAM countries (Mexico, Chile) and European countries (Spain, Italy) have
  complete EDI modules that can serve as architectural references

**Impact:**
Without this module, invoices generated by the system **cannot be legally issued** in
Colombia. This is a non-negotiable compliance requirement.

**Required sub-components:**

1. **UBL 2.1 XML generation with DIAN extensions**
   - Invoice (Factura de Venta)
   - Credit Note (Nota Credito)
   - Debit Note (Nota Debito)
   - Namespace: `urn:oasis:names:specification:ubl:schema:xsd:Invoice-2`
   - DIAN custom extension namespace for Colombian-specific fields

2. **CUFE generation (Clave Unica de Facturacion Electronica)**
   - Algorithm: SHA-384
   - Formula: `SHA384(NumFac + FecFac + ValFac + CodImp1 + ValImp1 + CodImp2 + ValImp2 + CodImp3 + ValImp3 + ValImp + NitOFE + NumAdq + ClTec + TipoAmbiente)`
   - Must be included in XML and printed on graphic representation
   - CUDE variant for credit/debit notes and equivalent documents

3. **DIAN web service integration**
   - SOAP/REST endpoints for invoice submission
   - Test environment: `vpfe-hab.dian.gov.co`
   - Production environment: `vpfe.dian.gov.co`
   - Synchronous validation response handling
   - Error code handling and retry logic
   - Status tracking per document

4. **Digital signature (XMLDSig)**
   - ONAC-accredited certificate management
   - RSA or ECDSA signing
   - SHA-256/SHA-384/SHA-512 hash algorithms
   - DIAN signing policy reference (`politicadefirmav2.pdf`)
   - Certificate upload, renewal tracking, expiration alerts

5. **QR code generation**
   - Mandatory on graphic representation (PDF)
   - Contains CUFE/CUDE and verification URL
   - Must follow DIAN specification

6. **DIAN-authorized numbering (Numeracion Autorizada)**
   - Configuration for authorized prefix/range per journal
   - Range validity period tracking
   - Alerts when approaching range exhaustion
   - Support for contingency numbering (talonario)

### 2.2 HIGH: Documento Equivalente Electronico (DEE)

**Regulatory Requirement:**
As of February-April 2025 (phased rollout), 13 types of equivalent documents must be
issued electronically and validated by DIAN. This affects public utilities, airlines,
financial institutions, and others.

**Current State:**
No support exists in the codebase.

**Required:**
- New document types extending `account.move` for DEE
- CUDE generation (same algorithm as CUFE but different parameters)
- Simplified buyer data handling (3 fields for POS per Res. 000202/2025)
- 48-hour transmission window for rural utilities

### 2.3 HIGH: Colombian Tax Reports

**Regulatory Requirement:**
Companies must file periodic tax returns with DIAN:
- Bimonthly IVA returns (Declaracion de IVA)
- Monthly withholding returns (Declaracion de Retencion en la Fuente)
- Annual income tax return
- ICA returns (municipal, varies by city)
- Exogenous information (Informacion Exogena) - annual third-party reporting

**Current State:**
- A report menu entry exists (`account_chart_template_data.xml`) but no actual report
  definitions or templates specific to Colombia
- The generic `account.report` framework supports creating country-specific reports
  with tag-based tax mapping, but no Colombian reports are defined

**Required:**
- IVA return report (Formulario 300)
- Withholding return report (Formulario 350)
- Withholding certificates (Certificados de Retencion) per Art. 381 E.T.
- ICA return report template
- Tax tag mapping on all Colombian taxes for report aggregation
- Exogenous information XML generation (Formato 1001, 1003, 1005, etc.)

### 2.4 HIGH: Withholding Certificates

**Regulatory Requirement:**
Withholding agents must deliver annual certificates to suppliers by March 31 of the
following year. Monthly certificates are also common practice.

**Current State:**
- The withholding tax framework exists (`l10n_account_withholding_tax`)
- Tax definitions for RteFte, RteIVA, RteICA are present
- No certificate generation or PDF template exists

**Required:**
- Withholding certificate model and report
- PDF template matching DIAN format
- Aggregation of withholdings by period, partner, and tax type
- Delivery tracking

### 2.5 MEDIUM: UVT Management

**Regulatory Requirement:**
The UVT (Unidad de Valor Tributario) changes annually (COP $52,374 for 2026). Many
tax thresholds are expressed in UVT, including withholding minimums.

**Current State:**
No UVT tracking mechanism exists. All tax computations use fixed percentages without
threshold-based triggering.

**Required:**
- UVT configuration model (value per year)
- Threshold-based withholding tax computation (e.g., RteFte on purchases applies only
  when base exceeds 10 UVT = COP $523,740 for 2026)
- Annual update mechanism

### 2.6 MEDIUM: Fiscal Position Rules

**Regulatory Requirement:**
Different tax treatment applies depending on the partner type:
- Gran Contribuyente (large taxpayer)
- Autorretenedor (self-withholding agent)
- Regimen Comun vs Regimen Simple
- Persona Natural declarante vs no declarante
- Foreign suppliers

**Current State:**
- The generic fiscal position framework exists in the `account` module
- No pre-configured Colombian fiscal positions are defined

**Required:**
- Fiscal position definitions for common Colombian partner classifications
- Tax mapping rules (e.g., when selling to a Gran Contribuyente, different
  withholding rates apply)
- Partner fields for Colombian tax classification
- Automatic fiscal position assignment based on partner type

### 2.7 MEDIUM: Self-Withholding (Autorretencion)

**Regulatory Requirement:**
Certain companies designated by DIAN must self-withhold (autorretencion sobre la renta)
on their sales income at 0.4%, 0.8%, or 1.6% depending on the activity.

**Current State:**
No support. The withholding framework only handles withholding on purchases.

**Required:**
- Self-withholding tax definitions
- Integration with sales invoicing workflow
- Automatic computation based on company designation

### 2.8 MEDIUM: Tax Rate and Threshold Updates for 2026

**Regulatory Requirement:**
Decreto 0572 de 2025 modified several withholding thresholds effective June 1, 2025.
The UVT for 2026 is COP $52,374 (Res. 000238/2025).

**Current State:**
- Tax rates in `account.tax-co.csv` appear to reflect rates from around 2017-2020
- Some legacy rates exist (16% IVA from 2016)
- No threshold-based withholding logic

**Items to update:**
- Verify all RteFte rates against current Decreto 0572/2025
- Add threshold-based withholding computation using UVT
- Mark legacy taxes (16% IVA from 2016) as inactive by default
- Verify RteICA rates against Bogota and other major municipalities
- Add RteVAT 100% rate for certain operations

### 2.9 LOW: RADIAN Support

**Regulatory Requirement:**
Electronic invoices can be used as negotiable instruments (titulos valores) through
DIAN's RADIAN system. Each event requires additional digital signatures.

**Current State:**
No support exists.

**Required (future phase):**
- RADIAN event registration
- Additional signature handling
- Title transfer tracking

### 2.10 LOW: NIIF/IFRS Reporting Reconciliation

**Regulatory Requirement:**
Colombian companies must maintain accounting records under NIIF (IFRS) and reconcile
with tax-basis accounting for DIAN filings.

**Current State:**
- The generic ledger group feature supports multiple accounting standards
- No Colombian-specific NIIF reconciliation is configured

**Required (future phase):**
- Pre-configured ledger groups for NIIF vs fiscal accounting
- Tax-to-IFRS reconciliation report
- Guidance documentation for setup

---

## 3. Implementation Plan

### Phase 1: Foundation (Weeks 1-4) — DONE

**Status:** COMPLETE. All foundation code implemented and tested.

**Goal:** Establish the `l10n_co_edi` module skeleton and supporting infrastructure.

#### 1.1 Create `l10n_co_edi` module structure

```
addons/l10n_co_edi/
  __init__.py
  __manifest__.py
  models/
    __init__.py
    account_move.py          # Extend account.move with CO EDI fields
    account_journal.py       # DIAN numbering configuration
    res_company.py           # Company-level EDI settings
    l10n_co_edi_document.py  # EDI document tracking model
    cude.py                  # CUFE/CUDE computation
  data/
    l10n_co_edi_data.xml     # DIAN tax codes, payment methods, etc.
    ubl_templates/           # Jinja2/QWeb UBL XML templates
  views/
    account_move_views.xml   # Invoice form extensions
    res_company_views.xml    # Company settings view
    account_journal_views.xml
  security/
    ir.model.access.csv
  wizard/
    account_move_send.py     # Override send wizard for DIAN
  tests/
    __init__.py
    test_cufe.py
    test_xml_generation.py
```

**Key tasks:**
- [ ] Define module manifest with dependencies: `l10n_co`, `account_edi`, `account_edi_ubl_cii`
- [ ] Add company-level fields: DIAN software ID, software PIN, test mode toggle, certificate
- [ ] Add journal fields: authorized prefix, range start/end, range validity dates
- [ ] Add `account.move` fields: CUFE/CUDE, DIAN status, QR code data, EDI XML attachment
- [ ] Implement CUFE SHA-384 computation with unit tests
- [ ] Implement CUDE computation for credit/debit notes
- [ ] Reference data: DIAN tax type codes (01=IVA, 02=INC, 03=ICA), payment means codes,
  document type codes

#### 1.2 UVT Management

- [ ] Create `l10n_co.uvt` model (year, value)
- [ ] Seed data: 2025 = COP $49,799; 2026 = COP $52,374
- [ ] Helper method: `convert_uvt_to_cop(uvt_amount, year)`

#### 1.3 Tax updates

- [ ] Audit all 64 taxes against current regulations
- [ ] Set `active=False` on legacy 16% IVA taxes by default
- [ ] Verify RteFte percentages and add any missing categories
- [ ] Add `l10n_co_tax_scope` field to link taxes to DIAN tax type codes (01, 02, 03, etc.)

### Phase 2: XML Generation & Digital Signature (Weeks 5-8) — DONE

**Status:** COMPLETE. UBL 2.1 builder, XMLDSig signer, and EDI format integration implemented.

**Goal:** Generate DIAN-compliant UBL 2.1 XML and sign it.

**Implementation:**
- `account_edi_xml_ubl_co.py` — Colombian UBL 2.1 builder extending `account.edi.xml.ubl_21`
- `tools/ubl_21_dian.py` — DIAN-specific UBL templates (DianInvoice, DianCreditNote)
- `tools/xml_signer.py` — XMLDSig/XAdES-BES signer with DIAN policy reference
- Updated `account_edi_format.py` — Full XML generation + signing wired into post flow

#### 2.1 UBL 2.1 XML generation

- [x] Colombian UBL 2.1 builder inheriting Odoo's dict-to-XML pattern
- [x] DIAN-specific templates for Invoice (01) and CreditNote (91)
- [x] All mandatory DIAN elements:
  - `cbc:UBLVersionID` = "UBL 2.1"
  - `cbc:CustomizationID` (10=Standard, 20=Export, 30=Contingency, 91=CreditNote, 92=DebitNote)
  - `cbc:ProfileID` = "DIAN 2.1"
  - `cbc:ProfileExecutionID` (1=Production, 2=Test)
  - `cbc:UUID` with CUFE/CUDE hash (SHA-384)
  - `ext:UBLExtensions` > `sts:DianExtensions` with InvoiceControl, SoftwareProvider, QR
  - Supplier/Customer party with NIT check digit, fiscal responsibilities, DIAN codes
  - Tax totals split into TaxTotal (IVA/INC/ICA) vs WithholdingTaxTotal (RteFte/RteIVA/RteICA)
  - DIAN payment means codes
  - BillingReference and DiscrepancyResponse for credit notes
- [x] NIT check digit algorithm with unit tests
- [x] Software security code computation (SHA-384)
- [ ] XSD schema validation (deferred to Phase 3 integration testing)

#### 2.2 Digital signature integration

- [x] PKCS#12 certificate loading and key extraction
- [x] XMLDSig/XAdES-BES implementation using `cryptography` and `lxml`
- [x] Support RSA-SHA256 and ECDSA-SHA256
- [x] Enveloped signature with 3 references (document, KeyInfo, SignedProperties)
- [x] DIAN signing policy reference (politicadefirmav2.pdf)
- [x] XAdES QualifyingProperties with SigningCertificate, SignerRole
- [x] Certificate expiry tracking (from Phase 1 company fields + cron)
- [x] Graceful fallback: unsigned XML when no certificate configured

#### 2.3 QR code generation

- [x] QR data URL generated from CUFE/CUDE (DIAN catalogo-vpfe verification URL)
- [ ] QR image generation for PDF graphic representation (deferred — needs `qrcode` library)

### Phase 3: DIAN Integration (Weeks 9-12) — DONE

**Status:** COMPLETE. DIAN SOAP client, full submission workflow, and status polling implemented.

**Goal:** Connect to DIAN web services for document validation.

**Implementation:**
- `l10n_co_edi_dian_client.py` — DIAN SOAP client using Odoo's zeep wrapper
- Updated `account_edi_format.py` — Full submission flow (generate → sign → submit → process)
- Updated `account_move.py` — Cron-based DIAN status polling for async documents
- Updated `ir_cron_data.xml` — 15-minute cron for polling pending documents

#### 3.1 DIAN web service client

- [x] SOAP client using Odoo's `zeep` wrapper (`odoo.tools.zeep.Client`)
- [x] All endpoints implemented:
  - `SendBillSync` — synchronous submission with ZIP packaging
  - `SendBillAsync` — async submission returning ZipKey for polling
  - `GetStatus` — check status by CUFE/CUDE track ID
  - `GetStatusZip` — check status by ZipKey
  - `SendTestSetAsync` — submit test set during habilitacion
- [x] Response parsing with standardized dict format
- [x] Retry logic with exponential backoff (3 retries: 2s, 5s, 15s)
- [x] Transient error detection (ConnectionError, Timeout, TransportError)
- [x] Both test (vpfe-hab.dian.gov.co) and production (vpfe.dian.gov.co) endpoints
- [x] ZIP packaging of signed XML (DIAN requirement)
- [x] Application response XML extraction and storage

#### 3.2 Document workflow

- [x] Complete invoice posting workflow:
  1. Generate UBL 2.1 XML (Phase 2 builder)
  2. Compute CUFE/CUDE (Phase 1)
  3. Sign with digital certificate (Phase 2 signer)
  4. Submit to DIAN (SendBillSync or SendTestSetAsync)
  5. Process DIAN response (validated/rejected/pending)
  6. Store validation result, XML attachment, response details
- [x] Status indicators on invoice form (Phase 1 views: pending/sent/validated/rejected/cancelled)
- [x] Cron-based async status polling (every 15 minutes for pending/sent documents)
- [x] Graceful degradation: submission failure stores XML locally as pending
- [ ] Email delivery of graphic representation with XML attachment (deferred)

#### 3.3 Enablement (habilitacion) workflow

- [x] Test set submission via SendTestSetAsync with test_set_id from company settings
- [ ] Test set submission wizard (UI — deferred to Phase 8 UI work)
- [ ] Validation result tracking dashboard (deferred)
- [ ] Transition from test to production mode

### Phase 4: Reporting & Certificates (Weeks 13-16)

**Goal:** Implement tax reports and withholding certificates.

#### 4.1 Tax report definitions

- [ ] IVA return (Formulario 300):
  - Sales subject to IVA 19%, 5%, exempt, excluded
  - Purchases with deductible IVA
  - Computed IVA payable/receivable
  - Tax tags on all IVA taxes for report aggregation
- [ ] Withholding return (Formulario 350):
  - Withholdings by concept (salaries, services, purchases, fees, etc.)
  - RteFte, RteIVA, RteICA breakdowns
  - Self-withholding amounts
  - Tax tags on all withholding taxes
- [ ] ICA return template:
  - Income by activity
  - ICA tax computation
  - Adjustable for major municipalities

#### 4.2 Withholding certificates

- [ ] Certificate model: period, partner, tax type, base, withheld amount
- [ ] Annual certificate PDF template (Certificado de Retencion en la Fuente)
- [ ] Monthly/bimonthly certificate option
- [ ] Bulk generation wizard
- [ ] Delivery tracking

#### 4.3 Tax tags

- [ ] Add `tag_ids` to all 64+ Colombian taxes
- [ ] Create tag hierarchy matching DIAN form line numbers
- [ ] Verify tag aggregation produces correct report values

### Phase 5: Fiscal Positions & Partner Classification (Weeks 17-18)

**Goal:** Automate tax mapping based on partner type.

#### 5.1 Partner fields for Colombian tax classification

- [ ] Add fields to `res.partner`:
  - `l10n_co_tax_regime`: Regimen Comun / Regimen Simple / No Responsable
  - `l10n_co_gran_contribuyente`: Boolean
  - `l10n_co_autorretenedor`: Boolean
  - `l10n_co_fiscal_responsibilities`: Multi-select (O-13, O-15, O-23, O-47, etc.)
  - `l10n_co_ciiu_code`: CIIU economic activity code

#### 5.2 Pre-configured fiscal positions

- [ ] Gran Contribuyente (purchases: no RteFte withholding on certain items)
- [ ] Persona Natural No Declarante (higher withholding rates)
- [ ] Regimen Simple (different IVA handling)
- [ ] Foreign supplier (different withholding treatment)
- [ ] Self-withholding company (add autorretencion on sales)

#### 5.3 Automatic fiscal position assignment

- [ ] Based on partner tax classification fields
- [ ] Configurable rules per company

### Phase 6: Documento Equivalente Electronico (Weeks 19-20)

**Goal:** Support electronic equivalent documents per Res. 000165/2023.

- [ ] New document type model for the 13 DEE types
- [ ] CUDE computation for equivalent documents
- [ ] Simplified buyer data handling per Res. 000202/2025
- [ ] 48-hour transmission window support for rural utilities
- [ ] XML templates for most common DEE types:
  - POS ticket (tiquete de maquina registradora POS)
  - Public utility bill (factura de servicios publicos)
  - Financial statement (extracto)

### Phase 7: Exogenous Information (Weeks 21-22)

**Goal:** Generate annual third-party reporting for DIAN.

- [ ] Formato 1001 (payments and withholdings to third parties)
- [ ] Formato 1003 (withholdings practiced)
- [ ] Formato 1005 (IVA deductible)
- [ ] Formato 1006 (IVA generated)
- [ ] Formato 1007 (income received)
- [ ] XML generation per DIAN schema
- [ ] Pre-validation report for data quality

### Phase 8: UI Modernization (Last — after all other phases)

**Implementation note:** Phase 8 is intentionally scheduled last. Before any theme
work begins, 5-6 complete theme mockup options will be presented for review and
selection. No theme implementation will proceed until a direction is chosen.

**Goal:** Modernize the accounting interface with a refreshed look and improved UX,
while preserving the existing OWL component architecture.

#### 8.1 Current UI State

The system uses:
- **OWL framework** (Odoo Web Library) — a Vue-like reactive component system
- **Bootstrap 5+** for CSS with extensive SCSS overrides in `addons/web/static/src/scss/`
- **QWeb templates** for server-rendered views
- Basic mobile CSS exists (control panels, calendar) but the core accounting views are
  desktop-oriented

#### 8.2 Modernization Options

**Option A: Theme Refresh (Low effort, low risk)**
- Create a custom SCSS theme overriding Bootstrap variables
- Modern color palette, improved typography, better whitespace
- Touch-friendly sizing for buttons and inputs (minimum 44px tap targets)
- Dark mode support via CSS custom properties
- Estimated effort: 2-3 weeks

**Option B: Component-Level Redesign (Medium effort, medium risk)**
- Rework key accounting views (invoice form, journal entries, reports dashboard)
  as modern OWL components with improved layouts
- Add contextual action panels, inline editing, and drag-and-drop
- Implement responsive breakpoints for tablet use
- Redesign the Colombian-specific views (EDI status, DIAN dashboard) from the start
  with mobile-first layouts
- Estimated effort: 4-6 weeks

**Option C: Progressive Web App Shell (Higher effort, high reward)**
- Build a PWA wrapper around the accounting module (following the pattern already
  used by `point_of_sale` with its service worker at
  `addons/point_of_sale/static/src/app/service_worker.js`)
- Offline-capable report viewing with cached data
- Push notifications for DIAN validation results, report due dates, certificate expiry
- Home screen installable on mobile devices
- Estimated effort: 6-8 weeks (can run in parallel with other phases)

**Recommendation:** Start with Option A for immediate visual improvement, then pursue
Option B for accounting-specific views during Phase 9 iOS development (shared design
system). Option C is best suited for the vet/lab POS integration where offline capability
is operationally important.

#### 8.3 Key UI tasks

- [ ] Define design tokens (colors, spacing, typography) as SCSS variables and CSS
  custom properties for shared use across web and iOS
- [ ] Create `gpcb_theme` module extending `web` with custom SCSS overrides
- [ ] Redesign invoice form view: clearer tax breakdown display, DIAN status badges,
  CUFE display, QR code preview
- [ ] Add a Colombian compliance dashboard: DIAN submission status, upcoming filing
  deadlines, certificate expiry warnings, numbering range utilization
- [ ] Improve report viewer: interactive filters, inline drill-down, export to Excel/PDF
- [ ] Responsive table components for tax reports (Formulario 300/350) usable on tablets
- [ ] Accessibility audit: WCAG 2.1 AA compliance for all new/modified views
- [ ] RTL-safe layouts (future-proofing for international expansion)

#### 8.4 Design system deliverables

- [ ] Component library documentation (Storybook-style catalog of OWL components)
- [ ] Shared icon set for Colombian compliance features (DIAN, tax types, filing status)
- [ ] Style guide for consistent use across web, iOS, and POS integration

---

### Phase 9: iOS Reporting App (Weeks 29-36)

**Goal:** Build a native iOS app providing real-time access to financial reports,
DIAN submission status, and key accounting dashboards for business owners and
accounting managers on the go.

#### 9.1 App Architecture

```
┌─────────────────────────────────────┐
│         iOS App (Swift/SwiftUI)     │
│  ┌──────────┐  ┌─────────────────┐  │
│  │ Reports  │  │ DIAN Dashboard  │  │
│  │ Viewer   │  │ & Notifications │  │
│  ├──────────┤  ├─────────────────┤  │
│  │ Offline  │  │ Push Notif.     │  │
│  │ Cache    │  │ Service (APNs)  │  │
│  └────┬─────┘  └────┬────────────┘  │
│       │              │               │
│  ┌────┴──────────────┴────────────┐  │
│  │   API Client (URLSession)      │  │
│  │   OAuth 2.0 / Token Auth       │  │
│  └────────────┬───────────────────┘  │
└───────────────┼─────────────────────┘
                │ HTTPS (REST API from Phase 10)
┌───────────────┼─────────────────────┐
│  GPCB_Accounting Server (Odoo)      │
│  ┌────────────┴───────────────────┐  │
│  │  gpcb_api module (Phase 10)    │  │
│  │  JSON REST endpoints           │  │
│  └────────────────────────────────┘  │
└─────────────────────────────────────┘
```

#### 9.2 Core features

- [ ] **Authentication:** OAuth 2.0 / token-based auth against Odoo server; biometric
  unlock (Face ID / Touch ID) for returning sessions; secure keychain storage
- [ ] **Report dashboard:** Summary cards for key metrics — revenue, expenses, IVA
  payable, withholdings balance, cash position
- [ ] **Report viewer:**
  - Formulario 300 (IVA return) — interactive, with period selection
  - Formulario 350 (withholding return) — drill-down by concept
  - Profit & Loss, Balance Sheet, Trial Balance
  - Withholding certificates — view and share as PDF
  - Custom date ranges and comparison periods
- [ ] **DIAN status monitor:**
  - Real-time invoice submission status (pending, validated, rejected)
  - Batch resubmission trigger for rejected invoices
  - Numbering range utilization and expiry alerts
  - Certificate expiry countdown
- [ ] **Notifications (APNs):**
  - DIAN invoice rejection alerts
  - Filing deadline reminders (configurable lead time)
  - Numbering range low/exhausted warnings
  - Payroll processing completion (Phase 12)
  - Automated report ready for review (Phase 11)
- [ ] **Offline mode:**
  - Cache last-viewed reports locally (Core Data or SwiftData)
  - Queue actions (e.g., approve invoice) for sync when online
  - Background refresh via BGTaskScheduler
- [ ] **PDF export and sharing:**
  - Generate and share reports via iOS share sheet
  - Email reports directly from the app
  - AirPrint support

#### 9.3 Technical requirements

- [ ] Minimum target: iOS 16+ (SwiftUI with NavigationStack)
- [ ] Swift 6 with strict concurrency checking
- [ ] Charts: Swift Charts framework for financial visualizations
- [ ] Networking: async/await with URLSession; Combine for reactive data binding
- [ ] Local storage: SwiftData for report caching; Keychain for credentials
- [ ] CI/CD: Xcode Cloud or Fastlane for TestFlight distribution
- [ ] Unit and UI test coverage (XCTest + XCUITest)

#### 9.4 Server-side requirements (depends on Phase 10 API)

- [ ] Push notification registration endpoint (device token storage)
- [ ] Report data endpoints returning JSON (not just PDF)
- [ ] Webhook or polling endpoint for DIAN status changes
- [ ] Efficient pagination for large report datasets
- [ ] Compressed responses (gzip) for mobile bandwidth optimization

---

### Phase 10: POS Integration API for Vet & Lab Testing Sales (Weeks 29-34)

**Goal:** Expose a documented, versioned REST API that enables the custom veterinary
and lab testing POS project to create invoices, apply Colombian taxes, trigger DIAN
electronic invoicing, and sync transactional data — all without direct database access.

#### 10.1 API Module Structure

```
addons/gpcb_api/
  __init__.py
  __manifest__.py
  controllers/
    __init__.py
    api_auth.py            # Token-based authentication
    api_invoice.py         # Invoice CRUD + DIAN submission
    api_partner.py         # Customer/supplier lookup & creation
    api_product.py         # Product/service catalog
    api_tax.py             # Tax computation preview
    api_pos_session.py     # POS session management
    api_report.py          # Report data for iOS app (Phase 9)
    api_payroll.py         # Payroll data exchange (Phase 12)
  models/
    __init__.py
    api_key.py             # API key management model
    api_log.py             # Request/response audit logging
  security/
    ir.model.access.csv
  views/
    api_key_views.xml      # API key management UI
    api_log_views.xml      # API audit log viewer
  data/
    api_data.xml           # Default configuration
  tests/
    __init__.py
    test_api_invoice.py
    test_api_auth.py
    test_api_tax.py
```

#### 10.2 Authentication & security

- [ ] API key model: generation, rotation, scoping (read-only vs read-write),
  per-key rate limits, IP allowlisting
- [ ] Token-based auth: API key in `Authorization: Bearer <token>` header
- [ ] OAuth 2.0 option for the iOS app (authorization code flow with PKCE)
- [ ] Per-endpoint permission checks mapped to Odoo security groups
- [ ] Request/response audit logging with tamper-evident storage
- [ ] Rate limiting: configurable per API key (default 100 req/min)
- [ ] CORS configuration for browser-based POS clients
- [ ] TLS 1.2+ required; reject plaintext connections

#### 10.3 Invoice endpoints (Vet & Lab POS integration)

```
POST   /api/v1/invoices              # Create draft invoice
GET    /api/v1/invoices/:id          # Retrieve invoice with DIAN status
POST   /api/v1/invoices/:id/confirm  # Confirm and trigger DIAN submission
POST   /api/v1/invoices/:id/cancel   # Request cancellation (credit note)
GET    /api/v1/invoices/:id/pdf      # Download graphic representation
GET    /api/v1/invoices/:id/xml      # Download signed UBL XML
GET    /api/v1/invoices              # List/search invoices (paginated)
```

**Invoice creation payload (Vet/Lab specific):**
```json
{
  "partner": {
    "nit": "900123456-7",
    "name": "Clinica Veterinaria El Prado",
    "identification_type": "nit"
  },
  "journal_code": "VET01",
  "lines": [
    {
      "product_code": "LAB-HEMOGRAMA",
      "description": "Hemograma completo - canino",
      "quantity": 1,
      "unit_price": 85000,
      "tax_ids": ["l10n_co_tax_8"],
      "animal_id": "CHIP-123456789",
      "animal_species": "canine",
      "animal_name": "Luna"
    },
    {
      "product_code": "CONS-GENERAL",
      "description": "Consulta veterinaria general",
      "quantity": 1,
      "unit_price": 120000,
      "tax_ids": ["l10n_co_tax_8"]
    }
  ],
  "narration": "Paciente: Luna (Labrador, 3 anos). Propietario: Juan Perez.",
  "payment_method": "cash"
}
```

#### 10.4 Tax computation endpoint

```
POST   /api/v1/tax/compute           # Preview tax computation
```

This allows the POS to show tax breakdowns in real time before invoice creation:
- Accepts a list of lines with product codes and amounts
- Returns computed IVA, INC, and applicable withholdings
- Respects fiscal position of the partner
- Returns both unit and total tax amounts

#### 10.5 Partner endpoints

```
GET    /api/v1/partners              # Search partners by NIT, name
POST   /api/v1/partners              # Create new partner
GET    /api/v1/partners/:id          # Retrieve partner details
PATCH  /api/v1/partners/:id          # Update partner
```

- NIT validation (check digit algorithm) on creation
- Auto-assign fiscal position based on partner type
- Return fiscal responsibilities and withholding obligations

#### 10.6 Product/service catalog endpoints

```
GET    /api/v1/products              # List/search products
GET    /api/v1/products/:id          # Product detail with default taxes
```

- Filterable by category (lab test, consultation, medication, supplies)
- Returns default tax_ids for automatic invoice line tax assignment
- Supports barcode/SKU lookup for physical products

#### 10.7 POS session endpoints

```
POST   /api/v1/pos/sessions/open     # Open a new POS session
POST   /api/v1/pos/sessions/:id/close # Close session with cash count
GET    /api/v1/pos/sessions/:id/summary # Session totals and reconciliation
```

- Maps to existing `pos.session` model
- Handles payment method reconciliation
- Returns Z-report data (session closing summary)

#### 10.8 Vet/Lab domain extensions

The custom POS will need domain-specific fields that flow through to invoices and
reports. These should be handled via custom fields rather than core model changes:

- [ ] `animal_id` — microchip or internal ID of the animal patient
- [ ] `animal_species` — canine, feline, equine, bovine, avian, exotic, other
- [ ] `animal_name` — patient name for invoice narration
- [ ] `veterinarian_id` — attending vet (maps to `res.users` or `hr.employee`)
- [ ] `lab_test_type` — categorization for reporting (hematology, chemistry, urinalysis,
  imaging, microbiology, parasitology)
- [ ] `sample_id` — lab sample tracking number
- [ ] `referring_clinic_id` — for lab referral invoicing (partner)

These fields should be:
- Stored on `account.move.line` as custom fields (prefixed `x_vet_`)
- Passed through the API in the invoice line payload
- Available in report filters for vet/lab-specific analytics
- Not required — the API works for any business; vet/lab fields are optional

#### 10.9 API versioning & documentation

- [ ] Version prefix: `/api/v1/` — breaking changes increment version
- [ ] Auto-generated OpenAPI 3.0 spec from endpoint decorators
- [ ] Interactive documentation at `/api/v1/docs` (Swagger UI or Redoc)
- [ ] Extend existing `api_doc` module (`addons/api_doc/`) with REST endpoint docs
- [ ] Changelog maintained per version
- [ ] Deprecation policy: old versions supported for 6 months after successor release

---

### Phase 11: Automated Report Scheduling, Filing & Delivery (Weeks 35-38)

**Goal:** Automate the generation, review, filing, and delivery of recurring
Colombian tax reports and financial statements.

#### 11.1 Report scheduler model

```
addons/gpcb_report_scheduler/
  __init__.py
  __manifest__.py
  models/
    __init__.py
    report_schedule.py       # Schedule definitions
    report_schedule_run.py   # Execution history/log
  views/
    report_schedule_views.xml
  data/
    ir_cron_data.xml         # Master cron job
  security/
    ir.model.access.csv
```

**`report.schedule` model fields:**
- `name` — Human-readable schedule name
- `report_type` — Selection: `iva_300`, `withholding_350`, `ica`, `income_tax`,
  `withholding_cert`, `exogenous`, `balance_sheet`, `profit_loss`, `trial_balance`,
  `custom`
- `frequency` — Selection: `monthly`, `bimonthly`, `quarterly`, `annual`, `custom_cron`
- `day_of_month` — Day to generate (e.g., 5th of each month for prior period)
- `lead_days` — Days before filing deadline to generate (for review buffer)
- `auto_file` — Boolean: automatically submit to DIAN (vs generate for review only)
- `recipients` — Many2many to `res.partner` (email delivery list)
- `notify_channel` — Selection: `email`, `push` (iOS app), `both`
- `state` — Selection: `active`, `paused`, `archived`
- `company_id` — Multi-company support

#### 11.2 Execution workflow

```
┌──────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ ir.cron  │───>│  Generate    │───>│  Review      │───>│  File/Send   │
│ triggers │    │  Report      │    │  (optional)  │    │  to DIAN     │
└──────────┘    └──────┬───────┘    └──────┬───────┘    └──────┬───────┘
                       │                   │                   │
                       v                   v                   v
                ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
                │ Store PDF +  │    │ Notify via   │    │ Store filing │
                │ data snapshot│    │ email/push   │    │ confirmation │
                └──────────────┘    └──────────────┘    └──────────────┘
```

#### 11.3 Key tasks

- [ ] Master cron job: runs daily, checks all active schedules for due reports
- [ ] Report generation: leverage existing `account.report` framework to produce
  data snapshots and PDF/Excel outputs
- [ ] Data snapshot storage: freeze report data at generation time so historical
  reports remain immutable even if underlying data is later corrected
- [ ] Review workflow:
  - Generate report in "pending review" state
  - Notify assigned reviewers (email + iOS push notification)
  - Reviewer approves or requests regeneration with notes
  - Approved reports proceed to filing/delivery
- [ ] DIAN filing integration (depends on Phase 3):
  - Formulario 300: auto-populate and submit via DIAN Muisca portal API (or generate
    pre-filled XML for manual upload if API unavailable)
  - Formulario 350: same approach
  - Exogenous XML: auto-generate and stage for submission
- [ ] Email delivery:
  - Use existing `mail.mail` queue infrastructure
  - Attach PDF + Excel to email
  - Template-based email body with period summary
  - CC/BCC support for external accountants
- [ ] iOS push notifications (depends on Phase 9):
  - "Formulario 300 for January 2026 is ready for review"
  - "Filing deadline in 3 days — report not yet approved"
  - "Formulario 350 filed successfully with DIAN"
- [ ] Audit trail: full history of generation, review, filing, and delivery per schedule
- [ ] Retry logic: if DIAN filing fails, retry with exponential backoff and alert on
  persistent failure

#### 11.4 Pre-configured schedules (Colombian defaults)

| Report | Frequency | Generate Day | Filing Deadline |
|--------|-----------|-------------|-----------------|
| Formulario 300 (IVA) | Bimonthly | 1st of filing month | Varies by NIT last digit |
| Formulario 350 (Withholding) | Monthly | 1st of following month | Varies by NIT last digit |
| Withholding certificates | Annual | March 1 | March 31 |
| Exogenous information | Annual | February 1 | March-April (by format) |
| ICA return | Bimonthly/Annual | Varies by municipality | Varies |
| Balance Sheet | Monthly | 5th of following month | Internal |
| Profit & Loss | Monthly | 5th of following month | Internal |

---

### Phase 12: Electronic Payroll Data Exchange (Weeks 39-42)

**Goal:** Implement electronic delivery and receipt of payroll data (nomina electronica)
compliant with DIAN requirements (Resolucion 000013 de 2021), and integrate payroll
information into the accounting system for accurate expense recognition and withholding.

#### 12.1 Regulatory context

Since 2021, Colombian employers must transmit payroll support documents (documentos
soporte de nomina electronica) to DIAN. These are not invoices but informational
documents that support payroll expense deductions. Key requirements:
- UBL 2.1 extension for payroll (DIAN Technical Annex — Nomina Electronica)
- CUNE generation (Codigo Unico de Nomina Electronica) — SHA-384 hash
- Digital signature (same certificate as electronic invoicing)
- Monthly transmission to DIAN
- Adjustment notes for corrections

#### 12.2 Module structure

```
addons/l10n_co_payroll_edi/
  __init__.py
  __manifest__.py
  models/
    __init__.py
    l10n_co_payroll_document.py    # Payroll EDI document model
    l10n_co_payroll_line.py        # Earnings, deductions, provisions
    l10n_co_payroll_cune.py        # CUNE computation
    res_company.py                 # Payroll EDI company settings
  data/
    payroll_edi_data.xml           # DIAN payroll codes
    ubl_templates/                 # Payroll XML templates
  views/
    payroll_document_views.xml
  wizard/
    payroll_import_wizard.py       # Import from external payroll system
    payroll_send_wizard.py         # Batch DIAN submission
  security/
    ir.model.access.csv
  tests/
    __init__.py
    test_cune.py
    test_payroll_xml.py
```

#### 12.3 Payroll document model

Since the codebase does not include a full `hr_payroll` module (only `hr` base with
`hr.payroll.structure.type` stub), the design must support two scenarios:

**Scenario A: Standalone payroll EDI (no hr_payroll installed)**
- Payroll data imported from external payroll system (e.g., Novasoft, Siigo, Helisa,
  World Office) via CSV/Excel upload or API
- `l10n_co.payroll.document` stores the structured data needed for DIAN XML
- Focus is on DIAN transmission and accounting entry generation, not payroll computation

**Scenario B: Integrated with hr_payroll (if installed later)**
- Extend `hr.payslip` with DIAN EDI fields
- Auto-generate payroll EDI documents from confirmed payslips
- Compute CUNE from payslip data

**Recommended approach:** Build Scenario A first (standalone), with hooks for Scenario B.

#### 12.4 Data model fields (`l10n_co.payroll.document`)

- `employee_id` — Link to `hr.employee`
- `period_start` / `period_end` — Pay period dates
- `settlement_date` — Payment date
- `document_number` — Sequential per company
- `cune` — Computed CUNE hash
- `state` — `draft`, `confirmed`, `sent`, `validated`, `rejected`
- **Earnings lines:**
  - Base salary, transportation subsidy, overtime (HED, HEN, HEDDF, HENDF, HRN, HRNDF),
    commissions, bonuses, vacation pay, disability pay, maternity/paternity leave
- **Deductions lines:**
  - Health (EPS) — 4%, Pension (AFP) — 4%, Solidarity fund (FSP) — 1%+,
    RteFte on salary, union dues, voluntary deductions, embargoes
- **Provisions (employer cost):**
  - Health (EPS) — 8.5%, Pension (AFP) — 12%, ARL (risk-based), SENA — 2%,
    ICBF — 3%, Caja de Compensacion — 4%, Severance (cesantias) — 8.33%,
    Severance interest — 1%, Prima — 8.33%, Vacation — 4.17%
- `total_earnings`, `total_deductions`, `net_pay`
- `xml_file` — Generated UBL XML (binary attachment)
- `dian_response` — Validation response from DIAN

#### 12.5 Key tasks

- [ ] CUNE generation: SHA-384 hash per DIAN payroll technical annex with unit tests
- [ ] UBL XML templates for:
  - Nomina Individual (standard monthly payroll)
  - Nomina Individual de Ajuste (adjustment/correction)
  - Nota de Ajuste (for reversals)
- [ ] Digital signature: reuse certificate infrastructure from Phase 2
- [ ] DIAN submission: reuse web service client from Phase 3 (same endpoints, different
  document type)
- [ ] Import wizard: CSV/Excel upload mapping external payroll system columns to the
  document model; support for:
  - Novasoft export format
  - Siigo export format
  - Generic columnar CSV with configurable mapping
- [ ] API endpoint for payroll import (Phase 10 integration):
  ```
  POST   /api/v1/payroll/documents           # Create payroll document
  GET    /api/v1/payroll/documents/:id        # Retrieve with DIAN status
  POST   /api/v1/payroll/documents/:id/send   # Submit to DIAN
  GET    /api/v1/payroll/documents            # List/search (paginated)
  ```
- [ ] Accounting entry generation:
  - Auto-create journal entries from confirmed payroll documents
  - Map earnings to expense accounts (PUC 5105xx - Salarios, 5110xx - Horas extras, etc.)
  - Map deductions to liability accounts (PUC 2370xx - Retenciones, 2380xx - Aportes)
  - Map provisions to liability/expense accounts
  - Reconcile with bank payments
- [ ] Monthly batch processing:
  - Bulk import, validate, sign, and submit payroll documents
  - Progress tracking with error reporting
  - Partial submission support (skip errored documents, continue with valid ones)
- [ ] Payroll cost reports:
  - Monthly payroll cost summary by department/cost center
  - Social security contribution summary (PILA reconciliation)
  - Annual salary and withholding summary per employee (for Certificado de Ingresos
    y Retenciones)
- [ ] iOS push notifications (Phase 9):
  - "Payroll batch for January 2026 processed: 45 accepted, 2 rejected"
  - "Payroll filing deadline in 5 days"

#### 12.6 PILA integration considerations

PILA (Planilla Integrada de Liquidacion de Aportes) is the unified social security
payment form. While full PILA generation is outside the initial scope, the payroll
document model should store sufficient data to:
- Reconcile PILA payments against recorded provisions
- Generate a PILA pre-validation summary
- Flag discrepancies between payroll documents and PILA operator reports

---

## 4. Architecture Considerations

### 4.1 Module dependencies

```
l10n_co_edi
  ├── l10n_co (Chart of Accounts, taxes, identification types)
  ├── account_edi (generic EDI framework)
  ├── account_edi_ubl_cii (UBL 2.1 base templates)
  ├── l10n_latam_invoice_document (LATAM document types)
  └── l10n_account_withholding_tax (withholding on payment)

l10n_co_reports (new)
  ├── l10n_co (base)
  └── account_reports (report framework - if available, or account)

l10n_co_edi_dee (new, optional)
  ├── l10n_co_edi
  └── point_of_sale (for POS tickets)

gpcb_theme (new)
  └── web (base web framework)

gpcb_api (new)
  ├── l10n_co_edi (for invoice DIAN submission via API)
  ├── account (core accounting)
  └── api_doc (auto-generated API documentation)

gpcb_report_scheduler (new)
  ├── l10n_co_reports (report definitions)
  ├── l10n_co_edi (DIAN filing integration)
  └── mail (email delivery infrastructure)

l10n_co_payroll_edi (new)
  ├── l10n_co_edi (shared DIAN client, certificate, signing)
  ├── hr (employee data)
  └── account (journal entry generation)

iOS App (external, not an Odoo module)
  └── Consumes gpcb_api REST endpoints

Custom Vet/Lab POS (external, separate project)
  └── Consumes gpcb_api REST endpoints
```

### 4.2 Reference implementations

The following existing modules provide proven patterns to follow:

| Module | Relevance |
|--------|-----------|
| `l10n_es_edi_facturae` | Spanish e-invoicing with XML signing, government submission |
| `l10n_it_edi` | Italian e-invoicing with clearance model (similar to Colombia) |
| `l10n_my_edi` | Malaysian e-invoicing with UBL 2.1 and government API |
| `l10n_mx` | Mexican CFDI — closest LATAM equivalent with SAT integration |
| `account_edi_ubl_cii` | Base UBL/CII templates to extend |
| `account_peppol` | EDI proxy architecture for government submission |

### 4.3 Security considerations

- Digital certificate private keys must be encrypted at rest
- DIAN credentials (software PIN) stored in system parameters, not in code
- Audit logging for all DIAN submissions
- Hash chain integrity for sequential invoice numbering (already supported by Odoo)

### 4.4 Testing strategy

- Unit tests for CUFE/CUDE/CUNE computation with known test vectors
- XML validation against DIAN XSD schemas
- Integration tests with DIAN test environment (habilitacion)
- End-to-end tests: invoice creation -> XML generation -> signing -> mock DIAN response
- Tax computation tests for all withholding scenarios
- API endpoint tests: authentication, CRUD operations, error handling, rate limiting
- iOS app: XCTest unit tests + XCUITest for critical user flows
- Report scheduler: cron execution tests with mocked clock, delivery verification
- Payroll EDI: import wizard tests with sample data from Novasoft/Siigo formats
- Load testing: API endpoints under concurrent POS terminal simulation (50+ terminals)

---

## 5. Priority Matrix

| Phase | Priority | Effort | Timeline | Business Impact |
|-------|----------|--------|----------|-----------------|
| Phase 1: Foundation | P0 | Medium | Wk 1-4 | Enables all subsequent work |
| Phase 2: XML & Signing | P0 | High | Wk 5-8 | Required for legal invoicing |
| Phase 3: DIAN Integration | P0 | High | Wk 9-12 | Required for legal invoicing |
| Phase 4: Reporting | P1 | Medium | Wk 13-16 | Required for tax filing |
| Phase 5: Fiscal Positions | P1 | Low-Med | Wk 17-18 | Reduces manual errors |
| Phase 6: DEE | P1 | Medium | Wk 19-20 | Required for POS and utilities |
| Phase 7: Exogenous Info | P2 | Medium | Wk 21-22 | Annual filing requirement |
| Phase 8: UI Modernization | P2 | Med-High | Wk 23-28 | User experience, adoption |
| Phase 9: iOS App | P2 | High | Wk 29-36 | Mobile access for management |
| Phase 10: POS API (Vet/Lab) | P1 | High | Wk 29-34 | Enables Vet/Lab POS project |
| Phase 11: Report Scheduling | P1 | Medium | Wk 35-38 | Filing automation, compliance |
| Phase 12: Payroll EDI | P2 | High | Wk 39-42 | Nomina electronica compliance |

**Phases 1-3** are mandatory for legal invoicing in Colombia.
**Phases 4-5** are required for periodic tax compliance.
**Phase 10** (API) is critical to unblock the Vet/Lab POS project and can start in
parallel with Phase 8 once DIAN integration (Phase 3) is complete.
**Phases 9 and 10** share a dependency (the API) and should be developed concurrently.
**Phase 11** amplifies the value of Phases 4 and 7 by automating their outputs.
**Phase 12** can be deferred if payroll is handled externally, but the transmission
obligation to DIAN remains.

### Parallelization opportunities

```
Wk 1-12:  [== Phase 1 ==][== Phase 2 ==][== Phase 3 ==]
Wk 13-18: [==== Phase 4 ====][Phase 5]
Wk 19-22: [Phase 6][Phase 7]
Wk 23-28: [====== Phase 8: UI ======]
Wk 29-36: [======= Phase 9: iOS =======]
Wk 29-34: [===== Phase 10: API =====]    <- parallel with iOS
Wk 35-38:                         [== Phase 11: Scheduling ==]
Wk 39-42:                                 [== Phase 12: Payroll ==]
```

Phases 9 and 10 are designed for concurrent development — the API module (Phase 10)
serves both the iOS app and the Vet/Lab POS. The iOS team and API team can work from
a shared contract (OpenAPI spec) defined at the start of Week 29.

---

## 6. Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| DIAN Technical Annex version change | Medium | High | Design XML templates for easy version updates; monitor DIAN resolutions |
| Digital certificate compatibility | Medium | Medium | Test with multiple ONAC-accredited providers (Certicamara, Andes SCD, GSE) |
| DIAN web service downtime | High | Medium | Implement contingency mode with offline numbering |
| Tax rate changes mid-year | High | Low | UVT-based thresholds; configurable tax rates; migration scripts |
| Constitutional challenge to Decreto 1474 | Medium | Low | Design tax rules to be easily toggled |
| Performance impact of XML generation | Low | Medium | Async processing; batch submission support |
| iOS App Store rejection | Medium | Medium | Follow Apple HIG strictly; submit early for review; have TestFlight fallback |
| API security breach | Low | Critical | Rate limiting, audit logging, token rotation, penetration testing before launch |
| POS offline/connectivity loss at vet clinic | High | High | API queues failed requests; POS stores locally and syncs; contingency numbering |
| External payroll system format changes | Medium | Low | Configurable column mapping in import wizard; template versioning |
| Concurrent POS terminal load on API | Medium | Medium | Load test at 50+ terminals; connection pooling; caching for catalog endpoints |
| Apple deprecates iOS framework dependency | Low | Medium | Use only first-party Apple frameworks (SwiftUI, Swift Charts, URLSession) |
| Report scheduling produces incorrect data | Medium | High | Data snapshot immutability; comparison against manual calculation; review workflow |
| Scope creep on vet/lab domain fields | High | Medium | Strict `x_vet_` prefix convention; optional fields only; no core model changes |

---

## 7. Regulatory Calendar

| Date | Obligation | Relevance |
|------|-----------|-----------|
| Monthly (varies) | IVA return (bimonthly for most; monthly for large taxpayers) | Phase 4, 11 |
| Monthly | Withholding return (Formulario 350) | Phase 4, 11 |
| Monthly | Nomina electronica transmission to DIAN | Phase 12 |
| Monthly | PILA payment (social security contributions) | Phase 12 |
| March 31, 2026 | Withholding certificates for TY 2025 | Phase 4, 11 |
| March 31, 2026 | Certificado de Ingresos y Retenciones to employees | Phase 12 |
| April-June 2026 | Annual income tax return (dates vary by NIT) | Phase 4, 11 |
| March-April 2026 | Exogenous information submission | Phase 7, 11 |
| Ongoing | Electronic invoice issuance per transaction | Phases 1-3, 10 |
| Ongoing | Documento equivalente electronico | Phase 6 |
| Ongoing | Vet/Lab POS invoice transmission via API | Phase 10 |
| July 31, 2026 | Tax normalization (Decreto 1474) | Informational |

---

## 8. Summary of Recommendations

1. **Immediate priority:** Begin Phase 1-3 development of `l10n_co_edi` module. Without
   electronic invoicing, the system cannot be legally used for invoicing in Colombia.

2. **Leverage existing architecture:** The `account_edi` and `account_edi_ubl_cii` modules
   provide a solid foundation. Italy's clearance model (`l10n_it_edi`) is the closest
   architectural match to Colombia's pre-validation requirement.

3. **Tax data maintenance:** Establish a process for annual tax rate and UVT updates.
   Current tax data should be audited against 2026 regulations.

4. **Test with DIAN:** Register for DIAN's test environment (habilitacion) early to
   validate XML format and web service integration before production deployment.

5. **Design the API early:** The `gpcb_api` module (Phase 10) is a shared dependency
   for both the iOS app and the Vet/Lab POS project. Define the OpenAPI spec during
   Phase 3 so the external POS team can begin integration work against mock endpoints.

6. **Vet/Lab POS: keep domain fields optional and prefixed.** Animal patient data,
   lab test metadata, and veterinarian references should be optional `x_vet_` custom
   fields on invoice lines — not changes to core accounting models. This keeps the
   system usable for any business while supporting vet/lab-specific reporting.

7. **iOS app: start with reports, expand to actions.** The MVP should focus on read-only
   report viewing and DIAN status monitoring. Transactional features (approve invoices,
   trigger resubmission) can follow once the read path is proven.

8. **Automate before you're asked.** Report scheduling (Phase 11) should be prioritized
   right after the API — manual report generation and email delivery is the most common
   source of missed deadlines. Automated scheduling with review workflows eliminates
   this risk.

9. **Payroll EDI: import-first, compute-later.** Since there is no full `hr_payroll`
   module in the codebase, build the payroll EDI module as a standalone import-and-transmit
   system first. If a full payroll computation module is added later, integrate it via
   hooks already designed into the architecture.

10. **UI modernization: theme first, then components.** A Bootstrap theme refresh
    (Phase 8, Option A) delivers immediate visual improvement with minimal risk.
    Component-level redesign should target the new Colombian-specific views (DIAN
    dashboard, EDI status) which have no legacy design constraints.

11. **Phased rollout:** Implement the 12 phases with the following grouping:
    - **MVP (Weeks 1-12):** Phases 1-3 — legal electronic invoicing
    - **Compliance (Weeks 13-22):** Phases 4-7 — reporting, filing, fiscal automation
    - **Platform (Weeks 23-38):** Phases 8-11 — UI, mobile, API, automation
    - **Payroll (Weeks 39-42):** Phase 12 — nomina electronica
