<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Custom Product Detail Template -->
    <template id="custom_product_detail" name="Custom Product Detail" inherit_id="website_sale.product">
        <!-- Override main product detail section -->
        <xpath expr="//section[@id='product_detail']" position="replace">
            <section t-attf-class="container py-4 oe_website_sale #{'discount' if combination_info['has_discounted_price'] else ''}" id="product_detail"
                    t-att-data-view-track="view_track and '1' or '0'"
                    t-att-data-product-tracking-info="json.dumps(request.env['product.template'].get_google_analytics_data(combination_info))">
                
                <!-- Store Header with rating -->
                <t t-if="product.seller_id">
                    <div class="store-header d-flex align-items-center py-2 mb-3 border-bottom">
                        <div class="store-logo me-2">
                            <t t-if="product.seller_id.image_1920">
                                <img t-att-src="image_data_uri(product.seller_id.image_1920)" width="40" height="40" alt="Store" class="rounded-circle"/>
                            </t>
                            <t t-else="">
                                <img src="/multi_vendor_marketplace/static/src/img/shop_icon.png" width="40" height="40" alt="Store" class="rounded-circle"/>
                            </t>
                        </div>
                        <div class="store-info flex-grow-1">
                            <div class="store-name fw-bold" t-esc="product.seller_id.name">Store Name</div>
                            <div class="store-rating">
                                <span class="rating-stars text-warning">
                                    <t t-foreach="range(5)" t-as="star">
                                        <t t-if="product.seller_id.avg_rating >= star+1">
                                            <i class="fa fa-star"></i>
                                        </t>
                                        <t t-elif="product.seller_id.avg_rating > star and product.seller_id.avg_rating &lt; star+1">
                                            <i class="fa fa-star-half-o"></i>
                                        </t>
                                        <t t-else="">
                                            <i class="fa fa-star-o"></i>
                                        </t>
                                    </t>
                                </span>
                                <span class="rating-score" t-esc="round(product.seller_id.avg_rating, 1)">4.0</span>
                            </div>
                        </div>
                        <div class="store-actions">
                            <button class="btn btn-outline-primary me-2" style="border-radius: 30px; background-color: white; color: #0d6efd;" data-bs-toggle="modal" data-bs-target="#contact_seller_modal">
                                <i class="fa fa-comments me-1"></i> Contact
                            </button>
                            <a t-att-href="'/shop/seller/%s' % (product.seller_id.id)" class="btn btn-primary" style="border-radius: 30px; background-color: white; color: #0d6efd;">
                                <i class="fa fa-shopping-bag me-1"></i> Visit Store
                            </a>
                        </div>
                    </div>
                </t>
                
                <!-- Breadcrumb section -->
                <div class="row align-items-center mb-4">
                    <div class="col-12">
                        <ol class="breadcrumb p-0 m-0">
                            <li class="breadcrumb-item o_not_editable">
                                <a t-att-href="keep(category=0)">All Products</a>
                            </li>
                            <li t-if="category" class="breadcrumb-item">
                                <a t-att-href="keep('/shop/category/%s' % slug(category), category=0)" t-field="category.name" />
                            </li>
                            <li class="breadcrumb-item active">
                                <span t-field="product.name" />
                            </li>
                        </ol>
                    </div>
                </div>
                
                <!-- Main product section -->
                <div class="row" id="product_detail_main">
                    <!-- Product Images -->
                    <t t-set="image_cols" t-value="website._get_product_page_proportions()"/>
                    <div t-attf-class="col-lg-#{image_cols[0]} mt-lg-4 o_wsale_product_images position-relative" t-if="website.product_page_image_width != 'none'">
                        <t t-call="website_sale.shop_product_images"/>
                    </div>
                    
                    <!-- Product Info -->
                    <div t-attf-class="col-lg-#{image_cols[1]} mt-md-4" id="product_details">
                        <!-- Product Title -->
                        <h1 class="mb-2" t-field="product.name">Product Name</h1>
                        
                        <!-- Product Description -->
                        <p t-field="product.description_sale" class="text-muted mb-3" placeholder="A short description that will also appear on documents." />
                        
                        <!-- Product form for cart actions -->
                        <form t-if="product._is_add_to_cart_possible()" action="/shop/cart/update" method="POST">
                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                            <div class="js_product js_main_product">
                                <div>
                                    <!-- Price display in larger font and with currency symbol -->
                                    <div class="product_price mt-2 mb-3">
                                        <h3 class="oe_price_h4 css_editable_mode_display">
                                            <span t-if="combination_info['has_discounted_price']" style="text-decoration: line-through; white-space: nowrap;" t-out="combination_info['list_price']" class="text-danger me-2"/>
                                            <span t-att-class="'text-success'" style="white-space: nowrap; font-size: 1.5em; font-weight: bold;" t-out="combination_info['price']"/>
                                            <span t-if="combination_info['base_unit_price']" class="ms-1 text-muted o_base_unit_price_wrapper d-none" groups="website_sale.group_show_uom_price">
                                                <t t-call='website_sale.base_unit_price'/>
                                            </span>
                                        </h3>
                                    </div>
                                    
                                    <!-- Variants section - important for fixing the error -->
                                    <t t-placeholder="select">
                                        <input type="hidden" class="product_id" name="product_id" t-att-value="product_variant.id" />
                                        <input type="hidden" class="product_template_id" name="product_template_id" t-att-value="product.id" />
                                        <input t-if="product.public_categ_ids.ids" type="hidden" class="product_category_id" name="product_category_id" t-att-value="product.public_categ_ids.ids[0]" />
                                        
                                        <t t-if="product.attribute_line_ids">
                                            <ul class="list-unstyled js_add_cart_variants" t-att-data-attribute_exclusions="product._get_attribute_exclusions()"/>
                                        </t>
                                        <t t-else="">
                                            <ul class="list-unstyled js_add_cart_variants d-none" t-att-data-attribute_exclusions="product._get_attribute_exclusions()"/>
                                        </t>
                                    </t>
                                    
                                    <!-- Required elements for JS variant handling -->
                                    <div class="css_not_available_msg alert alert-warning" style="display: none;">This combination does not exist.</div>
                                    <div id="add_to_cart_wrap" class="d-inline-flex align-items-center mb-2 me-auto"></div>
                                    <div id="product_option_block" class="d-flex flex-wrap w-100"></div>
                                    
                                    <!-- Stock status element with required format for _onChangeCombinationStock method -->
                                    <div id="stock_status" class="o_not_editable mb-2">
                                        <span id="availability_message" class="oe_availability text-success o_hidden">
                                            <i class="fa fa-check"></i> In Stock
                                        </span>
                                        <span id="availability_label" class="availability_label o_hidden">
                                            <i class="fa fa-info-circle"></i> 
                                            Available in <b><span id="available_threshold">5</span> days</b>
                                        </span>
                                    </div>
                                    
                                    <!-- Add the product availability message div with the right structure -->
                                    <div t-if="product.type == 'product'" class="availability mt-2">
                                        <div id="product_availability_message" class="alert alert-warning" role="alert" style="display: none;"></div>
                                    </div>
                                    
                                    <!-- Delivery info -->
                                    <div class="delivery-info mb-3">
                                        <div class="d-flex align-items-center text-muted">
                                            <i class="fa fa-truck me-2"></i>
                                            <span>Free Shipping within 24 hours</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Add quantity selection widget -->
                                    <div class="css_quantity input-group mx-auto w-auto">
                                        <div class="input-group-prepend">
                                            <button type="button" class="btn btn-secondary js_remove_qty">
                                                <i class="fa fa-minus"></i>
                                            </button>
                                        </div>
                                        <input type="text" class="js_quantity form-control quantity" name="add_qty" value="1"/>
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-secondary js_add_qty">
                                                <i class="fa fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Action buttons row (Buy Now and Add to Cart) -->
                                    <div class="action-buttons d-flex mb-3" style="gap: 10px; left: 0; right: 0; background-color: white; padding: 10px 15px; z-index: 1001; width: 100%;">
                                        <!-- Standard Add to Cart Button -->
                                        <div id="o_wsale_cta_wrapper" class="d-flex w-100 justify-content-between">
                                            <button type="submit" id="add_to_cart" class="btn btn-lg flex-fill me-2 js_check_product a-submit" 
                                                    style="background-color: #089454; border-color: #089454; color: white;">
                                                <i class="fa fa-shopping-cart me-2"></i>
                                                <span>Add to Cart</span>
                                            </button>
                                            
                                            <!-- Buy Now Button -->
                                            <button type="button" id="buy_now" class="btn btn-lg flex-fill" 
                                                    style="background-color: #089454; border-color: #089454; color: white;">
                                                <i class="fa fa-bolt me-2"></i>
                                                <span>Buy Now</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <p t-elif="not product.active" class="alert alert-warning">This product is no longer available.</p>
                        <p t-else="" class="alert alert-warning">This product has no valid combination.</p>
                        
                        <!-- Product attributes -->
                        <div id="product_attributes_simple">
                            <t t-set="single_value_attributes" t-value="product.valid_product_template_attribute_line_ids._prepare_single_value_for_display()"/>
                            <table t-attf-class="table table-sm text-muted {{'' if single_value_attributes else 'd-none'}}">
                                <t t-foreach="single_value_attributes" t-as="attribute">
                                    <tr>
                                        <td>
                                            <span t-field="attribute.name"/>:
                                            <t t-foreach="single_value_attributes[attribute]" t-as="ptal">
                                                <span t-field="ptal.product_template_value_ids._only_active().name"/><t t-if="not ptal_last">, </t>
                                            </t>
                                        </td>
                                    </tr>
                                </t>
                            </table>
                        </div>
                        
                        <!-- Terms and conditions, no OdooBot chat -->
                        <div id="o_product_terms_and_share" class="d-flex justify-content-between flex-column flex-md-row align-items-md-end mb-3">
                            <p class="text-muted mb-0">
                                <a href="/terms" class="text-muted"><u>Terms and Conditions</u></a><br/>
                                30-day money-back guarantee<br/>
                                Shipping: 2-3 Business Days
                            </p>
                            <div class="h4 mt-3 mb-0 d-flex justify-content-md-end flex-shrink-0">
                                <button class="btn btn-primary rounded-circle" aria-label="Chat with OdooBot" title="Chat with OdooBot" id="o_livechat_button">
                                    <i class="fa fa-comments"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Seller Contact Modal -->
                <div class="modal fade" id="contact_seller_modal" tabindex="-1" aria-labelledby="contactSellerModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="contactSellerModalLabel">Contact Seller</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="seller-contact-info">
                                    <div class="mb-3">
                                        <h6 class="fw-bold"><i class="fa fa-phone me-2"></i>Phone</h6>
                                        <p t-esc="product.seller_id.phone or '+1 (555) 123-4567'">+1 (555) 123-4567</p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold"><i class="fa fa-envelope me-2"></i>Email</h6>
                                        <p t-esc="product.seller_id.email or 'seller@example.com'">seller@example.com</p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold"><i class="fa fa-globe me-2"></i>Social Media</h6>
                                        <div class="social-links">
                                            <a href="#" class="btn btn-outline-primary me-2 mb-2">
                                                <i class="fa fa-facebook"></i>
                                            </a>
                                            <a href="#" class="btn btn-outline-info me-2 mb-2">
                                                <i class="fa fa-twitter"></i>
                                            </a>
                                            <a href="#" class="btn btn-outline-danger me-2 mb-2">
                                                <i class="fa fa-instagram"></i>
                                            </a>
                                            <a href="#" class="btn btn-outline-success me-2 mb-2">
                                                <i class="fa fa-whatsapp"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </xpath>
    </template>
</odoo> 